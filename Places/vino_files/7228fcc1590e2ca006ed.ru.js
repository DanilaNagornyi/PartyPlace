(window.__LOADABLE_LOADED_CHUNKS__=window.__LOADABLE_LOADED_CHUNKS__||[]).push([["ymaps-vector"],{125:function(t,e,i){"use strict";i.d(e,"a",function(){return a});var r=i(34),s=i(75),n=i(155),o=i(76),a={getScale:function(t,e){return Math.pow(2,e-t)},getWorldPixelSize:function(t){return 256*Math.pow(2,t)},worldToPixels:function(t,e){var i=Math.pow(2,e)/2*256;return o.muln({x:t.x+1,y:1-t.y},i)},worldToRelativePixels:function(t,e){var i=Math.pow(2,e)/2*256;return o.mulv(t,{x:i,y:-i})},worldToTile:function(t,e,i){var r=a.worldToPixels(t,e);return o.divn(r,i)},moveCloseToCenter:function(t,e,i){i=i||t;var r=o.sub(t,e).x;return Math.abs(r)>1?o.add(i,{x:-2*Object(s.mathSign)(r),y:0}):i},convertPixelSizeToWorldSize:function(t,e,i){var r=Math.pow(2,e)/2*256;return o.divv(t,{x:r,y:-r},i)},pixelsToWorld:function(t,e){var i=Math.pow(2,e)/2*256;return{x:t.x/i-1,y:1-t.y/i}},fitViewportToWorld:function(t,e){var i=e.zoom,r=e.worldOptions,s=e.size,n=void 0===s?o.ORIGIN:s;if(r.cycledX&&r.cycledY)return t;var h=a.convertPixelSizeToWorldSize(n,i);return{x:l(t.x,h.x,r.cycledX),y:l(t.y,-h.y,r.cycledY)}},restrictToZeroWorld:function(t,e){var i=Object(r.a)({},t);return e.cycledX&&(i.x=Object(n.a)(i.x,-1,1)),e.cycledY&&(i.y=Object(n.a)(i.y,-1,1)),i},computePixelPerfectWorldCoordinates:function(t,e,i,r,s){void 0===r&&(r=1),void 0===s&&(s={x:0,y:0});var n=a.getWorldPixelSize(e)/2*r*i;return o.applyFunction(t,function(t){return Math.round(t*n)/n},s)}};function l(t,e,i){var r=e/2;return i?Object(n.a)(t,-1,1):Object(n.b)(t,Math.min(0,r-1),Math.max(0,1-r))}},155:function(t,e,i){"use strict";function r(t,e,i){return t-Math.floor((t-e)/(i-e))*(i-e)}function s(t,e,i){return Math.max(Math.min(t,i),e)}i.d(e,"a",function(){return r}),i.d(e,"b",function(){return s})},167:function(t,e,i){"use strict";var r=i(34),s=i(76),n=i(402),o=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],a=16;function l(){return new Array(a)}function h(t,e){void 0===e&&(e=l());for(var i=0;i<a;++i)e[i]=t[i];return e}function c(t,e,i){void 0===i&&(i=l());for(var r=0;r<a;r+=4)for(var s=t[r],n=t[r+1],o=t[r+2],h=t[r+3],c=0;c<4;++c)i[r+c]=s*e[c]+n*e[4+c]+o*e[8+c]+h*e[12+c];return i}var d=h(o);function u(t,e,i){void 0===i&&(i=n.e(0,0,0));var r=t[3]*e.x+t[7]*e.y+t[11]*e.z+t[15],s=(t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12])/r,o=(t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13])/r,a=(t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14])/r;return i.x=s,i.y=o,i.z=a,i}var f=i(125);function _(t,e){var i=e.container.getBoundingClientRect();return m({x:t.x-i.left,y:t.y-i.top},e)}function p(t,e){var i=g(t,e),r=e.container.getBoundingClientRect();return s.add(i,{x:r.left,y:r.top},i),i}function m(t,e){var i=e.size,s=e.zoom,o=e.worldCenter,a=e.azimuth,l=e.tilt,h=e.fov,c=Math.tan(.5*h),d={x:0,y:0,z:y(-f.a.convertPixelSizeToWorldSize(i,s).y,h)};n.k(d,l,d),n.l(d,a,d),n.c(d,Object(r.a)(Object(r.a)({},o),{z:0}),d);var u=i.x/i.y,_=n.e(c*u,c,1),p={x:2*(t.x-i.x/2)/i.x,y:2*(i.y/2-t.y)/i.y,z:-1};n.i(p,_,p),n.k(p,l,p),n.l(p,a,p);var m=n.h(n.b,{origin:d,direction:p});if(!m)throw new Error("Pointer above the horizon.");return m}function g(t,e){var i=e.size,_=e.zoom,p=e.worldCenter,m=e.azimuth,g=e.tilt,v=e.fov,x=f.a.convertPixelSizeToWorldSize(i,_),b=s.divn(x,2),w=y(-x.y,v),A={x:0,y:0,z:w};n.k(A,g,A),n.l(A,m,A),n.c(A,Object(r.a)(Object(r.a)({},p),{z:0}),A);var P=function(t,e,i,r,s){void 0===s&&(s=l());var o=n.m(e,i);n.j(o,o);var a=n.f(r,o);n.j(a,a);var h=n.f(o,a);return d[0]=a.x,d[1]=h.x,d[2]=o.x,d[4]=a.y,d[5]=h.y,d[6]=o.y,d[8]=a.z,d[9]=h.z,d[10]=o.z,d[12]=-n.g(a,e),d[13]=-n.g(h,e),d[14]=-n.g(o,e),c(t,d,s)}(o,A,Object(r.a)(Object(r.a)({},p),{z:0}),n.l({x:0,y:1,z:0},m));if(g>0){var T=-b.y*Math.sin(g),S=-T-w,R=T-w,z=b.x/-b.y,M=function(t,e,i,r,s,n){void 0===n&&(n=l());for(var o=1/Math.tan(.5*e),h=o/i,c=(r+s)/(r-s),d=2*r*s/(r-s),u=0;u<a;u+=4){n[u]=t[u]*h,n[u+1]=t[u+1]*o;var f=t[u+2],_=t[u+3];n[u+2]=f*c+_*d,n[u+3]=-f}return n}(h(o),v,z,S,R);return M[0]=M[0]*i.x/2,M[5]=M[5]*(-i.y/2),M[8]=-i.x/2,M[9]=-i.y/2,u(c(P,M),Object(r.a)(Object(r.a)({},t),{z:0}))}var C=u(P,Object(r.a)(Object(r.a)({},t),{z:0})),k=s.add(C,b);return f.a.worldToRelativePixels(k,_)}function y(t,e){return.5*t/Math.tan(.5*e)}i.d(e,"c",function(){return _}),i.d(e,"e",function(){return p}),i.d(e,"b",function(){return m}),i.d(e,"d",function(){return g}),i.d(e,"a",function(){return y})},192:function(t,e,i){"use strict";i.r(e),i.d(e,"queueMicrotask",function(){return n}),i.d(e,"Promise",function(){return r}),i.d(e,"promiseFinally",function(){return o});var r=Promise,s=r.resolve(),n=function(t){return s.then(t)},o=function(t,e){var i=Promise.resolve(t);return"finally"in i?i.finally(e):i.then(function(t){return Promise.resolve(e()).then(function(){return Promise.resolve(t)})},function(t){return Promise.resolve(e()).then(function(){return Promise.reject(t)})})}},248:function(t,e,i){"use strict";var r=i(34);!function(t){function e(e){var i=t.call(this,e)||this;return i.name="AssertionError",i}Object(r.b)(e,t)}(Error)},268:function(t,e,i){"use strict";i.d(e,"b",function(){return a}),i.d(e,"a",function(){return r});var r,s=i(34),n=i(74),o=i(435);!function(t){t[t.QUICK=1]="QUICK",t[t.INTERMEDIATE=2]="INTERMEDIATE",t[t.FULL=3]="FULL"}(r||(r={}));var a=function(t){function e(){var e=t.call(this)||this;return e._rafId=0,e._animationsCounter=0,e._framesSinceIntermediateRendering=0,e._renderFrame=function(){e._rafId=0,e._updateIsRequested=!1;var t=Date.now();try{e._emit("beforeRender",t);var i=e._getQualityForCurrentFrame();e._emit("render",{time:t,qualityHint:i})}catch(r){throw r&&"object"==typeof r&&e._lastTriggerStack&&(r.additionalInfo=e._lastTriggerStack),r}e._isRunning&&e._requestFrame()},e._updateIsRequested=!1,e._isRunning=!1,e}return Object(s.b)(e,t),Object.defineProperty(e.prototype,"isActive",{get:function(){return this._isRunning},enumerable:!1,configurable:!0}),e.prototype.start=function(){this._isRunning=!0,this._requestFrame(),this._lastTriggerStack=(new Error).stack},e.prototype.stop=function(){this._isRunning&&(this._isRunning=!1,this._updateIsRequested||this._cancelFrame(),this._lastTriggerStack=void 0)},e.prototype.renderImmediately=function(t){var e=Date.now();this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=0),this._updateIsRequested=!1,this._emit("beforeRender",e),this._emit("render",{time:e,qualityHint:t})},e.prototype.update=function(){this._isRunning||(this._lastTriggerStack=(new Error).stack),this._updateIsRequested=!0,this._requestFrame()},e.prototype.destroy=function(){this._cancelFrame()},e.prototype.animate=function(t){var e=this;0===this._animationsCounter&&this.start(),this._animationsCounter++;var i=!0,r=this.on("beforeRender",function(s){i?t(s):(r.offAll(),e._animationsCounter--,0===e._animationsCounter&&e.stop())}),s=new o.b;return{complete:s.promise,get isRunning(){return i},stop:function(){i?(i=!1,s.resolve()):console.warn("Trying to stop animation twice")}}},e.prototype.animateForDuration=function(t,e){var i=-1,r=this.animate(function(s){if(i<0)i=s;else{var n=(s-i)/e;n<1?t(n):(t(1),r.stop())}});return r},e.prototype._requestFrame=function(){this._rafId||(this._rafId=requestAnimationFrame(this._renderFrame))},e.prototype._cancelFrame=function(){cancelAnimationFrame(this._rafId),this._rafId=0},e.prototype._getQualityForCurrentFrame=function(){return this._isRunning?this._framesSinceIntermediateRendering<12?(this._framesSinceIntermediateRendering++,r.QUICK):(this._framesSinceIntermediateRendering=1,r.INTERMEDIATE):(this._framesSinceIntermediateRendering=0,r.FULL)},e}(Object(n.a)().with())},2804:function(t,e){!function(t,e){for(var i in e)t[i]=e[i]}(e,function(t){var e={};function i(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return t[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(r,s,function(e){return t[e]}.bind(null,s));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=32)}([function(t,e){t.exports="varying lowp vec4 id;void main(void){gl_FragColor=id;}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec4 vertexId;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 shift;const float A=pow(2.,16.);const float B=pow(2.,-31.);const float C=1.-pow(2.,-24.);varying vec4 id;void main(){vec4 D=viewProjMatrix*vec4((A*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*B,0,1);gl_Position=vec4(D.xy/D.w,C,1.);gl_Position.xy+=vertexDisplacement*pixelSize;gl_Position.xy+=shift;id=vec4(vertexId.xy/255.,0,1);}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosition;attribute vec2 vertexUv;uniform float zIndex;\n#ifndef YV_LEAST_16b_P\n#   ifdef GL_FRAGMENT_PRECISION_HIGH\n#       define YV_LEAST_16b_P highp\n#   else\n#       define YV_LEAST_16b_P mediump\n#   endif\n#endif\nvarying YV_LEAST_16b_P vec2 uv;void main(void){gl_Position=vec4(vertexPosition,zIndex,1);uv=vertexUv;}"},function(t,e){t.exports="#version 100\nprecision mediump float;uniform sampler2D atlas;varying highp vec2 uv;varying float weight;varying float smoothness;varying lowp vec4 color;void main(void){vec4 A=color;float B=texture2D(atlas,uv).a;float C=smoothstep(weight-smoothness,weight+smoothness,B);gl_FragColor=vec4(A.rgb,A.a*C);}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexNormal;attribute vec2 vertexDisplacement;attribute vec2 vertexUv;attribute vec4 vertexIconLocation;attribute float vertexScale;attribute vec4 vertexId;attribute vec2 vertexZoomRelatedData;attribute float vertexZIndex;varying highp vec2 textureCoordinates;varying vec4 iconLocation;varying vec4 id;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform highp float worldToPxFactor;uniform float zoom;uniform float zoomScaleFactor;const float A=256.;const float B=2048.;const float C=64.;const float D=1024.;const float E=pow(2.,16.);const float F=pow(2.,-31.);void main(void){float G=vertexZoomRelatedData[0]*C;float H=vertexZoomRelatedData[1]*D;float I=pow(2.,(zoom-G)*zoomScaleFactor);vec2 J=vec2(vertexNormal.y,-vertexNormal.x);gl_Position=viewProjMatrix*vec4((E*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*F+(vertexDisplacement.x*J+vertexDisplacement.y*vertexNormal)*A*worldToPxFactor*I,0,1);gl_Position.z=gl_Position.w*vertexZIndex;\n#ifndef YV_COLOR_ID\ntextureCoordinates=vertexUv*B*vertexScale;iconLocation=vertexIconLocation;float K=pow(2.,G-zoom)*I;textureCoordinates.x+=H*K*vertexScale;\n#else\nid=vertexId;\n#endif\n}"},function(t,e){t.exports="#version 100\nattribute vec4 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexUV;attribute float vertexPriority;attribute lowp vec4 vertexColor;attribute lowp vec4 vertexOutlineColor;attribute float vertexScale;uniform float isOutlinePhase;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 atlasSize;uniform sampler2D visibility;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform float dpr;uniform bool isColorTransformed;uniform mat4 colorTransform;varying highp vec2 uv;varying float weight;varying float smoothness;varying lowp vec4 color;varying lowp vec4 id;const vec4 A=vec4(2,2,2,1);vec4 B(vec4 color,mat4 C){return C*vec4(color.rgb,1)*vec4(1,1,1,color.a);}const float D=pow(2.,16.);const float E=pow(2.,-31.);vec4 F(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 G,vec2 H,vec2 I,vec2 J){vec4 K=viewProjMatrix*vec4((D*(G-lookAtHigh)+(H-lookAtLow))*E,0,1);K=vec4(K.xy/K.w,0.,1.);return K+vec4(I*J,0.,0.);}const float L=0.5;float M(float N){return clamp(N,0.,L);}const float O=0.717;const float P=0.1;const float Q=0.12;float R(float N,bool S){return O+P*N+(S?-Q/N:0.);}const float T=0.1;const float U=0.06;float V(float N,float dpr){return(T+U/N)/dpr;}void main(void){float W=texture2D(visibility,vertexId.xy/256.+idHalfPxSize).a;if(W!=0.){gl_Position=F(viewProjMatrix,lookAtHigh,lookAtLow,vertexPosHigh,vertexPosLow,vertexDisplacement,pixelSize);\n#ifndef YV_COLOR_ID\nuv=vertexUV/atlasSize;bool S=isOutlinePhase>0.;float N=M(vertexScale);weight=R(N,S);smoothness=V(N,dpr);vec4 X=isColorTransformed?B(vertexColor,colorTransform):vertexColor;vec4 Y=vertexOutlineColor;Y.a=isColorTransformed?B(Y,colorTransform).a:Y.a;color=(isOutlinePhase*Y)+(1.-isOutlinePhase)*X;color.a*=W;\n#else\nid=vec4(vertexId.xy/255.,0,0);\n#endif\n}else{gl_Position=A;}}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexOffset;attribute vec2 vertexUV;attribute vec4 vertexId;attribute float vertexPriority;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 atlasSize;uniform sampler2D visibility;uniform vec2 idHalfPxSize;uniform vec2 extensionAndMinSize;varying vec2 uv;varying float alpha;varying vec4 id;const float A=32.;const float B=pow(2.,16.);const float C=pow(2.,-31.);const vec4 D=vec4(2,2,2,1);void main(){float E=texture2D(visibility,vertexId.xy/256.+idHalfPxSize).a;if(E!=0.){vec4 F=viewProjMatrix*vec4((B*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*C,0,1);vec2 G=vertexDisplacement/A;vec2 H=vertexOffset/A;float I=extensionAndMinSize.x;float J=extensionAndMinSize.y;vec2 K=max(vec2(J*0.5),I+abs(G))*sign(G)+H;gl_Position=vec4(F.xy/F.w+K*pixelSize,0.,1.);\n#ifndef YV_COLOR_ID\nuv=vertexUV/atlasSize;alpha=E;\n#else\nid=vec4(vertexId.xy/255.,0,0);\n#endif\n}else{gl_Position=D;}}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec4 vertexColor;attribute float vertexZIndex;attribute vec4 vertexId;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform bool isColorTransformed;uniform mat4 colorTransform;varying vec4 id;varying vec4 color;vec4 A(vec4 color,mat4 B){return B*vec4(color.rgb,1)*vec4(1,1,1,color.a);}const float C=pow(2.,16.);const float D=pow(2.,-31.);void main(void){gl_Position=viewProjMatrix*vec4((C*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*D,0,1);gl_Position.z=gl_Position.w*vertexZIndex;\n#ifndef YV_COLOR_ID\ncolor=isColorTransformed?A(vertexColor,colorTransform):vertexColor;\n#else\nid=vertexId;\n#endif\n}"},function(t,e){t.exports="#version 100\nattribute vec3 vertexPosHigh;attribute vec3 vertexPosLow;attribute float vertexHeight;attribute vec4 vertexColor;attribute vec4 vertexId;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform float zFactor;uniform bool isColorTransformed;uniform mat4 colorTransform;varying vec4 globalPosition;varying vec4 diffuseColor;varying vec4 id;const float A=pow(2.,16.);const float B=pow(2.,-31.);vec4 C(vec4 D,mat4 E){return E*vec4(D.rgb,1)*vec4(1,1,1,D.a);}void main(void){vec4 F=vec4((A*(vertexPosHigh.xy-lookAtHigh)+(vertexPosLow.xy-lookAtLow))*B,vertexHeight*zFactor,1);gl_Position=viewProjMatrix*F;\n#ifndef YV_COLOR_ID\ndiffuseColor=isColorTransformed?C(vertexColor,colorTransform):vertexColor;globalPosition=F;\n#else\nid=vertexId;\n#endif\n}"},function(t,e){t.exports="#version 100\nattribute vec4 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec3 vertexDisplacements;attribute vec2 vertexUV;attribute float vertexPriority;attribute lowp vec4 vertexColor;attribute lowp vec4 vertexOutlineColor;attribute vec2 polylineLength_vertexScale;attribute vec4 leftPolylineRatios;attribute vec4 leftPolylineAngles;attribute vec4 rightPolylineRatios;attribute vec4 rightPolylineAngles;uniform float isOutlinePhase;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 atlasSize;uniform sampler2D visibility;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform float dpr;varying highp vec2 uv;varying float weight;varying float smoothness;varying lowp vec4 color;varying lowp vec4 id;const vec4 A=vec4(2,2,2,1);const float B=pow(2.,16.);const float C=pow(2.,-31.);const float D=3.1415927410125732;const int E=4;const float F=1000000.;const float G=1./256.;vec2 H(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 pixelSize,vec2 I,vec2 J,vec2 K){vec4 L=viewProjMatrix*vec4((B*(I-lookAtHigh)+(J-lookAtLow))*C+K,0,1);vec2 M=L.xy/L.w;return M/pixelSize;}vec2 N(float O,float P,float Q){float R=P*2.*D-D;float S=O*Q;return vec2(cos(R),sin(R))*S;}float T(vec4 R,int U){if(U==0)return R[0];if(U==1)return R[1];if(U==2)return R[2];return R[3];}vec4 V(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 W,vec2 X,vec2 Y,vec2 Z,float a,float Q,vec4 leftPolylineRatios,vec4 leftPolylineAngles,vec4 rightPolylineRatios,vec4 rightPolylineAngles){vec2 L=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,vec2(0,0));vec2 b=N(rightPolylineRatios[0],rightPolylineAngles[0],Q);vec2 c=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,b);bool d=a>0.;bool e=c.x<L.x;bool f=d^^e;if(d==e){b=f?N(rightPolylineRatios[0],rightPolylineAngles[0],Q):N(leftPolylineRatios[0],leftPolylineAngles[0],Q);c=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,b);}float g=abs(a);for(int U=1;U<=E;U++){vec2 h=c-L;bool i=U==E||T(f?rightPolylineRatios:leftPolylineRatios,U)<G;float j=i?F:length(h);if(j>g){float k=a>0.?1.:-1.;vec2 l=normalize(h);vec2 m=vec2(-l.y,l.x);L+=l*g;L+=k*l*Z.x;L+=k*m*Z.y;break;}else{g-=j;L+=h;vec2 n=f?N(T(rightPolylineRatios,U),T(rightPolylineAngles,U),Q):N(T(leftPolylineRatios,U),T(leftPolylineAngles,U),Q);c=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,n);}}return vec4(L*W,0.,1.);}const float o=0.5;float p(float q){return clamp(q,0.,o);}const float r=0.717;const float s=0.1;const float t=0.12;float u(float q,bool v){return r+s*q+(v?-t/q:0.);}const float w=0.1;const float x=0.06;float y(float q,float dpr){return(w+x/q)/dpr;}void main(void){float z=texture2D(visibility,vertexId.xy/256.+idHalfPxSize).a;if(z!=0.){vec2 AA=vertexDisplacements.xy;float AB=vertexDisplacements.z;float Q=polylineLength_vertexScale[0];float AC=polylineLength_vertexScale[1];gl_Position=V(viewProjMatrix,lookAtHigh,lookAtLow,pixelSize,vertexPosHigh,vertexPosLow,AA,AB,Q,leftPolylineRatios,leftPolylineAngles,rightPolylineRatios,rightPolylineAngles);\n#ifndef YV_COLOR_ID\nuv=vertexUV/atlasSize;bool v=isOutlinePhase>0.;float q=p(AC);weight=u(q,v);smoothness=y(q,dpr);color=v?vertexOutlineColor:vertexColor;color.a*=z;\n#else\nid=vec4(vertexId.xy/255.,0,0);\n#endif\n}else{gl_Position=A;}}"},function(t,e,i){t.exports=function(){return i(31)('!function(t){var e={};function i(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return t[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(r,s,function(e){return t[e]}.bind(null,s));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=38)}([function(t,e,i){"use strict";var r="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function s(t,e){return Object.prototype.hasOwnProperty.call(t,e)}e.assign=function(t){for(var e=Array.prototype.slice.call(arguments,1);e.length;){var i=e.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var r in i)s(i,r)&&(t[r]=i[r])}}return t},e.shrinkBuf=function(t,e){return t.length===e?t:t.subarray?t.subarray(0,e):(t.length=e,t)};var n={arraySet:function(t,e,i,r,s){if(e.subarray&&t.subarray)t.set(e.subarray(i,i+r),s);else for(var n=0;n<r;n++)t[s+n]=e[i+n]},flattenChunks:function(t){var e,i,r,s,n,o;for(r=0,e=0,i=t.length;e<i;e++)r+=t[e].length;for(o=new Uint8Array(r),s=0,e=0,i=t.length;e<i;e++)n=t[e],o.set(n,s),s+=n.length;return o}},o={arraySet:function(t,e,i,r,s){for(var n=0;n<r;n++)t[s+n]=e[i+n]},flattenChunks:function(t){return[].concat.apply([],t)}};e.setTyped=function(t){t?(e.Buf8=Uint8Array,e.Buf16=Uint16Array,e.Buf32=Int32Array,e.assign(e,n)):(e.Buf8=Array,e.Buf16=Array,e.Buf32=Array,e.assign(e,o))},e.setTyped(r)},function(t,e,i){"use strict";(function(t){var r=e;function s(t,e,i){for(var r=Object.keys(e),s=0;s<r.length;++s)void 0!==t[r[s]]&&i||(t[r[s]]=e[r[s]]);return t}function n(t){function e(t,i){if(!(this instanceof e))return new e(t,i);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),i&&s(this,i)}return(e.prototype=Object.create(Error.prototype)).constructor=e,Object.defineProperty(e.prototype,"name",{get:function(){return t}}),e.prototype.toString=function(){return this.name+": "+this.message},e}r.asPromise=i(16),r.base64=i(17),r.EventEmitter=i(18),r.float=i(19),r.inquire=i(20),r.utf8=i(21),r.pool=i(22),r.LongBits=i(23),r.global="undefined"!=typeof window&&window||void 0!==t&&t||"undefined"!=typeof self&&self||this,r.emptyArray=Object.freeze?Object.freeze([]):[],r.emptyObject=Object.freeze?Object.freeze({}):{},r.isNode=Boolean(r.global.process&&r.global.process.versions&&r.global.process.versions.node),r.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},r.isString=function(t){return"string"==typeof t||t instanceof String},r.isObject=function(t){return t&&"object"==typeof t},r.isset=r.isSet=function(t,e){var i=t[e];return!(null==i||!t.hasOwnProperty(e))&&("object"!=typeof i||(Array.isArray(i)?i.length:Object.keys(i).length)>0)},r.Buffer=function(){try{var t=r.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(e){return null}}(),r._Buffer_from=null,r._Buffer_allocUnsafe=null,r.newBuffer=function(t){return"number"==typeof t?r.Buffer?r._Buffer_allocUnsafe(t):new r.Array(t):r.Buffer?r._Buffer_from(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},r.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,r.Long=r.global.dcodeIO&&r.global.dcodeIO.Long||r.global.Long||r.inquire("long"),r.key2Re=/^true|false|0|1$/,r.key32Re=/^-?(?:0|[1-9][0-9]*)$/,r.key64Re=/^(?:[\\\\x00-\\\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,r.longToHash=function(t){return t?r.LongBits.from(t).toHash():r.LongBits.zeroHash},r.longFromHash=function(t,e){var i=r.LongBits.fromHash(t);return r.Long?r.Long.fromBits(i.lo,i.hi,e):i.toNumber(Boolean(e))},r.merge=s,r.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},r.newError=n,r.ProtocolError=n("ProtocolError"),r.oneOfGetter=function(t){for(var e={},i=0;i<t.length;++i)e[t[i]]=1;return function(){for(var t=Object.keys(this),i=t.length-1;i>-1;--i)if(1===e[t[i]]&&void 0!==this[t[i]]&&null!==this[t[i]])return t[i]}},r.oneOfSetter=function(t){return function(e){for(var i=0;i<t.length;++i)t[i]!==e&&delete this[t[i]]}},r.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},r._configure=function(){var t=r.Buffer;t?(r._Buffer_from=t.from!==Uint8Array.from&&t.from||function(e,i){return new t(e,i)},r._Buffer_allocUnsafe=t.allocUnsafe||function(e){return new t(e)}):r._Buffer_from=r._Buffer_allocUnsafe=null}}).call(this,i(15))},function(t,e,i){"use strict";var r,s,n,o,a,l,h,c,d,u,f,p,_,g,y=i(13),m=y.Reader,b=y.util,x=y.roots.default||(y.roots.default={});x.yandex=((g={}).maps=((_={}).proto=((p={}).renderer=((c={}).vmap2=((r={}).Tile=function(){function t(t){if(this.presentation=[],this.layers=[],this.indoorPlanId=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.presentation=b.emptyArray,t.prototype.points=null,t.prototype.polylines=null,t.prototype.polygons=null,t.prototype.pointLabels=null,t.prototype.polylineLabels=null,t.prototype.layers=b.emptyArray,t.prototype.indoorPlanId=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Tile;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.presentation&&r.presentation.length||(r.presentation=[]),r.presentation.push(x.yandex.maps.proto.renderer.vmap2.Presentation.decode(t,t.uint32()));break;case 2:r.points=x.yandex.maps.proto.renderer.vmap2.Tile.PointObjects.decode(t,t.uint32());break;case 3:r.polylines=x.yandex.maps.proto.renderer.vmap2.Tile.PolylineObjects.decode(t,t.uint32());break;case 4:r.polygons=x.yandex.maps.proto.renderer.vmap2.Tile.PolygonObjects.decode(t,t.uint32());break;case 5:r.pointLabels=x.yandex.maps.proto.renderer.vmap2.Tile.StraightLabels.decode(t,t.uint32());break;case 6:r.polylineLabels=x.yandex.maps.proto.renderer.vmap2.Tile.CurvedLabels.decode(t,t.uint32());break;case 8:r.layers&&r.layers.length||(r.layers=[]),r.layers.push(x.yandex.maps.proto.renderer.vmap2.Tile.Layer.decode(t,t.uint32()));break;case 9:r.indoorPlanId&&r.indoorPlanId.length||(r.indoorPlanId=[]),r.indoorPlanId.push(t.string());break;default:t.skipType(7&s)}}return r},t.PointObjects=function(){function t(t){if(this.coordsx=[],this.coordsy=[],this.classId=[],this.zOrder=[],this.metadata=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.coordsx=b.emptyArray,t.prototype.coordsy=b.emptyArray,t.prototype.classId=b.emptyArray,t.prototype.zOrder=b.emptyArray,t.prototype.metadata=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Tile.PointObjects;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:if(r.coordsx&&r.coordsx.length||(r.coordsx=[]),2==(7&s))for(var n=t.uint32()+t.pos;t.pos<n;)r.coordsx.push(t.sint32());else r.coordsx.push(t.sint32());break;case 2:if(r.coordsy&&r.coordsy.length||(r.coordsy=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.coordsy.push(t.sint32());else r.coordsy.push(t.sint32());break;case 3:if(r.classId&&r.classId.length||(r.classId=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.classId.push(t.uint32());else r.classId.push(t.uint32());break;case 4:if(r.zOrder&&r.zOrder.length||(r.zOrder=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.zOrder.push(t.sint32());else r.zOrder.push(t.sint32());break;case 5:r.metadata&&r.metadata.length||(r.metadata=[]),r.metadata.push(x.yandex.maps.proto.renderer.common.FeatureMetadata.decode(t,t.uint32()));break;default:t.skipType(7&s)}}return r},t}(),t.PolylineObjects=function(){function t(t){if(this.coordsx=[],this.coordsy=[],this.lineSize=[],this.distance=[],this.classId=[],this.pointVisibility=[],this.zOrderBegin=[],this.zOrderEnd=[],this.metadata=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.coordsx=b.emptyArray,t.prototype.coordsy=b.emptyArray,t.prototype.lineSize=b.emptyArray,t.prototype.distance=b.emptyArray,t.prototype.classId=b.emptyArray,t.prototype.pointVisibility=b.emptyArray,t.prototype.zOrderBegin=b.emptyArray,t.prototype.zOrderEnd=b.emptyArray,t.prototype.metadata=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Tile.PolylineObjects;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:if(r.coordsx&&r.coordsx.length||(r.coordsx=[]),2==(7&s))for(var n=t.uint32()+t.pos;t.pos<n;)r.coordsx.push(t.sint32());else r.coordsx.push(t.sint32());break;case 2:if(r.coordsy&&r.coordsy.length||(r.coordsy=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.coordsy.push(t.sint32());else r.coordsy.push(t.sint32());break;case 3:if(r.lineSize&&r.lineSize.length||(r.lineSize=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.lineSize.push(t.uint32());else r.lineSize.push(t.uint32());break;case 4:if(r.distance&&r.distance.length||(r.distance=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.distance.push(t.uint64());else r.distance.push(t.uint64());break;case 5:if(r.classId&&r.classId.length||(r.classId=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.classId.push(t.uint32());else r.classId.push(t.uint32());break;case 6:if(r.pointVisibility&&r.pointVisibility.length||(r.pointVisibility=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.pointVisibility.push(t.uint32());else r.pointVisibility.push(t.uint32());break;case 7:if(r.zOrderBegin&&r.zOrderBegin.length||(r.zOrderBegin=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.zOrderBegin.push(t.sint32());else r.zOrderBegin.push(t.sint32());break;case 8:if(r.zOrderEnd&&r.zOrderEnd.length||(r.zOrderEnd=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.zOrderEnd.push(t.sint32());else r.zOrderEnd.push(t.sint32());break;case 9:r.metadata&&r.metadata.length||(r.metadata=[]),r.metadata.push(x.yandex.maps.proto.renderer.common.FeatureMetadata.decode(t,t.uint32()));break;default:t.skipType(7&s)}}return r},t}(),t.PolygonObjects=function(){function t(t){if(this.coordsx=[],this.coordsy=[],this.classId=[],this.ringCount=[],this.ringSize=[],this.contourIndex=[],this.contourCount=[],this.pointVisibility=[],this.height=[],this.zOrder=[],this.mesh=[],this.metadata=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.coordsx=b.emptyArray,t.prototype.coordsy=b.emptyArray,t.prototype.classId=b.emptyArray,t.prototype.ringCount=b.emptyArray,t.prototype.ringSize=b.emptyArray,t.prototype.contourIndex=b.emptyArray,t.prototype.contourCount=b.emptyArray,t.prototype.pointVisibility=b.emptyArray,t.prototype.height=b.emptyArray,t.prototype.zOrder=b.emptyArray,t.prototype.mesh=b.emptyArray,t.prototype.metadata=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Tile.PolygonObjects;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:if(r.coordsx&&r.coordsx.length||(r.coordsx=[]),2==(7&s))for(var n=t.uint32()+t.pos;t.pos<n;)r.coordsx.push(t.sint32());else r.coordsx.push(t.sint32());break;case 2:if(r.coordsy&&r.coordsy.length||(r.coordsy=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.coordsy.push(t.sint32());else r.coordsy.push(t.sint32());break;case 3:if(r.classId&&r.classId.length||(r.classId=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.classId.push(t.uint32());else r.classId.push(t.uint32());break;case 4:if(r.ringCount&&r.ringCount.length||(r.ringCount=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.ringCount.push(t.uint32());else r.ringCount.push(t.uint32());break;case 5:if(r.ringSize&&r.ringSize.length||(r.ringSize=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.ringSize.push(t.uint32());else r.ringSize.push(t.uint32());break;case 6:if(r.contourIndex&&r.contourIndex.length||(r.contourIndex=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.contourIndex.push(t.sint32());else r.contourIndex.push(t.sint32());break;case 7:if(r.contourCount&&r.contourCount.length||(r.contourCount=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.contourCount.push(t.sint32());else r.contourCount.push(t.sint32());break;case 8:if(r.pointVisibility&&r.pointVisibility.length||(r.pointVisibility=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.pointVisibility.push(t.uint32());else r.pointVisibility.push(t.uint32());break;case 9:if(r.height&&r.height.length||(r.height=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.height.push(t.sint32());else r.height.push(t.sint32());break;case 10:if(r.zOrder&&r.zOrder.length||(r.zOrder=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.zOrder.push(t.sint32());else r.zOrder.push(t.sint32());break;case 11:r.mesh&&r.mesh.length||(r.mesh=[]),r.mesh.push(x.yandex.maps.proto.renderer.vmap2.Tile.PolygonObjects.Mesh.decode(t,t.uint32()));break;case 12:r.metadata&&r.metadata.length||(r.metadata=[]),r.metadata.push(x.yandex.maps.proto.renderer.common.FeatureMetadata.decode(t,t.uint32()));break;default:t.skipType(7&s)}}return r},t.BBox=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.minX=0,t.prototype.minY=0,t.prototype.maxX=0,t.prototype.maxY=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Tile.PolygonObjects.BBox;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.minX=t.sint32();break;case 2:r.minY=t.sint32();break;case 3:r.maxX=t.sint32();break;case 4:r.maxY=t.sint32();break;default:t.skipType(7&s)}}return r},t}(),t.Mesh=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.polygonId=0,t.prototype.meshId="",t.prototype.bbox=null,t.prototype.objectId="",t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Tile.PolygonObjects.Mesh;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.polygonId=t.uint32();break;case 2:r.meshId=t.string();break;case 3:r.bbox=x.yandex.maps.proto.renderer.vmap2.Tile.PolygonObjects.BBox.decode(t,t.uint32());break;case 4:r.objectId=t.string();break;default:t.skipType(7&s)}}return r},t}(),t}(),t.ShapedString=function(){function t(t){if(this.glyphs=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.glyphs=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Tile.ShapedString;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:if(r.glyphs&&r.glyphs.length||(r.glyphs=[]),2==(7&s))for(var n=t.uint32()+t.pos;t.pos<n;)r.glyphs.push(t.uint32());else r.glyphs.push(t.uint32());break;default:t.skipType(7&s)}}return r},t}(),t.ShapedText=function(){function t(t){if(this.strings=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.strings=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Tile.ShapedText;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.strings&&r.strings.length||(r.strings=[]),r.strings.push(x.yandex.maps.proto.renderer.vmap2.Tile.ShapedString.decode(t,t.uint32()));break;default:t.skipType(7&s)}}return r},t}(),t.StraightLabels=function(){function t(t){if(this.classId=[],this.centerX=[],this.centerY=[],this.offsetX=[],this.offsetY=[],this.text=[],this.textAlt=[],this.priority=[],this.align=[],this.metadata=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}var e,i;return t.prototype.classId=b.emptyArray,t.prototype.centerX=b.emptyArray,t.prototype.centerY=b.emptyArray,t.prototype.offsetX=b.emptyArray,t.prototype.offsetY=b.emptyArray,t.prototype.text=b.emptyArray,t.prototype.textAlt=b.emptyArray,t.prototype.priority=b.emptyArray,t.prototype.align=b.emptyArray,t.prototype.metadata=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Tile.StraightLabels;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:if(r.classId&&r.classId.length||(r.classId=[]),2==(7&s))for(var n=t.uint32()+t.pos;t.pos<n;)r.classId.push(t.uint32());else r.classId.push(t.uint32());break;case 2:if(r.centerX&&r.centerX.length||(r.centerX=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.centerX.push(t.sint32());else r.centerX.push(t.sint32());break;case 3:if(r.centerY&&r.centerY.length||(r.centerY=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.centerY.push(t.sint32());else r.centerY.push(t.sint32());break;case 4:if(r.offsetX&&r.offsetX.length||(r.offsetX=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.offsetX.push(t.sint32());else r.offsetX.push(t.sint32());break;case 5:if(r.offsetY&&r.offsetY.length||(r.offsetY=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.offsetY.push(t.sint32());else r.offsetY.push(t.sint32());break;case 6:r.text&&r.text.length||(r.text=[]),r.text.push(x.yandex.maps.proto.renderer.vmap2.Tile.ShapedText.decode(t,t.uint32()));break;case 7:r.textAlt&&r.textAlt.length||(r.textAlt=[]),r.textAlt.push(x.yandex.maps.proto.renderer.vmap2.Tile.ShapedText.decode(t,t.uint32()));break;case 8:if(r.priority&&r.priority.length||(r.priority=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.priority.push(t.sint32());else r.priority.push(t.sint32());break;case 9:if(r.align&&r.align.length||(r.align=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.align.push(t.int32());else r.align.push(t.int32());break;case 10:r.metadata&&r.metadata.length||(r.metadata=[]),r.metadata.push(x.yandex.maps.proto.renderer.common.FeatureMetadata.decode(t,t.uint32()));break;default:t.skipType(7&s)}}return r},t.AlignType=(e={},(i=Object.create(e))[e[0]="Left"]=0,i[e[1]="Center"]=1,i[e[2]="Right"]=2,i),t}(),t.CurvedLabels=function(){function t(t){if(this.classId=[],this.text=[],this.textAlt=[],this.priority=[],this.verticesCount=[],this.vertexX=[],this.vertexY=[],this.metadata=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.classId=b.emptyArray,t.prototype.text=b.emptyArray,t.prototype.textAlt=b.emptyArray,t.prototype.priority=b.emptyArray,t.prototype.verticesCount=b.emptyArray,t.prototype.vertexX=b.emptyArray,t.prototype.vertexY=b.emptyArray,t.prototype.metadata=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Tile.CurvedLabels;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:if(r.classId&&r.classId.length||(r.classId=[]),2==(7&s))for(var n=t.uint32()+t.pos;t.pos<n;)r.classId.push(t.uint32());else r.classId.push(t.uint32());break;case 2:r.text&&r.text.length||(r.text=[]),r.text.push(x.yandex.maps.proto.renderer.vmap2.Tile.ShapedString.decode(t,t.uint32()));break;case 3:r.textAlt&&r.textAlt.length||(r.textAlt=[]),r.textAlt.push(x.yandex.maps.proto.renderer.vmap2.Tile.ShapedString.decode(t,t.uint32()));break;case 4:if(r.priority&&r.priority.length||(r.priority=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.priority.push(t.sint32());else r.priority.push(t.sint32());break;case 5:if(r.verticesCount&&r.verticesCount.length||(r.verticesCount=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.verticesCount.push(t.uint32());else r.verticesCount.push(t.uint32());break;case 6:if(r.vertexX&&r.vertexX.length||(r.vertexX=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.vertexX.push(t.sint32());else r.vertexX.push(t.sint32());break;case 7:if(r.vertexY&&r.vertexY.length||(r.vertexY=[]),2==(7&s))for(n=t.uint32()+t.pos;t.pos<n;)r.vertexY.push(t.sint32());else r.vertexY.push(t.sint32());break;case 8:r.metadata&&r.metadata.length||(r.metadata=[]),r.metadata.push(x.yandex.maps.proto.renderer.common.FeatureMetadata.decode(t,t.uint32()));break;default:t.skipType(7&s)}}return r},t}(),t.Layer=function(){function t(t){if(this.ids=[],this.objectIndices=[],this.keys=[],this.values=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.name="",t.prototype.ids=b.emptyArray,t.prototype.objectIndices=b.emptyArray,t.prototype.keys=b.emptyArray,t.prototype.values=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Tile.Layer;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.name=t.string();break;case 2:r.ids&&r.ids.length||(r.ids=[]),r.ids.push(t.string());break;case 3:if(r.objectIndices&&r.objectIndices.length||(r.objectIndices=[]),2==(7&s))for(var n=t.uint32()+t.pos;t.pos<n;)r.objectIndices.push(t.uint32());else r.objectIndices.push(t.uint32());break;case 4:r.keys&&r.keys.length||(r.keys=[]),r.keys.push(t.string());break;case 5:r.values&&r.values.length||(r.values=[]),r.values.push(t.string());break;default:t.skipType(7&s)}}return r},t}(),t}(),r.Presentation=function(){function t(t){if(this.classes=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.classes=b.emptyArray,t.prototype.name="",t.prototype.params=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.classes&&r.classes.length||(r.classes=[]),r.classes.push(x.yandex.maps.proto.renderer.vmap2.Presentation.Class.decode(t,t.uint32()));break;case 2:r.name=t.string();break;case 3:r.params=x.yandex.maps.proto.renderer.vmap2.Presentation.Parameters.decode(t,t.uint32());break;default:t.skipType(7&s)}}return r},t.Class=function(){function t(t){if(this.slices=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.id=0,t.prototype.name="",t.prototype.slices=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.id=t.uint32();break;case 2:r.name=t.string();break;case 3:r.slices&&r.slices.length||(r.slices=[]),r.slices.push(x.yandex.maps.proto.renderer.vmap2.Presentation.Class.ZoomSlice.decode(t,t.uint32()));break;default:t.skipType(7&s)}}return r},t.ZoomRange=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.min=0,t.prototype.max=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class.ZoomRange;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.min=t.sint32();break;case 2:r.max=t.sint32();break;default:t.skipType(7&s)}}return r},t}(),t.Image=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.id="",t.prototype.width=0,t.prototype.scale=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class.Image;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.id=t.string();break;case 2:r.width=t.float();break;case 3:r.scale=t.float();break;default:t.skipType(7&s)}}return r},t}(),t.PointStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.icon=null,t.prototype.anchorX=0,t.prototype.anchorY=0,t.prototype.selectedIcon=null,t.prototype.selectedAnchorX=0,t.prototype.selectedAnchorY=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class.PointStyle;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.icon=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.Image.decode(t,t.uint32());break;case 2:r.anchorX=t.float();break;case 3:r.anchorY=t.float();break;case 4:r.selectedIcon=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.Image.decode(t,t.uint32());break;case 5:r.selectedAnchorX=t.float();break;case 6:r.selectedAnchorY=t.float();break;default:t.skipType(7&s)}}return r},t}(),t.DashItem=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.fill=0,t.prototype.gap=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class.DashItem;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.fill=t.float();break;case 2:r.gap=t.float();break;default:t.skipType(7&s)}}return r},t}(),t.DashStyle=function(){function t(t){if(this.dashes=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.dashes=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class.DashStyle;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.dashes&&r.dashes.length||(r.dashes=[]),r.dashes.push(x.yandex.maps.proto.renderer.vmap2.Presentation.Class.DashItem.decode(t,t.uint32()));break;default:t.skipType(7&s)}}return r},t}(),t.LineStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}var e,i;return t.prototype.color=0,t.prototype.width=0,t.prototype.caps=0,t.prototype.joins=1,t.prototype.dash=null,t.prototype.pattern=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class.LineStyle;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.color=t.fixed32();break;case 2:r.width=t.float();break;case 3:r.caps=t.int32();break;case 4:r.joins=t.int32();break;case 5:r.dash=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.DashStyle.decode(t,t.uint32());break;case 6:r.pattern=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.Image.decode(t,t.uint32());break;default:t.skipType(7&s)}}return r},t.CapStyle=(e={},(i=Object.create(e))[e[0]="CapRound"]=0,i[e[1]="CapButt"]=1,i[e[2]="CapSquare"]=2,i),t.JoinStyle=function(){var t={},e=Object.create(t);return e[t[0]="JoinMiter"]=0,e[t[1]="JoinRound"]=1,e[t[2]="JoinBevel"]=2,e}(),t}(),t.PolylineStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.line=null,t.prototype.outline=null,t.prototype.equidistantOffset=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class.PolylineStyle;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.line=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.LineStyle.decode(t,t.uint32());break;case 2:r.outline=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.LineStyle.decode(t,t.uint32());break;case 3:r.equidistantOffset=t.float();break;default:t.skipType(7&s)}}return r},t}(),t.PolygonStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.pattern=null,t.prototype.color=0,t.prototype.extrusion=null,t.prototype.contour=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class.PolygonStyle;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.pattern=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.Image.decode(t,t.uint32());break;case 2:r.color=t.fixed32();break;case 3:r.extrusion=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.PolygonStyle.Extrusion.decode(t,t.uint32());break;case 4:r.contour=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.LineStyle.decode(t,t.uint32());break;default:t.skipType(7&s)}}return r},t.Extrusion=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.enabled=!1,t.prototype.height=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class.PolygonStyle.Extrusion;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.enabled=t.bool();break;case 3:r.height=t.float();break;default:t.skipType(7&s)}}return r},t}(),t}(),t.TextStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.color=0,t.prototype.fontId="",t.prototype.fontSize=0,t.prototype.outlineColor=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class.TextStyle;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.color=t.fixed32();break;case 2:r.fontId=t.string();break;case 3:r.fontSize=t.float();break;case 4:r.outlineColor=t.fixed32();break;default:t.skipType(7&s)}}return r},t}(),t.LabelStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.text=null,t.prototype.textAlt=null,t.prototype.hdistance=0,t.prototype.vdistance=0,t.prototype.background=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class.LabelStyle;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.text=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.TextStyle.decode(t,t.uint32());break;case 2:r.textAlt=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.TextStyle.decode(t,t.uint32());break;case 3:r.hdistance=t.float();break;case 4:r.vdistance=t.float();break;case 5:r.background=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.LabelBackgroundStyle.decode(t,t.uint32());break;default:t.skipType(7&s)}}return r},t}(),t.LabelBackgroundStyle=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.hPadding=0,t.prototype.vPadding=0,t.prototype.color=0,t.prototype.outline=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class.LabelBackgroundStyle;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.hPadding=t.float();break;case 2:r.vPadding=t.float();break;case 3:r.color=t.fixed32();break;case 4:r.outline=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.LineStyle.decode(t,t.uint32());break;default:t.skipType(7&s)}}return r},t}(),t.ZoomSlice=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.zIndex=0,t.prototype.visibility=null,t.prototype.line=null,t.prototype.poly=null,t.prototype.point=null,t.prototype.label=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Class.ZoomSlice;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.zIndex=t.sint32();break;case 2:r.visibility=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.ZoomRange.decode(t,t.uint32());break;case 3:r.line=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.PolylineStyle.decode(t,t.uint32());break;case 4:r.poly=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.PolygonStyle.decode(t,t.uint32());break;case 5:r.point=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.PointStyle.decode(t,t.uint32());break;case 6:r.label=x.yandex.maps.proto.renderer.vmap2.Presentation.Class.LabelStyle.decode(t,t.uint32());break;default:t.skipType(7&s)}}return r},t}(),t}(),t.Parameters=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.extrusion=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Parameters;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.extrusion=x.yandex.maps.proto.renderer.vmap2.Presentation.Parameters.Extrusion.decode(t,t.uint32());break;default:t.skipType(7&s)}}return r},t.Extrusion=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.adjustMeshHeightK=0,t.prototype.adjustMeshHeightPow=0,t.prototype.adjustBoxHeightK=0,t.prototype.adjustBoxHeightPow=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.vmap2.Presentation.Parameters.Extrusion;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.adjustMeshHeightK=t.float();break;case 2:r.adjustMeshHeightPow=t.float();break;case 3:r.adjustBoxHeightK=t.float();break;case 4:r.adjustBoxHeightPow=t.float();break;default:t.skipType(7&s)}}return r},t}(),t}(),t}(),r),c.common=((s={}).FeatureMetadata=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype[".yandex.maps.proto.renderer.common.TAG_METADATA_DEPRECATED"]=null,t.prototype[".yandex.maps.proto.renderer.common.TAG_METADATA"]=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.common.FeatureMetadata;t.pos<i;){var s=t.uint32();switch(s>>>3){case 10:r[".yandex.maps.proto.renderer.common.TAG_METADATA_DEPRECATED"]=x.yandex.maps.proto.renderer.common.TagMetadata.decode(t,t.uint32());break;case 12:r[".yandex.maps.proto.renderer.common.TAG_METADATA"]=x.yandex.maps.proto.renderer.common.TagMetadata.decode(t,t.uint32());break;default:t.skipType(7&s)}}return r},t}(),s.TagMetadata=function(){function t(t){if(this.tags=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.tags=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.common.TagMetadata;t.pos<i;){var s=t.uint32();switch(s>>>3){case 10:if(r.tags&&r.tags.length||(r.tags=[]),2==(7&s))for(var n=t.uint32()+t.pos;t.pos<n;)r.tags.push(t.uint32());else r.tags.push(t.uint32());break;default:t.skipType(7&s)}}return r},t}(),s),c.layers=((l={}).basemap=((a={}).Tag=(n={},(o=Object.create(n))[n[0]="ROAD"]=0,o[n[1]="ROAD_1"]=1,o[n[2]="ROAD_2"]=2,o[n[3]="ROAD_3"]=3,o[n[4]="ROAD_4"]=4,o[n[5]="ROAD_5"]=5,o[n[6]="ROAD_6"]=6,o[n[7]="ROAD_7"]=7,o[n[8]="ROAD_LIMITED"]=8,o[n[9]="ROAD_UNCLASSIFIED"]=9,o[n[10]="ROAD_MINOR"]=10,o[n[11]="ROAD_CONSTRUCTION"]=11,o[n[12]="PATH"]=12,o[n[13]="CROSSWALK"]=13,o[n[34]="IS_TUNNEL"]=34,o[n[33]="TRAFFIC_LIGHT"]=33,o[n[14]="WATER"]=14,o[n[15]="LANDSCAPE"]=15,o[n[42]="NATIONAL_PARK"]=42,o[n[35]="LAND"]=35,o[n[16]="LANDCOVER"]=16,o[n[17]="VEGETATION"]=17,o[n[18]="URBAN_AREA"]=18,o[n[19]="RESIDENTIAL"]=19,o[n[43]="INDUSTRIAL"]=43,o[n[44]="CEMETERY"]=44,o[n[21]="PARK"]=21,o[n[45]="SPORTS_GROUND"]=45,o[n[46]="CONSTRUCTION_SITE"]=46,o[n[47]="MEDICAL"]=47,o[n[48]="BEACH"]=48,o[n[20]="POI"]=20,o[n[22]="ADMIN"]=22,o[n[23]="COUNTRY"]=23,o[n[24]="REGION"]=24,o[n[25]="LOCALITY"]=25,o[n[26]="DISTRICT"]=26,o[n[27]="ADDRESS"]=27,o[n[28]="TRANSPORT"]=28,o.TRANSIT=28,o[n[36]="TRANSIT_LOCATION"]=36,o[n[37]="TRANSIT_STOP"]=37,o[n[38]="TRANSIT_ENTRANCE"]=38,o[n[39]="IS_UNCLASSIFIED_TRANSIT"]=39,o[n[40]="TRANSIT_LINE"]=40,o[n[41]="TRANSIT_SCHEMA"]=41,o[n[29]="STRUCTURE"]=29,o[n[30]="BUILDING"]=30,o[n[31]="ENTRANCE"]=31,o[n[32]="FENCE"]=32,o[n[49]="MAJOR_LANDMARK"]=49,o[n[50]="OUTDOOR"]=50,o[n[51]="SHOPPING"]=51,o[n[52]="COMMERCIAL_SERVICES"]=52,o[n[53]="FOOD_AND_DRINK"]=53,o),a),l),c.glyphs=((h={}).Glyph=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.id=0,t.prototype.bitmap=b.newBuffer([]),t.prototype.width=0,t.prototype.height=0,t.prototype.bearingX=0,t.prototype.bearingY=0,t.prototype.advance=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.glyphs.Glyph;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.id=t.uint32();break;case 2:r.bitmap=t.bytes();break;case 3:r.width=t.uint32();break;case 4:r.height=t.uint32();break;case 5:r.bearingX=t.sint32();break;case 6:r.bearingY=t.sint32();break;case 7:r.advance=t.uint32();break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("id"))throw b.ProtocolError("missing required \'id\'",{instance:r});if(!r.hasOwnProperty("bitmap"))throw b.ProtocolError("missing required \'bitmap\'",{instance:r});if(!r.hasOwnProperty("width"))throw b.ProtocolError("missing required \'width\'",{instance:r});if(!r.hasOwnProperty("height"))throw b.ProtocolError("missing required \'height\'",{instance:r});if(!r.hasOwnProperty("bearingX"))throw b.ProtocolError("missing required \'bearingX\'",{instance:r});if(!r.hasOwnProperty("bearingY"))throw b.ProtocolError("missing required \'bearingY\'",{instance:r});if(!r.hasOwnProperty("advance"))throw b.ProtocolError("missing required \'advance\'",{instance:r});return r},t}(),h.FontDescription=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.fontId="",t.prototype.xheight=0,t.prototype.margin=3,t.prototype.height=0,t.prototype.ascender=0,t.prototype.descender=0,t.prototype.capHeight=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.glyphs.FontDescription;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.fontId=t.string();break;case 2:r.xheight=t.uint32();break;case 3:r.margin=t.sint32();break;case 4:r.height=t.uint32();break;case 5:r.ascender=t.uint32();break;case 6:r.descender=t.int32();break;case 7:r.capHeight=t.uint32();break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("fontId"))throw b.ProtocolError("missing required \'fontId\'",{instance:r});if(!r.hasOwnProperty("xheight"))throw b.ProtocolError("missing required \'xheight\'",{instance:r});if(!r.hasOwnProperty("margin"))throw b.ProtocolError("missing required \'margin\'",{instance:r});return r},t}(),h.GlyphList=function(){function t(t){if(this.glyphs=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.font=null,t.prototype.glyphs=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.renderer.glyphs.GlyphList;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.font=x.yandex.maps.proto.renderer.glyphs.FontDescription.decode(t,t.uint32());break;case 2:r.glyphs&&r.glyphs.length||(r.glyphs=[]),r.glyphs.push(x.yandex.maps.proto.renderer.glyphs.Glyph.decode(t,t.uint32()));break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("font"))throw b.ProtocolError("missing required \'font\'",{instance:r});return r},t}(),h),c),p.indoor=((d={}).Level=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.id="",t.prototype.name="",t.prototype.isUnderground=!1,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.indoor.Level;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.id=t.string();break;case 2:r.name=t.string();break;case 3:r.isUnderground=t.bool();break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("id"))throw b.ProtocolError("missing required \'id\'",{instance:r});if(!r.hasOwnProperty("name"))throw b.ProtocolError("missing required \'name\'",{instance:r});return r},t}(),d.Plan=function(){function t(t){if(this.levels=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.levels=b.emptyArray,t.prototype.defaultLevelId="0",t.prototype.boundary=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.indoor.Plan;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.levels&&r.levels.length||(r.levels=[]),r.levels.push(x.yandex.maps.proto.indoor.Level.decode(t,t.uint32()));break;case 2:r.defaultLevelId=t.string();break;case 3:r.boundary=x.yandex.maps.proto.common2.geometry.BoundingBox.decode(t,t.uint32());break;default:t.skipType(7&s)}}return r},t}(),d),p.common2=((f={}).geometry=((u={}).Point=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.lon=0,t.prototype.lat=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.common2.geometry.Point;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.lon=t.double();break;case 2:r.lat=t.double();break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("lon"))throw b.ProtocolError("missing required \'lon\'",{instance:r});if(!r.hasOwnProperty("lat"))throw b.ProtocolError("missing required \'lat\'",{instance:r});return r},t}(),u.CoordSequence=function(){function t(t){if(this.deltas=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.first=0,t.prototype.deltas=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.common2.geometry.CoordSequence;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.first=t.sint32();break;case 2:if(r.deltas&&r.deltas.length||(r.deltas=[]),2==(7&s))for(var n=t.uint32()+t.pos;t.pos<n;)r.deltas.push(t.sint32());else r.deltas.push(t.sint32());break;default:t.skipType(7&s)}}return r},t}(),u.Polyline=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.lons=null,t.prototype.lats=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.common2.geometry.Polyline;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.lons=x.yandex.maps.proto.common2.geometry.CoordSequence.decode(t,t.uint32());break;case 2:r.lats=x.yandex.maps.proto.common2.geometry.CoordSequence.decode(t,t.uint32());break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("lons"))throw b.ProtocolError("missing required \'lons\'",{instance:r});if(!r.hasOwnProperty("lats"))throw b.ProtocolError("missing required \'lats\'",{instance:r});return r},t}(),u.PolylinePosition=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.segmentIndex=0,t.prototype.segmentPosition=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.common2.geometry.PolylinePosition;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.segmentIndex=t.uint32();break;case 2:r.segmentPosition=t.double();break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("segmentIndex"))throw b.ProtocolError("missing required \'segmentIndex\'",{instance:r});if(!r.hasOwnProperty("segmentPosition"))throw b.ProtocolError("missing required \'segmentPosition\'",{instance:r});return r},t}(),u.Subpolyline=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.begin=null,t.prototype.end=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.common2.geometry.Subpolyline;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.begin=x.yandex.maps.proto.common2.geometry.PolylinePosition.decode(t,t.uint32());break;case 2:r.end=x.yandex.maps.proto.common2.geometry.PolylinePosition.decode(t,t.uint32());break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("begin"))throw b.ProtocolError("missing required \'begin\'",{instance:r});if(!r.hasOwnProperty("end"))throw b.ProtocolError("missing required \'end\'",{instance:r});return r},t}(),u.LinearRing=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.lons=null,t.prototype.lats=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.common2.geometry.LinearRing;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.lons=x.yandex.maps.proto.common2.geometry.CoordSequence.decode(t,t.uint32());break;case 2:r.lats=x.yandex.maps.proto.common2.geometry.CoordSequence.decode(t,t.uint32());break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("lons"))throw b.ProtocolError("missing required \'lons\'",{instance:r});if(!r.hasOwnProperty("lats"))throw b.ProtocolError("missing required \'lats\'",{instance:r});return r},t}(),u.Polygon=function(){function t(t){if(this.innerRings=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.outerRing=null,t.prototype.innerRings=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.common2.geometry.Polygon;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.outerRing=x.yandex.maps.proto.common2.geometry.LinearRing.decode(t,t.uint32());break;case 2:r.innerRings&&r.innerRings.length||(r.innerRings=[]),r.innerRings.push(x.yandex.maps.proto.common2.geometry.LinearRing.decode(t,t.uint32()));break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("outerRing"))throw b.ProtocolError("missing required \'outerRing\'",{instance:r});return r},t}(),u.MultiPolygon=function(){function t(t){if(this.polygons=[],t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.polygons=b.emptyArray,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.common2.geometry.MultiPolygon;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.polygons&&r.polygons.length||(r.polygons=[]),r.polygons.push(x.yandex.maps.proto.common2.geometry.Polygon.decode(t,t.uint32()));break;default:t.skipType(7&s)}}return r},t}(),u.Geometry=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.point=null,t.prototype.polyline=null,t.prototype.polygon=null,t.prototype.multipolygon=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.common2.geometry.Geometry;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.point=x.yandex.maps.proto.common2.geometry.Point.decode(t,t.uint32());break;case 2:r.polyline=x.yandex.maps.proto.common2.geometry.Polyline.decode(t,t.uint32());break;case 3:r.polygon=x.yandex.maps.proto.common2.geometry.Polygon.decode(t,t.uint32());break;case 4:r.multipolygon=x.yandex.maps.proto.common2.geometry.MultiPolygon.decode(t,t.uint32());break;default:t.skipType(7&s)}}return r},t}(),u.BoundingBox=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.lowerCorner=null,t.prototype.upperCorner=null,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.common2.geometry.BoundingBox;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.lowerCorner=x.yandex.maps.proto.common2.geometry.Point.decode(t,t.uint32());break;case 2:r.upperCorner=x.yandex.maps.proto.common2.geometry.Point.decode(t,t.uint32());break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("lowerCorner"))throw b.ProtocolError("missing required \'lowerCorner\'",{instance:r});if(!r.hasOwnProperty("upperCorner"))throw b.ProtocolError("missing required \'upperCorner\'",{instance:r});return r},t}(),u.Direction=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.azimuth=0,t.prototype.tilt=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.common2.geometry.Direction;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.azimuth=t.double();break;case 2:r.tilt=t.double();break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("azimuth"))throw b.ProtocolError("missing required \'azimuth\'",{instance:r});if(!r.hasOwnProperty("tilt"))throw b.ProtocolError("missing required \'tilt\'",{instance:r});return r},t}(),u.Span=function(){function t(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)null!=t[e[i]]&&(this[e[i]]=t[e[i]])}return t.prototype.horizontalAngle=0,t.prototype.verticalAngle=0,t.decode=function(t,e){t instanceof m||(t=m.create(t));for(var i=void 0===e?t.len:t.pos+e,r=new x.yandex.maps.proto.common2.geometry.Span;t.pos<i;){var s=t.uint32();switch(s>>>3){case 1:r.horizontalAngle=t.double();break;case 2:r.verticalAngle=t.double();break;default:t.skipType(7&s)}}if(!r.hasOwnProperty("horizontalAngle"))throw b.ProtocolError("missing required \'horizontalAngle\'",{instance:r});if(!r.hasOwnProperty("verticalAngle"))throw b.ProtocolError("missing required \'verticalAngle\'",{instance:r});return r},t}(),u),f),p),_),g),t.exports=x},function(t,e,i){"use strict";var r={};(0,i(0).assign)(r,i(30),i(33),i(11)),t.exports=r},function(t,e,i){"use strict";t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},function(t,e,i){"use strict";t.exports=d;var r,s=i(1),n=s.LongBits,o=s.base64,a=s.utf8;function l(t,e,i){this.fn=t,this.len=e,this.next=void 0,this.val=i}function h(){}function c(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}function d(){this.len=0,this.head=new l(h,0,0),this.tail=this.head,this.states=null}function u(t,e,i){e[i]=255&t}function f(t,e){this.len=t,this.next=void 0,this.val=e}function p(t,e,i){for(;t.hi;)e[i++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;t.lo>127;)e[i++]=127&t.lo|128,t.lo=t.lo>>>7;e[i++]=t.lo}function _(t,e,i){e[i]=255&t,e[i+1]=t>>>8&255,e[i+2]=t>>>16&255,e[i+3]=t>>>24}d.create=s.Buffer?function(){return(d.create=function(){return new r})()}:function(){return new d},d.alloc=function(t){return new s.Array(t)},s.Array!==Array&&(d.alloc=s.pool(d.alloc,s.Array.prototype.subarray)),d.prototype._push=function(t,e,i){return this.tail=this.tail.next=new l(t,e,i),this.len+=e,this},f.prototype=Object.create(l.prototype),f.prototype.fn=function(t,e,i){for(;t>127;)e[i++]=127&t|128,t>>>=7;e[i]=t},d.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new f((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},d.prototype.int32=function(t){return t<0?this._push(p,10,n.fromNumber(t)):this.uint32(t)},d.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},d.prototype.uint64=function(t){var e=n.from(t);return this._push(p,e.length(),e)},d.prototype.int64=d.prototype.uint64,d.prototype.sint64=function(t){var e=n.from(t).zzEncode();return this._push(p,e.length(),e)},d.prototype.bool=function(t){return this._push(u,1,t?1:0)},d.prototype.fixed32=function(t){return this._push(_,4,t>>>0)},d.prototype.sfixed32=d.prototype.fixed32,d.prototype.fixed64=function(t){var e=n.from(t);return this._push(_,4,e.lo)._push(_,4,e.hi)},d.prototype.sfixed64=d.prototype.fixed64,d.prototype.float=function(t){return this._push(s.float.writeFloatLE,4,t)},d.prototype.double=function(t){return this._push(s.float.writeDoubleLE,8,t)};var g=s.Array.prototype.set?function(t,e,i){e.set(t,i)}:function(t,e,i){for(var r=0;r<t.length;++r)e[i+r]=t[r]};d.prototype.bytes=function(t){var e=t.length>>>0;if(!e)return this._push(u,1,0);if(s.isString(t)){var i=d.alloc(e=o.length(t));o.decode(t,i,0),t=i}return this.uint32(e)._push(g,e,t)},d.prototype.string=function(t){var e=a.length(t);return e?this.uint32(e)._push(a.write,e,t):this._push(u,1,0)},d.prototype.fork=function(){return this.states=new c(this),this.head=this.tail=new l(h,0,0),this.len=0,this},d.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new l(h,0,0),this.len=0),this},d.prototype.ldelim=function(){var t=this.head,e=this.tail,i=this.len;return this.reset().uint32(i),i&&(this.tail.next=t.next,this.tail=e,this.len+=i),this},d.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),i=0;t;)t.fn(t.val,e,i),i+=t.len,t=t.next;return e},d._configure=function(t){r=t}},function(t,e,i){"use strict";t.exports=l;var r,s=i(1),n=s.LongBits,o=s.utf8;function a(t,e){return RangeError("index out of range: "+t.pos+" + "+(e||1)+" > "+t.len)}function l(t){this.buf=t,this.pos=0,this.len=t.length}var h,c="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new l(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new l(t);throw Error("illegal buffer")};function d(){var t=new n(0,0),e=0;if(!(this.len-this.pos>4)){for(;e<3;++e){if(this.pos>=this.len)throw a(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*e)>>>0,t}for(;e<4;++e)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(e=0,this.len-this.pos>4){for(;e<5;++e)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw a(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function u(t,e){return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0}function f(){if(this.pos+8>this.len)throw a(this,8);return new n(u(this.buf,this.pos+=4),u(this.buf,this.pos+=4))}l.create=s.Buffer?function(t){return(l.create=function(t){return s.Buffer.isBuffer(t)?new r(t):c(t)})(t)}:c,l.prototype._slice=s.Array.prototype.subarray||s.Array.prototype.slice,l.prototype.uint32=(h=4294967295,function(){if(h=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return h;if(h=(h|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return h;if((this.pos+=5)>this.len)throw this.pos=this.len,a(this,10);return h}),l.prototype.int32=function(){return 0|this.uint32()},l.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},l.prototype.bool=function(){return 0!==this.uint32()},l.prototype.fixed32=function(){if(this.pos+4>this.len)throw a(this,4);return u(this.buf,this.pos+=4)},l.prototype.sfixed32=function(){if(this.pos+4>this.len)throw a(this,4);return 0|u(this.buf,this.pos+=4)},l.prototype.float=function(){if(this.pos+4>this.len)throw a(this,4);var t=s.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},l.prototype.double=function(){if(this.pos+8>this.len)throw a(this,4);var t=s.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},l.prototype.bytes=function(){var t=this.uint32(),e=this.pos,i=this.pos+t;if(i>this.len)throw a(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,i):e===i?new this.buf.constructor(0):this._slice.call(this.buf,e,i)},l.prototype.string=function(){var t=this.bytes();return o.read(t,0,t.length)},l.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw a(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw a(this)}while(128&this.buf[this.pos++]);return this},l.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(t=7&this.uint32());)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},l._configure=function(t){r=t;var e=s.Long?"toLong":"toNumber";s.merge(l.prototype,{int64:function(){return d.call(this)[e](!1)},uint64:function(){return d.call(this)[e](!0)},sint64:function(){return d.call(this).zzDecode()[e](!1)},fixed64:function(){return f.call(this)[e](!0)},sfixed64:function(){return f.call(this)[e](!1)}})}},function(t,e,i){"use strict";t.exports=function(t,e,i,r){for(var s=65535&t|0,n=t>>>16&65535|0,o=0;0!==i;){i-=o=i>2e3?2e3:i;do{n=n+(s=s+e[r++]|0)|0}while(--o);s%=65521,n%=65521}return s|n<<16|0}},function(t,e,i){"use strict";var r=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var r=0;r<8;r++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e}();t.exports=function(t,e,i,s){var n=r,o=s+i;t^=-1;for(var a=s;a<o;a++)t=t>>>8^n[255&(t^e[a])];return-1^t}},function(t,e,i){"use strict";var r=i(0),s=!0,n=!0;try{String.fromCharCode.apply(null,[0])}catch(h){s=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(h){n=!1}for(var o=new r.Buf8(256),a=0;a<256;a++)o[a]=a>=252?6:a>=248?5:a>=240?4:a>=224?3:a>=192?2:1;function l(t,e){if(e<65534&&(t.subarray&&n||!t.subarray&&s))return String.fromCharCode.apply(null,r.shrinkBuf(t,e));for(var i="",o=0;o<e;o++)i+=String.fromCharCode(t[o]);return i}o[254]=o[254]=1,e.string2buf=function(t){var e,i,s,n,o,a=t.length,l=0;for(n=0;n<a;n++)55296==(64512&(i=t.charCodeAt(n)))&&n+1<a&&56320==(64512&(s=t.charCodeAt(n+1)))&&(i=65536+(i-55296<<10)+(s-56320),n++),l+=i<128?1:i<2048?2:i<65536?3:4;for(e=new r.Buf8(l),o=0,n=0;o<l;n++)55296==(64512&(i=t.charCodeAt(n)))&&n+1<a&&56320==(64512&(s=t.charCodeAt(n+1)))&&(i=65536+(i-55296<<10)+(s-56320),n++),i<128?e[o++]=i:i<2048?(e[o++]=192|i>>>6,e[o++]=128|63&i):i<65536?(e[o++]=224|i>>>12,e[o++]=128|i>>>6&63,e[o++]=128|63&i):(e[o++]=240|i>>>18,e[o++]=128|i>>>12&63,e[o++]=128|i>>>6&63,e[o++]=128|63&i);return e},e.buf2binstring=function(t){return l(t,t.length)},e.binstring2buf=function(t){for(var e=new r.Buf8(t.length),i=0,s=e.length;i<s;i++)e[i]=t.charCodeAt(i);return e},e.buf2string=function(t,e){var i,r,s,n,a=e||t.length,h=new Array(2*a);for(r=0,i=0;i<a;)if((s=t[i++])<128)h[r++]=s;else if((n=o[s])>4)h[r++]=65533,i+=n-1;else{for(s&=2===n?31:3===n?15:7;n>1&&i<a;)s=s<<6|63&t[i++],n--;n>1?h[r++]=65533:s<65536?h[r++]=s:(s-=65536,h[r++]=55296|s>>10&1023,h[r++]=56320|1023&s)}return l(h,r)},e.utf8border=function(t,e){var i;for((e=e||t.length)>t.length&&(e=t.length),i=e-1;i>=0&&128==(192&t[i]);)i--;return i<0||0===i?e:i+o[t[i]]>e?i:e}},function(t,e,i){"use strict";t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},function(t,e,i){"use strict";t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},function(t,e,i){"use strict";function r(t,e,i){i=i||2;var r,a,l,h,c,f,_,g=e&&e.length,y=g?e[0]*i:t.length,m=s(t,0,y,i,!0),b=[];if(!m)return b;if(g&&(m=function(t,e,i,r){var o,a,l,h,c,f=[];for(o=0,a=e.length;o<a;o++)l=e[o]*r,h=o<a-1?e[o+1]*r:t.length,(c=s(t,l,h,r,!1))===c.next&&(c.steiner=!0),f.push(p(c));for(f.sort(d),o=0;o<f.length;o++)u(f[o],i),i=n(i,i.next);return i}(t,e,m,i)),t.length>80*i){r=l=t[0],a=h=t[1];for(var x=i;x<y;x+=i)(c=t[x])<r&&(r=c),(f=t[x+1])<a&&(a=f),c>l&&(l=c),f>h&&(h=f);_=0!==(_=Math.max(l-r,h-a))?1/_:0}return o(m,b,i,r,a,_),b}function s(t,e,i,r,s){var n,o;if(s===T(t,e,i,r)>0)for(n=e;n<i;n+=r)o=v(n,t[n],t[n+1],o);else for(n=i-r;n>=e;n-=r)o=v(n,t[n],t[n+1],o);return o&&m(o,o.next)&&(k(o),o=o.next),o}function n(t,e){if(!t)return t;e||(e=t);var i,r=t;do{if(i=!1,r.steiner||!m(r,r.next)&&0!==y(r.prev,r,r.next))r=r.next;else{if(k(r),(r=e=r.prev)===r.next)break;i=!0}}while(i||r!==e);return e}function o(t,e,i,r,s,d,u){if(t){!u&&d&&function(t,e,i,r){var s=t;do{null===s.z&&(s.z=f(s.x,s.y,e,i,r)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==t);s.prevZ.nextZ=null,s.prevZ=null,function(t){var e,i,r,s,n,o,a,l,h=1;do{for(i=t,t=null,n=null,o=0;i;){for(o++,r=i,a=0,e=0;e<h&&(a++,r=r.nextZ);e++);for(l=h;a>0||l>0&&r;)0!==a&&(0===l||!r||i.z<=r.z)?(s=i,i=i.nextZ,a--):(s=r,r=r.nextZ,l--),n?n.nextZ=s:t=s,s.prevZ=n,n=s;i=r}n.nextZ=null,h*=2}while(o>1)}(s)}(t,r,s,d);for(var p,_,g=t;t.prev!==t.next;)if(p=t.prev,_=t.next,d?l(t,r,s,d):a(t))e.push(p.i/i),e.push(t.i/i),e.push(_.i/i),k(t),t=_.next,g=_.next;else if((t=_)===g){u?1===u?o(t=h(t,e,i),e,i,r,s,d,2):2===u&&c(t,e,i,r,s,d):o(n(t),e,i,r,s,d,1);break}}}function a(t){var e=t.prev,i=t,r=t.next;if(y(e,i,r)>=0)return!1;for(var s=t.next.next;s!==t.prev;){if(_(e.x,e.y,i.x,i.y,r.x,r.y,s.x,s.y)&&y(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function l(t,e,i,r){var s=t.prev,n=t,o=t.next;if(y(s,n,o)>=0)return!1;for(var a=s.x<n.x?s.x<o.x?s.x:o.x:n.x<o.x?n.x:o.x,l=s.y<n.y?s.y<o.y?s.y:o.y:n.y<o.y?n.y:o.y,h=s.x>n.x?s.x>o.x?s.x:o.x:n.x>o.x?n.x:o.x,c=s.y>n.y?s.y>o.y?s.y:o.y:n.y>o.y?n.y:o.y,d=f(a,l,e,i,r),u=f(h,c,e,i,r),p=t.prevZ,g=t.nextZ;p&&p.z>=d&&g&&g.z<=u;){if(p!==t.prev&&p!==t.next&&_(s.x,s.y,n.x,n.y,o.x,o.y,p.x,p.y)&&y(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,g!==t.prev&&g!==t.next&&_(s.x,s.y,n.x,n.y,o.x,o.y,g.x,g.y)&&y(g.prev,g,g.next)>=0)return!1;g=g.nextZ}for(;p&&p.z>=d;){if(p!==t.prev&&p!==t.next&&_(s.x,s.y,n.x,n.y,o.x,o.y,p.x,p.y)&&y(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;g&&g.z<=u;){if(g!==t.prev&&g!==t.next&&_(s.x,s.y,n.x,n.y,o.x,o.y,g.x,g.y)&&y(g.prev,g,g.next)>=0)return!1;g=g.nextZ}return!0}function h(t,e,i){var r=t;do{var s=r.prev,n=r.next.next;!m(s,n)&&b(s,r,r.next,n)&&x(s,n)&&x(n,s)&&(e.push(s.i/i),e.push(r.i/i),e.push(n.i/i),k(r),k(r.next),r=t=n),r=r.next}while(r!==t);return r}function c(t,e,i,r,s,a){var l=t;do{for(var h=l.next.next;h!==l.prev;){if(l.i!==h.i&&g(l,h)){var c=w(l,h);return l=n(l,l.next),c=n(c,c.next),o(l,e,i,r,s,a),void o(c,e,i,r,s,a)}h=h.next}l=l.next}while(l!==t)}function d(t,e){return t.x-e.x}function u(t,e){if(e=function(t,e){var i,r=e,s=t.x,n=t.y,o=-1/0;do{if(n<=r.y&&n>=r.next.y&&r.next.y!==r.y){var a=r.x+(n-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=s&&a>o){if(o=a,a===s){if(n===r.y)return r;if(n===r.next.y)return r.next}i=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!i)return null;if(s===o)return i.prev;var l,h=i,c=i.x,d=i.y,u=1/0;r=i.next;for(;r!==h;)s>=r.x&&r.x>=c&&s!==r.x&&_(n<d?s:o,n,c,d,n<d?o:s,n,r.x,r.y)&&((l=Math.abs(n-r.y)/(s-r.x))<u||l===u&&r.x>i.x)&&x(r,t)&&(i=r,u=l),r=r.next;return i}(t,e)){var i=w(e,t);n(i,i.next)}}function f(t,e,i,r,s){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*s)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*s)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function p(t){var e=t,i=t;do{e.x<i.x&&(i=e),e=e.next}while(e!==t);return i}function _(t,e,i,r,s,n,o,a){return(s-o)*(e-a)-(t-o)*(n-a)>=0&&(t-o)*(r-a)-(i-o)*(e-a)>=0&&(i-o)*(n-a)-(s-o)*(r-a)>=0}function g(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&b(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&x(t,e)&&x(e,t)&&function(t,e){var i=t,r=!1,s=(t.x+e.x)/2,n=(t.y+e.y)/2;do{i.y>n!=i.next.y>n&&i.next.y!==i.y&&s<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==t);return r}(t,e)}function y(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function m(t,e){return t.x===e.x&&t.y===e.y}function b(t,e,i,r){return!!(m(t,e)&&m(i,r)||m(t,r)&&m(i,e))||y(t,e,i)>0!=y(t,e,r)>0&&y(i,r,t)>0!=y(i,r,e)>0}function x(t,e){return y(t.prev,t,t.next)<0?y(t,e,t.next)>=0&&y(t,t.prev,e)>=0:y(t,e,t.prev)<0||y(t,t.next,e)<0}function w(t,e){var i=new A(t.i,t.x,t.y),r=new A(e.i,e.x,e.y),s=t.next,n=e.prev;return t.next=e,e.prev=t,i.next=s,s.prev=i,r.next=i,i.prev=r,n.next=r,r.prev=n,r}function v(t,e,i,r){var s=new A(t,e,i);return r?(s.next=r.next,s.prev=r,r.next.prev=s,r.next=s):(s.prev=s,s.next=s),s}function k(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function A(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function T(t,e,i,r){for(var s=0,n=e,o=i-r;n<i;n+=r)s+=(t[o]-t[n])*(t[n+1]+t[o+1]),o=n;return s}t.exports=r,t.exports.default=r,r.deviation=function(t,e,i,r){var s=e&&e.length,n=s?e[0]*i:t.length,o=Math.abs(T(t,0,n,i));if(s)for(var a=0,l=e.length;a<l;a++){var h=e[a]*i,c=a<l-1?e[a+1]*i:t.length;o-=Math.abs(T(t,h,c,i))}var d=0;for(a=0;a<r.length;a+=3){var u=r[a]*i,f=r[a+1]*i,p=r[a+2]*i;d+=Math.abs((t[u]-t[p])*(t[f+1]-t[u+1])-(t[u]-t[f])*(t[p+1]-t[u+1]))}return 0===o&&0===d?0:Math.abs((d-o)/o)},r.flatten=function(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},r=0,s=0;s<t.length;s++){for(var n=0;n<t[s].length;n++)for(var o=0;o<e;o++)i.vertices.push(t[s][n][o]);s>0&&(r+=t[s-1].length,i.holes.push(r))}return i}},function(t,e,i){"use strict";t.exports=i(14)},function(t,e,i){"use strict";var r=e;function s(){r.Reader._configure(r.BufferReader),r.util._configure()}r.build="minimal",r.Writer=i(5),r.BufferWriter=i(24),r.Reader=i(6),r.BufferReader=i(25),r.util=i(1),r.rpc=i(26),r.roots=i(28),r.configure=s,r.Writer._configure(r.BufferWriter),s()},function(t,e){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(r){"object"==typeof window&&(i=window)}t.exports=i},function(t,e,i){"use strict";t.exports=function(t,e){var i=new Array(arguments.length-1),r=0,s=2,n=!0;for(;s<arguments.length;)i[r++]=arguments[s++];return new Promise((function(s,o){i[r]=function(t){if(n)if(n=!1,t)o(t);else{for(var e=new Array(arguments.length-1),i=0;i<e.length;)e[i++]=arguments[i];s.apply(null,e)}};try{t.apply(e||null,i)}catch(a){n&&(n=!1,o(a))}}))}},function(t,e,i){"use strict";var r=e;r.length=function(t){var e=t.length;if(!e)return 0;for(var i=0;--e%4>1&&"="===t.charAt(e);)++i;return Math.ceil(3*t.length)/4-i};for(var s=new Array(64),n=new Array(123),o=0;o<64;)n[s[o]=o<26?o+65:o<52?o+71:o<62?o-4:o-59|43]=o++;r.encode=function(t,e,i){for(var r,n=null,o=[],a=0,l=0;e<i;){var h=t[e++];switch(l){case 0:o[a++]=s[h>>2],r=(3&h)<<4,l=1;break;case 1:o[a++]=s[r|h>>4],r=(15&h)<<2,l=2;break;case 2:o[a++]=s[r|h>>6],o[a++]=s[63&h],l=0}a>8191&&((n||(n=[])).push(String.fromCharCode.apply(String,o)),a=0)}return l&&(o[a++]=s[r],o[a++]=61,1===l&&(o[a++]=61)),n?(a&&n.push(String.fromCharCode.apply(String,o.slice(0,a))),n.join("")):String.fromCharCode.apply(String,o.slice(0,a))};r.decode=function(t,e,i){for(var r,s=i,o=0,a=0;a<t.length;){var l=t.charCodeAt(a++);if(61===l&&o>1)break;if(void 0===(l=n[l]))throw Error("invalid encoding");switch(o){case 0:r=l,o=1;break;case 1:e[i++]=r<<2|(48&l)>>4,r=l,o=2;break;case 2:e[i++]=(15&r)<<4|(60&l)>>2,r=l,o=3;break;case 3:e[i++]=(3&r)<<6|l,o=0}}if(1===o)throw Error("invalid encoding");return i-s},r.test=function(t){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(t)}},function(t,e,i){"use strict";function r(){this._listeners={}}t.exports=r,r.prototype.on=function(t,e,i){return(this._listeners[t]||(this._listeners[t]=[])).push({fn:e,ctx:i||this}),this},r.prototype.off=function(t,e){if(void 0===t)this._listeners={};else if(void 0===e)this._listeners[t]=[];else for(var i=this._listeners[t],r=0;r<i.length;)i[r].fn===e?i.splice(r,1):++r;return this},r.prototype.emit=function(t){var e=this._listeners[t];if(e){for(var i=[],r=1;r<arguments.length;)i.push(arguments[r++]);for(r=0;r<e.length;)e[r].fn.apply(e[r++].ctx,i)}return this}},function(t,e,i){"use strict";function r(t){return"undefined"!=typeof Float32Array?function(){var e=new Float32Array([-0]),i=new Uint8Array(e.buffer),r=128===i[3];function s(t,r,s){e[0]=t,r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3]}function n(t,r,s){e[0]=t,r[s]=i[3],r[s+1]=i[2],r[s+2]=i[1],r[s+3]=i[0]}function o(t,r){return i[0]=t[r],i[1]=t[r+1],i[2]=t[r+2],i[3]=t[r+3],e[0]}function a(t,r){return i[3]=t[r],i[2]=t[r+1],i[1]=t[r+2],i[0]=t[r+3],e[0]}t.writeFloatLE=r?s:n,t.writeFloatBE=r?n:s,t.readFloatLE=r?o:a,t.readFloatBE=r?a:o}():function(){function e(t,e,i,r){var s=e<0?1:0;if(s&&(e=-e),0===e)t(1/e>0?0:2147483648,i,r);else if(isNaN(e))t(2143289344,i,r);else if(e>34028234663852886e22)t((s<<31|2139095040)>>>0,i,r);else if(e<11754943508222875e-54)t((s<<31|Math.round(e/1401298464324817e-60))>>>0,i,r);else{var n=Math.floor(Math.log(e)/Math.LN2);t((s<<31|n+127<<23|8388607&Math.round(e*Math.pow(2,-n)*8388608))>>>0,i,r)}}function i(t,e,i){var r=t(e,i),s=2*(r>>31)+1,n=r>>>23&255,o=8388607&r;return 255===n?o?NaN:s*(1/0):0===n?1401298464324817e-60*s*o:s*Math.pow(2,n-150)*(o+8388608)}t.writeFloatLE=e.bind(null,s),t.writeFloatBE=e.bind(null,n),t.readFloatLE=i.bind(null,o),t.readFloatBE=i.bind(null,a)}(),"undefined"!=typeof Float64Array?function(){var e=new Float64Array([-0]),i=new Uint8Array(e.buffer),r=128===i[7];function s(t,r,s){e[0]=t,r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3],r[s+4]=i[4],r[s+5]=i[5],r[s+6]=i[6],r[s+7]=i[7]}function n(t,r,s){e[0]=t,r[s]=i[7],r[s+1]=i[6],r[s+2]=i[5],r[s+3]=i[4],r[s+4]=i[3],r[s+5]=i[2],r[s+6]=i[1],r[s+7]=i[0]}function o(t,r){return i[0]=t[r],i[1]=t[r+1],i[2]=t[r+2],i[3]=t[r+3],i[4]=t[r+4],i[5]=t[r+5],i[6]=t[r+6],i[7]=t[r+7],e[0]}function a(t,r){return i[7]=t[r],i[6]=t[r+1],i[5]=t[r+2],i[4]=t[r+3],i[3]=t[r+4],i[2]=t[r+5],i[1]=t[r+6],i[0]=t[r+7],e[0]}t.writeDoubleLE=r?s:n,t.writeDoubleBE=r?n:s,t.readDoubleLE=r?o:a,t.readDoubleBE=r?a:o}():function(){function e(t,e,i,r,s,n){var o=r<0?1:0;if(o&&(r=-r),0===r)t(0,s,n+e),t(1/r>0?0:2147483648,s,n+i);else if(isNaN(r))t(0,s,n+e),t(2146959360,s,n+i);else if(r>17976931348623157e292)t(0,s,n+e),t((o<<31|2146435072)>>>0,s,n+i);else{var a;if(r<22250738585072014e-324)t((a=r/5e-324)>>>0,s,n+e),t((o<<31|a/4294967296)>>>0,s,n+i);else{var l=Math.floor(Math.log(r)/Math.LN2);1024===l&&(l=1023),t(4503599627370496*(a=r*Math.pow(2,-l))>>>0,s,n+e),t((o<<31|l+1023<<20|1048576*a&1048575)>>>0,s,n+i)}}}function i(t,e,i,r,s){var n=t(r,s+e),o=t(r,s+i),a=2*(o>>31)+1,l=o>>>20&2047,h=4294967296*(1048575&o)+n;return 2047===l?h?NaN:a*(1/0):0===l?5e-324*a*h:a*Math.pow(2,l-1075)*(h+4503599627370496)}t.writeDoubleLE=e.bind(null,s,0,4),t.writeDoubleBE=e.bind(null,n,4,0),t.readDoubleLE=i.bind(null,o,0,4),t.readDoubleBE=i.bind(null,a,4,0)}(),t}function s(t,e,i){e[i]=255&t,e[i+1]=t>>>8&255,e[i+2]=t>>>16&255,e[i+3]=t>>>24}function n(t,e,i){e[i]=t>>>24,e[i+1]=t>>>16&255,e[i+2]=t>>>8&255,e[i+3]=255&t}function o(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24)>>>0}function a(t,e){return(t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3])>>>0}t.exports=r(r)},function(module,exports,__webpack_require__){"use strict";function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}module.exports=inquire},function(t,e,i){"use strict";var r=e;r.length=function(t){for(var e=0,i=0,r=0;r<t.length;++r)(i=t.charCodeAt(r))<128?e+=1:i<2048?e+=2:55296==(64512&i)&&56320==(64512&t.charCodeAt(r+1))?(++r,e+=4):e+=3;return e},r.read=function(t,e,i){if(i-e<1)return"";for(var r,s=null,n=[],o=0;e<i;)(r=t[e++])<128?n[o++]=r:r>191&&r<224?n[o++]=(31&r)<<6|63&t[e++]:r>239&&r<365?(r=((7&r)<<18|(63&t[e++])<<12|(63&t[e++])<<6|63&t[e++])-65536,n[o++]=55296+(r>>10),n[o++]=56320+(1023&r)):n[o++]=(15&r)<<12|(63&t[e++])<<6|63&t[e++],o>8191&&((s||(s=[])).push(String.fromCharCode.apply(String,n)),o=0);return s?(o&&s.push(String.fromCharCode.apply(String,n.slice(0,o))),s.join("")):String.fromCharCode.apply(String,n.slice(0,o))},r.write=function(t,e,i){for(var r,s,n=i,o=0;o<t.length;++o)(r=t.charCodeAt(o))<128?e[i++]=r:r<2048?(e[i++]=r>>6|192,e[i++]=63&r|128):55296==(64512&r)&&56320==(64512&(s=t.charCodeAt(o+1)))?(r=65536+((1023&r)<<10)+(1023&s),++o,e[i++]=r>>18|240,e[i++]=r>>12&63|128,e[i++]=r>>6&63|128,e[i++]=63&r|128):(e[i++]=r>>12|224,e[i++]=r>>6&63|128,e[i++]=63&r|128);return i-n}},function(t,e,i){"use strict";t.exports=function(t,e,i){var r=i||8192,s=r>>>1,n=null,o=r;return function(i){if(i<1||i>s)return t(i);o+i>r&&(n=t(r),o=0);var a=e.call(n,o,o+=i);return 7&o&&(o=1+(7|o)),a}}},function(t,e,i){"use strict";t.exports=s;var r=i(1);function s(t,e){this.lo=t>>>0,this.hi=e>>>0}var n=s.zero=new s(0,0);n.toNumber=function(){return 0},n.zzEncode=n.zzDecode=function(){return this},n.length=function(){return 1};var o=s.zeroHash="\\0\\0\\0\\0\\0\\0\\0\\0";s.fromNumber=function(t){if(0===t)return n;var e=t<0;e&&(t=-t);var i=t>>>0,r=(t-i)/4294967296>>>0;return e&&(r=~r>>>0,i=~i>>>0,++i>4294967295&&(i=0,++r>4294967295&&(r=0))),new s(i,r)},s.from=function(t){if("number"==typeof t)return s.fromNumber(t);if(r.isString(t)){if(!r.Long)return s.fromNumber(parseInt(t,10));t=r.Long.fromString(t)}return t.low||t.high?new s(t.low>>>0,t.high>>>0):n},s.prototype.toNumber=function(t){if(!t&&this.hi>>>31){var e=1+~this.lo>>>0,i=~this.hi>>>0;return e||(i=i+1>>>0),-(e+4294967296*i)}return this.lo+4294967296*this.hi},s.prototype.toLong=function(t){return r.Long?new r.Long(0|this.lo,0|this.hi,Boolean(t)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(t)}};var a=String.prototype.charCodeAt;s.fromHash=function(t){return t===o?n:new s((a.call(t,0)|a.call(t,1)<<8|a.call(t,2)<<16|a.call(t,3)<<24)>>>0,(a.call(t,4)|a.call(t,5)<<8|a.call(t,6)<<16|a.call(t,7)<<24)>>>0)},s.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},s.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},s.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},s.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,i=this.hi>>>24;return 0===i?0===e?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:i<128?9:10}},function(t,e,i){"use strict";t.exports=o;var r=i(5);(o.prototype=Object.create(r.prototype)).constructor=o;var s=i(1),n=s.Buffer;function o(){r.call(this)}o.alloc=function(t){return(o.alloc=s._Buffer_allocUnsafe)(t)};var a=n&&n.prototype instanceof Uint8Array&&"set"===n.prototype.set.name?function(t,e,i){e.set(t,i)}:function(t,e,i){if(t.copy)t.copy(e,i,0,t.length);else for(var r=0;r<t.length;)e[i++]=t[r++]};function l(t,e,i){t.length<40?s.utf8.write(t,e,i):e.utf8Write(t,i)}o.prototype.bytes=function(t){s.isString(t)&&(t=s._Buffer_from(t,"base64"));var e=t.length>>>0;return this.uint32(e),e&&this._push(a,e,t),this},o.prototype.string=function(t){var e=n.byteLength(t);return this.uint32(e),e&&this._push(l,e,t),this}},function(t,e,i){"use strict";t.exports=n;var r=i(6);(n.prototype=Object.create(r.prototype)).constructor=n;var s=i(1);function n(t){r.call(this,t)}s.Buffer&&(n.prototype._slice=s.Buffer.prototype.slice),n.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len))}},function(t,e,i){"use strict";e.Service=i(27)},function(t,e,i){"use strict";t.exports=s;var r=i(1);function s(t,e,i){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");r.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(i)}(s.prototype=Object.create(r.EventEmitter.prototype)).constructor=s,s.prototype.rpcCall=function t(e,i,s,n,o){if(!n)throw TypeError("request must be specified");var a=this;if(!o)return r.asPromise(t,a,e,i,s,n);if(a.rpcImpl)try{return a.rpcImpl(e,i[a.requestDelimited?"encodeDelimited":"encode"](n).finish(),(function(t,i){if(t)return a.emit("error",t,e),o(t);if(null!==i){if(!(i instanceof s))try{i=s[a.responseDelimited?"decodeDelimited":"decode"](i)}catch(t){return a.emit("error",t,e),o(t)}return a.emit("data",i,e),o(null,i)}a.end(!0)}))}catch(l){return a.emit("error",l,e),void setTimeout((function(){o(l)}),0)}else setTimeout((function(){o(Error("already ended"))}),0)},s.prototype.end=function(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},function(t,e,i){"use strict";t.exports={}},function(t,e,i){"use strict";!function(t){if(t.TextEncoder&&t.TextDecoder)return!1;function e(t="utf-8"){if("utf-8"!==t)throw new RangeError(`Failed to construct \'TextEncoder\': The encoding label provided (\'${t}\') is invalid.`)}function i(t="utf-8",e={fatal:!1}){if("utf-8"!==t)throw new RangeError(`Failed to construct \'TextDecoder\': The encoding label provided (\'${t}\') is invalid.`);if(e.fatal)throw new Error("Failed to construct \'TextDecoder\': the \'fatal\' option is unsupported.")}Object.defineProperty(e.prototype,"encoding",{value:"utf-8"}),e.prototype.encode=function(t,e={stream:!1}){if(e.stream)throw new Error("Failed to encode: the \'stream\' option is unsupported.");let i=0;const r=t.length;let s=0,n=Math.max(32,r+(r>>1)+7),o=new Uint8Array(n>>3<<3);for(;i<r;){let e=t.charCodeAt(i++);if(e>=55296&&e<=56319){if(i<r){const r=t.charCodeAt(i);56320==(64512&r)&&(++i,e=((1023&e)<<10)+(1023&r)+65536)}if(e>=55296&&e<=56319)continue}if(s+4>o.length){n+=8,n*=1+i/t.length*2,n=n>>3<<3;const e=new Uint8Array(n);e.set(o),o=e}if(0!=(4294967168&e)){if(0==(4294965248&e))o[s++]=e>>6&31|192;else if(0==(4294901760&e))o[s++]=e>>12&15|224,o[s++]=e>>6&63|128;else{if(0!=(4292870144&e))continue;o[s++]=e>>18&7|240,o[s++]=e>>12&63|128,o[s++]=e>>6&63|128}o[s++]=63&e|128}else o[s++]=e}return o.slice(0,s)},Object.defineProperty(i.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(i.prototype,"fatal",{value:!1}),Object.defineProperty(i.prototype,"ignoreBOM",{value:!1}),i.prototype.decode=function(t,e={stream:!1}){if(e.stream)throw new Error("Failed to decode: the \'stream\' option is unsupported.");const i=new Uint8Array(t);let r=0;const s=i.length,n=[];for(;r<s;){const t=i[r++];if(0===t)break;if(0==(128&t))n.push(t);else if(192==(224&t)){const e=63&i[r++];n.push((31&t)<<6|e)}else if(224==(240&t)){const e=63&i[r++],s=63&i[r++];n.push((31&t)<<12|e<<6|s)}else if(240==(248&t)){let e=(7&t)<<18|(63&i[r++])<<12|(63&i[r++])<<6|63&i[r++];e>65535&&(e-=65536,n.push(e>>>10&1023|55296),e=56320|1023&e),n.push(e)}}return String.fromCharCode.apply(null,n)},t.TextEncoder=e,t.TextDecoder=i}("undefined"!=typeof window?window:"undefined"!=typeof self?self:this)},function(t,e,i){"use strict";var r=i(31),s=i(0),n=i(9),o=i(4),a=i(10),l=Object.prototype.toString;function h(t){if(!(this instanceof h))return new h(t);this.options=s.assign({level:-1,method:8,chunkSize:16384,windowBits:15,memLevel:8,strategy:0,to:""},t||{});var e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new a,this.strm.avail_out=0;var i=r.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(0!==i)throw new Error(o[i]);if(e.header&&r.deflateSetHeader(this.strm,e.header),e.dictionary){var c;if(c="string"==typeof e.dictionary?n.string2buf(e.dictionary):"[object ArrayBuffer]"===l.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,0!==(i=r.deflateSetDictionary(this.strm,c)))throw new Error(o[i]);this._dict_set=!0}}function c(t,e){var i=new h(e);if(i.push(t,!0),i.err)throw i.msg||o[i.err];return i.result}h.prototype.push=function(t,e){var i,o,a=this.strm,h=this.options.chunkSize;if(this.ended)return!1;o=e===~~e?e:!0===e?4:0,"string"==typeof t?a.input=n.string2buf(t):"[object ArrayBuffer]"===l.call(t)?a.input=new Uint8Array(t):a.input=t,a.next_in=0,a.avail_in=a.input.length;do{if(0===a.avail_out&&(a.output=new s.Buf8(h),a.next_out=0,a.avail_out=h),1!==(i=r.deflate(a,o))&&0!==i)return this.onEnd(i),this.ended=!0,!1;0!==a.avail_out&&(0!==a.avail_in||4!==o&&2!==o)||("string"===this.options.to?this.onData(n.buf2binstring(s.shrinkBuf(a.output,a.next_out))):this.onData(s.shrinkBuf(a.output,a.next_out)))}while((a.avail_in>0||0===a.avail_out)&&1!==i);return 4===o?(i=r.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,0===i):2!==o||(this.onEnd(0),a.avail_out=0,!0)},h.prototype.onData=function(t){this.chunks.push(t)},h.prototype.onEnd=function(t){0===t&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},e.Deflate=h,e.deflate=c,e.deflateRaw=function(t,e){return(e=e||{}).raw=!0,c(t,e)},e.gzip=function(t,e){return(e=e||{}).gzip=!0,c(t,e)}},function(t,e,i){"use strict";var r,s=i(0),n=i(32),o=i(7),a=i(8),l=i(4);function h(t,e){return t.msg=l[e],e}function c(t){return(t<<1)-(t>4?9:0)}function d(t){for(var e=t.length;--e>=0;)t[e]=0}function u(t){var e=t.state,i=e.pending;i>t.avail_out&&(i=t.avail_out),0!==i&&(s.arraySet(t.output,e.pending_buf,e.pending_out,i,t.next_out),t.next_out+=i,e.pending_out+=i,t.total_out+=i,t.avail_out-=i,e.pending-=i,0===e.pending&&(e.pending_out=0))}function f(t,e){n._tr_flush_block(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,u(t.strm)}function p(t,e){t.pending_buf[t.pending++]=e}function _(t,e){t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e}function g(t,e){var i,r,s=t.max_chain_length,n=t.strstart,o=t.prev_length,a=t.nice_match,l=t.strstart>t.w_size-262?t.strstart-(t.w_size-262):0,h=t.window,c=t.w_mask,d=t.prev,u=t.strstart+258,f=h[n+o-1],p=h[n+o];t.prev_length>=t.good_match&&(s>>=2),a>t.lookahead&&(a=t.lookahead);do{if(h[(i=e)+o]===p&&h[i+o-1]===f&&h[i]===h[n]&&h[++i]===h[n+1]){n+=2,i++;do{}while(h[++n]===h[++i]&&h[++n]===h[++i]&&h[++n]===h[++i]&&h[++n]===h[++i]&&h[++n]===h[++i]&&h[++n]===h[++i]&&h[++n]===h[++i]&&h[++n]===h[++i]&&n<u);if(r=258-(u-n),n=u-258,r>o){if(t.match_start=e,o=r,r>=a)break;f=h[n+o-1],p=h[n+o]}}}while((e=d[e&c])>l&&0!=--s);return o<=t.lookahead?o:t.lookahead}function y(t){var e,i,r,n,l,h,c,d,u,f,p=t.w_size;do{if(n=t.window_size-t.lookahead-t.strstart,t.strstart>=p+(p-262)){s.arraySet(t.window,t.window,p,p,0),t.match_start-=p,t.strstart-=p,t.block_start-=p,e=i=t.hash_size;do{r=t.head[--e],t.head[e]=r>=p?r-p:0}while(--i);e=i=p;do{r=t.prev[--e],t.prev[e]=r>=p?r-p:0}while(--i);n+=p}if(0===t.strm.avail_in)break;if(h=t.strm,c=t.window,d=t.strstart+t.lookahead,u=n,f=void 0,(f=h.avail_in)>u&&(f=u),i=0===f?0:(h.avail_in-=f,s.arraySet(c,h.input,h.next_in,f,d),1===h.state.wrap?h.adler=o(h.adler,c,f,d):2===h.state.wrap&&(h.adler=a(h.adler,c,f,d)),h.next_in+=f,h.total_in+=f,f),t.lookahead+=i,t.lookahead+t.insert>=3)for(l=t.strstart-t.insert,t.ins_h=t.window[l],t.ins_h=(t.ins_h<<t.hash_shift^t.window[l+1])&t.hash_mask;t.insert&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[l+3-1])&t.hash_mask,t.prev[l&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=l,l++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<262&&0!==t.strm.avail_in)}function m(t,e){for(var i,r;;){if(t.lookahead<262){if(y(t),t.lookahead<262&&0===e)return 1;if(0===t.lookahead)break}if(i=0,t.lookahead>=3&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==i&&t.strstart-i<=t.w_size-262&&(t.match_length=g(t,i)),t.match_length>=3)if(r=n._tr_tally(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do{t.strstart++,t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart}while(0!=--t.match_length);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+1])&t.hash_mask;else r=n._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(r&&(f(t,!1),0===t.strm.avail_out))return 1}return t.insert=t.strstart<2?t.strstart:2,4===e?(f(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(f(t,!1),0===t.strm.avail_out)?1:2}function b(t,e){for(var i,r,s;;){if(t.lookahead<262){if(y(t),t.lookahead<262&&0===e)return 1;if(0===t.lookahead)break}if(i=0,t.lookahead>=3&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,0!==i&&t.prev_length<t.max_lazy_match&&t.strstart-i<=t.w_size-262&&(t.match_length=g(t,i),t.match_length<=5&&(1===t.strategy||3===t.match_length&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){s=t.strstart+t.lookahead-3,r=n._tr_tally(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do{++t.strstart<=s&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart)}while(0!=--t.prev_length);if(t.match_available=0,t.match_length=2,t.strstart++,r&&(f(t,!1),0===t.strm.avail_out))return 1}else if(t.match_available){if((r=n._tr_tally(t,0,t.window[t.strstart-1]))&&f(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(r=n._tr_tally(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,4===e?(f(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(f(t,!1),0===t.strm.avail_out)?1:2}function x(t,e,i,r,s){this.good_length=t,this.max_lazy=e,this.nice_length=i,this.max_chain=r,this.func=s}function w(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new s.Buf16(1146),this.dyn_dtree=new s.Buf16(122),this.bl_tree=new s.Buf16(78),d(this.dyn_ltree),d(this.dyn_dtree),d(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new s.Buf16(16),this.heap=new s.Buf16(573),d(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new s.Buf16(573),d(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function v(t){var e;return t&&t.state?(t.total_in=t.total_out=0,t.data_type=2,(e=t.state).pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap?42:113,t.adler=2===e.wrap?0:1,e.last_flush=0,n._tr_init(e),0):h(t,-2)}function k(t){var e,i=v(t);return 0===i&&((e=t.state).window_size=2*e.w_size,d(e.head),e.max_lazy_match=r[e.level].max_lazy,e.good_match=r[e.level].good_length,e.nice_match=r[e.level].nice_length,e.max_chain_length=r[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=2,e.match_available=0,e.ins_h=0),i}function A(t,e,i,r,n,o){if(!t)return-2;var a=1;if(-1===e&&(e=6),r<0?(a=0,r=-r):r>15&&(a=2,r-=16),n<1||n>9||8!==i||r<8||r>15||e<0||e>9||o<0||o>4)return h(t,-2);8===r&&(r=9);var l=new w;return t.state=l,l.strm=t,l.wrap=a,l.gzhead=null,l.w_bits=r,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=n+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+3-1)/3),l.window=new s.Buf8(2*l.w_size),l.head=new s.Buf16(l.hash_size),l.prev=new s.Buf16(l.w_size),l.lit_bufsize=1<<n+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new s.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=e,l.strategy=o,l.method=i,k(t)}r=[new x(0,0,0,0,(function(t,e){var i=65535;for(i>t.pending_buf_size-5&&(i=t.pending_buf_size-5);;){if(t.lookahead<=1){if(y(t),0===t.lookahead&&0===e)return 1;if(0===t.lookahead)break}t.strstart+=t.lookahead,t.lookahead=0;var r=t.block_start+i;if((0===t.strstart||t.strstart>=r)&&(t.lookahead=t.strstart-r,t.strstart=r,f(t,!1),0===t.strm.avail_out))return 1;if(t.strstart-t.block_start>=t.w_size-262&&(f(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,4===e?(f(t,!0),0===t.strm.avail_out?3:4):(t.strstart>t.block_start&&(f(t,!1),t.strm.avail_out),1)})),new x(4,4,8,4,m),new x(4,5,16,8,m),new x(4,6,32,32,m),new x(4,4,16,16,b),new x(8,16,32,32,b),new x(8,16,128,128,b),new x(8,32,128,256,b),new x(32,128,258,1024,b),new x(32,258,258,4096,b)],e.deflateInit=function(t,e){return A(t,e,8,15,8,0)},e.deflateInit2=A,e.deflateReset=k,e.deflateResetKeep=v,e.deflateSetHeader=function(t,e){return t&&t.state?2!==t.state.wrap?-2:(t.state.gzhead=e,0):-2},e.deflate=function(t,e){var i,s,o,l;if(!t||!t.state||e>5||e<0)return t?h(t,-2):-2;if(s=t.state,!t.output||!t.input&&0!==t.avail_in||666===s.status&&4!==e)return h(t,0===t.avail_out?-5:-2);if(s.strm=t,i=s.last_flush,s.last_flush=e,42===s.status)if(2===s.wrap)t.adler=0,p(s,31),p(s,139),p(s,8),s.gzhead?(p(s,(s.gzhead.text?1:0)+(s.gzhead.hcrc?2:0)+(s.gzhead.extra?4:0)+(s.gzhead.name?8:0)+(s.gzhead.comment?16:0)),p(s,255&s.gzhead.time),p(s,s.gzhead.time>>8&255),p(s,s.gzhead.time>>16&255),p(s,s.gzhead.time>>24&255),p(s,9===s.level?2:s.strategy>=2||s.level<2?4:0),p(s,255&s.gzhead.os),s.gzhead.extra&&s.gzhead.extra.length&&(p(s,255&s.gzhead.extra.length),p(s,s.gzhead.extra.length>>8&255)),s.gzhead.hcrc&&(t.adler=a(t.adler,s.pending_buf,s.pending,0)),s.gzindex=0,s.status=69):(p(s,0),p(s,0),p(s,0),p(s,0),p(s,0),p(s,9===s.level?2:s.strategy>=2||s.level<2?4:0),p(s,3),s.status=113);else{var g=8+(s.w_bits-8<<4)<<8;g|=(s.strategy>=2||s.level<2?0:s.level<6?1:6===s.level?2:3)<<6,0!==s.strstart&&(g|=32),g+=31-g%31,s.status=113,_(s,g),0!==s.strstart&&(_(s,t.adler>>>16),_(s,65535&t.adler)),t.adler=1}if(69===s.status)if(s.gzhead.extra){for(o=s.pending;s.gzindex<(65535&s.gzhead.extra.length)&&(s.pending!==s.pending_buf_size||(s.gzhead.hcrc&&s.pending>o&&(t.adler=a(t.adler,s.pending_buf,s.pending-o,o)),u(t),o=s.pending,s.pending!==s.pending_buf_size));)p(s,255&s.gzhead.extra[s.gzindex]),s.gzindex++;s.gzhead.hcrc&&s.pending>o&&(t.adler=a(t.adler,s.pending_buf,s.pending-o,o)),s.gzindex===s.gzhead.extra.length&&(s.gzindex=0,s.status=73)}else s.status=73;if(73===s.status)if(s.gzhead.name){o=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>o&&(t.adler=a(t.adler,s.pending_buf,s.pending-o,o)),u(t),o=s.pending,s.pending===s.pending_buf_size)){l=1;break}l=s.gzindex<s.gzhead.name.length?255&s.gzhead.name.charCodeAt(s.gzindex++):0,p(s,l)}while(0!==l);s.gzhead.hcrc&&s.pending>o&&(t.adler=a(t.adler,s.pending_buf,s.pending-o,o)),0===l&&(s.gzindex=0,s.status=91)}else s.status=91;if(91===s.status)if(s.gzhead.comment){o=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>o&&(t.adler=a(t.adler,s.pending_buf,s.pending-o,o)),u(t),o=s.pending,s.pending===s.pending_buf_size)){l=1;break}l=s.gzindex<s.gzhead.comment.length?255&s.gzhead.comment.charCodeAt(s.gzindex++):0,p(s,l)}while(0!==l);s.gzhead.hcrc&&s.pending>o&&(t.adler=a(t.adler,s.pending_buf,s.pending-o,o)),0===l&&(s.status=103)}else s.status=103;if(103===s.status&&(s.gzhead.hcrc?(s.pending+2>s.pending_buf_size&&u(t),s.pending+2<=s.pending_buf_size&&(p(s,255&t.adler),p(s,t.adler>>8&255),t.adler=0,s.status=113)):s.status=113),0!==s.pending){if(u(t),0===t.avail_out)return s.last_flush=-1,0}else if(0===t.avail_in&&c(e)<=c(i)&&4!==e)return h(t,-5);if(666===s.status&&0!==t.avail_in)return h(t,-5);if(0!==t.avail_in||0!==s.lookahead||0!==e&&666!==s.status){var m=2===s.strategy?function(t,e){for(var i;;){if(0===t.lookahead&&(y(t),0===t.lookahead)){if(0===e)return 1;break}if(t.match_length=0,i=n._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,i&&(f(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,4===e?(f(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(f(t,!1),0===t.strm.avail_out)?1:2}(s,e):3===s.strategy?function(t,e){for(var i,r,s,o,a=t.window;;){if(t.lookahead<=258){if(y(t),t.lookahead<=258&&0===e)return 1;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=3&&t.strstart>0&&(r=a[s=t.strstart-1])===a[++s]&&r===a[++s]&&r===a[++s]){o=t.strstart+258;do{}while(r===a[++s]&&r===a[++s]&&r===a[++s]&&r===a[++s]&&r===a[++s]&&r===a[++s]&&r===a[++s]&&r===a[++s]&&s<o);t.match_length=258-(o-s),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=3?(i=n._tr_tally(t,1,t.match_length-3),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(i=n._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),i&&(f(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,4===e?(f(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(f(t,!1),0===t.strm.avail_out)?1:2}(s,e):r[s.level].func(s,e);if(3!==m&&4!==m||(s.status=666),1===m||3===m)return 0===t.avail_out&&(s.last_flush=-1),0;if(2===m&&(1===e?n._tr_align(s):5!==e&&(n._tr_stored_block(s,0,0,!1),3===e&&(d(s.head),0===s.lookahead&&(s.strstart=0,s.block_start=0,s.insert=0))),u(t),0===t.avail_out))return s.last_flush=-1,0}return 4!==e?0:s.wrap<=0?1:(2===s.wrap?(p(s,255&t.adler),p(s,t.adler>>8&255),p(s,t.adler>>16&255),p(s,t.adler>>24&255),p(s,255&t.total_in),p(s,t.total_in>>8&255),p(s,t.total_in>>16&255),p(s,t.total_in>>24&255)):(_(s,t.adler>>>16),_(s,65535&t.adler)),u(t),s.wrap>0&&(s.wrap=-s.wrap),0!==s.pending?0:1)},e.deflateEnd=function(t){var e;return t&&t.state?42!==(e=t.state.status)&&69!==e&&73!==e&&91!==e&&103!==e&&113!==e&&666!==e?h(t,-2):(t.state=null,113===e?h(t,-3):0):-2},e.deflateSetDictionary=function(t,e){var i,r,n,a,l,h,c,u,f=e.length;if(!t||!t.state)return-2;if(2===(a=(i=t.state).wrap)||1===a&&42!==i.status||i.lookahead)return-2;for(1===a&&(t.adler=o(t.adler,e,f,0)),i.wrap=0,f>=i.w_size&&(0===a&&(d(i.head),i.strstart=0,i.block_start=0,i.insert=0),u=new s.Buf8(i.w_size),s.arraySet(u,e,f-i.w_size,i.w_size,0),e=u,f=i.w_size),l=t.avail_in,h=t.next_in,c=t.input,t.avail_in=f,t.next_in=0,t.input=e,y(i);i.lookahead>=3;){r=i.strstart,n=i.lookahead-2;do{i.ins_h=(i.ins_h<<i.hash_shift^i.window[r+3-1])&i.hash_mask,i.prev[r&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=r,r++}while(--n);i.strstart=r,i.lookahead=2,y(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,t.next_in=h,t.input=c,t.avail_in=l,i.wrap=a,0},e.deflateInfo="pako deflate (from Nodeca project)"},function(t,e,i){"use strict";var r=i(0);function s(t){for(var e=t.length;--e>=0;)t[e]=0}var n=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],o=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],l=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],h=new Array(576);s(h);var c=new Array(60);s(c);var d=new Array(512);s(d);var u=new Array(256);s(u);var f=new Array(29);s(f);var p,_,g,y=new Array(30);function m(t,e,i,r,s){this.static_tree=t,this.extra_bits=e,this.extra_base=i,this.elems=r,this.max_length=s,this.has_stree=t&&t.length}function b(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}function x(t){return t<256?d[t]:d[256+(t>>>7)]}function w(t,e){t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255}function v(t,e,i){t.bi_valid>16-i?(t.bi_buf|=e<<t.bi_valid&65535,w(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=i-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=i)}function k(t,e,i){v(t,i[2*e],i[2*e+1])}function A(t,e){var i=0;do{i|=1&t,t>>>=1,i<<=1}while(--e>0);return i>>>1}function T(t,e,i){var r,s,n=new Array(16),o=0;for(r=1;r<=15;r++)n[r]=o=o+i[r-1]<<1;for(s=0;s<=e;s++){var a=t[2*s+1];0!==a&&(t[2*s]=A(n[a]++,a))}}function S(t){var e;for(e=0;e<286;e++)t.dyn_ltree[2*e]=0;for(e=0;e<30;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.last_lit=t.matches=0}function I(t){t.bi_valid>8?w(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0}function z(t,e,i,r){var s=2*e,n=2*i;return t[s]<t[n]||t[s]===t[n]&&r[e]<=r[i]}function P(t,e,i){for(var r=t.heap[i],s=i<<1;s<=t.heap_len&&(s<t.heap_len&&z(e,t.heap[s+1],t.heap[s],t.depth)&&s++,!z(e,r,t.heap[s],t.depth));)t.heap[i]=t.heap[s],i=s,s<<=1;t.heap[i]=r}function R(t,e,i){var r,s,a,l,h=0;if(0!==t.last_lit)do{r=t.pending_buf[t.d_buf+2*h]<<8|t.pending_buf[t.d_buf+2*h+1],s=t.pending_buf[t.l_buf+h],h++,0===r?k(t,s,e):(k(t,(a=u[s])+256+1,e),0!==(l=n[a])&&v(t,s-=f[a],l),k(t,a=x(--r),i),0!==(l=o[a])&&v(t,r-=y[a],l))}while(h<t.last_lit);k(t,256,e)}function C(t,e){var i,r,s,n=e.dyn_tree,o=e.stat_desc.static_tree,a=e.stat_desc.has_stree,l=e.stat_desc.elems,h=-1;for(t.heap_len=0,t.heap_max=573,i=0;i<l;i++)0!==n[2*i]?(t.heap[++t.heap_len]=h=i,t.depth[i]=0):n[2*i+1]=0;for(;t.heap_len<2;)n[2*(s=t.heap[++t.heap_len]=h<2?++h:0)]=1,t.depth[s]=0,t.opt_len--,a&&(t.static_len-=o[2*s+1]);for(e.max_code=h,i=t.heap_len>>1;i>=1;i--)P(t,n,i);s=l;do{i=t.heap[1],t.heap[1]=t.heap[t.heap_len--],P(t,n,1),r=t.heap[1],t.heap[--t.heap_max]=i,t.heap[--t.heap_max]=r,n[2*s]=n[2*i]+n[2*r],t.depth[s]=(t.depth[i]>=t.depth[r]?t.depth[i]:t.depth[r])+1,n[2*i+1]=n[2*r+1]=s,t.heap[1]=s++,P(t,n,1)}while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],function(t,e){var i,r,s,n,o,a,l=e.dyn_tree,h=e.max_code,c=e.stat_desc.static_tree,d=e.stat_desc.has_stree,u=e.stat_desc.extra_bits,f=e.stat_desc.extra_base,p=e.stat_desc.max_length,_=0;for(n=0;n<=15;n++)t.bl_count[n]=0;for(l[2*t.heap[t.heap_max]+1]=0,i=t.heap_max+1;i<573;i++)(n=l[2*l[2*(r=t.heap[i])+1]+1]+1)>p&&(n=p,_++),l[2*r+1]=n,r>h||(t.bl_count[n]++,o=0,r>=f&&(o=u[r-f]),a=l[2*r],t.opt_len+=a*(n+o),d&&(t.static_len+=a*(c[2*r+1]+o)));if(0!==_){do{for(n=p-1;0===t.bl_count[n];)n--;t.bl_count[n]--,t.bl_count[n+1]+=2,t.bl_count[p]--,_-=2}while(_>0);for(n=p;0!==n;n--)for(r=t.bl_count[n];0!==r;)(s=t.heap[--i])>h||(l[2*s+1]!==n&&(t.opt_len+=(n-l[2*s+1])*l[2*s],l[2*s+1]=n),r--)}}(t,e),T(n,h,t.bl_count)}function O(t,e,i){var r,s,n=-1,o=e[1],a=0,l=7,h=4;for(0===o&&(l=138,h=3),e[2*(i+1)+1]=65535,r=0;r<=i;r++)s=o,o=e[2*(r+1)+1],++a<l&&s===o||(a<h?t.bl_tree[2*s]+=a:0!==s?(s!==n&&t.bl_tree[2*s]++,t.bl_tree[32]++):a<=10?t.bl_tree[34]++:t.bl_tree[36]++,a=0,n=s,0===o?(l=138,h=3):s===o?(l=6,h=3):(l=7,h=4))}function M(t,e,i){var r,s,n=-1,o=e[1],a=0,l=7,h=4;for(0===o&&(l=138,h=3),r=0;r<=i;r++)if(s=o,o=e[2*(r+1)+1],!(++a<l&&s===o)){if(a<h)do{k(t,s,t.bl_tree)}while(0!=--a);else 0!==s?(s!==n&&(k(t,s,t.bl_tree),a--),k(t,16,t.bl_tree),v(t,a-3,2)):a<=10?(k(t,17,t.bl_tree),v(t,a-3,3)):(k(t,18,t.bl_tree),v(t,a-11,7));a=0,n=s,0===o?(l=138,h=3):s===o?(l=6,h=3):(l=7,h=4)}}s(y);var E=!1;function B(t,e,i,s){v(t,0+(s?1:0),3),function(t,e,i,s){I(t),s&&(w(t,i),w(t,~i)),r.arraySet(t.pending_buf,t.window,e,i,t.pending),t.pending+=i}(t,e,i,!0)}e._tr_init=function(t){E||(!function(){var t,e,i,r,s,l=new Array(16);for(i=0,r=0;r<28;r++)for(f[r]=i,t=0;t<1<<n[r];t++)u[i++]=r;for(u[i-1]=r,s=0,r=0;r<16;r++)for(y[r]=s,t=0;t<1<<o[r];t++)d[s++]=r;for(s>>=7;r<30;r++)for(y[r]=s<<7,t=0;t<1<<o[r]-7;t++)d[256+s++]=r;for(e=0;e<=15;e++)l[e]=0;for(t=0;t<=143;)h[2*t+1]=8,t++,l[8]++;for(;t<=255;)h[2*t+1]=9,t++,l[9]++;for(;t<=279;)h[2*t+1]=7,t++,l[7]++;for(;t<=287;)h[2*t+1]=8,t++,l[8]++;for(T(h,287,l),t=0;t<30;t++)c[2*t+1]=5,c[2*t]=A(t,5);p=new m(h,n,257,286,15),_=new m(c,o,0,30,15),g=new m(new Array(0),a,0,19,7)}(),E=!0),t.l_desc=new b(t.dyn_ltree,p),t.d_desc=new b(t.dyn_dtree,_),t.bl_desc=new b(t.bl_tree,g),t.bi_buf=0,t.bi_valid=0,S(t)},e._tr_stored_block=B,e._tr_flush_block=function(t,e,i,r){var s,n,o=0;t.level>0?(2===t.strm.data_type&&(t.strm.data_type=function(t){var e,i=4093624447;for(e=0;e<=31;e++,i>>>=1)if(1&i&&0!==t.dyn_ltree[2*e])return 0;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return 1;for(e=32;e<256;e++)if(0!==t.dyn_ltree[2*e])return 1;return 0}(t)),C(t,t.l_desc),C(t,t.d_desc),o=function(t){var e;for(O(t,t.dyn_ltree,t.l_desc.max_code),O(t,t.dyn_dtree,t.d_desc.max_code),C(t,t.bl_desc),e=18;e>=3&&0===t.bl_tree[2*l[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e}(t),s=t.opt_len+3+7>>>3,(n=t.static_len+3+7>>>3)<=s&&(s=n)):s=n=i+5,i+4<=s&&-1!==e?B(t,e,i,r):4===t.strategy||n===s?(v(t,2+(r?1:0),3),R(t,h,c)):(v(t,4+(r?1:0),3),function(t,e,i,r){var s;for(v(t,e-257,5),v(t,i-1,5),v(t,r-4,4),s=0;s<r;s++)v(t,t.bl_tree[2*l[s]+1],3);M(t,t.dyn_ltree,e-1),M(t,t.dyn_dtree,i-1)}(t,t.l_desc.max_code+1,t.d_desc.max_code+1,o+1),R(t,t.dyn_ltree,t.dyn_dtree)),S(t),r&&I(t)},e._tr_tally=function(t,e,i){return t.pending_buf[t.d_buf+2*t.last_lit]=e>>>8&255,t.pending_buf[t.d_buf+2*t.last_lit+1]=255&e,t.pending_buf[t.l_buf+t.last_lit]=255&i,t.last_lit++,0===e?t.dyn_ltree[2*i]++:(t.matches++,e--,t.dyn_ltree[2*(u[i]+256+1)]++,t.dyn_dtree[2*x(e)]++),t.last_lit===t.lit_bufsize-1},e._tr_align=function(t){v(t,2,3),k(t,256,h),function(t){16===t.bi_valid?(w(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)}(t)}},function(t,e,i){"use strict";var r=i(34),s=i(0),n=i(9),o=i(11),a=i(4),l=i(10),h=i(37),c=Object.prototype.toString;function d(t){if(!(this instanceof d))return new d(t);this.options=s.assign({chunkSize:16384,windowBits:0,to:""},t||{});var e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&0==(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var i=r.inflateInit2(this.strm,e.windowBits);if(i!==o.Z_OK)throw new Error(a[i]);if(this.header=new h,r.inflateGetHeader(this.strm,this.header),e.dictionary&&("string"==typeof e.dictionary?e.dictionary=n.string2buf(e.dictionary):"[object ArrayBuffer]"===c.call(e.dictionary)&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(i=r.inflateSetDictionary(this.strm,e.dictionary))!==o.Z_OK))throw new Error(a[i])}function u(t,e){var i=new d(e);if(i.push(t,!0),i.err)throw i.msg||a[i.err];return i.result}d.prototype.push=function(t,e){var i,a,l,h,d,u=this.strm,f=this.options.chunkSize,p=this.options.dictionary,_=!1;if(this.ended)return!1;a=e===~~e?e:!0===e?o.Z_FINISH:o.Z_NO_FLUSH,"string"==typeof t?u.input=n.binstring2buf(t):"[object ArrayBuffer]"===c.call(t)?u.input=new Uint8Array(t):u.input=t,u.next_in=0,u.avail_in=u.input.length;do{if(0===u.avail_out&&(u.output=new s.Buf8(f),u.next_out=0,u.avail_out=f),(i=r.inflate(u,o.Z_NO_FLUSH))===o.Z_NEED_DICT&&p&&(i=r.inflateSetDictionary(this.strm,p)),i===o.Z_BUF_ERROR&&!0===_&&(i=o.Z_OK,_=!1),i!==o.Z_STREAM_END&&i!==o.Z_OK)return this.onEnd(i),this.ended=!0,!1;u.next_out&&(0!==u.avail_out&&i!==o.Z_STREAM_END&&(0!==u.avail_in||a!==o.Z_FINISH&&a!==o.Z_SYNC_FLUSH)||("string"===this.options.to?(l=n.utf8border(u.output,u.next_out),h=u.next_out-l,d=n.buf2string(u.output,l),u.next_out=h,u.avail_out=f-h,h&&s.arraySet(u.output,u.output,l,h,0),this.onData(d)):this.onData(s.shrinkBuf(u.output,u.next_out)))),0===u.avail_in&&0===u.avail_out&&(_=!0)}while((u.avail_in>0||0===u.avail_out)&&i!==o.Z_STREAM_END);return i===o.Z_STREAM_END&&(a=o.Z_FINISH),a===o.Z_FINISH?(i=r.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===o.Z_OK):a!==o.Z_SYNC_FLUSH||(this.onEnd(o.Z_OK),u.avail_out=0,!0)},d.prototype.onData=function(t){this.chunks.push(t)},d.prototype.onEnd=function(t){t===o.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=s.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},e.Inflate=d,e.inflate=u,e.inflateRaw=function(t,e){return(e=e||{}).raw=!0,u(t,e)},e.ungzip=u},function(t,e,i){"use strict";var r=i(0),s=i(7),n=i(8),o=i(35),a=i(36);function l(t){return(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24)}function h(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new r.Buf16(320),this.work=new r.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function c(t){var e;return t&&t.state?(e=t.state,t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=1,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new r.Buf32(852),e.distcode=e.distdyn=new r.Buf32(592),e.sane=1,e.back=-1,0):-2}function d(t){var e;return t&&t.state?((e=t.state).wsize=0,e.whave=0,e.wnext=0,c(t)):-2}function u(t,e){var i,r;return t&&t.state?(r=t.state,e<0?(i=0,e=-e):(i=1+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?-2:(null!==r.window&&r.wbits!==e&&(r.window=null),r.wrap=i,r.wbits=e,d(t))):-2}function f(t,e){var i,r;return t?(r=new h,t.state=r,r.window=null,0!==(i=u(t,e))&&(t.state=null),i):-2}var p,_,g=!0;function y(t){if(g){var e;for(p=new r.Buf32(512),_=new r.Buf32(32),e=0;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(a(1,t.lens,0,288,p,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;a(2,t.lens,0,32,_,0,t.work,{bits:5}),g=!1}t.lencode=p,t.lenbits=9,t.distcode=_,t.distbits=5}function m(t,e,i,s){var n,o=t.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new r.Buf8(o.wsize)),s>=o.wsize?(r.arraySet(o.window,e,i-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):((n=o.wsize-o.wnext)>s&&(n=s),r.arraySet(o.window,e,i-s,n,o.wnext),(s-=n)?(r.arraySet(o.window,e,i-s,s,0),o.wnext=s,o.whave=o.wsize):(o.wnext+=n,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=n))),0}e.inflateReset=d,e.inflateReset2=u,e.inflateResetKeep=c,e.inflateInit=function(t){return f(t,15)},e.inflateInit2=f,e.inflate=function(t,e){var i,h,c,d,u,f,p,_,g,b,x,w,v,k,A,T,S,I,z,P,R,C,O,M,E=0,B=new r.Buf8(4),L=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&0!==t.avail_in)return-2;12===(i=t.state).mode&&(i.mode=13),u=t.next_out,c=t.output,p=t.avail_out,d=t.next_in,h=t.input,f=t.avail_in,_=i.hold,g=i.bits,b=f,x=p,C=0;t:for(;;)switch(i.mode){case 1:if(0===i.wrap){i.mode=13;break}for(;g<16;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(2&i.wrap&&35615===_){i.check=0,B[0]=255&_,B[1]=_>>>8&255,i.check=n(i.check,B,2,0),_=0,g=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&_)<<8)+(_>>8))%31){t.msg="incorrect header check",i.mode=30;break}if(8!=(15&_)){t.msg="unknown compression method",i.mode=30;break}if(g-=4,R=8+(15&(_>>>=4)),0===i.wbits)i.wbits=R;else if(R>i.wbits){t.msg="invalid window size",i.mode=30;break}i.dmax=1<<R,t.adler=i.check=1,i.mode=512&_?10:12,_=0,g=0;break;case 2:for(;g<16;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(i.flags=_,8!=(255&i.flags)){t.msg="unknown compression method",i.mode=30;break}if(57344&i.flags){t.msg="unknown header flags set",i.mode=30;break}i.head&&(i.head.text=_>>8&1),512&i.flags&&(B[0]=255&_,B[1]=_>>>8&255,i.check=n(i.check,B,2,0)),_=0,g=0,i.mode=3;case 3:for(;g<32;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}i.head&&(i.head.time=_),512&i.flags&&(B[0]=255&_,B[1]=_>>>8&255,B[2]=_>>>16&255,B[3]=_>>>24&255,i.check=n(i.check,B,4,0)),_=0,g=0,i.mode=4;case 4:for(;g<16;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}i.head&&(i.head.xflags=255&_,i.head.os=_>>8),512&i.flags&&(B[0]=255&_,B[1]=_>>>8&255,i.check=n(i.check,B,2,0)),_=0,g=0,i.mode=5;case 5:if(1024&i.flags){for(;g<16;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}i.length=_,i.head&&(i.head.extra_len=_),512&i.flags&&(B[0]=255&_,B[1]=_>>>8&255,i.check=n(i.check,B,2,0)),_=0,g=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&i.flags&&((w=i.length)>f&&(w=f),w&&(i.head&&(R=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),r.arraySet(i.head.extra,h,d,w,R)),512&i.flags&&(i.check=n(i.check,h,w,d)),f-=w,d+=w,i.length-=w),i.length))break t;i.length=0,i.mode=7;case 7:if(2048&i.flags){if(0===f)break t;w=0;do{R=h[d+w++],i.head&&R&&i.length<65536&&(i.head.name+=String.fromCharCode(R))}while(R&&w<f);if(512&i.flags&&(i.check=n(i.check,h,w,d)),f-=w,d+=w,R)break t}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&i.flags){if(0===f)break t;w=0;do{R=h[d+w++],i.head&&R&&i.length<65536&&(i.head.comment+=String.fromCharCode(R))}while(R&&w<f);if(512&i.flags&&(i.check=n(i.check,h,w,d)),f-=w,d+=w,R)break t}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&i.flags){for(;g<16;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(_!==(65535&i.check)){t.msg="header crc mismatch",i.mode=30;break}_=0,g=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),t.adler=i.check=0,i.mode=12;break;case 10:for(;g<32;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}t.adler=i.check=l(_),_=0,g=0,i.mode=11;case 11:if(0===i.havedict)return t.next_out=u,t.avail_out=p,t.next_in=d,t.avail_in=f,i.hold=_,i.bits=g,2;t.adler=i.check=1,i.mode=12;case 12:if(5===e||6===e)break t;case 13:if(i.last){_>>>=7&g,g-=7&g,i.mode=27;break}for(;g<3;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}switch(i.last=1&_,g-=1,3&(_>>>=1)){case 0:i.mode=14;break;case 1:if(y(i),i.mode=20,6===e){_>>>=2,g-=2;break t}break;case 2:i.mode=17;break;case 3:t.msg="invalid block type",i.mode=30}_>>>=2,g-=2;break;case 14:for(_>>>=7&g,g-=7&g;g<32;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if((65535&_)!=(_>>>16^65535)){t.msg="invalid stored block lengths",i.mode=30;break}if(i.length=65535&_,_=0,g=0,i.mode=15,6===e)break t;case 15:i.mode=16;case 16:if(w=i.length){if(w>f&&(w=f),w>p&&(w=p),0===w)break t;r.arraySet(c,h,d,w,u),f-=w,d+=w,p-=w,u+=w,i.length-=w;break}i.mode=12;break;case 17:for(;g<14;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(i.nlen=257+(31&_),_>>>=5,g-=5,i.ndist=1+(31&_),_>>>=5,g-=5,i.ncode=4+(15&_),_>>>=4,g-=4,i.nlen>286||i.ndist>30){t.msg="too many length or distance symbols",i.mode=30;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;g<3;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}i.lens[L[i.have++]]=7&_,_>>>=3,g-=3}for(;i.have<19;)i.lens[L[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,O={bits:i.lenbits},C=a(0,i.lens,0,19,i.lencode,0,i.work,O),i.lenbits=O.bits,C){t.msg="invalid code lengths set",i.mode=30;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;T=(E=i.lencode[_&(1<<i.lenbits)-1])>>>16&255,S=65535&E,!((A=E>>>24)<=g);){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(S<16)_>>>=A,g-=A,i.lens[i.have++]=S;else{if(16===S){for(M=A+2;g<M;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(_>>>=A,g-=A,0===i.have){t.msg="invalid bit length repeat",i.mode=30;break}R=i.lens[i.have-1],w=3+(3&_),_>>>=2,g-=2}else if(17===S){for(M=A+3;g<M;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}g-=A,R=0,w=3+(7&(_>>>=A)),_>>>=3,g-=3}else{for(M=A+7;g<M;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}g-=A,R=0,w=11+(127&(_>>>=A)),_>>>=7,g-=7}if(i.have+w>i.nlen+i.ndist){t.msg="invalid bit length repeat",i.mode=30;break}for(;w--;)i.lens[i.have++]=R}}if(30===i.mode)break;if(0===i.lens[256]){t.msg="invalid code -- missing end-of-block",i.mode=30;break}if(i.lenbits=9,O={bits:i.lenbits},C=a(1,i.lens,0,i.nlen,i.lencode,0,i.work,O),i.lenbits=O.bits,C){t.msg="invalid literal/lengths set",i.mode=30;break}if(i.distbits=6,i.distcode=i.distdyn,O={bits:i.distbits},C=a(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,O),i.distbits=O.bits,C){t.msg="invalid distances set",i.mode=30;break}if(i.mode=20,6===e)break t;case 20:i.mode=21;case 21:if(f>=6&&p>=258){t.next_out=u,t.avail_out=p,t.next_in=d,t.avail_in=f,i.hold=_,i.bits=g,o(t,x),u=t.next_out,c=t.output,p=t.avail_out,d=t.next_in,h=t.input,f=t.avail_in,_=i.hold,g=i.bits,12===i.mode&&(i.back=-1);break}for(i.back=0;T=(E=i.lencode[_&(1<<i.lenbits)-1])>>>16&255,S=65535&E,!((A=E>>>24)<=g);){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(T&&0==(240&T)){for(I=A,z=T,P=S;T=(E=i.lencode[P+((_&(1<<I+z)-1)>>I)])>>>16&255,S=65535&E,!(I+(A=E>>>24)<=g);){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}_>>>=I,g-=I,i.back+=I}if(_>>>=A,g-=A,i.back+=A,i.length=S,0===T){i.mode=26;break}if(32&T){i.back=-1,i.mode=12;break}if(64&T){t.msg="invalid literal/length code",i.mode=30;break}i.extra=15&T,i.mode=22;case 22:if(i.extra){for(M=i.extra;g<M;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}i.length+=_&(1<<i.extra)-1,_>>>=i.extra,g-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;T=(E=i.distcode[_&(1<<i.distbits)-1])>>>16&255,S=65535&E,!((A=E>>>24)<=g);){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(0==(240&T)){for(I=A,z=T,P=S;T=(E=i.distcode[P+((_&(1<<I+z)-1)>>I)])>>>16&255,S=65535&E,!(I+(A=E>>>24)<=g);){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}_>>>=I,g-=I,i.back+=I}if(_>>>=A,g-=A,i.back+=A,64&T){t.msg="invalid distance code",i.mode=30;break}i.offset=S,i.extra=15&T,i.mode=24;case 24:if(i.extra){for(M=i.extra;g<M;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}i.offset+=_&(1<<i.extra)-1,_>>>=i.extra,g-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){t.msg="invalid distance too far back",i.mode=30;break}i.mode=25;case 25:if(0===p)break t;if(w=x-p,i.offset>w){if((w=i.offset-w)>i.whave&&i.sane){t.msg="invalid distance too far back",i.mode=30;break}w>i.wnext?(w-=i.wnext,v=i.wsize-w):v=i.wnext-w,w>i.length&&(w=i.length),k=i.window}else k=c,v=u-i.offset,w=i.length;w>p&&(w=p),p-=w,i.length-=w;do{c[u++]=k[v++]}while(--w);0===i.length&&(i.mode=21);break;case 26:if(0===p)break t;c[u++]=i.length,p--,i.mode=21;break;case 27:if(i.wrap){for(;g<32;){if(0===f)break t;f--,_|=h[d++]<<g,g+=8}if(x-=p,t.total_out+=x,i.total+=x,x&&(t.adler=i.check=i.flags?n(i.check,c,x,u-x):s(i.check,c,x,u-x)),x=p,(i.flags?_:l(_))!==i.check){t.msg="incorrect data check",i.mode=30;break}_=0,g=0}i.mode=28;case 28:if(i.wrap&&i.flags){for(;g<32;){if(0===f)break t;f--,_+=h[d++]<<g,g+=8}if(_!==(4294967295&i.total)){t.msg="incorrect length check",i.mode=30;break}_=0,g=0}i.mode=29;case 29:C=1;break t;case 30:C=-3;break t;case 31:return-4;case 32:default:return-2}return t.next_out=u,t.avail_out=p,t.next_in=d,t.avail_in=f,i.hold=_,i.bits=g,(i.wsize||x!==t.avail_out&&i.mode<30&&(i.mode<27||4!==e))&&m(t,t.output,t.next_out,x-t.avail_out)?(i.mode=31,-4):(b-=t.avail_in,x-=t.avail_out,t.total_in+=b,t.total_out+=x,i.total+=x,i.wrap&&x&&(t.adler=i.check=i.flags?n(i.check,c,x,t.next_out-x):s(i.check,c,x,t.next_out-x)),t.data_type=i.bits+(i.last?64:0)+(12===i.mode?128:0)+(20===i.mode||15===i.mode?256:0),(0===b&&0===x||4===e)&&0===C&&(C=-5),C)},e.inflateEnd=function(t){if(!t||!t.state)return-2;var e=t.state;return e.window&&(e.window=null),t.state=null,0},e.inflateGetHeader=function(t,e){var i;return t&&t.state?0==(2&(i=t.state).wrap)?-2:(i.head=e,e.done=!1,0):-2},e.inflateSetDictionary=function(t,e){var i,r=e.length;return t&&t.state?0!==(i=t.state).wrap&&11!==i.mode?-2:11===i.mode&&s(1,e,r,0)!==i.check?-3:m(t,e,r,r)?(i.mode=31,-4):(i.havedict=1,0):-2},e.inflateInfo="pako inflate (from Nodeca project)"},function(t,e,i){"use strict";t.exports=function(t,e){var i,r,s,n,o,a,l,h,c,d,u,f,p,_,g,y,m,b,x,w,v,k,A,T,S;i=t.state,r=t.next_in,T=t.input,s=r+(t.avail_in-5),n=t.next_out,S=t.output,o=n-(e-t.avail_out),a=n+(t.avail_out-257),l=i.dmax,h=i.wsize,c=i.whave,d=i.wnext,u=i.window,f=i.hold,p=i.bits,_=i.lencode,g=i.distcode,y=(1<<i.lenbits)-1,m=(1<<i.distbits)-1;t:do{p<15&&(f+=T[r++]<<p,p+=8,f+=T[r++]<<p,p+=8),b=_[f&y];e:for(;;){if(f>>>=x=b>>>24,p-=x,0===(x=b>>>16&255))S[n++]=65535&b;else{if(!(16&x)){if(0==(64&x)){b=_[(65535&b)+(f&(1<<x)-1)];continue e}if(32&x){i.mode=12;break t}t.msg="invalid literal/length code",i.mode=30;break t}w=65535&b,(x&=15)&&(p<x&&(f+=T[r++]<<p,p+=8),w+=f&(1<<x)-1,f>>>=x,p-=x),p<15&&(f+=T[r++]<<p,p+=8,f+=T[r++]<<p,p+=8),b=g[f&m];i:for(;;){if(f>>>=x=b>>>24,p-=x,!(16&(x=b>>>16&255))){if(0==(64&x)){b=g[(65535&b)+(f&(1<<x)-1)];continue i}t.msg="invalid distance code",i.mode=30;break t}if(v=65535&b,p<(x&=15)&&(f+=T[r++]<<p,(p+=8)<x&&(f+=T[r++]<<p,p+=8)),(v+=f&(1<<x)-1)>l){t.msg="invalid distance too far back",i.mode=30;break t}if(f>>>=x,p-=x,v>(x=n-o)){if((x=v-x)>c&&i.sane){t.msg="invalid distance too far back",i.mode=30;break t}if(k=0,A=u,0===d){if(k+=h-x,x<w){w-=x;do{S[n++]=u[k++]}while(--x);k=n-v,A=S}}else if(d<x){if(k+=h+d-x,(x-=d)<w){w-=x;do{S[n++]=u[k++]}while(--x);if(k=0,d<w){w-=x=d;do{S[n++]=u[k++]}while(--x);k=n-v,A=S}}}else if(k+=d-x,x<w){w-=x;do{S[n++]=u[k++]}while(--x);k=n-v,A=S}for(;w>2;)S[n++]=A[k++],S[n++]=A[k++],S[n++]=A[k++],w-=3;w&&(S[n++]=A[k++],w>1&&(S[n++]=A[k++]))}else{k=n-v;do{S[n++]=S[k++],S[n++]=S[k++],S[n++]=S[k++],w-=3}while(w>2);w&&(S[n++]=S[k++],w>1&&(S[n++]=S[k++]))}break}}break}}while(r<s&&n<a);r-=w=p>>3,f&=(1<<(p-=w<<3))-1,t.next_in=r,t.next_out=n,t.avail_in=r<s?s-r+5:5-(r-s),t.avail_out=n<a?a-n+257:257-(n-a),i.hold=f,i.bits=p}},function(t,e,i){"use strict";var r=i(0),s=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],n=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],a=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(t,e,i,l,h,c,d,u){var f,p,_,g,y,m,b,x,w,v=u.bits,k=0,A=0,T=0,S=0,I=0,z=0,P=0,R=0,C=0,O=0,M=null,E=0,B=new r.Buf16(16),L=new r.Buf16(16),U=null,D=0;for(k=0;k<=15;k++)B[k]=0;for(A=0;A<l;A++)B[e[i+A]]++;for(I=v,S=15;S>=1&&0===B[S];S--);if(I>S&&(I=S),0===S)return h[c++]=20971520,h[c++]=20971520,u.bits=1,0;for(T=1;T<S&&0===B[T];T++);for(I<T&&(I=T),R=1,k=1;k<=15;k++)if(R<<=1,(R-=B[k])<0)return-1;if(R>0&&(0===t||1!==S))return-1;for(L[1]=0,k=1;k<15;k++)L[k+1]=L[k]+B[k];for(A=0;A<l;A++)0!==e[i+A]&&(d[L[e[i+A]]++]=A);if(0===t?(M=U=d,m=19):1===t?(M=s,E-=257,U=n,D-=257,m=256):(M=o,U=a,m=-1),O=0,A=0,k=T,y=c,z=I,P=0,_=-1,g=(C=1<<I)-1,1===t&&C>852||2===t&&C>592)return 1;for(;;){b=k-P,d[A]<m?(x=0,w=d[A]):d[A]>m?(x=U[D+d[A]],w=M[E+d[A]]):(x=96,w=0),f=1<<k-P,T=p=1<<z;do{h[y+(O>>P)+(p-=f)]=b<<24|x<<16|w|0}while(0!==p);for(f=1<<k-1;O&f;)f>>=1;if(0!==f?(O&=f-1,O+=f):O=0,A++,0==--B[k]){if(k===S)break;k=e[i+d[A]]}if(k>I&&(O&g)!==_){for(0===P&&(P=I),y+=T,R=1<<(z=k-P);z+P<S&&!((R-=B[z+P])<=0);)z++,R<<=1;if(C+=1<<z,1===t&&C>852||2===t&&C>592)return 1;h[_=O&g]=I<<24|z<<16|y-c|0}}return 0!==O&&(h[y+O]=k-P<<24|64<<16|0),u.bits=I,0}},function(t,e,i){"use strict";t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},function(t,e,i){"use strict";i.r(e);class r{constructor(){this._listeners=new Map}addListener(t,e){this._listeners.set(t,e)}removeListener(t){this._listeners.delete(t)}fire(...t){for(const[e,i]of this._listeners)e.call(i,...t)}}class s{constructor(t){this._rootCommunicator=t,this._listeners={},this._rootCommunicator.onMessage.addListener(this._onMessage,this)}destructor(){this._rootCommunicator.onMessage.removeListener(this._onMessage)}getCommunicator(t){let e=this._listeners[t];return e||(e=new r,this._listeners[t]=e),{onMessage:e,sendMessage:(e,i,...r)=>{this._rootCommunicator.sendMessage({type:t,message:e},i,...r)}}}_onMessage(t){const e=this._listeners[t.type];e&&e.fire(t.message)}}class n{constructor(t){this._worker=t,this._scheduledFlush=function(t,e=!1){let i=!1;return(...r)=>{e&&i||(Promise.resolve().then(()=>{t(...r),i=!1}),i=!0)}}(()=>t.flushMessages()),this.onMessage=this._onMessage=new r,t.onMessage(t=>{this._onMessage.fire(t)})}sendMessage(t,e,...i){this._worker.addMessage(t,i),e&&this._scheduledFlush()}}class o{constructor(){this._contentPortions=[]}destructor(){for(const t of this._contentPortions)if(t.resources)for(const e of t.resources)e.release()}addContent(t,e){const i={content:t,resources:e};if(this._contentPortions.push(i),i.resources)for(const r of i.resources)r.retain()}hasContent(){return 0!==this._contentPortions.length}}class a extends o{constructor(t,e){super(),this.id=t.id,this.tile=t,this._state=e,this.onStateChanged=this._onStateChanged=new r}get state(){return this._state}set state(t){const e=this._state;t!==e&&(this._state=t,this._onStateChanged.fire(this,e,t))}destructor(){this.state=3,super.destructor()}}class l extends class{constructor(){this._items=new Map,this.onAdded=this._onAdded=new r,this.onRemoved=this._onRemoved=new r}get size(){return this._items.size}get items(){return this._items.values()}get(t){return this._items.get(t)}has(t){return this._items.has(t)}_add(t,e){this._items.set(t,e),this._onAdded.fire(e)}_remove(t){const e=this._items.get(t);e&&(this._items.delete(t),this._onRemoved.fire(e))}}{add(t,e){this._add(t,e)}remove(t){this._remove(t)}}class h extends l{constructor(t){super(),this._communicator=t}add(t,e){super.add(t,e),this._communicator.sendMessage({type:0,id:t,item:this._serialize(e)},!1)}remove(t){super.remove(t),this._communicator.sendMessage({type:1,id:t},!1)}}class c extends h{getOrCreate(t,e){const i=this.get(t.id);if(i)return i;{const i=new a(t,e);return this.add(t.id,i),i}}_serialize(t){return Object.assign(Object.assign({},t.tile),{id:t.id})}}function d(t,e){return t.x+"_"+t.y+"_"+t.zoom+"_"+e}function u(t,e){return Object.assign(Object.assign({},t),{id:d(t,e)})}function f(t,e){const i=[];for(const[r,s]of t)e.has(r)||i.push(s);return i}function p(t,e,i){let r=t.get(e);return r||(r=i(),t.set(e,r)),r}function _(t,e,i=1e-6){const r=t-e;return-i<r&&r<i}function g(t,e){return{x:t,y:e}}const y=g(0,0);g(1,0),g(-1,0),g(0,1),g(0,-1);function m(t,e=g(0,0)){return e.x=t.x,e.y=t.y,e}function b(t,e,i=g(0,0)){return i.x=t.x-e.x,i.y=t.y-e.y,i}function x(t,e,i=g(0,0)){const r=t.x,s=t.y,n=Math.cos(e),o=Math.sin(e);return i.x=n*r-o*s,i.y=o*r+n*s,i}function w(t,e=g(0,0)){const i=t.y;return e.y=t.x,e.x=-i,e}function v(t){return Math.hypot(t.x,t.y)}function k(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))}function A(t,e=g(0,0)){return function(t,e,i=g(0,0)){return i.x=t.x/e,i.y=t.y/e,i}(t,v(t),e)}function T(t,e){return t.x*e.x+t.y*e.y}const S={minX:0,maxX:0,minY:0,maxY:0};function I(t,e,i,r){return{minX:t,maxX:e,minY:i,maxY:r}}function z(t,e=I(0,0,0,0)){return e.minX=t.minX,e.maxX=t.maxX,e.minY=t.minY,e.maxY=t.maxY,e}function P(t,e,i={minX:0,maxX:0,minY:0,maxY:0}){return i.minX=Math.min(t.minX,e.minX),i.minY=Math.min(t.minY,e.minY),i.maxX=Math.max(t.maxX,e.maxX),i.maxY=Math.max(t.maxY,e.maxY),i}function R(t,e,i){return`${t}:${e}:${i}`}function C(t){return R(t.x,t.y,t.zoom)}function O(t,e,i){return e<t?t<i?t:i:e}function M(t,e,i){const r=(t-e)/(i-e);return e+(i-e)*(r-Math.floor(r))}function E(t,e,i){return(1-i)*t+i*e}function B(t,e,i){const r=O((i-t)/(e-t),0,1);return r*r*(3-2*r)}const L={direction:g(0,-1),normal:g(-1,0),diagonal:g(-1,-1),prevSide:()=>N,nextSide:()=>D},U={direction:g(0,1),normal:g(1,0),diagonal:g(1,1),prevSide:()=>D,nextSide:()=>N},D={direction:g(1,0),normal:g(0,-1),diagonal:g(1,-1),prevSide:()=>L,nextSide:()=>U},N={direction:g(-1,0),normal:g(0,1),diagonal:g(-1,1),prevSide:()=>U,nextSide:()=>L};function j(t,e,i,r,s){t.x=r?M(t.x,0,i):t.x,t.y=s?M(t.y,0,i):t.y,0<=t.x&&t.x<i&&0<=t.y&&t.y<i&&e.set(C(t),t)}function V(t,e,i,r,s,n){for(let l=1;l<=i;l++)j({x:e.currentTile.x+l*e.currentTileSide.normal.x,y:e.currentTile.y+l*e.currentTileSide.normal.y,zoom:e.currentTile.zoom},e.beltTiles,r,s,n);const o=t.get(R(e.currentTile.x+e.currentTileSide.diagonal.x,e.currentTile.y+e.currentTileSide.diagonal.y,e.currentTile.zoom));if(o)return e.currentTile=o,void(e.currentTileSide=e.currentTileSide.prevSide());const a=t.get(R(e.currentTile.x+e.currentTileSide.direction.x,e.currentTile.y+e.currentTileSide.direction.y,e.currentTile.zoom));if(a)e.currentTile=a;else{for(let t=1;t<=i;t++)for(let o=1;o<=i;o++)j({x:e.currentTile.x+t*e.currentTileSide.diagonal.x,y:e.currentTile.y+o*e.currentTileSide.diagonal.y,zoom:e.currentTile.zoom},e.beltTiles,r,s,n);e.currentTileSide=e.currentTileSide.nextSide()}}class W{constructor(t,e){this._communicator=t,this._storage=e,this._visibleTiles=new Map,this._beltTiles=new Map,this.onViewportChanged=this._onViewportChanged=new r,this._cameraPosition={x:0,y:0,zoom:0},this._communicator.onMessage.addListener(this._onMessage,this)}get cameraPosition(){return this._cameraPosition}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}_onMessage(t){switch(t.type){case 0:this._onSetup(t);break;case 1:this._onViewportUpdate(t)}}_onSetup(t){this._tileIdPrefix=t.tileIdPrefix,this._preloadedTilesBeltWidth=t.preloadedTilesBeltWidth,this._useLowPrecisionBeltTiles=t.useLowPrecisionBeltTiles,this._wrapModeX=t.wrapModeX,this._wrapModeY=t.wrapModeY}_onViewportUpdate(t){const e=this._visibleTiles;for(const o of t.visibleTilesToAdd)this._visibleTiles.set(o.id,o);for(const o of t.visibleTilesToRemove)this._visibleTiles.delete(o.id);const i=this._beltTiles,r=this._calculateBeltTiles(e),s=f(r,i),n=f(i,r);for(const o of t.visibleTilesToAdd){this._storage.getOrCreate(o,0).state=0}for(const o of s){this._storage.getOrCreate(o,1).state=1}for(const o of t.visibleTilesToRemove){const t=this._storage.getOrCreate(o,0);1!==t.state&&(t.state=2)}for(const o of n){const t=this._storage.getOrCreate(o,1);0!==t.state&&(t.state=2)}this._visibleTiles=e,this._beltTiles=r,this._cameraPosition=t.cameraPosition,this._onViewportChanged.fire({cameraPosition:t.cameraPosition,visibleAdded:t.visibleTilesToAdd,visibleRemoved:t.visibleTilesToRemove,preloadedAdded:s,preloadedRemoved:n})}_calculateBeltTiles(t){const e=new Map;let i;if(this._useLowPrecisionBeltTiles){i=this._getCoveringParents(t);for(const r of i.values())for(let i=0;i<=1;i++)for(let s=0;s<=1;s++){const n=u({x:2*r.x+i,y:2*r.y+s,zoom:r.zoom+1},this._tileIdPrefix);t.has(n.id)||e.set(n.id,n)}}else i=t;for(const r of function(t,e,i,r){const s=new Map,n=new Map;for(const a of t)s.set(C(a),a);const o=new Map(s);for(;o.size>0;){let t={x:Number.POSITIVE_INFINITY,y:0,zoom:0};for(const e of o.values())e.x<t.x&&(t=e);const s=[],a=[],l={currentTile:t,currentTileSide:L,beltTiles:n},h=Object.assign({},l),c=Math.pow(2,t.zoom);do{V(o,h,e,c,i,r);const t=h.currentTile.x-l.currentTile.x;s[t]=void 0===s[t]?h.currentTile.y:Math.max(s[t],h.currentTile.y),a[t]=void 0===a[t]?h.currentTile.y:Math.min(a[t],h.currentTile.y)}while(h.currentTile!==l.currentTile||h.currentTileSide!==l.currentTileSide);const d=t.zoom;for(let e=0;e<s.length;e++){const i=t.x+e;for(let t=a[e];t<=s[e];t++)o.delete(R(i,t,d))}}for(const a of n.keys())s.has(a)&&n.delete(a);return n.values()}(i.values(),this._preloadedTilesBeltWidth,2===this._wrapModeX,2===this._wrapModeY)){const t=u(r,this._tileIdPrefix);e.set(t.id,t)}return e}_getCoveringParents(t){const e=new Map;for(const i of t.values()){const t=i.zoom-1;if(t>=0){const r=u({x:i.x/2|0,y:i.y/2|0,zoom:t},this._tileIdPrefix);e.set(r.id,r)}}return e}}function*F(t,e){for(const i of t)yield e(i)}function*q(t,e){for(const i of t)e(i)&&(yield i)}function*Y(t,e,i=((t,e)=>[t,e])){const r=t[Symbol.iterator](),s=e[Symbol.iterator]();for(let n=r.next(),o=s.next();!n.done&&!o.done;n=r.next(),o=s.next())yield i(n.value,o.value)}var X=i(2),G=X.yandex.maps.proto.renderer.vmap2.Presentation,Z=X.yandex.maps.proto.renderer.vmap2.Tile,H=X.yandex.maps.proto.renderer.glyphs.GlyphList,K=X.yandex.maps.proto.renderer.layers.basemap.Tag,Q=X.yandex.maps.proto.indoor.Plan;X.yandex.maps.proto.common2.geometry.BoundingBox;function $(t){return t?t.classId.length:0}function J(t,e,i,r,s,n){let o=t.get(e);o||(o=new Map,t.set(e,o));for(let a=0;a<i.length;++a)o.set(i[a],r[s+a]);o.set("objectId",n)}function tt(t){const e={points:new Map,polylines:new Map,polygons:new Map,pointLabels:new Map,curvedLabels:new Map},{points:i,polylines:r,polygons:s,pointLabels:n,layers:o}=t,a=$(i),l=a+$(r),h=l+$(s),c=h+$(n);for(const d of o){const{keys:t,values:i}=d;if(0!==t.length)for(let r=0,s=0,n=d.ids.length;r<n;++r,s+=t.length){const n=d.objectIndices[r],o=d.ids[r];switch(!0){case n>=c:J(e.curvedLabels,n-c,t,i,s,o);break;case n>=h:J(e.pointLabels,n-h,t,i,s,o);break;case n>=l:J(e.polygons,n-l,t,i,s,o);break;case n>=a:J(e.polylines,n-a,t,i,s,o);break;default:J(e.points,n,t,i,s,o)}}}return function(t,e){const{polygons:i}=t;if(i)for(let r=0,s=0;r<i.classId.length;r++){const t=i.contourIndex[r],n=e.polygons.get(r);if(!n||t<0)continue;const o=i.contourCount[s];for(let i=0;i<o;i++)e.polylines.set(t+i,n);s++}}(t,e),e}function et(t){return 2/(1<<t)}class it{constructor(t){this._zoom=Math.ceil(O(t,0,31)),this._tileSize=et(this._zoom)}getZoom(){return this._zoom}getTileSize(){return this._tileSize}getTileOffset(t){return{x:this.getTileSize()*t.x-1,y:1-this.getTileSize()*t.y}}toTileCoordinates(t){return{x:(t.x+1)/this._tileSize,y:(1-t.y)/this._tileSize}}}function rt(t,e){return-16384===t||16383===t||-16384===e||16383===e}class st{constructor(t){const e=new it(t.zoom),i=e.getTileOffset(t),r=e.getTileSize(),s=r/2;this._tileCenter=g(i.x+s,i.y-s),this._tileWorldRatio=r/32767}toWorldXCoordinate(t){return O(this._tileCenter.x+t*this._tileWorldRatio,-1,1)}toWorldYCoordinate(t){return O(this._tileCenter.y-t*this._tileWorldRatio,-1,1)}toWorldZCoordinate(t){return t*this._tileWorldRatio}toWorldCoordinates(t,e){return g(this.toWorldXCoordinate(t),this.toWorldYCoordinate(e))}}const nt={minZoom:0,maxZoom:0,zIndex:0,classId:0};function*ot(t,e,i,r,s=at(0)){const n=(t.find(t=>t.name===s)||t[0]).classes[e];if(n)for(const o of n.slices)if(o.visibility){nt.minZoom=o.visibility.min===r.zoom?-1/0:o.visibility.min,nt.maxZoom=o.visibility.max===r.zoom?1/0:o.visibility.max,nt.zIndex=o.zIndex,nt.classId=e;const t=i(o,nt);t&&(yield t)}}function at(t){switch(t){case 0:return"map";case 1:return"map.night"}}ht(0,0,0,1),ht(1,1,0,1);const lt=ht(0,0,0,0);function ht(t,e,i,r=1){return{r:t,g:e,b:i,a:r}}function ct(t){return{r:(t>>>24)/255,g:(t>>>16&255)/255,b:(t>>>8&255)/255,a:(255&t)/255}}function dt(t,e,i,r){return 255*t|255*e<<8|255*i<<16|255*r<<24}function ut(t){return dt(t.r,t.g,t.b,t.a)}const ft=/^(0x|#)?(([a-fA-F0-9]{3}){1,2}|([a-fA-F0-9]{4}){1,2})$/;function pt(t,e,i){const r=t.substring(i*e,(i+1)*e),s=(1<<4*e)-1;return parseInt(r,16)/s}function _t(t){const e=ft.exec(t);if(!e)return null;const i=e[2],r=i.length>4?2:1;return ht(pt(i,r,0),pt(i,r,1),pt(i,r,2),i.length%4?1:pt(i,r,3))}function gt(t){const e=(255*t).toString(16);return 2===e.length?e:"0"+e}function yt(t){const{r:e,g:i,b:r,a:s}=t;return gt(e)+gt(i)+gt(r)+(s<1?gt(s):"")}const mt={min:512,max:65535},bt={min:65536,max:4294967294};const xt=new Array;function wt(t){switch(t){case 1:return-1;case 2:return-2;default:return 0}}function vt(t,e){return t.zoom-wt(e)}function kt(t,e){return(t&e)===e}function At(t,e){return 0!=(t&e)}const Tt=[],St={};function It(t){const e=[0,0];for(const i of t)e[i/32&1]|=1<<i%32;return e}function zt(t){const e=[];for(const i of t){const t="number"==typeof i?i:St[i];if(void 0===t)return console.warn(`unknown "tag": "${i}"`),null;e.push(t)}return It(e)}function Pt(t,e){return At(t[0],e[0])||At(t[1],e[1])}function Rt(t,e,i){if(void 0===t&&void 0===e&&void 0===i)return()=>!0;const r=t&&zt(t),s=e&&zt(e),n=i&&zt(i);return null===r||null===s||null===n?(console.warn(`not valid "tags": all=[${t||[]}] any=[${e||[]}] none=[${i||[]}]`),()=>!1):t=>{const e=It(t);return(!r||(o=r,kt((i=e)[0],o[0])&&kt(i[1],o[1])))&&(!s||Pt(e,s))&&(!n||!Pt(e,n));var i,o}}function Ct(t,e){const i=t.metadata[e],r=i&&i[".yandex.maps.proto.renderer.common.TAG_METADATA"];return r?r.tags:Tt}function*Ot(t,e,i,r){let s=0,n=0;for(let o=0;o<i;o++)s+=t.coordsx[e],n+=t.coordsy[e],yield r.toWorldCoordinates(s,n),e++}function*Mt(t,e,i,r,s){for(let n=0;n<r;n++){const r=t.ringSize[i+n];yield Ot(t,e,r,s),e+=r}}function Et(t,e,i,r,s,n,o){if(o&&o.bbox){return{id:t,metadata:e,objectId:(1===n?"night_":"")+o.objectId,meshId:o.meshId,bbox:{minX:r.toWorldXCoordinate(o.bbox.minX),maxX:r.toWorldXCoordinate(o.bbox.maxX),minY:r.toWorldYCoordinate(o.bbox.maxY),maxY:r.toWorldYCoordinate(o.bbox.minY),minZ:i,maxZ:0},color:s[0].color}}}function Bt(t,e){if(t.poly){const i=!!t.poly.extrusion&&t.poly.extrusion.enabled;return Object.assign(Object.assign({},e),{color:ct(t.poly.color),pattern:t.poly.pattern?{imageId:t.poly.pattern.id,scale:t.poly.pattern.scale}:void 0,extruded:i,height:i?t.poly.extrusion.height:0})}}function*Lt(t,e,i,r,s,n,o){const{polygons:a}=e;if(a){const l=new st(t);let h=0,c=0,d=0;const u=a.mesh.reduce((t,e)=>(t.set(e.polygonId,e),t),new Map);for(;h<a.ringCount.length;){const f=a.ringCount[h],p=c,_=d,g=a.classId[h],y=i.polygons.get(h),m=Ct(a,h),b=[...ot(e.presentation,g,Bt,t,at(n))];o.customizePolygon(b,m,vt(t,s));const x=y?r(y.get("objectId")):4294967295,w=b[0]&&b[0].extruded,v=w?l.toWorldZCoordinate(a.height[h]||b[0].height||0):0,k=w?Et(x,y,v,l,b,n,u.get(h)):void 0;let A=0;for(let t=0;t<f;t++)A+=a.ringSize[c+t];const T=[...F(Mt(a,_,p,f,l),t=>[...t])],S=a.contourIndex[h];yield{id:x,vertexRings:T,height:v,externalMesh:k,metadata:y,styles:b,hasContour:-1===S},c+=f,d+=A,h++}}}function Ut(t,e=.5){const i=new Array(t.length);i[0]=0;for(let d=1;d<t.length;++d)i[d]=i[d-1]+k(t[d-1],t[d]);const r=e*i[t.length-1],s=i.findIndex(t=>t>=r)||1,n=function(t,e,i,r=g(0,0)){return r.x=(1-i)*t.x+i*e.x,r.y=(1-i)*t.y+i*e.y,r}(t[s-1],t[s],(r-i[s-1])/(i[s]-i[s-1]||1)),o=new Array(s+1);for(let d=0;d<s;++d)o[d]=t[d];o[s]=n;const a=function(t,e,i=1e-6){return _(t.x,e.x,i)&&_(t.y,e.y,i)}(t[s],n,1e-6*r),l=t.length-s,h=new Array(l+(a?0:1));let c=0;a||(h[c++]=m(n));for(let d=0;d<l;d++)h[c++]=t[s+d];return[o,h]}Object.keys(K).forEach(t=>{St[t.toLowerCase()]=K[t]});const Dt={[G.Class.LineStyle.JoinStyle.JoinMiter]:0,[G.Class.LineStyle.JoinStyle.JoinRound]:1,[G.Class.LineStyle.JoinStyle.JoinBevel]:2},Nt={[G.Class.LineStyle.CapStyle.CapButt]:0,[G.Class.LineStyle.CapStyle.CapSquare]:2,[G.Class.LineStyle.CapStyle.CapRound]:1};function jt(t){return{strokeColor:t.pattern?lt:ct(t.color),strokeWidth:t.width,join:Dt[t.joins],startCap:Nt[t.caps],endCap:Nt[t.caps],dash:t.dash?{fill:t.dash.dashes[0].fill,gap:t.dash.dashes[0].gap}:void 0,pattern:t.pattern?{imageId:t.pattern.id,scale:t.pattern.scale,height:t.width}:void 0}}function Vt(t,e){const i=t.line&&t.line.line||t.poly&&t.poly.contour,r=t.line&&t.line.outline;return i||r?Object.assign(Object.assign({},e),{inline:i?jt(i):void 0,outline:r?jt(r):void 0}):void 0}function Wt(t,e){const i=t.poly&&t.poly.contour;return i?Object.assign(Object.assign({},e),{inline:jt(i),outline:void 0}):void 0}function*Ft(t,e,i,r,s,n){let o=0;for(const a of i){const i=a.styles[0],l=Ct(e.polygons,o);if(++o,!a.hasContour||!i)continue;const h=[...ot(e.presentation,i.classId,Wt,t,at(s))];if(h[0]){n.customizePolygonContour(h,l,vt(t,r));for(const t of a.vertexRings)yield{vertices:t.concat(t[0]),styles:h,id:a.id,metadata:a.metadata}}}}function*qt(t,e,i,r,s,n,o){const a=e.polylines;if(!a)return;const l=(i,r,a,l,h,c,d,u)=>{const f=[...ot(e.presentation,r,Vt,t,at(n))];o.customizePolyline(f,h,vt(t,s));for(const t of f)t.zIndex+=a,void 0!==d&&(t.inline&&(t.inline.startCap=d),t.outline&&(t.outline.startCap=d)),void 0!==u&&t.inline&&(t.inline&&(t.inline.endCap=u),t.outline&&(t.outline.endCap=u));return{vertices:i,styles:f,metadata:l,id:c}},h=new st(t);for(let c=0,d=0;c<a.lineSize.length;++c){const t=0|a.zOrderBegin[c],e=0|a.zOrderEnd[c],s=a.lineSize[c],n=new Array(s);let o,u,f=0,p=0;for(let i=0;i<s;++i,++d)f+=a.coordsx[d],p+=a.coordsy[d],0===i&&rt(f,p)&&(o=0),i===s-1&&rt(f,p)&&(u=0),n[i]=g(h.toWorldXCoordinate(f),h.toWorldYCoordinate(p));const _=i.polylines.get(c),y=_?r():4294967295,m=Ct(a,c);if(t!==e){const i=Ut(n);yield l(i[0],a.classId[c],t,_,m,y,o,u),yield l(i[1],a.classId[c],e,_,m,y,o,u)}else yield l(n,a.classId[c],t,_,m,y,o,u)}}function Yt(t){return t.styles.length>0}function Xt(t){return{color:ct(t.color),outlineColor:ct(t.outlineColor),fontId:t.fontId,fontSize:t.fontSize}}function Gt(t,e){const i=[];if(t.label)return t.label.text&&i.push(Xt(t.label.text)),t.label.textAlt&&i.push(Xt(t.label.textAlt)),Object.assign(Object.assign({},e),{distance:0,styles:i,align:1,background:t.label.background?{color:ct(t.label.background.color),verticalPadding:t.label.background.vPadding,horizontalPadding:t.label.background.hPadding}:void 0})}const Zt={[Z.StraightLabels.AlignType.Left]:0,[Z.StraightLabels.AlignType.Right]:2,[Z.StraightLabels.AlignType.Center]:1};function*Ht(t,e){t.text[e]&&t.text[e].strings.length&&(yield{textLines:t.text[e].strings.map(t=>({glyphIds:t.glyphs}))}),t.textAlt[e]&&t.textAlt[e].strings.length>0&&(yield{textLines:t.textAlt[e].strings.map(t=>({glyphIds:t.glyphs}))})}function Kt(t,e){const i=Gt(t,e);return i&&t.label&&(i.distance=t.label.vdistance),i}function*Qt(t,e,i,r,s,n,o){const{pointLabels:a}=e;if(a){const l=new st(t);for(let h=0;h<a.text.length;h++){const c=a.classId[h],d=[...ot(e.presentation,c,Kt,t,at(n))];for(const t of d)t.align=Zt[a.align[h]];const u=Ct(a,h);o.customizePointLabel(d,u,vt(t,s));const f=l.toWorldCoordinates(a.centerX[h],a.centerY[h]),p=r(),_=i.pointLabels.get(h);_&&_.set("position",`${f.x},${f.y}`),yield{id:p,anchorPoint:f,offset:g(a.offsetX[h],a.offsetY[h]),texts:[...Ht(a,h)],priority:a.priority[h],styles:d,metadata:_}}}}function*$t(t,e,i,r){let s=0,n=0;for(let o=0;o<i;o++)yield r.toWorldCoordinates(s+=t.vertexX[e+o],n+=t.vertexY[e+o])}function*Jt(t,e){t.text[e]&&(yield{textLines:[{glyphIds:t.text[e].glyphs}]}),t.textAlt[e]&&t.textAlt[e].glyphs.length>0&&(yield{textLines:[{glyphIds:t.textAlt[e].glyphs}]})}function te(t,e){const i=Gt(t,e);return i&&t.label&&t.label.hdistance&&(i.distance=t.label.hdistance),i}function*ee(t,e,i,r,s,n,o){const{polylineLabels:a}=e;if(a){const l=new st(t);let h=0;for(let c=0;c<a.text.length;c++){const d=a.classId[c],u=a.verticesCount[c],f=r();if(u>=2){const r=[...ot(e.presentation,d,te,t,at(n))],p=Ct(a,c);o.customizeCurvedLabel(r,p,vt(t,s)),yield{id:f,polyline:[...$t(a,h,u,l)],texts:[...Jt(a,c)],styles:r,metadata:i.curvedLabels.get(c),priority:a.priority[c]}}else console.warn(`Curved label with ${u} vertices extracted`);h+=u}}}const ie=-1+Math.pow(2,-23),re=1-Math.pow(2,-23);function se(t){return O(t/8388607,ie,re)}function ne(t,e){const i=O(t,-2097152,2097151);return O(2*((i- -2097152|e<<22)/16777215)-1,ie,re)}function oe(t,e){return g(-t,e-1)}function ae(t,e){const i=t.point;return i&&i.icon?Object.assign(Object.assign({},e),{imageId:i.icon.id,offset:oe(i.anchorX,i.anchorY),scale:i.icon.scale,selectedIcon:i.selectedIcon?{imageId:i.selectedIcon.id,offset:oe(i.selectedAnchorX,i.selectedAnchorY),scale:i.selectedIcon.scale}:void 0}):void 0}function*le(t,e,i,r,s,n,o,a,l){var h,c,d,u;const{points:f}=e;if(f){const p=new st(t);for(let _=0;_<f.classId.length;_++){const g=p.toWorldCoordinates(f.coordsx[_],f.coordsy[_]),y=i.points.get(_);y&&y.set("position",`${g.x},${g.y}`);const m=Ct(f,_),b=null===(h=y)||void 0===h?void 0:h.get("objectId"),x=b?s.find(t=>{var e;return(null===(e=t.metadata)||void 0===e?void 0:e.get("objectId"))===b}):s.find(t=>t.anchorPoint.x===g.x&&t.anchorPoint.y===g.y),w=x?x.id:r(),v=[...ot(e.presentation,f.classId[_],ae,t,at(o))];if(a.customizePoint(v,m,vt(t,n)),l){const t=null===(c=x)||void 0===c?void 0:c.metadata;y&&l(y,v),t&&l(t,v)}const k=null!=(u=null===(d=x)||void 0===d?void 0:d.priority)?u:2097151;yield{position:g,styles:v,priority:k,metadata:y,id:w}}}}function he(...t){const e={};let i,r,s;for(const n of t)n&&(Object.assign(e,n.content.primitives),n.content.references&&(i=i||[],i.push(...n.content.references)),n.contentToRemove&&(r=r||[],r.push(...n.contentToRemove)),n.metrics&&(s=s||{},Object.assign(s,n.metrics)));return{content:{primitives:e,references:i},contentToRemove:r,metrics:s}}const ce=Date.now();const de="performance"in self&&"now"in performance?performance.now.bind(performance):function(){return Date.now()-ce};class ue extends class{constructor(t,e,i){this._taskQueue=t,this._priority=e,this._contentPriority=i,this.onContentReady=this._onContentReady=new r,this._scheduleStart=void 0,this._queueWaitingTime=void 0,this._state=0,this._taskStage=0,this._subTasks=[]}get state(){return this._state}destructor(){1===this._state&&this.pause()}start(){0===this._state&&(this._startImpl(),this._state=1);for(const t of this._subTasks)t.start()}pause(){1===this._state&&(this._pauseImpl(),this._state=2);for(const t of this._subTasks)t.pause()}resume(){2===this._state&&(this._resumeImpl(),this._state=1);for(const t of this._subTasks)t.resume()}resetPriority(t){switch(this._priority=t,this._taskStage){case 1:this._taskQueue.remove(this._processingTask),this._processingTask=this._createTask(this._processingTask.execute),this._enqueueProcessingTask();break;case 2:this._processingTask=this._createTask(this._processingTask.execute)}for(const e of this._subTasks)e.resetPriority(t)}_pauseImpl(){switch(this._taskStage){case 1:this._taskQueue.remove(this._processingTask),this._taskStage=2}}_resumeImpl(){switch(this._taskStage){case 2:this._enqueueProcessingTask(),this._taskStage=1}}_startSubTask(t){this._subTasks.push(t),t.onContentReady.addListener(this._onSubTaskContent,this),t.start()}_onSubTaskContent(t){console.warn("Sub task output is not handled",t)}_scheduleProcessing(t){switch(this._taskStage){case 0:this._scheduleStart=de(),this._processingTask=this._createTask(()=>{this._queueWaitingTime=de()-this._scheduleStart;const e=this._process(t);e&&this._onContentReady.fire(e),this._state=3,this._taskStage=3}),this._enqueueProcessingTask(),this._taskStage=1}}_getTaskPriority(){return this._priority+this._contentPriority}_createTask(t){return{execute:t,priority:this._getTaskPriority()}}_enqueueProcessingTask(){this._taskQueue.enqueueSync(this._processingTask)}}{constructor(t,e,i){super(t,e,i),this._stage=0,this._loadStart=void 0,this._loadTime=void 0}resetPriority(t){super.resetPriority(t)}_startImpl(){switch(this._stage){case 0:case 2:this._load()}}_pauseImpl(){switch(super._pauseImpl(),this._stage){case 1:this._loadCancel(),this._stage=2}}_resumeImpl(){switch(super._resumeImpl(),this._stage){case 0:case 2:this._load()}}_load(){this._loadStart=de(),this._request=this._loadImpl(),this._request.then(this._onResponse.bind(this),this._onResponseError.bind(this)),this._stage=1}_onResponse(t){switch(this._stage){case 1:this._stage=3,this._loadTime=de()-this._loadStart,this._scheduleProcessing(t)}}_onResponseError(t){this.pause()}}function fe(t,e){return e.vertexByteOffset+e.vertexByteLength===t.vertexByteOffset&&e.indexByteOffset+e.indexByteLength===t.indexByteOffset&&e.bufferId===t.bufferId&&(e.vertexByteLength+=t.vertexByteLength,e.indexByteLength+=t.indexByteLength,!0)}function*pe(t,e,i,r=(()=>!0)){const s=t[Symbol.iterator]();let n=s.next().value;if(!n)return;let o=n,a=i(o);for(n=s.next().value;n;){const t=e(n);r(o,n,a)&&fe(t,a)||(yield a,a=i(n)),o=n,n=s.next().value}yield a}function _e(t){return F(pe(t,t=>t.location,t=>Object.assign(Object.assign({},t.location),{id:t.id,metadata:t.metadata}),(t,e)=>{var i,r;return(null===(i=t.metadata)||void 0===i?void 0:i.get("objectId"))===(null===(r=e.metadata)||void 0===r?void 0:r.get("objectId"))}),t=>({location:t,id:t.id,metadata:t.metadata}))}function ge(t){return F(pe(t,t=>t.location,t=>Object.assign(Object.assign({},t.location),{id:t.id,atlasId:t.atlasId,metadata:t.metadata}),(t,e)=>{var i,r;return t.atlasId===e.atlasId&&(null===(i=t.metadata)||void 0===i?void 0:i.get("objectId"))===(null===(r=e.metadata)||void 0===r?void 0:r.get("objectId"))}),t=>({location:t,id:t.id,atlasId:t.atlasId,metadata:t.metadata}))}function ye(t){return t>1e4?1:128}function me(t,e){return t-t%e}class be{constructor(t=[]){this._fontGlyphRanges=new Map;for(const e of t)this.addRangesForGlyphs(e[0],e[1])}addRangesForGlyphs(t,...e){let i=this._fontGlyphRanges.get(t);i||(i=new Map,this._fontGlyphRanges.set(t,i));for(const r of e){const t=ye(r),e=me(r,t);i.set(e,e+t)}}contains(t,e){const i=this._fontGlyphRanges.get(t);return!!i&&i.has(e)}containsAll(t){for(const[e,i]of t)for(const[t]of i)if(!this.contains(e,t))return!1;return!0}isEmpty(){return 0===this._fontGlyphRanges.size}clear(){this._fontGlyphRanges.clear()}*[Symbol.iterator](){yield*this._fontGlyphRanges.entries()}}function xe(t,e,i,r,s){const n=t.glyphIds,o=n.length,a=[];for(let l=0;l<o;l++){const t=r.glyphs[n[l]],o=e+(t.bearingX-r.margin)*s,h=e+(t.bearingX+t.width+r.margin)*s,c=i+(t.bearingY+r.margin)*s,d=i+(t.bearingY-t.height-r.margin)*s,u=g(o,c),f=g(h,c),p=g(h,d),_=g(o,d),y={fontId:r.id,glyphId:t.id,scale:s,topLeft:u,topRight:f,bottomRight:p,bottomLeft:_};a.push(y),e+=t.advance*s}return a}function we(t,e,i){const r=[],s=t.texts.map((t,r)=>{const s=e.styles[r],n=i.get(s.fontId),o=s.fontSize,a=o/n.xheight,l=n.height?n.height*a:2*o;return t.textLines.map(t=>{const e=function(t,e){return e.glyphIds.reduce((e,i)=>e+t.glyphs[i].advance,0)}(n,t)*a;return{line:t,font:n,scale:a,width:e,height:l,fontSize:o}})}),n=s.reduce((t,e)=>e.reduce((t,e)=>(t.width=Math.max(t.width,e.width),t.height+=e.height,t),t),{width:0,height:e.distance*(s.length-1)}),o=t.offset.x-n.width/2;let a=t.offset.y+n.height/2,l=!0;for(const h of s){const t=[];for(const i of h){const r=a-=i.height-(l?i.fontSize/2:0),s=o+(0===e.align?0:1===e.align?(n.width-i.width)/2:2===e.align?n.width-i.width:0),h=xe(i.line,s,r,i.font,i.scale);t.push(h),l=!1}a-=e.distance,r.push(t)}return r}function ve(t,e){return t>e?1:t<e?-1:0}function ke(t,e,i){const r=t[e];t[e]=t[i],t[i]=r}function Ae(t,e=0,i=t.length){for(let r=e,s=i-1;r<s;++r,--s)ke(t,r,s)}function Te(t,e=1,i=0,r=t.length){Ae(t,i,r),Ae(t,i,i+e),Ae(t,i+e,r)}function Se(t,e,i=0,r=t.length,s=0){for(let n=i,o=s;n<r;++n,++o)e[o]=t[n]}function Ie(t,e,i){const r=Math.min(e.length,i.length);for(let s=0;s<r;s++){const r=t(e[s],i[s]);if(r)return r}return e.length-i.length}function ze(t,e=ve,i=0,r=t.length){for(let s=i;s<r;++s)for(let r=s;r>i&&e(t[r-1],t[r])>0;--r)ke(t,r-1,r)}function Pe(t,e,i,r,s,n,o){let a=o,l=r,h=s;for(;l<s&&h<n;)e[a++]=i(t[l],t[h])>0?t[h++]:t[l++];Se(t,e,l,s,a),Se(t,e,h,n,a)}function Re(t,e,i){const r=[];let s=0;for(const[o,a]of function(t,e,i=((t,e)=>[t,e])){const r=Math.min(t.length,e.length),s=new Array(r);for(let n=0;n<r;++n)s[n]=i(t[n],e[n]);return s}(t.texts,e.styles)){const t=[],n=i.get(a.fontId),l=a.fontSize/n.xheight,h=a.fontSize/2;for(const e of o.textLines)for(const i of e.glyphIds){const e=n.glyphs[i],r=(e.bearingY+n.margin)*l,o=(e.bearingY-e.height-n.margin)*l,a=(e.bearingX-n.margin)*l,c=(e.bearingX+e.width+n.margin)*l,d=(c-a)/2,u=a-d,f=c-d,p=r-h,_=o-h;t.push({fontId:n.id,glyphId:i,scale:l,topLeft:{x:u,y:p},topRight:{x:f,y:p},bottomRight:{x:f,y:_},bottomLeft:{x:u,y:_},lineDisplacement:s+d}),s+=e.advance*l}s+=e.distance,r.push(t)}s-=e.distance;const n=s/2;for(const o of r)for(const t of o)t.lineDisplacement-=n;return r}class Ce extends ue{constructor(t,e,i,r,s,n,o,a,l=2e3){super(i,a,l),this._glyphAtlasRegistry=s,this._pointLabelsBufferWriter=n,this._curvedLabelsBufferWriter=o,this._pointLabels=t,this._curvedLabels=e,this._requiredGlyphs=this._getRequiredGlyphs(t,this._requiredGlyphs),this._requiredGlyphs=this._getRequiredGlyphs(e,this._requiredGlyphs),this._collisionPriority=r}canBeProcessedSynchronously(){return this._requiredGlyphs.isEmpty()||this._glyphAtlasRegistry.hasAllGlyphsLoaded(this._requiredGlyphs)}processSynchronously(){return this._requiredGlyphs.isEmpty()?this._createContentPortion([],[],void 0):this._process(this._glyphAtlasRegistry.getAtlasWithGlyphs(this._requiredGlyphs))}_process(t){return this._createContentPortion(this._writePointLabels(t),this._writeCurvedLabels(t),this._loadTime)}_loadImpl(){return this._glyphAtlasRegistry.loadGlyphsAndGetAtlas(this._requiredGlyphs,Math.floor(this._getTaskPriority()))}_loadCancel(){}_createContentPortion(t,e,i){return{content:{primitives:{4:t,5:e}},metrics:{glyphsAndResourcesLoadTime:i}}}_getRequiredGlyphs(t,e=new be){for(const i of t){const{texts:t,styles:r}=i,s=r[0];for(let i=0;i<t.length;i++){const r=s.styles[i];if(r){const{fontId:s}=r,n=t[i].textLines.reduce((t,e)=>(t.push(...e.glyphIds),t),[]);e.addRangesForGlyphs(s,...n)}}}return e}_writePointLabels(t){const e=[];for(const i of this._pointLabels){const r=i.id,s=i.styles[0],n=we(i,s,this._glyphAtlasRegistry.loadedFonts),o=t.allocatedGlyphs,a=this._pointLabelsBufferWriter.writePointLabel(r,i,s,n,o,this._collisionPriority);e.push({id:r,location:a,metadata:i.metadata,atlasId:t.id})}return[...ge(e)]}_writeCurvedLabels(t){const e=[];for(const i of this._curvedLabels){const r=i.id,s=i.styles[0],n=Re(i,s,this._glyphAtlasRegistry.loadedFonts),o=t.allocatedGlyphs,a=this._curvedLabelsBufferWriter.writeLabel(i,s,n,o,r,this._collisionPriority);e.push({location:a,metadata:i.metadata,atlasId:t.id})}return[...ge(e)]}}var Oe=function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function o(t){try{l(r.next(t))}catch(e){n(e)}}function a(t){try{l(r.throw(t))}catch(e){n(e)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}l((r=r.apply(t,e||[])).next())}))};const Me={imageSize:{width:0,height:0},atlasId:-1,atlasLocation:S};class Ee extends ue{constructor(t,e,i,r,s,n,o=1e3){super(e,n,o),this._iconAtlasRegistry=r,this._iconBufferWriter=s,this._icons=t,this._iconDataList=this._icons.map(t=>{const{imageId:e,scale:i,scaleFactor:s,transformer:n}=t.styles[0];return r.getIconData(e,i*(null!=s?s:1),n)||Me}),this._collisionPriority=i}canBeProcessedSynchronously(){return!function(t,e){for(const i of t)if(e(i))return!0;return!1}(this._iconDataList,t=>t===Me)}processSynchronously(){return this._process()}_process(){return{content:{primitives:{6:this._writeIcons()}},metrics:{glyphsAndResourcesLoadTime:this._loadTime}}}_loadImpl(){return Oe(this,void 0,void 0,(function*(){const t=[];for(let e=0;e<this._iconDataList.length;e++)if(this._iconDataList[e]===Me){const i=e,{imageId:r,scale:s,scaleFactor:n,transformer:o}=this._icons[e].styles[0],a=this._iconAtlasRegistry.loadIcon(r,Math.floor(this._getTaskPriority()),s*(null!=n?n:1),o).then(t=>{this._iconDataList[i]=t});t.push(a)}return yield Promise.all(t),this._iconDataList}))}_loadCancel(){}_writeIcons(){const t=[];for(let e=0;e<this._icons.length;e++){const i=this._icons[e],r=this._iconDataList[e],s=i.styles[0],n=1/this._iconAtlasRegistry.getDpr(),o=this._iconBufferWriter.writeIcon(i,r.atlasLocation,r.imageSize,s.offset,n,this._collisionPriority);t.push({location:o,id:i.id,metadata:i.metadata,atlasId:r.atlasId,zIndex:s.zIndex})}return t}}function Be(t){return 255*t|0}function Le(t){return 65535*t|0}function Ue(t){return(65535*t-1)/2|0}function De(t,e){return e<<16|65535&t}function Ne(t){return 4294967295*(.5*(t+1))|0}function je(t,e){return De(t>>>16,e>>>16)}function Ve(t,e){return De(t,e)}function We(t,e){const i=Ne(e.x),r=Ne(e.y);t.writeVertexUint32(je(i,r)),t.writeVertexUint32(Ve(i,r))}class Fe{constructor(t){this._bufferDataProvider=t,this._currentMeshWrittenVertices=0}endMesh(){return this._currentMeshWrittenVertices=0,this._currentBufferData.endMesh()}writeIndices(t){this._ensureEnoughIndexBufferSpace(t.length),this._currentBufferData.writeIndices(t)}writeVertex(...t){return this._ensureEnoughVertexBufferSpace(),this._writeVertex(this._currentBufferData,...t),this._currentMeshWrittenVertices++}_ensureEnoughVertexBufferSpace(t=1){this._currentBufferData||this._requestNewBuffer();const e=this._currentBufferData.vertexBuffer,i=t*e.vertexByteSize;if(e.occupiedByteSize+i>e.byteSize&&(this._requestNewBuffer(),i>this._currentBufferData.vertexBuffer.byteSize))throw new Error("Mesh is too big to write its vertices")}_ensureEnoughIndexBufferSpace(t){this._currentBufferData||this._requestNewBuffer();const e=this._currentBufferData.indexBuffer;if(e.occupiedSize+t>e.size&&(this._requestNewBuffer(),t>this._currentBufferData.indexBuffer.size))throw new Error("Mesh is too big to write its indices")}_requestNewBuffer(){const t=this._currentBufferData;this._currentBufferData=this._bufferDataProvider(),t&&(t.vertexBuffer.transferUnfinishedMesh(this._currentBufferData.vertexBuffer),t.indexBuffer.transferUnfinishedMesh(this._currentBufferData.indexBuffer,t.vertexBuffer.currentMeshBaseIndex))}}function qe(t,e=4){let i=0;return{attributes:[...F(t,([t,{type:r,size:s,normalized:n}])=>{const o=[t,{type:r,size:s,normalized:n,offset:i}],a=s*function(t){switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4}}(r),l=function(t,e){return(t-1&e)-e}(i+a,-e);return i=l,o})],vertexByteSize:i}}const Ye=qe([[2,{size:4,type:5121,normalized:!0}],[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[5,{size:2,type:5122,normalized:!0}],[6,{size:2,type:5122,normalized:!0}],[10,{size:1,type:5126,normalized:!1}],[4,{size:2,type:5123,normalized:!0}],[12,{size:4,type:5123,normalized:!1}],[13,{size:1,type:5126,normalized:!1}],[14,{size:2,type:5122,normalized:!0}]]),Xe={};for(const En of Ye.attributes)Xe[En[0]]=En[1].offset/4;class Ge{constructor(){const t=new ArrayBuffer(Ye.vertexByteSize);this._uint32View=new Uint32Array(t),this._float32View=new Float32Array(t)}get data(){return this._uint32View}set position({x:t,y:e}){const i=Ne(t),r=Ne(e);this._uint32View[Xe[0]]=je(i,r),this._uint32View[Xe[1]]=Ve(i,r)}set normal({x:t,y:e}){this._uint32View[Xe[5]]=De(Ue(t),Ue(e))}setDisplacement(t,e){this._uint32View[Xe[6]]=De(He(t),He(e))}setUv(t,e){this._uint32View[Xe[4]]=De(Ke(t),Ke(e))}set iconLocation({minX:t,maxX:e,minY:i,maxY:r}){const s=Xe[12];this._uint32View[s]=De(t,e),this._uint32View[s+1]=De(i,r)}set iconScale(t){this._float32View[Xe[13]]=t}set id(t){this._uint32View[Xe[2]]=t}set zIndex(t){this._float32View[Xe[10]]=se(t)}set zoom(t){this._zoom=t,this._writeZoomRelatedData()}set vertexZoomScaledTextureUDisplacement(t){this._zoomScaledTextureUDisplacement=t,this._writeZoomRelatedData()}_writeZoomRelatedData(){this._uint32View[Xe[14]]=De(Ue(O(this._zoom,-64,64)/64),Ue(O(this._zoomScaledTextureUDisplacement,-1024,1024)/1024))}}class Ze extends Fe{rewriteIcon(t,e,i,r){const s=new Uint32Array(t.vertexBuffer.data),n=new Float32Array(t.vertexBuffer.data),o=this._getAttribOffset(12),a=this._getAttribOffset(13),l=Ye.vertexByteSize,h=l/4,c=e.vertexByteOffset/4,d=e.vertexByteLength/l;for(let u=0;u<d;u++){const t=c+u*h;s[t+o]=De(i.minX,i.maxX),s[t+o+1]=De(i.minY,i.maxY),n[t+a]=r}}_getAttribOffset(t){const e=Ye.attributes,i=e.findIndex(e=>e[0]===t);return-1!==i?e[i][1].offset/4:-1}writeVertex(t){return super.writeVertex(t)}writeIndices(t){return super.writeIndices(t)}_writeVertex(t,e){for(const i of e.data)t.writeVertexUint32(i)}}function He(t){return Ue(O(t,-256,256)/256)}function Ke(t){return Le(O(t,0,2048)/2048)}class Qe{constructor(t){this._bufferWriter=t,this._vertexBuffer=new Ge}writePolyline({vertices:t},e,i,r,s,n,o,a,l,h,c,d=!1,u=0){const f=.5*i,p=this._vertexBuffer,_={leftVertexIndex:-1,rightVertexIndex:-1,segmentNormal:g(0,0)};p.id=e,p.iconLocation=o,p.iconScale=a,p.zoom=h,p.zIndex=c,p.vertexZoomScaledTextureUDisplacement=0;let y=u;this._writeStartCap(t[0],t[1],r,f,y,p,_);for(let g=1;g<t.length-1;g++)d||(y+=k(t[g],t[g-1])/l),this._writeJoin(t[g],t[g+1],n,f,y,d,l,p,_);return d||(y+=k(t[t.length-1],t[t.length-2])/l),this._writeEndCap(t[t.length-1],s,f,y,p,_),this._bufferWriter.endMesh()}_writeStartCap(t,e,i,r,s,n,o){const a=w(A(b(e,t)));n.position=t,n.normal=a;const l=this._writeVertex(n,0,r,s,2*r),h=this._writeVertex(n,0,-r,s,0);o.segmentNormal=a,o.leftVertexIndex=l,o.rightVertexIndex=h,this._writeStartCapTypeSpecificVertices(i,n,r,s,l,h)}_writeJoin(t,e,i,r,s,n,o,a,l){a.position=t;const h=2*r,c=l.segmentNormal,d=k(e,t)/o,u=function(t,e){const i=b(e,t);return A(i,i),w(i,i),i}(t,e);var f,p;const _=Math.sign((p=u,(f=c).x*p.y-f.y*p.x))>0,g=Math.min(function(t,e){const i=T(t,e),r=Math.abs((1-i)/(1+i));return Math.sqrt(r)}(c,u)*r,d),y=-g,m=this._writeVertex(a,0,0,s,r);let x,v;_?(v=this._writeVertex(a,0,-r,s,0),x=n?this._writeVertex(a,y,r,s,h):this._writeVertexWithUDisplacement(a,y,r,s,h,y)):(x=this._writeVertex(a,0,r,s,h),v=n?this._writeVertex(a,y,-r,s,0):this._writeVertexWithUDisplacement(a,y,-r,s,0,y)),a.normal=u;const S=_?x:this._writeVertex(a,0,r,s,h),I=_?this._writeVertex(a,0,-r,s,0):v;this._bufferWriter.writeIndices([l.leftVertexIndex,l.rightVertexIndex,x,l.rightVertexIndex,v,x,v,m,x,I,S,m]),l.segmentNormal=u,l.leftVertexIndex=S,l.rightVertexIndex=I,0===i&&g>4*r&&(i=1),this._writeJoinTypeSpecificVertices(i,a,l,_,c,u,g,r,s,m,x,v,S,I)}_writeEndCap(t,e,i,r,s,n){s.position=t;const o=this._writeVertex(s,0,i,r,2*i),a=this._writeVertex(s,0,-i,r,0);this._bufferWriter.writeIndices([n.leftVertexIndex,n.rightVertexIndex,o,n.rightVertexIndex,a,o]),this._writeEndCapTypeSpecificVertices(e,s,i,r,o,a)}_writeStartCapTypeSpecificVertices(t,e,i,r,s,n){switch(t){case 2:{const t=this._writeVertex(e,0,0,r,i),s=this._writeVertex(e,0,i,r,0),o=this._writeVertex(e,-i,i,r,0),a=this._writeVertex(e,-i,-i,r,0);this._bufferWriter.writeIndices([t,a,n,t,o,a,t,s,o]);break}}}_writeJoinTypeSpecificVertices(t,e,i,r,s,n,o,a,l,h,c,d,u,f){const p=2*a;switch(t){case 0:if(r){const t=this._writeVertex(e,o,-a,l,0);this._bufferWriter.writeIndices([h,t,d,h,f,t])}else{const t=this._writeVertex(e,o,a,l,p);this._bufferWriter.writeIndices([h,c,t,h,t,u])}break;case 2:{const t=a*a,i=o*o,s=t/Math.sqrt(t+i);if(r){const t=this._writeVertex(e,0,0,l,s);this._bufferWriter.writeIndices([t,d,f])}else{const t=this._writeVertex(e,0,0,l,p-s);this._bufferWriter.writeIndices([t,u,c])}break}}}_writeEndCapTypeSpecificVertices(t,e,i,r,s,n){switch(t){case 2:{const t=this._writeVertex(e,0,0,r,i),s=this._writeVertex(e,0,i,r,0),o=this._writeVertex(e,i,i,r,0),a=this._writeVertex(e,i,-i,r,0);this._bufferWriter.writeIndices([t,n,a,t,a,o,t,o,s]);break}}}_writeVertex(t,e,i,r,s){return t.setDisplacement(e,i),t.setUv(r,s),this._bufferWriter.writeVertex(t)}_writeVertexWithUDisplacement(t,e,i,r,s,n){t.vertexZoomScaledTextureUDisplacement=n;const o=this._writeVertex(t,e,i,r,s);return t.vertexZoomScaledTextureUDisplacement=0,o}}class $e extends Qe{writePolyline(t,e,i,r,s,n,o,a,l,h,c){return super.writePolyline(t,e,i,r,s,n,o,a,l,h,c,!0,i/2)}_writeStartCapTypeSpecificVertices(t,e,i,r,s,n){switch(t){case 1:{const t=this._writeVertex(e,-i,i,0,2*i),r=this._writeVertex(e,-i,-i,0,0);this._bufferWriter.writeIndices([s,n,t,n,r,t]);break}default:super._writeStartCapTypeSpecificVertices(t,e,i,r,s,n)}}_writeEndCapTypeSpecificVertices(t,e,i,r,s,n){switch(t){case 1:{const t=2*i,r=this._writeVertex(e,i,i,t,t),o=this._writeVertex(e,i,-i,t,0);this._bufferWriter.writeIndices([s,n,r,n,o,r]);break}case 2:{const t=this._writeVertex(e,0,0,i,i),r=this._writeVertex(e,0,i,i,0),s=this._writeVertex(e,i,i,i,0),o=this._writeVertex(e,i,-i,i,0);this._bufferWriter.writeIndices([t,n,o,t,o,s,t,s,r]);break}}}_writeJoinTypeSpecificVertices(t,e,i,r,s,n,o,a,l,h,c,d,u,f){e.normal=s;const p=2*a;switch(t){case 1:if(o<=a){const t=a+o;if(r){const i=this._writeVertex(e,o,-a,t,0);this._bufferWriter.writeIndices([h,d,i,h,i,f])}else{const i=this._writeVertex(e,o,a,t,p);this._bufferWriter.writeIndices([h,i,c,h,u,i])}}else{const t=1/o*a*a;if(r){const i=a-t,r=this._writeVertex(e,a,-a,p,0),s=this._writeVertex(e,a,-t,p,i);e.normal=n;const o=this._writeVertex(e,-a,-a,p,0);this._bufferWriter.writeIndices([h,d,r,h,r,s,h,s,o,h,o,f])}else{const i=a+t,r=this._writeVertex(e,a,a,p,p),s=this._writeVertex(e,a,t,p,i);e.normal=n;const o=this._writeVertex(e,-a,a,p,p);this._bufferWriter.writeIndices([h,c,r,h,r,s,h,s,o,h,o,u])}}break;default:super._writeJoinTypeSpecificVertices(t,e,i,r,s,n,o,a,l,h,c,d,u,f)}e.normal=n}}class Je extends Qe{constructor(t){super(t),this._halfCircleVectorsCache=new Map}writePolyline(t,e,i,r,s,n,o,a,l,h,c){return super.writePolyline(t,e,i,r,s,n,o,a,l,h,c,!1,0)}_writeStartCapTypeSpecificVertices(t,e,i,r,s,n){switch(t){case 1:const o=this._writeVertex(e,0,0,r,i),a=2*i;let l=s;for(const t of this._getHalfCircleVectors(Math.floor(i))){const s=-i*t.y,n=i*t.x,h=this._writeVertex(e,s,n,r,a);this._bufferWriter.writeIndices([o,l,h]),l=h}break;default:super._writeStartCapTypeSpecificVertices(t,e,i,r,s,n)}}_writeEndCapTypeSpecificVertices(t,e,i,r,s,n){switch(t){case 1:const o=this._writeVertex(e,0,0,r,i);let a=s;for(const t of this._getHalfCircleVectors(Math.floor(i))){const s=i*t.y,n=i*t.x,l=this._writeVertex(e,s,n,r,2*i);this._bufferWriter.writeIndices([o,l,a]),a=l}break;default:super._writeEndCapTypeSpecificVertices(t,e,i,r,s,n)}}_writeJoinTypeSpecificVertices(t,e,i,r,s,n,o,a,l,h,c,d,u,f){switch(e.normal=s,r?i.leftVertexIndex=this._writeVertexWithUDisplacement(e,-o,a,l,2*a,o):i.rightVertexIndex=this._writeVertexWithUDisplacement(e,-o,-a,l,0,o),t){case 1:{const t=T(s,n);if(r){const i=[];let r=d;for(const s of this._getHalfCircleVectors(Math.floor(a))){if(!(s.x>t))break;{const t=a*s.y,n=-a*s.x,o=this._writeVertex(e,t,n,l,0);i.push(h,o,r),r=o}}i.push(h,f,r),this._bufferWriter.writeIndices(i)}else{const i=2*a,r=[];let s=c;for(const n of this._getHalfCircleVectors(Math.floor(a))){if(!(n.x>t))break;{const t=a*n.y,o=a*n.x,c=this._writeVertex(e,t,o,l,i);r.push(h,c,s),s=c}}r.push(h,u,s),this._bufferWriter.writeIndices(r)}break}default:super._writeJoinTypeSpecificVertices(t,e,i,r,s,n,o,a,l,h,c,d,u,f)}e.normal=n}_getHalfCircleVectors(t){let e=this._halfCircleVectorsCache.get(t);if(!e){e=[];const i=Math.PI/t,r=g(1,0);for(let s=0;s<t;s++)x(r,i,r),e.push(m(r));this._halfCircleVectorsCache.set(t,e)}return e}}function ti(t,e,i){const r=e<=1&&t<2,s=e<=1&&t>=2?.55:.5,{r:n,g:o,b:a}=i,l=i.a*Math.min(t,1);t=Math.max(t,1);let h=Math.ceil(t+2*s);h+=1-h%2;const c=.5*h-.5,d=.5*t,u=d-s,f=d+s,p=new Uint32Array(h*h);for(let _=0;_<h;_++){const t=_-c;for(let e=0;e<h;e++){const i=e-c,s=Math.sqrt(t*t+i*i),g=r?.5+O(d-s,-.5,.5):B(f,u,s);p[e*h+_]=dt(n,o,a,l*g)}}return{size:{width:h,height:h},data:new Uint8Array(p.buffer)}}function ei(t,e,i,r,s){const n=r<=1&&t<2,o=r<=1&&t>=2?.55:.5,{r:a,g:l,b:h}=s,c=s.a*Math.min(t,1);t=Math.max(t,1);let d=Math.ceil(t+2*o);d+=1-d%2;const u=Math.ceil(e+i),f=Math.ceil(e+2*o),p=new Uint32Array(u*d),_=.5*e,g=.5*f-.5,y=.5*d-.5,m=.5*t,b=_-o,x=_+o,w=m-o,v=m+o;for(let k=0;k<f;k++){const t=B(x,b,Math.abs(k-g));for(let e=0;e<d;e++){const i=Math.abs(e-y),r=n?.5+O(m-i,-.5,.5):B(v,w,i);p[e*u+k]=dt(a,l,h,c*t*r)}}return{size:{width:u,height:d},data:new Uint8Array(p.buffer)}}var ii=function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function o(t){try{l(r.next(t))}catch(e){n(e)}}function a(t){try{l(r.throw(t))}catch(e){n(e)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}l((r=r.apply(t,e||[])).next())}))};class ri extends ue{constructor(t,e,i,r,s,n,o,a,l=1e3){super(e,a,l),this._pageRegistry=i,this._iconAtlasRegistry=r,this._bufferWriter=s,this._polylines=t,this._zoom=n,this._worldToPxFactor=o,this._missingIcons=function(t,e){var i;const r=[];for(const s of t){const t=s.styles[0].inline||s.styles[0].outline,n=t&&t.pattern;n&&n.imageId&&(e.getIconData(n.imageId,n.scale*(null!=(i=t.patternScaleFactor)?i:1),t.patternTransformer)||r.push(t))}return r}(t,r),this._missingIconsWrittenPrimitives=[],this._solidPolylinesWriter=new $e(s),this._patternPolylineWriter=new Je(s)}hasAsyncContent(){return this._missingIcons.length>0}processSynchronously(){const t=de(),e=[...ge(this._writePolylines())];return this._writtenPrimitives={content:{primitives:{3:e}},metrics:{polylinesParsing:de()-t,glyphsAndResourcesLoadTime:this._loadTime}}}_process(){let t=!1;for(const e of this._missingIconsWrittenPrimitives){const i=this._pageRegistry.getPage(e.primitive.location.bufferId),r=e.imageId,s=this._iconAtlasRegistry.getIconData(r,e.scaleFactor,e.transformer),n=(s.atlasLocation.maxY-s.atlasLocation.minY)/e.widthDIPx;this._bufferWriter.rewriteIcon(i.data,e.primitive.location,s.atlasLocation,n),i.touch(e.primitive.location),e.primitive.atlasId!==s.atlasId&&(t=!0)}return t?Object.assign({contentToRemove:[3]},this._writtenPrimitives):{content:{primitives:{}},metrics:{}}}_loadImpl(){return ii(this,void 0,void 0,(function*(){const t=this._missingIcons.map(t=>{var e;return this._iconAtlasRegistry.loadIcon(t.pattern.imageId,Math.floor(this._getTaskPriority()),t.pattern.scale*(null!=(e=t.patternScaleFactor)?e:1),t.patternTransformer)});yield Promise.all(t)}))}_loadCancel(){}_writePolylines(){var t,e;const i=[],r=function(t,e,i){let r=i;for(const s of t)r=e(r,s);return r}(q(this._polylines,Yt),(t,e)=>{const i=e.styles[0];return i.inline&&!i.inline.hidden&&t.push({polyline:e,style:i.inline,zIndex:i.zIndex+.01}),i.outline&&!i.outline.hidden&&t.push({polyline:e,style:i.outline,zIndex:i.zIndex}),t},[]);!function(t,e=ve,i=0,r=t.length){if(r-i<=32)return void ze(t,e,i,r);{let s=i,n=s+32;for(;n<r;)ze(t,e,s,n),s=n,n+=32;ze(t,e,s,r)}const s=new Array(r-i);for(let n=32;n<r-i;n+=n){Se(t,s,i,r);let o=i,a=0,l=n,h=l+n;for(;h<r-i;)Pe(s,t,e,a,l,h,o),a=h,l=a+n,h=l+n,o+=2*n;Pe(s,t,e,a,Math.min(l,r-i),r-i,o)}}(r,(t,e)=>t.zIndex-e.zIndex);const s=this._iconAtlasRegistry,n=this._zoom,o=this._worldToPxFactor,a=this._iconAtlasRegistry.getDpr();for(const l of r){const r=l.style,h=l.zIndex,c=r.strokeWidth,d=l.polyline.id,u=r.strokeColor,f=r.join;if(r.pattern){const a=r.strokeWidth,c=s.getIconData(r.pattern.imageId,r.pattern.scale*(null!=(t=r.patternScaleFactor)?t:1),r.patternTransformer),u=!!c,f=c?c.atlasId:s.getCurrentAtlas().id,p=c?c.atlasLocation:s.getCurrentAtlas().emptyIcon,_=(p.maxY-p.minY)/a,g={id:d,location:this._patternPolylineWriter.writePolyline(l.polyline,d,a,r.startCap,r.endCap,r.join,p,_,o,n,h),metadata:l.polyline.metadata,atlasId:f};i.push(g),u||this._missingIconsWrittenPrimitives.push({primitive:g,imageId:r.pattern.imageId,widthDIPx:a,scaleFactor:r.pattern.scale*(e=r.patternScaleFactor,null!=e?e:1),transformer:r.patternTransformer})}else if(l.style.dash){const t=l.style.dash,e=c+"_"+ut(u)+"_"+t.fill+"_"+t.gap,p=s.getIconData(e)||s.addIcon(ei(c*a,l.style.dash.fill*a,l.style.dash.gap*a,a,u),e),_=(p.atlasLocation.maxY-p.atlasLocation.minY)/a;i.push({id:d,location:this._patternPolylineWriter.writePolyline(l.polyline,d,_,r.startCap,r.endCap,f,p.atlasLocation,a,o,n,h),metadata:l.polyline.metadata,atlasId:p.atlasId})}else{const t=c+"_"+ut(u),e=s.getIconData(t)||s.addIcon(ti(c*a,a,u),t),p=(e.atlasLocation.maxY-e.atlasLocation.minY)/a;i.push({id:d,location:this._solidPolylinesWriter.writePolyline(l.polyline,d,p,r.startCap,r.endCap,f,e.atlasLocation,a,o,n,h),metadata:l.polyline.metadata,atlasId:e.atlasId})}}return i}}function si(t){return t.objectId+t.meshId+ut(t.color)}class ni extends ue{constructor(t,e,i,s,n,o,a,l,h,c,d,u,f,p,_){super(s,n,2e3),this._options=t,this._zoom=e,this._worldToPxFactor=i,this._opaquePolygonBufferWriter=o,this._transparentPolygonBufferWriter=a,this._extrudedPolygonBufferWriter=l,this._polylineBufferWriter=h,this._pointLabelsBufferWriter=c,this._curvedLabelsBufferWriter=d,this._iconBufferWriter=u,this._pageRegistry=f,this._glyphAtlasRegistry=p,this._iconAtlasRegistry=_,this.onModelRequired=this._onModelRequired=new r}_writePolygons(t){const e=de(),i=[],r=[],s=[],n=[];for(const o of t){const t=o.styles[0];t.pattern||(1===t.color.a?i.push({id:o.id,location:this._opaquePolygonBufferWriter.writePolygon(o,t.zIndex,t.color,o.id),metadata:o.metadata}):s.push({id:o.id,location:this._transparentPolygonBufferWriter.writePolygon(o,t.zIndex,t.color,o.id),metadata:o.metadata})),o.height>0&&(o.externalMesh?(this._onModelRequired.fire(o.externalMesh),n.push(si(o.externalMesh))):r.push({id:o.id,location:this._extrudedPolygonBufferWriter.writePolygon(o,o.height,o.styles[0].color,o.id),metadata:o.metadata}))}return{content:{primitives:{0:[..._e(i)],1:[..._e(s)],2:[..._e(r)]},references:n},metrics:{polygonsParsing:de()-e}}}_writePolylines(t,e){const i=this._zoom,r=this._worldToPxFactor,s=new ri([...t,...e],this._taskQueue,this._pageRegistry,this._iconAtlasRegistry,this._polylineBufferWriter,i,r,this._priority,1e3),n=s.processSynchronously();return s.hasAsyncContent()?this._startSubTask(s):s.destructor(),n}_writeLabels(t,e){const i=new Ce(t,e,this._taskQueue,this._options.objectsCollisionPriority,this._glyphAtlasRegistry,this._pointLabelsBufferWriter,this._curvedLabelsBufferWriter,this._priority,2e3);if(i.canBeProcessedSynchronously()){const t=i.processSynchronously();return i.destructor(),t}this._startSubTask(i)}_writeIcons(t){const e=new Ee(t,this._taskQueue,this._options.objectsCollisionPriority,this._iconAtlasRegistry,this._iconBufferWriter,this._priority,1e3);if(e.canBeProcessedSynchronously()){const t=e.processSynchronously();return e.destructor(),t}this._startSubTask(e)}}function oi(t){return Yt(t)&&!t.styles[0].hidden}function ai(t){return oi(t)&&t.texts.length>0}class li extends ni{constructor(t,e,i,r,s,n,o,a,l,h,c,d,u,f,p,_,g,y=(t=>tt(t))){super(e,t.tile.zoom-wt(e.tileSize),function(t,e){xt[t]||(xt[t]=[]);let i=xt[t][e];return i||(i=2/(function(t){switch(t){case 1:return 512;case 2:return 1024;default:return 256}}(t)*Math.pow(2,e)),xt[t][e]=i),i}(e.tileSize,t.tile.zoom),i,s,n,o,a,l,h,c,d,u,f,p),this._tile=t,this._tileSpecificOptions=e,this._tileLoader=r,this._metadataPreprocessor=y,this._objectIdProvider=_,this._stylesCustomizer=g,this._modifyIconMetadata=this._modifyIconMetadata.bind(this)}_onSubTaskContent(t){this._onContentReady.fire(t)}_process(t){const e=de(),i=Z.decode(new Uint8Array(t)),r=de(),s=this._metadataPreprocessor(i,this._tile),n=this._tile.tile,o=this._extractPointLabels(n,i,s),a=this._extractCurvedLabels(n,i,s),l=this._extractPolygons(n,i,s),h=this._extractPolylines(n,i,s),c=this._extractContours(n,i,l),d=this._exractIcons(n,i,s,o);return he(this._writeLabels(o,a),this._writeIcons(d),this._writePolygons(l),this._writePolylines(h,c),{content:{primitives:{}},metrics:{tileUnpack:r-e,tileLoadTime:this._loadTime,workerQueueDelay:this._queueWaitingTime}})}_loadImpl(){const t=Math.floor(this._getTaskPriority());return this._tileLoader.load(this._tile,t)}_loadCancel(){this._tileLoader.cancel(this._request)}_extractPolygons(t,e,i){return[...q(Lt(t,e,i,this._objectIdProvider.idGenerator,this._tileSpecificOptions.tileSize,this._tileSpecificOptions.mapMode,this._stylesCustomizer),oi)]}_extractPolylines(t,e,i){return[...qt(t,e,i,this._objectIdProvider.idGenerator,this._tileSpecificOptions.tileSize,this._tileSpecificOptions.mapMode,this._stylesCustomizer)]}_extractContours(t,e,i){return[...Ft(t,e,i,this._tileSpecificOptions.tileSize,this._tileSpecificOptions.mapMode,this._stylesCustomizer)]}_extractPointLabels(t,e,i){return[...q(Qt(t,e,i,this._objectIdProvider.collidingIdGenerator,this._tileSpecificOptions.tileSize,this._tileSpecificOptions.mapMode,this._stylesCustomizer),ai)]}_extractCurvedLabels(t,e,i){return[...q(ee(t,e,i,this._objectIdProvider.collidingIdGenerator,this._tileSpecificOptions.tileSize,this._tileSpecificOptions.mapMode,this._stylesCustomizer),oi)]}_exractIcons(t,e,i,r){return[...q(le(t,e,i,this._objectIdProvider.collidingIdGenerator,r,this._tileSpecificOptions.tileSize,this._tileSpecificOptions.mapMode,this._stylesCustomizer,this._modifyIconMetadata),oi)]}_modifyIconMetadata(t,e){const i=e[0];if(i&&i.selectedIcon){const e=!1,r=this._iconAtlasRegistry.buildIconUrl(i.selectedIcon.imageId,i.scaleFactor,e);t.set("_vector_selectedIconUrl",r)}}}class hi{constructor(t){this._task=t,this.onContentReady=this._onContentReady=new r,this._onWrappedTaskContentReady=this._onWrappedTaskContentReady.bind(this),this._task.onContentReady.addListener(this._onWrappedTaskContentReady)}destructor(){this._task.onContentReady.removeListener(this._onWrappedTaskContentReady)}start(){this._task.resetPriority(this._calculateTaskPriority()),this._task.start()}_onWrappedTaskContentReady(t){this._onContentReady.fire(t)}}class ci extends hi{constructor(t,e,i,r){super(e),this._tile=t,this._viewport=i,this._taskExtraPriority=r,this._tileCenterPosition=function(t){const e=et(t.zoom);return{x:e*(t.x+.5)-1,y:1-e*(t.y+.5)}}(t.tile),this._onTileStateChanged=this._onTileStateChanged.bind(this),this._tile.onStateChanged.addListener(this._onTileStateChanged),this._onViewportUpdated=this._onViewportUpdated.bind(this),this._viewport.onViewportChanged.addListener(this._onViewportUpdated)}destructor(){this._task.destructor(),this._tile.onStateChanged.removeListener(this._onTileStateChanged),this._viewport.onViewportChanged.removeListener(this._onViewportUpdated)}start(){2!==this._tile.state&&super.start()}_calculateTaskPriority(){return(0===this._tile.state?3e4:1===this._tile.state?2e4:1e4)+(1-k(this._viewport.cameraPosition,this._tileCenterPosition)/2)+this._taskExtraPriority}_onTileStateChanged(t){switch(t.state){case 2:case 3:this._task.pause();break;case 0:case 1:this._resetTaskPriority(),0===this._task.state?this._task.start():this._task.resume()}}_onViewportUpdated(){this._resetTaskPriority()}_resetTaskPriority(){this._task.resetPriority(this._calculateTaskPriority())}}class di extends ci{constructor(t,e,i,s,n,o,a,l,h,c,d,u,f,p,_,g,y,m,b){const x=new li(t,e,i,s,o,a,l,h,c,d,u,f,p,_,g,y,m,b);super(t,x,n,o),this.onModelRequired=this._onModelRequired=new r,x.onModelRequired.addListener(t=>this._onModelRequired.fire(t))}}function ui(t,e="something that is supposed to be defined is undefined"){if(!(void 0!==t))throw new Error(e);return void 0!==t}function fi(t){let e=0;for(let i=0;i<t.length;i++)e+=t.charCodeAt(i);return(e%4+1).toString()}class pi extends ue{constructor(t,e,i,r,s,n,o=1e3){super(e,n,o),this._model=t,this._loadManager=i,this._trimeshModelBufferWriter=r,this._meshTemplateUrl=s}_process(t){const e=this._model.mesh;return{primitives:{2:this._trimeshModelBufferWriter.writeModel(t,e).map(t=>({id:e.id,metadata:e.metadata,location:t}))}}}_loadImpl(){const t=this._model.mesh.meshId;return this._loadManager.load(this._meshTemplateUrl.replace("{{hostAlias}}",fi(t)).replace("{{id}}",t),Math.floor(this._getTaskPriority()))}_loadCancel(){this._loadManager.cancel(this._request)}}class _i extends a{constructor(){super({id:"_NO_ID_",x:-1,y:-1,zoom:-1},2),this._tiles=[],this._onSubTileStateChanged=this._onSubTileStateChanged.bind(this)}addTile(t){this._tiles.find(e=>e===t)||(this._tiles.push(t),t.onStateChanged.addListener(this._onSubTileStateChanged,this),this._recalculateState())}_onSubTileStateChanged(){this._recalculateState()}_recalculateState(){this.state=this._calculateState()}_calculateState(){for(const t of this._tiles)if(0===t.state)return 0;for(const t of this._tiles)if(1===t.state)return 1;return 2}}class gi extends ci{constructor(t,e,i,r,s,n,o){const a=new _i;super(a,new pi(t,e,i,n,o,s),r,s),this._combinedTile=a}addTile(t){this._combinedTile.addTile(t)}}class yi{constructor(){this.onReleased=this._onReleased=new r,this.onRetain=this._onRetain=new r,this._clients=0}get isRetained(){return 0!==this._clients}retain(){++this._clients,this._onRetain.fire(this)}release(){this._clients>0&&(--this._clients,0===this._clients&&this._onReleased.fire(this))}}class mi extends yi{constructor(t,e){super(),this.id=t,this.mesh=e,this._contentHolder=new o}destructor(){this._contentHolder.destructor()}addContent(t,e){return this._contentHolder.addContent(t,e)}hasContent(){return this._contentHolder.hasContent()}}class bi{constructor(t,e){this._loadManager=t,this._storage=e,this._cache=new Map,this._storage.onRemoved.addListener(this._onTileRemoved,this),this._tileUrlTemplate="",this._tileSize=0}destructor(){this._storage.onRemoved.removeListener(this._onTileRemoved)}update(t,e){let i=!1;this._tileUrlTemplate!==t&&(this._tileUrlTemplate=t,i=!0),this._tileSize!==e&&(this._tileSize=e,i=!0),i&&(this._cache.clear(),this._cache=new Map)}load(t,e){const i=this._cache,r=C(t.tile),s=i.get(r);if(s)return s.count++,Promise.resolve(s.data);const n=this._buildTileUrl(t.tile,r),o=this._loadManager.load(n,e);return o.then(t=>{i.set(r,{count:1,data:t})}),o}cancel(t){this._loadManager.cancel(t)}_onTileRemoved(t){const e=C(t.tile),i=this._cache.get(e);i&&(i.count--,0===i.count&&this._cache.delete(e))}_buildTileUrl(t,e){const{x:i,y:r,zoom:s}=t,n=vt(t,this._tileSize);return this._tileUrlTemplate.replace("{{hostAlias}}",fi(e)).replace("{{x}}",i+"").replace("{{y}}",r+"").replace("{{z}}",s+"").replace("{{zmin}}",n+"").replace("{{zmax}}",n+"")}}function xi(t){return Array.isArray(t)?t:[t]}function wi(t,e){console.warn(`not valid "${t}": "${e}"`)}function vi(t,e){return t^e+2654435769+(t<<6)+(t>>2)}function ki(t,e,i,r){if(void 0!==t)return function(t){let e=0;for(const i of[t.r,t.g,t.b,t.a])e=vi(e,255*i|0);return e}(t);let s=0;return void 0!==e&&(s=vi(s,e/6*255|0)),void 0!==i&&(s=vi(s,function(t){let e=0;for(let i=0;i<t.length;++i)e=vi(e,255*t[i]|0);return e}(i))),void 0!==r&&(s=vi(s,255*r|0)),s}function Ai(t,e,i,r){return s=>{let n=s;return void 0!==t?n=t:(void 0!==e&&(n=function(t,e){const i=Math.min(t.r,t.g,t.b),r=Math.max(t.r,t.g,t.b)-i,s=r*(1-Math.abs(e%2-1));let n=0,o=0,a=0;switch(Math.floor(e)){case 0:n=r,o=s;break;case 1:n=s,o=r;break;case 2:o=r,a=s;break;case 3:o=s,a=r;break;case 4:a=r,n=s;break;case 5:a=s,n=r}return ht(n+i,o+i,a+i,t.a)}(n,e)),void 0!==i&&(n=function({r:t,g:e,b:i,a:r},s){const n=ht(O(s[0]*t+s[1]*e+s[2]*i+s[3],0,1),O(s[4]*t+s[5]*e+s[6]*i+s[7],0,1),O(s[8]*t+s[9]*e+s[10]*i+s[11],0,1),O(s[12]*t+s[13]*e+s[14]*i+s[15],0,1));return n.a*=r,n}(n,i))),void 0!==r&&(n=ht(n.r,n.g,n.b,n.a*r)),n}}function Ti(t,e,i,r,s,n){const o=ki(t,e,i,r),a=function(t,e,i){return(t?"&c1="+yt(t):"")+(e?"&c2="+yt(e):"")+(i?"&c3="+yt(i):"")}(t,s,n);if(0!==o||""!==a)return{key:o,colorQuery:a,transform:Ai(t,e,i,r),transformImage:({size:t,data:s})=>(function(t,e){for(let i=0;i<t.length;i+=4){const{r:r,g:s,b:n,a:o}=e(ht(t[i+0]/255,t[i+1]/255,t[i+2]/255,1));t[i+0]=255*r,t[i+1]=255*s,t[i+2]=255*n,t[i+3]=t[i+3]*o}}(s,Ai(void 0,e,i,r)),{size:t,data:s})}}var Si;!function(t){t[t.None=0]="None",t[t.Point=1]="Point",t[t.Polyline=2]="Polyline",t[t.Polygon=4]="Polygon",t[t.All=7]="All"}(Si||(Si={}));const Ii={point:Si.Point,polyline:Si.Polyline,polygon:Si.Polygon};var zi;!function(t){t[t.None=0]="None",t[t.GeometryFillRaw=1]="GeometryFillRaw",t[t.GeometryFillPattern=2]="GeometryFillPattern",t[t.GeometryOutline=4]="GeometryOutline",t[t.GeometryFill=3]="GeometryFill",t[t.Geometry=7]="Geometry",t[t.LabelIcon=8]="LabelIcon",t[t.LabelTextFill=16]="LabelTextFill",t[t.LabelTextOutline=32]="LabelTextOutline",t[t.LabelText=48]="LabelText",t[t.Label=56]="Label",t[t.All=63]="All"}(zi||(zi={}));const Pi={"geometry.fill":zi.GeometryFill,"geometry.fill.pattern":zi.GeometryFillPattern,"geometry.outline":zi.GeometryOutline,geometry:zi.Geometry,"label.icon":zi.LabelIcon,"label.text.fill":zi.LabelTextFill,"label.text.outline":zi.LabelTextOutline,"label.text":zi.LabelText,label:zi.Label};function Ri(){return new Array(9)}Ri();function Ci(t,e,i){return{x:t,y:e,z:i}}Ci(0,0,0),Ci(1,0,0),Ci(-1,0,0),Ci(0,1,0),Ci(0,-1,0),Ci(0,0,1),Ci(0,0,-1);function Oi(t,e=Ci(0,0,0)){return e.x=t.x,e.y=t.y,e.z=t.z,e}function Mi(t,e,i=Ci(0,0,0)){return i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i}function Ei(t,e,i=Ci(0,0,0)){return i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i}function Bi(){return new Array(16)}!function(t,e=Bi()){for(let i=0;i<16;++i)e[i]=t[i]}([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function Li(t,e,i=Bi()){for(let r=0;r<16;r+=4){const s=t[r],n=t[r+1],o=t[r+2],a=t[r+3];for(let t=0;t<4;++t)i[r+t]=s*e[t]+n*e[4+t]+o*e[8+t]+a*e[12+t]}return i}function Ui(t,e){return e?Li(t,e):t}function Di(t,e){if(void 0!==t.visibility&&("off"===t.visibility?e.isHidden=!0:wi("styler.visibility",t.visibility)),void 0!==t.scale&&(t.scale>=0?e.scale=t.scale:wi("styler.scale",t.scale)),void 0!==t.color){const i=_t(t.color);i?e.color=i:wi("styler.color",t.color)}if(void 0!==t["secondary-color"]){const i=_t(t["secondary-color"]);i?e.secondaryColor=i:wi("styler.secondary-color",t["secondary-color"])}if(void 0!==t["tertiary-color"]){const i=_t(t["tertiary-color"]);i?e.tertiaryColor=i:wi("styler.tertiary-color",t["tertiary-color"])}if(void 0!==t.hue){const i=_t(t.hue),r=i?function({r:t,g:e,b:i}){const r=Math.min(t,e,i),s=Math.max(t,e,i),n=s-r;if(_(n,0))return;let o;switch(!0){case _(s,t):o=0+(e-i)/n;break;case _(s,e):o=2+(i-t)/n;break;case _(s,i):o=4+(t-e)/n}return(o+6)%6}(i):void 0;void 0!==r?e.hue=r:wi("styler.hue",t.hue)}void 0!==t.saturation&&(-1<=t.saturation&&t.saturation<=1?e.colorTransform=Ui(function(t){const e=.2125*(1-t),i=.7154*(1-t),r=.0721*(1-t);return[e+t,i,r,0,e,i+t,r,0,e,i,r+t,0,0,0,0,1]}(t.saturation+1),e.colorTransform):wi("styler.saturation",t.saturation)),void 0!==t.lightness&&(-1<=t.lightness&&t.lightness<=1?e.colorTransform=Ui(function(t){const e=1-Math.abs(t),i=Math.max(0,t);return[e,0,0,i,0,e,0,i,0,0,e,i,0,0,0,1]}(t.lightness),e.colorTransform):wi("styler.lightness",t.lightness)),void 0!==t.opacity&&(0<=t.opacity&&t.opacity<=1?e.opacity=t.opacity:wi("styler.opacity",t.opacity))}function Ni(t){const e=function(t){if(void 0===t)return()=>!0;const e=xi(t);return e.length>1?(r=e[0],s=e[1],t=>r<=t&&t<=s):(i=e[0],t=>t===i);var i,r,s}(t.zoom),i={};return Di(t,i),{matchZoom:e,properties:i}}function ji(t,e,i){if(i.isHidden)return void t.hide(e);void 0!==i.scale&&t.changeScale(e,i.scale);const r=Ti(i.color,i.hue,i.colorTransform,i.opacity,i.secondaryColor,i.tertiaryColor);void 0!==r&&t.changeColor(e,r)}class Vi{constructor(t){var e;this._types=function(t){if(void 0===t)return Si.All;let e=Si.None;for(const i of xi(t)){const r=Ii[i];if(!r)return wi("types",t),Si.None;e|=r}return e}(t.types),this._elements=function(t){if(void 0===t)return zi.All;let e=zi.None;for(const i of xi(t)){const r=Pi[i];if(!r)return wi("elements",t),zi.None;e|=r}return e}(t.elements),this._matchTags=function(t){let e,i,r;return"string"==typeof t?e=xi(t):t&&(t.all&&(e=xi(t.all)),t.any&&(i=xi(t.any)),t.none&&(r=xi(t.none))),Rt(e,i,r)}(t.tags),this._stylers=void 0!==(e=t.stylers)?xi(e).map(Ni):[]}match(t,e,i){return At(this._types,t)&&At(this._elements,e)&&this._matchTags(i)}pickStylers(t){const e=[];for(const i of this._stylers)i.matchZoom(t)&&e.push(i.properties);return e}}const Wi={hide(t){t.hidden=!0},changeScale(t,e){t.scaleFactor=e},changeColor(t,e){t.transformer=e}};function Fi(t,e){return{hide(i){const r=t(i);r&&e.hide(r)},changeScale(i,r){const s=t(i);s&&e.changeScale(s,r)},changeColor(i,r){const s=t(i);s&&e.changeColor(s,r)}}}const qi={hide(t){t.hidden=!0},changeScale(t,e){t.strokeWidth*=e},changeColor(t,e){t.strokeColor=e.transform(t.strokeColor)}},Yi=Fi((function(t){return t.inline&&!t.inline.pattern?t.inline:void 0}),qi),Xi=Fi((function(t){return t.outline}),qi),Gi=Fi((function(t){return t.inline&&t.inline.pattern?t.inline:void 0}),{hide:qi.hide,changeScale(t,e){qi.changeScale(t,e),t.patternScaleFactor=e},changeColor(t,e){t.patternTransformer=e}}),Zi={hide(t){t.hidden=!0},changeScale(){},changeColor(t,e){t.color=e.transform(t.color)}},Hi=Yi,Ki={hide(){},changeScale(){},changeColor(t,e){t.pattern&&(t.patternTransformer=e)}};function Qi(t){return{hide(e){for(const i of e.styles)i[t]=lt},changeScale(t,e){for(const i of t.styles)i.fontSize*=e},changeColor(e,i){for(const r of e.styles)r[t]=i.transform(r[t])}}}const $i=Qi("color"),Ji=Qi("outlineColor");Ji.changeScale=()=>{},Ji.hide=t=>{for(const e of t.styles){if(e.color===lt)return void(t.hidden=!0);e.outlineColor=lt}};const tr=[{element:zi.LabelIcon,adapter:Wi}],er=[{element:zi.GeometryFillRaw,adapter:Yi},{element:zi.GeometryOutline,adapter:Xi},{element:zi.GeometryFillPattern,adapter:Gi}],ir=[{element:zi.GeometryFill,adapter:Zi},{element:zi.GeometryFillPattern,adapter:Ki}],rr=[{element:zi.GeometryOutline,adapter:Hi}],sr=[{element:zi.LabelTextFill,adapter:$i},{element:zi.LabelTextOutline,adapter:Ji}];class nr{constructor(){this._blocks=[]}update(t){this._blocks=t.map(t=>new Vi(t)),console.log(`styles customization config update: ${this._blocks.length} blocks`)}customizePoint(t,e,i){this._customize(t,e,Si.Point,i,tr)}customizePolyline(t,e,i){this._customize(t,e,Si.Polyline,i,er)}customizePolygon(t,e,i){this._customize(t,e,Si.Polygon,i,ir)}customizePolygonContour(t,e,i){this._customize(t,e,Si.Polygon,i,rr)}customizePointLabel(t,e,i){this._customize(t,e,Si.Point,i,sr)}customizeCurvedLabel(t,e,i){this._customize(t,e,Si.Polyline,i,sr)}_customize(t,e,i,r,s){var n;if(this._blocks.length)for(const o of t)for(const{element:t,adapter:a}of s){const s=[];for(const n of this._blocks)n.match(i,t,e)&&s.push(...n.pickStylers(r));if(s.length){ji(a,o,(n=s,Object.assign({},...n)))}}}}var or=i(12),ar=i.n(or);function lr(t){const e=[],i=[];let r=0;for(const s of t){0!==r&&i.push(r);for(const t of s)e.push(t.x,t.y),r++}return ar()(e,i)}class hr extends Fe{writePolygon(t,e,i,r){const s=se(e),n=ut(i);for(const o of t.vertexRings)for(const t of o)this.writeVertex(t,n,r,s);return this.writeIndices(lr(t.vertexRings)),this.endMesh()}_writeVertex(t,e,i,r,s){We(t,e),t.writeVertexUint32(i),t.writeVertexUint32(r),t.writeVertexFloat32(s)}}class cr extends Fe{writePointLabel(t,e,i,r,s,n){const o=e.anchorPoint,a=ne(e.priority,n);for(const[l,h]of Y(r,i.styles)){const e=ut(h.color),i=ut(h.outlineColor),r=[];for(let n=0;n<l.length;n++){const h=l[n],c=[];for(const r of h){const n=s.get(r.fontId)[r.glyphId],l=this.writeVertex(t,o,r.topLeft,{x:n.minX,y:n.minY},e,i,a,r.scale),h=this.writeVertex(t,o,r.topRight,{x:n.maxX,y:n.minY},e,i,a,r.scale),d=this.writeVertex(t,o,r.bottomRight,{x:n.maxX,y:n.maxY},e,i,a,r.scale),u=this.writeVertex(t,o,r.bottomLeft,{x:n.minX,y:n.maxY},e,i,a,r.scale);this.writeIndices([l,h,d,l,d,u]),c.push({topLeft:l,topRight:h,bottomRight:d,bottomLeft:u})}r.push(c)}this._writeHitTestLabelFillings(r)}return this.endMesh()}_writeHitTestLabelFillings(t){if(1!==t.length)for(let e=0;e<t.length-1;e++)this._writeHitTestFillingIndices(t[e],t[e+1]);else this._writeHitTestFillingIndices(t[0],t[0])}_writeHitTestFillingIndices(t,e){const[i,r,s,n]=[t[0].topLeft,t[t.length-1].topRight,e[e.length-1].bottomRight,e[0].bottomLeft];this.writeIndices([i,n,s,i,s,r])}_writeVertex(t,e,i,r,s,n,o,a,l){t.writeVertexUint32(e),We(t,i),t.writeVertexFloat32(r.x),t.writeVertexFloat32(r.y),t.writeVertexUint32(De(s.x,s.y)),t.writeVertexUint32(n),t.writeVertexUint32(o),t.writeVertexFloat32(a),t.writeVertexFloat32(l)}}class dr extends Fe{writeLabel(t,e,i,r,s,n){const o=ne(t.priority,n),a=Ut(t.polyline),l=a[1][0];a[0].reverse();for(const h of a)for(let t=1;t<h.length;t++)b(h[t],l,h[t]);for(const[h,c]of Y(i,e.styles)){const t=ut(c.color),e=ut(c.outlineColor);for(const i of h){const n=r.get(i.fontId)[i.glyphId],h=this.writeVertex(s,l,i.topLeft,{x:n.minX,y:n.minY},t,e,o,i.lineDisplacement,a,i.scale),c=this.writeVertex(s,l,i.topRight,{x:n.maxX,y:n.minY},t,e,o,i.lineDisplacement,a,i.scale),d=this.writeVertex(s,l,i.bottomRight,{x:n.maxX,y:n.maxY},t,e,o,i.lineDisplacement,a,i.scale),u=this.writeVertex(s,l,i.bottomLeft,{x:n.minX,y:n.maxY},t,e,o,i.lineDisplacement,a,i.scale);this.writeIndices([h,c,d,h,d,u])}}return this.endMesh()}_writeVertex(t,e,i,r,s,n,o,a,l,h,c){t.writeVertexUint32(e),We(t,i),t.writeVertexFloat32(r.x),t.writeVertexFloat32(r.y),t.writeVertexFloat32(l),t.writeVertexUint32(De(s.x,s.y)),t.writeVertexUint32(n),t.writeVertexUint32(o),t.writeVertexFloat32(a);const d=this._computePolylineLength(h);for(const u of h)this._writePolylinePart(t,u,d);t.writeVertexFloat32(d),t.writeVertexFloat32(c)}_writePolylinePart(t,e,i){const r=[];for(let a=1;a<=4;a++)r.push(this._encodePoint(e[a],i));for(let a=0;a<4;a+=4)t.writeVertexUint32((s=Be(r[a].ratio),n=Be(r[a+1].ratio),o=Be(r[a+2].ratio),Be(r[a+3].ratio)<<24|(255&o)<<16|(255&n)<<8|255&s));var s,n,o;for(let a=0;a<4;a+=2)t.writeVertexUint32(De(Le(r[a].angle),Le(r[a+1].angle)))}_encodePoint(t=g(0,0),e){return{ratio:v(t)/e,angle:(Math.atan2(t.y,t.x)+Math.PI)/(2*Math.PI)}}_computePolylineLength(t){let e=0;for(const i of t)for(let t=1;t<=4;t++)i[t]&&(e+=v(i[t]));return e}}class ur extends Fe{writeIcon(t,e,i,r,s,n){const o=i.height*s*32,a=i.width*s*32,l=(r.x+.5)*a,h=(r.y+.5)*o,c=.5*-o,d=.5*o,u=.5*-a,f=.5*a,p=ne(t.priority,n),_=this.writeVertex(t.position,u,d,l,h,e.minX,e.minY,t.id,p),g=this.writeVertex(t.position,u,c,l,h,e.minX,e.maxY,t.id,p),y=this.writeVertex(t.position,f,d,l,h,e.maxX,e.minY,t.id,p),m=this.writeVertex(t.position,f,c,l,h,e.maxX,e.maxY,t.id,p);return this.writeIndices([_,y,g,g,y,m]),this.endMesh()}_writeVertex(t,e,i,r,s,n,o,a,l,h){We(t,e),t.writeVertexUint32(De(i,r)),t.writeVertexUint32(De(s,n)),t.writeVertexUint32(De(o,a)),t.writeVertexUint32(l),t.writeVertexFloat32(h)}}const fr=qe([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[7,{size:4,type:5121,normalized:!0}],[2,{size:4,type:5121,normalized:!0}],[10,{size:1,type:5126,normalized:!1}]]),pr=qe([[2,{size:4,type:5121,normalized:!1}],[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[6,{size:2,type:5126,normalized:!1}],[4,{size:2,type:5123,normalized:!1}],[7,{size:4,type:5121,normalized:!0}],[8,{size:4,type:5121,normalized:!0}],[9,{size:1,type:5126,normalized:!1}],[11,{size:1,type:5126,normalized:!1}]]),_r=qe([[2,{size:4,type:5121,normalized:!1}],[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[6,{size:3,type:5126,normalized:!1}],[4,{size:2,type:5123,normalized:!1}],[7,{size:4,type:5121,normalized:!0}],[8,{size:4,type:5121,normalized:!0}],[9,{size:1,type:5126,normalized:!1}],[12,{size:4,type:5121,normalized:!0}],[13,{size:4,type:5123,normalized:!0}],[14,{size:4,type:5121,normalized:!0}],[15,{size:4,type:5123,normalized:!0}],[11,{size:2,type:5126,normalized:!1}]]),gr=qe([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[6,{size:2,type:5122,normalized:!1}],[11,{size:2,type:5122,normalized:!1}],[4,{size:2,type:5123,normalized:!1}],[2,{size:4,type:5121,normalized:!1}],[9,{size:1,type:5126,normalized:!1}]]),yr=qe([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[3,{size:1,type:5126,normalized:!1}],[7,{size:4,type:5121,normalized:!0}],[2,{size:4,type:5121,normalized:!0}]]);function*mr(t,e){const i=new Set;for(const r of function*(t){for(const e in t)yield Number(e)}(e))for(const t of e[r])i.add(t.location.bufferId);for(const r of i){const e=t.getPage(r);ui(e)&&(yield e)}}function*br(t,e){const i=new Set,r=e[4];r&&r.forEach(t=>i.add(t.atlasId));const s=e[5];s&&s.forEach(t=>i.add(t.atlasId));for(const n of i){const e=t.getAtlas(n);ui(e)&&(yield e)}}function*xr(t,e){const i=new Set,r=e[6];r&&r.forEach(t=>{i.add(t.atlasId)});const s=e[3];s&&s.forEach(t=>{i.add(t.atlasId)});for(const n of i){const e=t.getAtlas(n);ui(e)&&(yield e)}}class wr extends Fe{_writeVertex(t,e,i,r){We(t,e),t.writeVertexFloat32(e.z),t.writeVertexUint32(i),t.writeVertexUint32(r)}}function vr(t,e){return(e+1)%t.length}function kr(t,e){return(e||t.length)-1}function Ar(t,e){return t[vr(t,e)]}function Tr(t,e){return t[kr(t,e)]}const Sr={0:3,1:3,2:1,3:1};class Ir{constructor(t){this._view=new DataView(t),this.header={signature:this._view.getUint32(0,!0),nCmdAdd:this._view.getUint32(4,!0),nCmdEtc:this._view.getUint16(8,!0),nAux:this._view.getUint16(10,!0),precision:this._view.getUint8(12)},this._auxOffset=13,this._cmdOffset=this._auxOffset+2*this.header.nAux,this._diffOffset=this._cmdOffset+this.header.nCmdAdd+this.header.nCmdEtc,this._cmdEnd=this._diffOffset}readCommand(t={type:0,valence:0,shift:0}){const e=this._view.getUint8(this._cmdOffset++),i=3&e;let r=e>>2;r=0!==r?r-1:this._readAux()+62,r+=Sr[i];const s=2===i||3===i?this._readAux():0;return t.type=i,t.valence=r,t.shift=s,t}readDiff(t=Ci(0,0,0)){return t.x=this._readDiff(this._diffOffset+3*this.header.nCmdAdd,this._diffOffset+0*this.header.nCmdAdd),t.y=this._readDiff(this._diffOffset+4*this.header.nCmdAdd,this._diffOffset+1*this.header.nCmdAdd),t.z=this._readDiff(this._diffOffset+5*this.header.nCmdAdd,this._diffOffset+2*this.header.nCmdAdd),this._diffOffset++,t}hasCommands(){return this._cmdOffset<this._cmdEnd}_readAux(){const t=this._view.getUint8(this._auxOffset),e=this._view.getUint8(this._auxOffset+this.header.nAux)<<8|t;return this._auxOffset++,e}_readDiff(t,e){return(i=this._view.getUint8(t)<<8|this._view.getUint8(e))>>1^-(1&i);var i}}class zr{constructor(t,e,i){this.vertex=e,this.index=i,this._neighbours=new Array(t).fill(void 0)}calculateSpan(t,e){const i=this._neighbours.indexOf(t),r=this._neighbours.indexOf(e);return(this._neighbours.length+(r-i))%this._neighbours.length}setNeighbors(t,e,i=0,r){let s=(this._neighbours.indexOf(r)+i)%this._neighbours.length;this._neighbours[s]=t,s=vr(this._neighbours,s),this._neighbours[s]=e}setBefore(t,e){const i=this._neighbours.indexOf(t);this._neighbours[kr(this._neighbours,i)]=e}setAfter(t,e){const i=this._neighbours.indexOf(t);this._neighbours[vr(this._neighbours,i)]=e}getPrevNeighbor(t){const e=this._neighbours.indexOf(t);return Tr(this._neighbours,e)}getNextNeighbor(t){const e=this._neighbours.indexOf(t);return Ar(this._neighbours,e)}}const Pr=Ci(-1,-1,-1);class Rr extends zr{constructor(t){super(t,Pr,-1)}static isHoleNode(t){return t instanceof Rr}}const Cr=Ci(0,0,0),Or=Ci(0,0,0),Mr={type:0,valence:0,shift:0};function Er(t,e,i,r){Rr.isHoleNode(t)||Rr.isHoleNode(e)||Rr.isHoleNode(i)||r.writeIndices([t.index,e.index,i.index])}const Br=(t,e)=>t-e;function Lr(t,e){const i=new Array(t.length);for(let n=0,o=t.length;o>0;){if(i[n]=t[n].calculateSpan(Tr(t,n),Ar(t,n)),i[n]>1)n=vr(t,n),o--;else if(1===i[n]){const r=t[n],s=Tr(t,n),a=Ar(t,n);a.setAfter(r,s),s.setBefore(r,a),Er(r,s,a,e);for(let t=n;t<i.length-1;t++)i[t]=i[t+1];t.splice(n,1),n=kr(t,n),o++}else Te(t,t.length-vr(t,n)),t.splice(t.length-2,2),n=0,o=t.length;if(t.length<3)return}let r=0,s=[i[r],i[kr(t,r)],i[vr(t,r)]];for(let n=1;n<t.length;n++){const e=[i[n],i[kr(t,n)],i[vr(t,n)]];Ie(Br,e,s)<0&&(s=e,r=n)}Te(t,t.length-r)}function Ur(t,e,i,r,s,n){r.setNeighbors(e,i,s,n),e.setAfter(i,r),i.setBefore(e,r),Er(r,e,i,t)}function Dr(t,e,i,r,s){const n=e[0],o=n[0],a=n[n.length-1];switch(t.type){case 0:{const e=o.getPrevNeighbor(a);let l;Rr.isHoleNode(o)||Rr.isHoleNode(a)||Rr.isHoleNode(e)?l=Rr.isHoleNode(o)?a.vertex:o.vertex:(Mi(a.vertex,o.vertex,Or),Ei(Or,e.vertex,Or),r.clamp(Or,Or),l=Or),i.readDiff(Cr),Mi(l,Cr,Or);const h=Oi(Or),c=r.decode(h),d=new zr(t.valence,h,s.writeVertex(c));Ur(s,o,a,d,0),n.push(d);break}case 1:{const e=new Rr(t.valence);Ur(s,o,a,e,0),n.push(e);break}case 2:{const i=t.shift;Ur(s,o,a,n[i],t.valence,n[i-1]),e.push(n.slice(0,i+1)),n.splice(0,i);break}case 3:{let i=1;for(;i!==e.length&&e[i].length<=t.shift;i++)t.shift-=e[i].length;Te(e[i],e[i].length-t.shift),Ur(s,o,a,e[i][0],t.valence,e[i][e[i].length-1]),e[i].push(e[i][0]),n.splice(0,0,...e[i]),e.splice(i,1);break}}}function Nr(t,e,i){const r=[function(t,e,i){const r=Ci(0,0,0),s=new Array(3);for(let n=0;n<3;n++){const o=t.readCommand();1===o.type?s[n]=new Rr(o.valence):0===o.type&&(t.readDiff(Cr),Mi(r,Cr,r),s[n]=new zr(o.valence,Oi(r),i.writeVertex(e.decode(r))))}for(let n=0;n<s.length;n++)s[n].setNeighbors(Ar(s,n),Tr(s,n));return Er(s[0],s[1],s[2],i),s}(t,e,i)];for(;0!==r.length;){for(Lr(r[0],i);r[0].length>2;)Dr(t.readCommand(Mr),r,t,e,i),Lr(r[0],i);r.shift()}return i.flush()}class jr{constructor(t){this._precisionXY=15&t,this._precisionZ=t>>4,this._shiftXY=16-this._precisionXY,this._shiftZ=16-this._precisionZ,this._maxXY=(1<<this._precisionXY)-1,this._maxZ=(1<<this._precisionZ)-1}clamp(t,e=Ci(0,0,0)){return e.x=O(t.x,0,this._maxXY),e.y=O(t.y,0,this._maxXY),e.z=O(t.z,0,this._maxZ),e}decode(t,e=Ci(0,0,0)){return e.x=jr._decode(t.x,this._precisionXY,this._shiftXY),e.y=jr._decode(t.y,this._precisionXY,this._shiftXY),e.z=jr._decode(t.z,this._precisionZ,this._shiftZ),e}static _decode(t,e,i){return t<<=i,t=(t|=t>>e)/65535}}class Vr extends wr{constructor(t){super(t),this._trimeshWriter={writeVertex:t=>{const e=this._currentMesh;if(e){const i=e.bbox;return t.x=E(i.minX,i.maxX,t.x),t.y=E(i.minY,i.maxY,t.y),t.z=E(i.maxZ,i.minZ,t.z),this.writeVertex(t,this._currentColor,e.id)}return-1},writeIndices:t=>this.writeIndices(t),flush:()=>this.endMesh()}}writeModel(t,e){this._currentMesh=e,this._currentColor=ut(e.color);const i=[];let r;for(const s of function*(t,e){const i=new Ir(t),r=new jr(i.header.precision);for(;i.hasCommands();)yield Nr(i,r,e)}(t,this._trimeshWriter))r?r.bufferId===s.bufferId?(r.vertexByteLength+=s.vertexByteLength,r.indexByteLength+=s.indexByteLength):(i.push(r),r=s):r=s;return i.push(r),i}}class Wr extends wr{writePolygon(t,e,i,r){const s=ut(i),n=t.vertexRings.reduce((t,e)=>(t.push(...e),t),[]);for(const o of n)this.writeVertex(Object.assign(Object.assign({},o),{z:e}),s,r);for(const o of n)this.writeVertex(Object.assign(Object.assign({},o),{z:0}),s,r);return this.writeIndices(lr(t.vertexRings)),this._buildWall(t.vertexRings,n.length),this.endMesh()}_buildWall(t,e){let i=0;for(const r of t){for(let t=0;t<r.length;t++){const s=i+t,n=i+(t+1)%r.length;this.writeIndices([s+e,n,s,s+e,n+e,n])}i+=r.length}}}function Fr(t,e){let i;return()=>{i&&setTimeout(t=>t.release(),0,i),i=t.getFreeOrCreatePage(e),i.retain();const r=t=>{t.release(),t.onRetain.removeListener(r)};return i.retain(),i.onRetain.addListener(r),i.data}}class qr{constructor(t,e,i,r,s,n,o){this._registry=t,this._glyphAtlasRegistry=e,this._iconAtlasRegistry=i,this._taskQueue=s,this._loadManager=n,this._taskPriority=o,this._objectIdProvider=r,this._opaquePolygonBufferWriter=new hr(Fr(t,fr)),this._transparentPolygonBufferWriter=new hr(Fr(t,fr)),this._extrudedPolygonWriter=new Wr(Fr(t,yr)),this._trimeshBufferWriter=new Vr(Fr(t,yr)),this._polylineBufferWriter=new Ze(Fr(t,Ye)),this._pointLabelBufferWriter=new cr(Fr(t,pr)),this._curvedLabelBufferWriter=new dr(Fr(t,_r)),this._iconBufferWriter=new ur(Fr(t,gr)),this._sharedResourcesExtractors=[mr.bind(void 0,this._registry),br.bind(void 0,this._glyphAtlasRegistry),xr.bind(void 0,this._iconAtlasRegistry)]}_extractSharedResources(t){const e=[];for(const i of this._sharedResourcesExtractors)e.push(...i(t));return e}}class Yr{constructor(t){this._objectIdProvider=t,this._ids=new Map,this._tileIds=new Map}createSharedIdProvider(t){return{idGenerator:e=>this._getObjectId(t,e),collidingIdGenerator:e=>this._getCollidingObjectId(t,e)}}releaseTileObjectIds(t){const e=this._tileIds.get(t);if(e){this._tileIds.delete(t);for(const t of e)this._releaseId(t)}}_getObjectId(t,e){return this._getId(t,e,this._objectIdProvider.idGenerator)}_getCollidingObjectId(t,e){return this._getId(t,e,this._objectIdProvider.collidingIdGenerator)}_getId(t,e,i){if(!e)return i();return this._addIdToTile(t,e),this._retainId(e,i).id}_addIdToTile(t,e){let i=this._tileIds.get(t);i||(i=[],this._tileIds.set(t,i)),i.push(e)}_retainId(t,e){let i=this._ids.get(t);return i?i.count++:(i={id:e(),count:1},this._ids.set(t,i)),i}_releaseId(t){const e=this._ids.get(t);e?(e.count--,0===e.count&&this._ids.delete(t)):console.warn("Tried to release non-existing id")}}const Xr={tileUrlTemplate:"no tileUrlTemplate specified",meshUrlTemplate:"no meshUrlTemplate specified",tileSize:0,mapMode:0,customizationConfig:[],objectsCollisionPriority:1};class Gr extends qr{constructor(t,e,i,r,s,n,o,a,l,h,c){super(r,s,n,a,l,h,c),this._communicator=t,this._storage=e,this._modelStorage=i,this._viewport=o,this._requests=new Map,this._modelRequests=new Map,this._options=Object.assign({},Xr),this._tileLoader=new bi(this._loadManager,this._storage),this._stylesCustomizer=new nr,this._objectIdManager=new Yr(a),this._communicator.onMessage.addListener(this._onMessage,this),this._storage.onAdded.addListener(this._onTileAdded,this),this._storage.onRemoved.addListener(this._onTileRemoved,this),this._modelStorage.onRemoved.addListener(this._onModelRemoved,this)}destructor(){this._modelStorage.onRemoved.removeListener(this._onModelRemoved),this._storage.onRemoved.removeListener(this._onTileRemoved),this._storage.onAdded.removeListener(this._onTileAdded),this._communicator.onMessage.removeListener(this._onMessage)}_createTileRequest(t,e){const i=this._objectIdManager.createSharedIdProvider(t.id);return new di(t,e,this._taskQueue,this._tileLoader,this._viewport,this._taskPriority,this._opaquePolygonBufferWriter,this._transparentPolygonBufferWriter,this._extrudedPolygonWriter,this._polylineBufferWriter,this._pointLabelBufferWriter,this._curvedLabelBufferWriter,this._iconBufferWriter,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,i,this._stylesCustomizer)}_onMessage(t){switch(t.type){case 0:this._onSetup(t);break;case 2:this._onCustomize(t)}}_onSetup(t){this._options=Object.assign(Object.assign({},Xr),t.options),this._tileLoader.update(this._options.tileUrlTemplate,this._options.tileSize)}_onCustomize(t){this._stylesCustomizer.update(t.customizationConfig)}_onTileAdded(t){const e=this._createTileRequest(t,this._options);this._requests.set(t.id,e),e.onContentReady.addListener(e=>this._onTileContentReady(t,e)),e.onModelRequired.addListener(e=>this._onModelRequired(t,e)),e.start()}_onTileRemoved(t){const e=this._requests.get(t.id);ui(e)&&(e.destructor(),this._requests.delete(t.id)),this._objectIdManager.releaseTileObjectIds(t.id)}_onModelRemoved(t){const e=this._modelRequests.get(t.id);ui(e)&&(e.destructor(),this._modelRequests.delete(t.id))}_onTileContentReady(t,e){e.contentToRemove&&this._communicator.sendMessage({type:4,tileId:t.id,content:e.contentToRemove},!1),t.addContent(e.content,this._extractSharedResources(e.content.primitives)),this._registry.flushBackendUpdates(),this._iconAtlasRegistry.flushAtlasesUpdates(),this._communicator.sendMessage({type:3,tileId:t.id,content:e.content,metrics:e.metrics},!0)}_onModelContentReady(t,e){const i=[];for(const r of this._sharedResourcesExtractors)i.push(...r(e.primitives));t.addContent({content:e,resources:i}),this._registry.flushBackendUpdates(),this._communicator.sendMessage({type:5,modelId:t.id,content:e},!0)}_onModelRequired(t,e){if(this._options.meshUrlTemplate){const i=si(e);let r=this._modelStorage.get(i);r||(r=new mi(i,e),this._modelStorage.add(i,r));let s=this._modelRequests.get(i);s||(s=new gi(r,this._taskQueue,this._loadManager,this._viewport,this._taskPriority,this._trimeshBufferWriter,this._options.meshUrlTemplate),this._modelRequests.set(r.id,s),s.onContentReady.addListener(t=>this._onModelContentReady(r,t)),s.start()),s.addTile(t),t.addContent(r,[r])}}}var Zr;!function(t){t[t.FROM_BACKEND_ADD_PAGE=0]="FROM_BACKEND_ADD_PAGE",t[t.FROM_BACKEND_UPDATE_PAGE=1]="FROM_BACKEND_UPDATE_PAGE",t[t.FROM_BACKEND_REMOVE_PAGE=2]="FROM_BACKEND_REMOVE_PAGE"}(Zr||(Zr={}));Error;class Hr{constructor(t,e){this._wordByteSize=e,this._nextWordOffset=0,this._currentMeshByteOffset=0,this._uint8View=new Uint8Array(t)}get data(){return this._uint8View.buffer}get byteSize(){return this._uint8View.byteLength}get occupiedByteSize(){return this._nextWordOffset*this._wordByteSize}endMesh(){const t=this._currentMeshByteOffset,e=this.occupiedByteSize,i=e-t;return this._currentMeshByteOffset=e,{byteOffset:t,byteSize:i}}transferUnfinishedMesh(t){const e=this.occupiedByteSize,i=e-this._currentMeshByteOffset,r=this._uint8View.subarray(this._currentMeshByteOffset,e);t._uint8View.set(r,0),t._nextWordOffset=i/this._wordByteSize,this._nextWordOffset=this._currentMeshByteOffset/this._wordByteSize}reset(){this._nextWordOffset=0,this._currentMeshByteOffset=0}}class Kr extends Hr{constructor(t,e){super(t*e,Uint32Array.BYTES_PER_ELEMENT),this.vertexByteSize=e,this._uint32View=new Uint32Array(this._uint8View.buffer),this._float32View=new Float32Array(this._uint8View.buffer),this._currentMeshBaseIndex=0}get currentMeshBaseIndex(){return this._currentMeshBaseIndex}get isFull(){return this._nextWordOffset>=this._uint32View.length}pushUint32(t){this._uint32View[this._nextWordOffset++]=t}pushFloat32(t){this._float32View[this._nextWordOffset++]=t}asUint32Array(){return this._uint32View.subarray(0,this._nextWordOffset)}endMesh(){return this._currentMeshBaseIndex=this.occupiedByteSize/this.vertexByteSize,super.endMesh()}reset(){this._currentMeshBaseIndex=0,super.reset()}}class Qr extends Hr{constructor(t){const e=Uint16Array.BYTES_PER_ELEMENT;super(t*e,e),this._uint16View=new Uint16Array(this._uint8View.buffer)}get size(){return this._uint16View.length}get occupiedSize(){return this._nextWordOffset}push(t){this._uint16View[this._nextWordOffset++]=t}asUint16Array(){return this._uint16View.subarray(0,this._nextWordOffset)}transferUnfinishedMesh(t,e=0){if(super.transferUnfinishedMesh(t),e)for(let i=0;i<t._nextWordOffset;i++)t._uint16View[i]-=e}}class $r{constructor(t,e,i,s){this.id=t,this.vertexBuffer=new Kr(e,i),this.indexBuffer=new Qr(s),this.onMeshWritten=this._onMeshWritten=new r}writeVertexUint32(t){this.vertexBuffer.pushUint32(t)}writeVertexFloat32(t){this.vertexBuffer.pushFloat32(t)}writeIndices(t){const e=this.vertexBuffer.currentMeshBaseIndex;for(const i of t)this.indexBuffer.push(e+i)}endMesh(){const t=this.vertexBuffer.endMesh(),e=this.indexBuffer.endMesh(),i={vertexByteOffset:t.byteOffset,vertexByteLength:t.byteSize,indexByteOffset:e.byteOffset,indexByteLength:e.byteSize,bufferId:this.id};return this._onMeshWritten.fire(i),i}reset(){this.vertexBuffer.reset(),this.indexBuffer.reset()}}const Jr={vertexMinByte:Number.MAX_SAFE_INTEGER,vertexMaxByte:Number.MIN_SAFE_INTEGER,indexMinByte:Number.MAX_SAFE_INTEGER,indexMaxByte:Number.MIN_SAFE_INTEGER};class ts extends yi{constructor(t,e,i,s,n){super(),this.id=t,this.attribMapping=e,this.data=new $r(t,i,s,n),this.data.onMeshWritten.addListener(this._onMeshWritten,this),this.onUpdate=this._onUpdate=new r,this._updatedRegion=Object.assign({},Jr)}reset(){this.data.reset(),this.flushUpdatedRegion()}touch(t){this._onMeshWritten(t)}flushUpdatedRegion(){const t=this._updatedRegion;return this._updatedRegion=Object.assign({},Jr),t}_onMeshWritten(t){t.vertexByteOffset<this._updatedRegion.vertexMinByte&&(this._updatedRegion.vertexMinByte=t.vertexByteOffset);const e=t.vertexByteOffset+t.vertexByteLength;e>this._updatedRegion.vertexMaxByte&&(this._updatedRegion.vertexMaxByte=e),t.indexByteOffset<this._updatedRegion.indexMinByte&&(this._updatedRegion.indexMinByte=t.indexByteOffset);const i=t.indexByteOffset+t.indexByteLength;i>this._updatedRegion.indexMaxByte&&(this._updatedRegion.indexMaxByte=i),this._onUpdate.fire(this)}}class es{constructor(t){this._communicator=t,this._updatedPages=new Set,this._pages=new Map,this._freePages=new Map,this._lastGeneratedPageId=0}getPage(t){return this._pages.get(t)}getFreeOrCreatePage(t){const e=this._freePages.get(t),i=e&&e.pop();if(i)return i.reset(),i;{const e=this._generateId(),i=new ts(e,t,65536,t.vertexByteSize,131072);return i.onUpdate.addListener(this._onPageUpdated,this),i.onReleased.addListener(this._onPageReleased,this),this._pages.set(e,i),this._communicator.sendMessage({type:Zr.FROM_BACKEND_ADD_PAGE,id:e,attribMapping:t,vertexDataByteSize:i.data.vertexBuffer.byteSize,indexDataByteSize:i.data.indexBuffer.byteSize},!1),i}}flushBackendUpdates(){for(const t of this._updatedPages){const{vertexMinByte:e,vertexMaxByte:i,indexMinByte:r,indexMaxByte:s}=t.flushUpdatedRegion(),n=t.data.vertexBuffer.data.slice(e,i),o=t.data.indexBuffer.data.slice(r,s);this._communicator.sendMessage({type:Zr.FROM_BACKEND_UPDATE_PAGE,id:t.id,vertexData:n,vertexByteOffset:e,indexData:o,indexByteOffset:r},!1,n,o)}this._updatedPages.clear()}_onPageUpdated(t){this._updatedPages.add(t)}_onPageReleased(t){const e=this._freePages.get(t.attribMapping);e?e.push(t):this._freePages.set(t.attribMapping,[t])}_generateId(){return this._lastGeneratedPageId++}}function is(t){return(t+1>>1)-1}function rs(t){return(t+1<<1)-1}class ss{constructor(t=ve){this._items=[],this._comparator=t}insert(t){const e=this._items,i=this._comparator;let r=e.push(t)-1,s=is(r);for(;s>-1&&i(e[r],e[s])>0;)ke(e,r,s),r=s,s=is(r)}pop(){const t=this._items;if(0===t.length)return;const e=t[0];return this._removeByIndex(0),e}peek(){return this._items[0]}*[Symbol.iterator](){for(const t of this._items)yield t}get size(){return this._items.length}remove(t){const e=this._items.findIndex(t);-1!=e&&this._removeByIndex(e)}_restoreOrderDownward(t){let e=t,i=rs(e);const r=this._items.length,s=this._comparator,n=this._items;for(;i<r&&(i+1<r&&s(n[i],n[i+1])<0&&(i+=1),!(s(n[e],n[i])>0));)ke(n,e,i),e=i,i=rs(i)}_removeByIndex(t){ke(this._items,t,this._items.length-1),this._items.pop(),this._restoreOrderDownward(t)}}function ns(t,e){return t.priority-e.priority}class os{constructor(){this._heap=new ss(ns)}enqueue(t){this._heap.insert(t)}dequeue(){return this._heap.pop()}peek(){return this._heap.peek()}isEmpty(){return 0===this._heap.size}get size(){return this._heap.size}remove(t){this._heap.remove(t)}}class as extends class{constructor(){this._listeners=new Set}addListener(t){this._listeners.add(t)}removeListener(t){this._listeners.delete(t)}fire(t){this._listeners.forEach(e=>{e(t)})}}{fire(){super.fire(void 0)}}class ls{constructor(t=50){this._queue=new os,this._frozen=!1,this._dequeueTimeoutHandle=0,this.onEmpty=new as,this.onAdd=new as,this._maxDequeueDuration=t}destroy(){clearTimeout(this._dequeueTimeoutHandle)}enqueue(t){return this.onAdd.fire(),this._frozen||this._setDequeueTimeout(),new Promise((e,i)=>{this._queue.enqueue({execute(){try{t.execute(),e()}catch(r){i(r)}},priority:t.priority})})}enqueueSync(t){this._queue.enqueue(t),this._setDequeueTimeout()}remove(t){this._queue.remove(e=>e===t)}isEmpty(){return this._queue.isEmpty()}freeze(){this._dequeueTimeoutHandle&&(clearTimeout(this._dequeueTimeoutHandle),this._dequeueTimeoutHandle=0),this._frozen=!0}unfreeze(){this._frozen=!1,this._queue.isEmpty()||this._setDequeueTimeout()}_dequeue(){if(this._dequeueTimeoutHandle=0,null===this._maxDequeueDuration)for(;this._queue.size;)this._queue.dequeue().execute();else{const t=de();for(;this._queue.size&&(this._queue.dequeue().execute(),!(de()-t>this._maxDequeueDuration)););}this._queue.isEmpty()?this.onEmpty.fire():this._setDequeueTimeout()}_setDequeueTimeout(){this._dequeueTimeoutHandle||(this._dequeueTimeoutHandle=setTimeout(()=>this._dequeue(),0))}}var hs;function cs(t=0,e=0){return{width:t,height:e}}!function(t){t[t.TO_BACKEND_SETUP=0]="TO_BACKEND_SETUP",t[t.FROM_BACKEND_ADD_ATLAS=1]="FROM_BACKEND_ADD_ATLAS",t[t.FROM_BACKEND_UPDATE_ATLAS=2]="FROM_BACKEND_UPDATE_ATLAS",t[t.FROM_BACKEND_REMOVE_ATLAS=3]="FROM_BACKEND_REMOVE_ATLAS"}(hs||(hs={}));class ds{constructor(t,e){this.width=t,this.height=e,this._cursor={x:0,y:0,lineHeight:0}}createRestorePoint(){return Object.assign({},this._cursor)}resetToRestorePoint(t){Object.assign(this._cursor,t)}allocate(t,e){const{x:i,y:r,lineHeight:s}=this._cursor,n=this.width-i,o=this.height-r;if(t<=n&&e<=o)return this._cursor.x=i+t,this._cursor.lineHeight=Math.max(s,e),{minX:i,maxX:i+t,minY:r,maxY:r+e};const a=this.height-(r+s);return t<=this.width&&e<=a?(this._cursor.x=t,this._cursor.y=r+s,this._cursor.lineHeight=e,{minY:this._cursor.y,maxY:this._cursor.y+e,minX:0,maxX:t}):void 0}}const us={minX:Number.MAX_SAFE_INTEGER,maxX:Number.MIN_SAFE_INTEGER,minY:Number.MAX_SAFE_INTEGER,maxY:Number.MIN_SAFE_INTEGER};class fs extends yi{constructor(t,e,i){super(),this.id=t,this.width=e,this.height=i,this.data=this._data=new Uint8Array(e*i),this.allocatedGlyphs=this._allocatedGlyphs=new Map,this.allocatedRanges=new be,this._allocator=new ds(e,i),this._initAllocatorState=this._allocator.createRestorePoint(),this._updatedRegion=Object.assign({},us)}allocate(t,e){const i=this._allocator.createRestorePoint(),r=new Map;for(const[s,n]of t){const t=e.get(s);if(ui(t)){const e=p(r,s,()=>new Set);for(const[r,o]of n)if(!this.allocatedRanges.contains(s,r)){const s=Math.min(o,t.glyphs.length);for(let n=r;n<s;++n){const r=t.glyphs[n];if(ui(r)){const s=this._allocator.allocate(r.width+2*t.margin,r.height+2*t.margin);if(!s)return this._allocator.resetToRestorePoint(i),!1;e.add({glyph:r,location:s})}}}}}for(const[s,n]of r){const t=p(this._allocatedGlyphs,s,()=>[]);for(const i of n)t[i.glyph.id]=i.location,this._insertGlyphBitmap(i.location,i.glyph.bitmap);this.allocatedRanges.addRangesForGlyphs(s,...F(n,t=>t.glyph.id));const e=this._computeUpdatedRegion(F(n,t=>t.location));e&&(this._updatedRegion=this._computeUpdatedRegion([e,this._updatedRegion]))}return!0}flushUpdates(){if(this._updatedRegion.minX!==us.minX){const t=this._updatedRegion.maxX-this._updatedRegion.minX,e=this._updatedRegion.maxY-this._updatedRegion.minY,i=new Uint8Array(t*e);let r=0;for(let a=this._updatedRegion.minY;a<this._updatedRegion.maxY;++a)for(let t=this._updatedRegion.minX;t<this._updatedRegion.maxX;++t)i[r]=this._data[a*this.width+t],++r;const s=this._updatedRegion,n=g(s.minX,s.minY),o=cs(s.maxX-s.minX,s.maxY-s.minY);return this._updatedRegion=Object.assign({},us),{offset:n,size:o,data:i}}}reset(){this._allocatedGlyphs.clear(),this.allocatedRanges.clear(),this._allocator.resetToRestorePoint(this._initAllocatorState),this._updatedRegion=Object.assign({},us)}_insertGlyphBitmap(t,e){const i=this.width;let r=0;for(let s=t.minY;s<t.maxY;++s)for(let n=t.minX;n<t.maxX;++n)this._data[s*i+n]=e[r],++r}_computeUpdatedRegion(t){const e=function(t){let e;for(const i of t)e?(i.minX<e.minX&&(e.minX=i.minX),i.maxX>e.maxX&&(e.maxX=i.maxX),i.minY<e.minY&&(e.minY=i.minY),i.maxY>e.maxY&&(e.maxY=i.maxY)):e=Object.assign({},i);return e}(t);return e?{minY:e.minY,maxY:e.maxY,minX:4*Math.floor(e.minX/4),maxX:4*Math.ceil(e.maxX/4)}:void 0}}const ps={glyphRangeUrlTemplate:"no url for glyph ranges"};class _s{constructor(t,e,i=2048,r=2048){this._communicator=t,this._fontLoader=e,this._atlasWidth=i,this._atlasHeight=r,this._loadedFontsAsRanges=new be,this._atlases=[],this._freeAtlases=[],this.loadedFonts=this._loadedFonts=new Map,this._options=Object.assign({},ps),this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getAtlas(t){return this._atlases[t]}hasAllGlyphsLoaded(t){return this._loadedFontsAsRanges.containsAll(t)}getAtlasWithGlyphs(t){return this._getAtlas(t)}loadGlyphsAndGetAtlas(t,e){const i=[];for(const[r,s]of t)for(const[t,n]of s)this._loadedFontsAsRanges.contains(r,t)||i.push(this._loadRange(r,t,n,e));return Promise.all(i).then(()=>this._getAtlas(t))}_onMessage(t){switch(t.type){case hs.TO_BACKEND_SETUP:this._onSetup(t)}}_onSetup(t){Object.assign(this._options,t.options)}_loadRange(t,e,i,r){let s=this._loadedFonts.get(t);s||(s={id:t,xheight:-1,margin:-1,glyphs:[]},this._loadedFonts.set(t,s));const n=this._options.glyphRangeUrlTemplate.replace("{{hostAlias}}",fi(t+e)).replace("{{fontId}}",t).replace("{{range}}",e+","+i);return this._fontLoader.fillFont(n,s,e,r).then(()=>{this._loadedFontsAsRanges.addRangesForGlyphs(t,e)})}_getAtlas(t){for(const i of this._atlases)if(i.allocatedRanges.containsAll(t))return i;const e=this._atlases[this._atlases.length-1];if(e&&e.allocate(t,this._loadedFonts)){const t=e.flushUpdates();return ui(t)&&this._communicator.sendMessage(Object.assign({type:hs.FROM_BACKEND_UPDATE_ATLAS,atlasId:e.id},t),!1,t.data.buffer),e}{let e=this._freeAtlases.pop();if(!e){const t=new fs(this._atlases.length,this._atlasWidth,this._atlasHeight);t.onReleased.addListener(()=>{t.reset(),this._freeAtlases.push(t)}),this._atlases.push(t),this._communicator.sendMessage({type:hs.FROM_BACKEND_ADD_ATLAS,atlasId:t.id,width:t.width,height:t.height},!1),e=t}if(e.allocate(t,this._loadedFonts)){const t=e.flushUpdates();return t&&this._communicator.sendMessage(Object.assign({type:hs.FROM_BACKEND_UPDATE_ATLAS,atlasId:e.id},t),!1),e}throw new Error("Couldnt allocate glyphs in atlas")}}}i(29);const gs=new TextDecoder("utf-8");const ys=new TextEncoder;class ms{constructor(t=8192,e={}){let i=!1;"number"==typeof t?t=new ArrayBuffer(t):(i=!0,this.lastWrittenByte=t.byteLength);const r=e.offset?e.offset>>>0:0,s=t.byteLength-r;let n=r;(ArrayBuffer.isView(t)||t instanceof ms)&&(t.byteLength!==t.buffer.byteLength&&(n=t.byteOffset+r),t=t.buffer),this.lastWrittenByte=i?s:0,this.buffer=t,this.length=s,this.byteLength=s,this.byteOffset=n,this.offset=0,this.littleEndian=!0,this._data=new DataView(this.buffer,n,s),this._mark=0,this._marks=[]}available(t=1){return this.offset+t<=this.length}isLittleEndian(){return this.littleEndian}setLittleEndian(){return this.littleEndian=!0,this}isBigEndian(){return!this.littleEndian}setBigEndian(){return this.littleEndian=!1,this}skip(t=1){return this.offset+=t,this}seek(t){return this.offset=t,this}mark(){return this._mark=this.offset,this}reset(){return this.offset=this._mark,this}pushMark(){return this._marks.push(this.offset),this}popMark(){const t=this._marks.pop();if(void 0===t)throw new Error("Mark stack empty");return this.seek(t),this}rewind(){return this.offset=0,this}ensureAvailable(t=1){if(!this.available(t)){const e=2*(this.offset+t),i=new Uint8Array(e);i.set(new Uint8Array(this.buffer)),this.buffer=i.buffer,this.length=this.byteLength=e,this._data=new DataView(this.buffer)}return this}readBoolean(){return 0!==this.readUint8()}readInt8(){return this._data.getInt8(this.offset++)}readUint8(){return this._data.getUint8(this.offset++)}readByte(){return this.readUint8()}readBytes(t=1){const e=new Uint8Array(t);for(let i=0;i<t;i++)e[i]=this.readByte();return e}readInt16(){const t=this._data.getInt16(this.offset,this.littleEndian);return this.offset+=2,t}readUint16(){const t=this._data.getUint16(this.offset,this.littleEndian);return this.offset+=2,t}readInt32(){const t=this._data.getInt32(this.offset,this.littleEndian);return this.offset+=4,t}readUint32(){const t=this._data.getUint32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat32(){const t=this._data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t}readFloat64(){const t=this._data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t}readChar(){return String.fromCharCode(this.readInt8())}readChars(t=1){let e="";for(let i=0;i<t;i++)e+=this.readChar();return e}readUtf8(t=1){return e=this.readBytes(t),gs.decode(e);var e}writeBoolean(t){return this.writeUint8(t?255:0),this}writeInt8(t){return this.ensureAvailable(1),this._data.setInt8(this.offset++,t),this._updateLastWrittenByte(),this}writeUint8(t){return this.ensureAvailable(1),this._data.setUint8(this.offset++,t),this._updateLastWrittenByte(),this}writeByte(t){return this.writeUint8(t)}writeBytes(t){this.ensureAvailable(t.length);for(let e=0;e<t.length;e++)this._data.setUint8(this.offset++,t[e]);return this._updateLastWrittenByte(),this}writeInt16(t){return this.ensureAvailable(2),this._data.setInt16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeUint16(t){return this.ensureAvailable(2),this._data.setUint16(this.offset,t,this.littleEndian),this.offset+=2,this._updateLastWrittenByte(),this}writeInt32(t){return this.ensureAvailable(4),this._data.setInt32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeUint32(t){return this.ensureAvailable(4),this._data.setUint32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat32(t){return this.ensureAvailable(4),this._data.setFloat32(this.offset,t,this.littleEndian),this.offset+=4,this._updateLastWrittenByte(),this}writeFloat64(t){return this.ensureAvailable(8),this._data.setFloat64(this.offset,t,this.littleEndian),this.offset+=8,this._updateLastWrittenByte(),this}writeChar(t){return this.writeUint8(t.charCodeAt(0))}writeChars(t){for(let e=0;e<t.length;e++)this.writeUint8(t.charCodeAt(e));return this}writeUtf8(t){return this.writeBytes(function(t){return ys.encode(t)}(t))}toArray(){return new Uint8Array(this.buffer,this.byteOffset,this.lastWrittenByte)}_updateLastWrittenByte(){this.offset>this.lastWrittenByte&&(this.lastWrittenByte=this.offset)}}var bs=i(3);const xs=[137,80,78,71,13,10,26,10],ws=[];for(let En=0;En<256;En++){let t=En;for(let e=0;e<8;e++)1&t?t=3988292384^t>>>1:t>>>=1;ws[En]=t}function vs(t,e){return(4294967295^function(t,e,i){let r=t;for(let s=0;s<i;s++)r=ws[255&(r^e[s])]^r>>>8;return r}(4294967295,t,e))>>>0}var ks,As,Ts,Ss;!function(t){t[t.UNKNOWN=-1]="UNKNOWN",t[t.GREYSCALE=0]="GREYSCALE",t[t.TRUECOLOUR=2]="TRUECOLOUR",t[t.INDEXED_COLOUR=3]="INDEXED_COLOUR",t[t.GREYSCALE_ALPHA=4]="GREYSCALE_ALPHA",t[t.TRUECOLOUR_ALPHA=6]="TRUECOLOUR_ALPHA"}(ks||(ks={})),function(t){t[t.UNKNOWN=-1]="UNKNOWN",t[t.DEFLATE=0]="DEFLATE"}(As||(As={})),function(t){t[t.UNKNOWN=-1]="UNKNOWN",t[t.ADAPTIVE=0]="ADAPTIVE"}(Ts||(Ts={})),function(t){t[t.UNKNOWN=-1]="UNKNOWN",t[t.NO_INTERLACE=0]="NO_INTERLACE",t[t.ADAM7=1]="ADAM7"}(Ss||(Ss={}));const Is=new Uint8Array(0),zs=new Uint16Array([255]),Ps=255===new Uint8Array(zs.buffer)[0];class Rs extends ms{constructor(t,e={}){super(t);const{checkCrc:i=!1}=e;this._checkCrc=i,this._inflator=new bs.Inflate,this._png={width:-1,height:-1,channels:-1,data:new Uint8Array(0),depth:1,text:{}},this._end=!1,this._hasPalette=!1,this._palette=[],this._compressionMethod=As.UNKNOWN,this._filterMethod=Ts.UNKNOWN,this._interlaceMethod=Ss.UNKNOWN,this._colorType=-1,this.setBigEndian()}decode(){for(this.decodeSignature();!this._end;)this.decodeChunk();return this.decodeImage(),this._png}decodeSignature(){for(let t=0;t<xs.length;t++)if(this.readUint8()!==xs[t])throw new Error(`wrong PNG signature. Byte at ${t} should be ${xs[t]}.`)}decodeChunk(){const t=this.readUint32(),e=this.readChars(4),i=this.offset;switch(e){case"IHDR":this.decodeIHDR();break;case"PLTE":this.decodePLTE(t);break;case"IDAT":this.decodeIDAT(t);break;case"IEND":this._end=!0;break;case"tRNS":this.decodetRNS(t);break;case"tEXt":this.decodetEXt(t);break;case"pHYs":this.decodepHYs();break;default:this.skip(t)}if(this.offset-i!==t)throw new Error("Length mismatch while decoding chunk "+e);if(this._checkCrc){const i=this.readUint32(),r=t+4,s=vs(new Uint8Array(this.buffer,this.byteOffset+this.offset-r-4,r),r);if(s!==i)throw new Error(`CRC mismatch for chunk ${e}. Expected ${i}, found ${s}`)}else this.skip(4)}decodeIHDR(){const t=this._png;t.width=this.readUint32(),t.height=this.readUint32(),t.depth=function(t){if(1!==t&&2!==t&&4!==t&&8!==t&&16!==t)throw new Error("invalid bit depth: "+t);return t}(this.readUint8());const e=this.readUint8();let i;switch(this._colorType=e,e){case ks.GREYSCALE:i=1;break;case ks.TRUECOLOUR:i=3;break;case ks.INDEXED_COLOUR:i=1;break;case ks.GREYSCALE_ALPHA:i=2;break;case ks.TRUECOLOUR_ALPHA:i=4;break;default:throw new Error("Unknown color type: "+e)}if(this._png.channels=i,this._compressionMethod=this.readUint8(),this._compressionMethod!==As.DEFLATE)throw new Error("Unsupported compression method: "+this._compressionMethod);this._filterMethod=this.readUint8(),this._interlaceMethod=this.readUint8()}decodePLTE(t){if(t%3!=0)throw new RangeError("PLTE field length must be a multiple of 3. Got "+t);const e=t/3;this._hasPalette=!0;const i=[];this._palette=i;for(let r=0;r<e;r++)i.push([this.readUint8(),this.readUint8(),this.readUint8()])}decodeIDAT(t){this._inflator.push(new Uint8Array(this.buffer,this.offset+this.byteOffset,t),!1),this.skip(t)}decodetRNS(t){if(3===this._colorType){if(t>this._palette.length)throw new Error(`tRNS chunk contains more alpha values than there are palette colors (${t} vs ${this._palette.length})`);let e=0;for(;e<t;e++){const t=this.readByte();this._palette[e].push(t)}for(;e<this._palette.length;e++)this._palette[e].push(255)}}decodetEXt(t){let e,i="";for(;"\\0"!==(e=this.readChar());)i+=e;this._png.text[i]=this.readChars(t-i.length-1)}decodepHYs(){const t=this.readUint32(),e=this.readUint32(),i=this.readByte();this._png.resolution={x:t,y:e,unit:i}}decodeImage(){if(this._inflator.push(Is,!0),this._inflator.err)throw new Error("Error while decompressing the data: "+this._inflator.err);const t=this._inflator.result;if(this._filterMethod!==Ts.ADAPTIVE)throw new Error(`Filter method ${this._filterMethod} not supported`);if(this._interlaceMethod!==Ss.NO_INTERLACE)throw new Error(`Interlace method ${this._interlaceMethod} not supported`);this.decodeInterlaceNull(t)}decodeInterlaceNull(t){const e=this._png.height,i=this._png.channels*this._png.depth/8,r=this._png.width*i,s=new Uint8Array(this._png.height*r);let n,o,a=Is,l=0;for(let c=0;c<e;c++){switch(n=t.subarray(l+1,l+1+r),o=s.subarray(c*r,(c+1)*r),t[l]){case 0:Cs(n,o,r);break;case 1:Os(n,o,r,i);break;case 2:Ms(n,o,a,r);break;case 3:Es(n,o,a,r,i);break;case 4:Bs(n,o,a,r,i);break;default:throw new Error("Unsupported filter: "+t[l])}a=o,l+=r+1}if(this._hasPalette&&(this._png.palette=this._palette),16===this._png.depth){const t=new Uint16Array(s.buffer);if(Ps)for(let e=0;e<t.length;e++)t[e]=(255&(h=t[e]))<<8|h>>8&255;this._png.data=t}else this._png.data=s;var h}}function Cs(t,e,i){for(let r=0;r<i;r++)e[r]=t[r]}function Os(t,e,i,r){let s=0;for(;s<r;s++)e[s]=t[s];for(;s<i;s++)e[s]=t[s]+e[s-r]&255}function Ms(t,e,i,r){let s=0;if(0===i.length)for(;s<r;s++)e[s]=t[s];else for(;s<r;s++)e[s]=t[s]+i[s]&255}function Es(t,e,i,r,s){let n=0;if(0===i.length){for(;n<s;n++)e[n]=t[n];for(;n<r;n++)e[n]=t[n]+(e[n-s]>>1)&255}else{for(;n<s;n++)e[n]=t[n]+(i[n]>>1)&255;for(;n<r;n++)e[n]=t[n]+(e[n-s]+i[n]>>1)&255}}function Bs(t,e,i,r,s){let n=0;if(0===i.length){for(;n<s;n++)e[n]=t[n];for(;n<r;n++)e[n]=t[n]+e[n-s]&255}else{for(;n<s;n++)e[n]=t[n]+i[n]&255;for(;n<r;n++)e[n]=t[n]+Ls(e[n-s],i[n],i[n-s])&255}}function Ls(t,e,i){const r=t+e-i,s=Math.abs(r-t),n=Math.abs(r-e),o=Math.abs(r-i);return s<=n&&s<=o?t:n<=o?e:i}var Us;!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.METRE=1]="METRE"}(Us||(Us={}));class Ds{constructor(t){this._comparator=t,this._size=0}get root(){return this._root}get size(){return this._size}get min(){if(this._root)return this._min(this._root).value}get max(){if(this._root)return this._max(this._root).value}insert(t){if(this._size++,!this._root)return this._root={value:t},this._root;let e=this._root;for(;e;)if(this._comparator(t,e.value)<0){if(!e.left)return e.left={parent:e,value:t};e=e.left}else{if(!e.right)return e.right={parent:e,value:t};e=e.right}throw new Error}remove(t){if(this._size--,t.left&&t.right){const e=this._min(t.right);this._replaceSubtree(t,e),t.left&&(e.left=t.left,t.left.parent=e),t.right&&(e.right=t.right,t.right.parent=e)}else t.left?this._replaceSubtree(t,t.left):t.right?this._replaceSubtree(t,t.right):this._replaceSubtree(t,void 0)}*values(t){t&&(yield*this.values(t.left),yield t.value,yield*this.values(t.right))}[Symbol.iterator](){return this.values(this._root)}_min(t){let e=t;for(;e.left;)e=e.left;return e}_max(t){let e=t;for(;e.right;)e=e.right;return e}_replaceSubtree(t,e){t.parent?t.parent.left===t?t.parent.left=e:t.parent.right===t&&(t.parent.right=e):this._root=e,e&&(e.parent&&(e.parent.left===e?e.parent.left=void 0:e.parent.right===e&&(e.parent.right=void 0)),e.parent=t.parent)}}class Ns{constructor(){this._nodes=new Map}get begin(){return this._begin&&this._begin.value}get end(){return this._end&&this._end.value}insert(t){if(!this._nodes.has(t)){const e={value:t};this._end?this.insertAfter(this._end.value,t):(this._begin=this._end=e,this._nodes.set(t,e))}}insertBefore(t,e){const i=this._nodes.get(t);if(i&&!this._nodes.has(e)){const t={value:e};i.prev&&(i.prev.next=t,t.prev=i.prev),t.next=i,i.prev=t,this._nodes.set(e,t),i===this._begin&&(this._begin=t)}}insertAfter(t,e){const i=this._nodes.get(t);if(i&&!this._nodes.has(e)){const t={value:e};i.next&&(i.next.prev=t,t.next=i.next),t.prev=i,i.next=t,this._nodes.set(e,t),i===this._end&&(this._end=t)}}remove(t){const e=this._nodes.get(t);e&&(e===this._begin&&(this._begin=e.next),e===this._end&&(this._end=e.prev),e.next&&(e.next.prev=e.prev),e.prev&&(e.prev.next=e.next),this._nodes.delete(t))}getPrev(t){const e=this._nodes.get(t);if(e&&e.prev)return e.prev.value}getNext(t){const e=this._nodes.get(t);if(e&&e.next)return e.next.value}*values(){let t=this._begin;for(;t;)yield t.value,t=t.next}[Symbol.iterator](){return this.values()}}class js{constructor(t,e=1){this._size=t,this._alignment=e,this._freeOffset=0,this._allocatedOffsets=new Set}get size(){return this._size}get maxAllocableSize(){return this._size-this._freeOffset}get isEmpty(){return 0===this._allocatedOffsets.size}allocate(t){if(this._size>=this._freeOffset+t){const e=this._freeOffset;return this._freeOffset=function(t,e){return e*Math.ceil(t/e)}(e+t,this._alignment),this._allocatedOffsets.add(e),e}return-1}deallocate(t){this._allocatedOffsets.delete(t)}isAllocated(t){return t<this._freeOffset}extend(t){if(t<this._freeOffset)throw new Error("Could not reduce the size because it conflicts with already allocated region.");this._size=t}}class Vs{constructor(t){this._size=t,this._allRegions=new Ns,this._occupiedRegions=new Map,this._freeRegions=new Ds((t,e)=>t.size-e.size);const e={offset:0,size:t};this._allRegions.insert(e),e._freeNode=this._freeRegions.insert(e)}get size(){return this._size}get maxAllocableSize(){const t=this._freeRegions.max;return t?t.size:0}get isEmpty(){return 0===this._occupiedRegions.size}allocate(t){const e=this._findMinSuitable(t);if(!e)return-1;const i=e.value;this._freeRegions.remove(e);const r={offset:i.offset,size:t};if(this._occupiedRegions.set(i.offset,r),this._allRegions.insertAfter(i,r),this._allRegions.remove(i),i.size>t){const e={offset:i.offset+t,size:i.size-t};e._freeNode=this._freeRegions.insert(e),this._allRegions.insertAfter(r,e)}return r.offset}deallocate(t){let e=this._occupiedRegions.get(t);if(e){const i=this._allRegions.getPrev(e);if(i&&i._freeNode){const t={offset:i.offset,size:i.size+e.size};this._allRegions.insertAfter(i,t),this._allRegions.remove(e),this._allRegions.remove(i),this._freeRegions.remove(i._freeNode),e=t}const r=this._allRegions.getNext(e);if(r&&r._freeNode){const t={offset:e.offset,size:e.size+r.size};this._allRegions.insertBefore(r,t),this._allRegions.remove(e),this._allRegions.remove(r),this._freeRegions.remove(r._freeNode),e=t}this._occupiedRegions.delete(t),e._freeNode=this._freeRegions.insert(e)}}isAllocated(t){return this._occupiedRegions.has(t)}extend(t){if(t<this._size)throw new Error("Size reducing is not allowed in free list allocator");const e=t-this._size,i=this._allRegions.end;if(i&&i._freeNode){this._freeRegions.remove(i._freeNode);const t={offset:i.offset,size:i.size+e,isFree:!0};this._allRegions.insertAfter(i,t),this._allRegions.remove(i),this._freeRegions.insert(t)}else{const t={offset:this._size,size:e,isFree:!0};this._allRegions.insert(t),this._freeRegions.insert(t)}this._size=t}_findMinSuitable(t){let e,i=this._freeRegions.root;for(;i;){if(i.value.size===t){e=i;break}i.value.size<t?i=i.right:(e=i,i=i.left)}return e}}class Ws{constructor(t,e){this.width=t,this.height=e,this._allocator=new Vs(this.width)}allocate(t){return this._allocator.allocate(t)}deallocate(t){this._allocator.deallocate(t)}isAllocated(t){return this._allocator.isAllocated(t)}canAllocate(t){return this._allocator.maxAllocableSize>=t}resize(t){this._allocator.extend(t),this.width=t}}class Fs{constructor(t,e){this.width=t,this.height=e,this._shelves=new Map,this._shelfAllocator=new js(e)}allocate(t){let e,i=-1,r=-1;for(const[s,n]of this._shelves.entries()){const o=t.height/n.height;if(1===o&&n.canAllocate(t.width)){e=n,i=s;break}o<1&&o>r&&n.canAllocate(t.width)&&(e=n,i=s,r=o)}if(!e&&this._shelfAllocator.maxAllocableSize>=t.height&&this.width>=t.width){const r=this._shelfAllocator.allocate(t.height);e=new Ws(this.width,t.height),i=r,this._shelves.set(r,e)}if(e){const r=e.allocate(t.width),s=i;return{minX:r,maxX:r+t.width,minY:s,maxY:s+t.height}}return null}deallocate(t){const e=this._shelves.get(t.minY);e&&e.deallocate(t.minX)}isAllocated(t){const e=this._shelves.get(t.minY);return!!e&&e.isAllocated(t.minX)}resize(t,e){this._shelfAllocator.extend(e);for(const i of this._shelves.values())i.resize(t);this.width=t,this.height=e}}const qs=I(Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER);function Ys(t,e,i){return 4*(e*(t.y+i)+t.x)}function Xs(t,e,i,r,s,n,{width:o,height:a}){for(let l=0;l<a;++l){const a=Ys(i,s,l),h=Ys(r,n,l);for(let i=0;i<4*o;++i)e[h+i]=t[a+i]}}function Gs(t,e){return new Uint8Array(4*t*e)}class Zs extends yi{constructor(t,e,i){super(),this.id=t,this.width=e,this.height=i,this.emptyIcon={minX:0,maxX:0,minY:0,maxY:0},this._data=Gs(e,i),this._updatedRegion=I(0,0,0,0),this._resetAllocator(),this._resetUpdatedRegion()}allocate(t,e){const i=this._allocator.allocate(cs((r=t).width+1,r.height+1));var r;if(!i)return;const s=function(t){const e=z(t);return e.maxX-=1,e.maxY-=1,e}(i);return this._insertIcon(s,e),P(this._updatedRegion,i,this._updatedRegion),s}flushUpdates(){if(this._updatedRegion.minX===qs.minX)return;const{minX:t,minY:e,maxX:i,maxY:r}=this._updatedRegion;this._resetUpdatedRegion();const s=i-t,n=r-e,o=Gs(s,n);return Xs(this._data,o,g(t,e),y,this.width,s,cs(s,n)),{offset:g(t,e),size:cs(s,n),data:o}}reset(){this._resetUpdatedRegion(),this._resetAllocator(),this._data.fill(0)}_insertIcon(t,e){const{minX:i,minY:r,maxX:s,maxY:n}=t;Xs(e,this._data,y,g(i,r),s-i,this.width,cs(s-i,n-r))}_resetAllocator(){this._allocator=new Fs(this.width,this.height)}_resetUpdatedRegion(){z(qs,this._updatedRegion)}}var Hs;function Ks(t,e){return t.finally?t.finally(e):t.then(t=>Promise.resolve(e()).then(()=>t),t=>Promise.resolve(e()).then(()=>Promise.reject(t)))}!function(t){t[t.TO_BACKEND_SETUP=0]="TO_BACKEND_SETUP",t[t.FROM_BACKEND_ADD_ATLAS=1]="FROM_BACKEND_ADD_ATLAS",t[t.FROM_BACKEND_UPDATE_ATLAS=2]="FROM_BACKEND_UPDATE_ATLAS",t[t.FROM_BACKEND_REMOVE_ATLAS=3]="FROM_BACKEND_REMOVE_ATLAS"}(Hs||(Hs={}));var Qs=function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function o(t){try{l(r.next(t))}catch(e){n(e)}}function a(t){try{l(r.throw(t))}catch(e){n(e)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}l((r=r.apply(t,e||[])).next())}))};const $s={iconUrlTemplate:"no url for icons",dpr:1};function Js(t,e,i){return t+"_"+e+"_"+i.key+"_"+i.colorQuery}function tn(t,e){const i=e&&t.byteLength%Uint32Array.BYTES_PER_ELEMENT==0&&new Uint32Array(t);if(i&&i[0]===rn)return{size:cs(i[1],i[2]),data:new Uint8Array(t,3*Uint32Array.BYTES_PER_ELEMENT)};{const e=new Rs(t,r).decode();return{size:cs(e.width,e.height),data:e.data}}var r}const en={key:0,colorQuery:"",transform:t=>t,transformImage:t=>t},rn=2537892953;class sn{constructor(t,e,i=1024,r=1024){this._communicator=t,this._atlasWidth=i,this._atlasHeight=r,this._loadManager=e,this._options=Object.assign({},$s),this._atlases=[],this._freeAtlases=[],this._currentAtlas=null,this._requests=new Map,this._iconDataMap=new Map,this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getAtlas(t){return this._atlases[t]}getIconData(t,e=1,i=en){const r=Js(t,e,i);return this._iconDataMap.get(r)}getCurrentAtlas(){return this._currentAtlas||(this._currentAtlas=this._getNextAtlas()),this._currentAtlas}getDpr(){return this._options.dpr}loadIcon(t,e,i=1,r=en){const s=Js(t,i,r);let n=this._requests.get(s);return n||(n=this._loadIcon(t,e,i,r.colorQuery).then(e=>{const s=r.transformImage(e);return this.addIcon(s,t,i,r)}),Ks(n,()=>this._requests.delete(s)),this._requests.set(s,n),n)}addIcon(t,e,i=1,r=en){const s=Js(e,i,r),n=this._assignIconToAtlas(t),o={atlasId:this._currentAtlas.id,imageSize:t.size,atlasLocation:n};return this._iconDataMap.set(s,o),o}flushAtlasesUpdates(){for(const t of this._atlases){const e=t.flushUpdates();e&&this._communicator.sendMessage({type:Hs.FROM_BACKEND_UPDATE_ATLAS,atlasId:t.id,atlasRegion:e},!1,e.data.buffer)}}buildIconUrl(t,e=1,i=!1,r=""){return this._options.iconUrlTemplate.replace("{{hostAlias}}",fi(t)).replace(/\\{\\{id\\}\\}/g,t).replace("{{scale}}",O(this._options.dpr*e,.1,10).toString())+r+(i?"&format=bmp":"")}_onMessage(t){switch(t.type){case Hs.TO_BACKEND_SETUP:this._onSetup(t)}}_onSetup(t){Object.assign(this._options,t.options)}_loadIcon(t,e,i,r){return Qs(this,void 0,void 0,(function*(){const s="bmp"===this._options.iconFormat,n=this.buildIconUrl(t,i,s,r);return tn(yield this._loadManager.load(n,e),s)}))}_getNextAtlas(){if(this._freeAtlases.length>0)return this._freeAtlases.shift();const t=this._atlases.length,e=new Zs(t,this._atlasWidth,this._atlasHeight);return e.retain(),e.onReleased.addListener(()=>{e.reset(),this._freeAtlases.push(e)}),this._atlases.push(e),this._communicator.sendMessage({type:Hs.FROM_BACKEND_ADD_ATLAS,atlasId:t,atlasWidth:this._atlasWidth,atlasHeight:this._atlasHeight},!1),e}_assignIconToAtlas({size:t,data:e}){const i=this.getCurrentAtlas();let r=i.allocate(t,e);if(!r&&(i.release(),this._currentAtlas=this._getNextAtlas(),r=this._currentAtlas.allocate(t,e),!r))throw new Error("Couldn\'t allocate icon in atlas");return r}}class nn{constructor(t){this._loadManager=t,this._requests=new Map}fillFont(t,e,i,r){const s=e.id+"_"+i;let n=this._requests.get(s);return n||(n=this._loadManager.load(t,r).then(t=>{const i=H.decode(new Uint8Array(t));-1===e.xheight&&(e.xheight=i.font.xheight),-1===e.margin&&(e.margin=i.font.margin),void 0===e.height&&void 0!==i.font.height&&(e.height=i.font.height),void 0===e.ascender&&void 0!==i.font.ascender&&(e.ascender=i.font.ascender),void 0===e.descender&&void 0!==i.font.descender&&(e.descender=i.font.descender);for(const r of i.glyphs)e.glyphs[r.id]=r;return e}),Ks(n,()=>this._requests.delete(s)),this._requests.set(s,n)),n}}class on{constructor(t,e,i,r=300){this._storage=t,this._modelStorage=e,this._taskQueue=i,this._size=r,this._cache=new Set,this._storage.onAdded.addListener(this._onTileAdded,this),this._storage.onRemoved.addListener(this._onTileRemoved,this),this._modelStorage.onAdded.addListener(this._onModelAdded,this),this._modelStorage.onRemoved.addListener(this._onModelRemoved,this)}destructor(){this._modelStorage.onRemoved.removeListener(this._onModelRemoved),this._modelStorage.onAdded.removeListener(this._onModelAdded),this._storage.onRemoved.removeListener(this._onTileRemoved),this._storage.onAdded.removeListener(this._onTileAdded)}_cleaning(){this._cleaningIsScheduled=!1;const t=this._cache.size-this._size;if(t>0){const e=new Array(t);let i=0;for(const r of this._cache){if(!(i<t))break;e[i]=r,++i}for(const t of e)this._destroyTile(t)}}_destroyTile(t){this._storage.remove(t.id)}_onTileAdded(t){t.onStateChanged.addListener(this._onTileStateChanged,this),this._onTileStateChanged(t)}_onTileRemoved(t){this._cache.delete(t),t.onStateChanged.removeListener(this._onTileStateChanged),t.destructor()}_onTileStateChanged(t){2===t.state?this._onTileCached(t):0!==t.state&&1!==t.state||this._onTileUse(t)}_onTileUse(t){this._cache.delete(t)}_onTileCached(t){t.hasContent()?(this._cache.add(t),this._cache.size>this._size&&!this._cleaningIsScheduled&&(this._cleaningIsScheduled=!0,this._taskQueue.enqueueSync({execute:this._cleaning.bind(this),priority:3e4}))):this._destroyTile(t)}_onModelAdded(t){t.onReleased.addListener(this._onModelReleased,this)}_onModelRemoved(t){t.onReleased.removeListener(this._onModelReleased),t.destructor()}_onModelReleased(t){this._modelStorage.remove(t.id)}}class an extends h{_serialize(t){return t.id}}class ln{constructor(t,e,i="GET"){this._url=t,this._method=i,this._xhr=new XMLHttpRequest,this._xhr.responseType=e}get isCanceled(){return this._xhr.readyState===XMLHttpRequest.DONE&&0===this._xhr.status}send(){const t=this._xhr;return t.readyState!==XMLHttpRequest.UNSENT?Promise.reject(new Error("already sent")):new Promise((e,i)=>{t.open(this._method,this._url),t.onload=()=>{this.isCanceled||(200<=t.status&&t.status<300?e(this._prepareResponse(t.response)):i(new Error(`Failed request: ${t.status} ${t.statusText}, ${this._url}`)))},this._xhr.onerror=()=>{i(new Error("Failed request: "+this._url))},this._xhr.send()})}cancel(){this._xhr.readyState===XMLHttpRequest.UNSENT||this.isCanceled||this._xhr.abort()}}class hn extends ln{constructor(t,e="GET"){super(t,"arraybuffer",e)}_prepareResponse(t){return t instanceof ArrayBuffer?t:new ArrayBuffer(0)}}class cn extends ln{constructor(t,e="GET"){super(t,"json",e)}_prepareResponse(t){return t}}class dn{constructor(){this._requests=new Map,this._queue=new os}load(t,e){return un(this._makeLoadRequest(t,e,new hn(t)))}loadJson(t,e){return un(this._makeLoadRequest(t,e,new cn(t)))}cancel(t){const e=function(t,e){for(const i of t)if(e(i))return i}(this._requests.values(),e=>e.subs.has(t));e&&(!function(t,e){t.subs.get(e)&&t.subs.delete(e)}(e,t),0===e.subs.size&&(this._requests.delete(e.url),e.isRunning?e.httpRequest.cancel():this._queue.remove(t=>t===e),this._checkLoadingQueue()))}_checkLoadingQueue(){if(!this._queue.size)return;let t=Number.NEGATIVE_INFINITY;this._requests.forEach(e=>{e.isRunning&&e.priority>t&&(t=e.priority)});const e=this._queue.peek().priority;if(!(e<t))for(;this._queue.size&&this._queue.peek().priority===e;)this._startLoading(this._queue.dequeue())}_makeLoadRequest(t,e,i){let r=this._requests.get(t);return r&&(r.isRunning||r.priority>=e)||(r?(this._queue.remove(t=>t===r),r.priority=e):(r={url:t,priority:e,httpRequest:i,isRunning:!1,subs:new Map},this._requests.set(t,r)),this._queue.enqueue(r),this._checkLoadingQueue()),r}_startLoading(t){Ks(t.httpRequest.send().then(e=>t.subs.forEach(t=>t.onData(e)),e=>t.subs.forEach(t=>t.onError(e))),()=>{this._requests.delete(t.url),this._checkLoadingQueue()}),t.isRunning=!0}}function un(t){let e;const i=new Promise((t,i)=>{e={onData:t,onError:i}});return t.subs.set(i,e),i}class fn{constructor(t,e,i=new ls,r=new dn,n=100,o){this._commutator=new s(t),this._objectIdProvider=e,this._taskQueue=i,this._loadManager=r,this._taskPriority=n,this._tileStorage=new c(this._commutator.getCommunicator(1)),this._modelStorage=new an(this._commutator.getCommunicator(2)),this._viewport=new W(this._commutator.getCommunicator(0),this._tileStorage),this._registry=new es(this._commutator.getCommunicator(4)),this._glyphAtlasRegistry=new _s(this._commutator.getCommunicator(5),new nn(this._loadManager)),this._iconAtlasRegistry=new sn(this._commutator.getCommunicator(6),this._loadManager),this._tileContentManager=this._createTileVectorContentManagerBackend(),this._gc=new on(this._tileStorage,this._modelStorage,i,o),this._stylesCustomizer=new nr}destructor(){this._gc.destructor(),this._tileContentManager.destructor(),this._iconAtlasRegistry.destructor(),this._glyphAtlasRegistry.destructor(),this._viewport.destructor(),this._commutator.destructor()}_createTileVectorContentManagerBackend(){return new Gr(this._commutator.getCommunicator(3),this._tileStorage,this._modelStorage,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._viewport,this._objectIdProvider,this._taskQueue,this._loadManager,this._taskPriority)}}function pn({min:t,max:e}){let i=0;return()=>i++%(e-t+1)+t}var _n;!function(t){t[t.SETUP=0]="SETUP",t[t.ADD=1]="ADD",t[t.DESTROY=2]="DESTROY"}(_n||(_n={}));class gn extends yi{constructor(t){super(),this.id=t}addContent(t){this.content=t}}const yn={indoorPlanUrlTemplate:"No url provided"};class mn{constructor(t,e){this._communicator=t,this._loader=e,this._plans=new Map,this._options=Object.assign({},yn),this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){for(const t of this._plans.values())t.onReleased.removeListener(this._onPlanReleased);this._communicator.onMessage.removeListener(this._onMessage)}getPlan(t){return this._plans.get(t)}getOrCreatePlan(t){let e=this._plans.get(t);return e||(e=new gn(t),e.onReleased.addListener(this._onPlanReleased,this),this._loader.loadPlan(t).then(e=>this._onLoad(t,e)),this._plans.set(t,e)),e}_onPlanReleased(t){this._plans.delete(t.id),this._communicator.sendMessage({type:_n.DESTROY,planId:t.id},!1)}_onLoad(t,e){const i=this._plans.get(t);i&&(i.addContent(e),this._communicator.sendMessage(Object.assign({type:_n.ADD,planId:t},e),!0))}_onMessage(t){switch(t.type){case _n.SETUP:this._options=t.options,this._loader.setUrlProvider(t=>this._options.indoorPlanUrlTemplate.replace("{{id}}",t).replace("{{hostAlias}}",fi(t)))}}}class bn extends Gr{constructor(t,e,i,r,s,n,o,a,l,h,c,d){super(t,e,i,r,s,n,o,a,l,h,c),this._indoorPlanRegistry=d,this._metadataPreprocessor=(t,e)=>this._preprocessMetadata(t,e)}_createTileRequest(t,e){const i=this._objectIdManager.createSharedIdProvider(t.id);return new di(t,e,this._taskQueue,this._tileLoader,this._viewport,this._taskPriority,this._opaquePolygonBufferWriter,this._transparentPolygonBufferWriter,this._extrudedPolygonWriter,this._polylineBufferWriter,this._pointLabelBufferWriter,this._curvedLabelBufferWriter,this._iconBufferWriter,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,i,this._stylesCustomizer,this._metadataPreprocessor)}_preprocessMetadata(t,e){const i=tt(t);for(const r of[i.points,i.polylines,i.polygons,i.pointLabels,i.curvedLabels]){const t=r;for(const i of t.values()){const t=i.get("indoor_plan_id");if(t){const i=this._indoorPlanRegistry.getOrCreatePlan(t);e.addContent({primitives:{}},[i])}}}return i}}var xn=function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function o(t){try{l(r.next(t))}catch(e){n(e)}}function a(t){try{l(r.throw(t))}catch(e){n(e)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,a)}l((r=r.apply(t,e||[])).next())}))};class wn{constructor(t,e){this._loadManager=t,this._urlProvider=e,this._loadings=new Map}setUrlProvider(t){this._urlProvider=t}loadPlan(t){return xn(this,void 0,void 0,(function*(){let e=this._loadings.get(t);return e||(e=Ks(this._createRequest(t),()=>this._loadings.delete(t)),this._loadings.set(t,e)),e}))}_createRequest(t){return xn(this,void 0,void 0,(function*(){const e=yield this._loadManager.load(this._urlProvider(t),32e3),{levels:i,defaultLevelId:r,boundary:s}=Q.decode(new Uint8Array(e));if(!s)throw new Error("No indoor plan boundary provided");return{levels:i,defaultLevelId:r,boundary:s}}))}}class vn extends fn{destructor(){this._planRegistry&&this._planRegistry.destructor(),super.destructor()}_createTileVectorContentManagerBackend(){const t=this._getOrCreatePlanRegistry();return new bn(this._commutator.getCommunicator(3),this._tileStorage,this._modelStorage,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._viewport,this._objectIdProvider,this._taskQueue,this._loadManager,this._taskPriority,t)}_getOrCreatePlanRegistry(){if(!this._planRegistry){const t=new wn(this._loadManager,()=>{throw new Error("No url for indoor plans provided")});this._planRegistry=new mn(this._commutator.getCommunicator(7),t)}return this._planRegistry}}class kn extends h{_serialize(t){return{id:t.id,bbox:t.bbox}}}class An extends ni{constructor(t,e,i,r,s,n,o,a,l,h,c,d,u,f,p,_,g,y){super(i,r,s,n,o,a,l,h,c,d,u,f,p,_,g),this._object=t,this._data=e,this._objectIdProvider=y}_onSubTaskContent(t){this._onContentReady.fire({object:this._object,content:t})}_startImpl(){this._scheduleProcessing(this._data)}_process(t){return{object:this._object,content:he(this._writePolygons(this._extractPolygons(t)),{content:{primitives:{}},metrics:{loadTime:this._loadTime}})}}_loadImpl(){throw new Error("TODO: implement geo content loading")}_loadCancel(){throw new Error("TODO: implement geo content loading cancel")}_extractPolygons(t){const e=[];if("FeatureCollection"===t.type)for(const i of t.features)"Feature"===i.type&&"Polygon"===i.geometry.type&&e.push({id:this._objectIdProvider.idGenerator(),styles:[{color:ht(1,0,0,1),extruded:!1,height:0,minZoom:0,maxZoom:0,zIndex:0,classId:1}],height:0,hasContour:!1,vertexRings:i.geometry.coordinates.map(t=>t.map(t=>g(t[0],t[1])))});return e}}class Tn extends o{constructor(t,e){super(),this.id=t,this.bbox=e}}class Sn extends ue{constructor(t,e,i,r,s,n,o,a,l,h,c,d,u,f,p,_){super(r,i,2e3),this._url=t,this._options=e,this._loadManager=s,this._opaquePolygonBufferWriter=n,this._transparentPolygonBufferWriter=o,this._extrudedPolygonBufferWriter=a,this._polylineBufferWriter=l,this._pointLabelsBufferWriter=h,this._curvedLabelsBufferWriter=c,this._iconBufferWriter=d,this._pageRegistry=u,this._glyphAtlasRegistry=f,this._iconAtlasRegistry=p,this._objectIdProvider=_}_process(t){const e=[t];for(const[i,r]of e.entries()){const t=this._url+"_"+i,e=-1,s=new Tn(t,{minX:.20893428,maxX:.20993428,minY:.37293635,maxY:.37393635}),n=new An(s,r,this._options,e,this._priority,this._taskQueue,this._priority,this._opaquePolygonBufferWriter,this._transparentPolygonBufferWriter,this._extrudedPolygonBufferWriter,this._polylineBufferWriter,this._pointLabelsBufferWriter,this._curvedLabelsBufferWriter,this._iconBufferWriter,this._pageRegistry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._objectIdProvider);this._startSubTask(n)}}_onSubTaskContent(t){this._onContentReady.fire(t)}_loadImpl(){return this._loadManager.loadJson(this._url,this._priority).then(()=>{throw new Error("tmp")},()=>({type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Polygon",coordinates:[[[.20893428,.37293635],[.20893428,.37393635],[.20993428,.37393635],[.20993428,.37293635]]]},properties:{tags:["animated_polygon"]},id:"Polygon_${tileId.x}_${tileId.y}_${tileId.z}"}]}))}_loadCancel(){this._loadManager.cancel(this._request)}}class In{constructor(t){this.id=t,this._geoObjects=new Set,this.onBBoxExtended=this._onBBoxExtended=new r}get bbox(){return this._bbox||Object.assign({},S)}get geoObjects(){return this._geoObjects}get isEmpty(){return 0===this._geoObjects.size}destructor(){for(const t of this._geoObjects)t.destructor()}addGeoObject(t){this._geoObjects.add(t),this._bbox?P(this._bbox,t.bbox):this._bbox=Object.assign({},t.bbox),this._onBBoxExtended.fire(this)}hasGeoObject(t){return this._geoObjects.has(t)}}const zn={contentUrlTemplate:"no contentUtlTemplate specified",objectsCollisionPriority:1};class Pn extends qr{constructor(t,e,i,r,s,n,o,a,l){super(r,s,n,o,a,l,0),this._communicator=t,this._storage=e,this._batchStorage=i,this._requests=new Map,this._options=Object.assign({},zn),this._communicator.onMessage.addListener(this._onMessage,this),this._batchStorage.onRemoved.addListener(this._onBatchRemoved,this)}destructor(){this._communicator.onMessage.removeListener(this._onMessage),this._batchStorage.onRemoved.removeListener(this._onBatchRemoved)}fetch(t){if(!this._requests.has(t)){const e=new In(t),i=new Sn(t,this._options,0,this._taskQueue,this._loadManager,this._opaquePolygonBufferWriter,this._transparentPolygonBufferWriter,this._extrudedPolygonWriter,this._polylineBufferWriter,this._pointLabelBufferWriter,this._curvedLabelBufferWriter,this._iconBufferWriter,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._objectIdProvider);i.onContentReady.addListener(t=>this._onContentReady(e,t)),i.start(),this._requests.set(t,i),this._batchStorage.add(t,e)}}_onMessage(t){switch(t.type){case 0:this._onSetup(t)}}_onSetup(t){this._options=Object.assign(Object.assign({},zn),t.options)}_onContentReady(t,e){const{object:i,content:r}=e;i.addContent(e.content,this._extractSharedResources(r.content.primitives)),t.hasGeoObject(i)||t.addGeoObject(i),this._batchStorage.has(t.id)||this._batchStorage.add(t.id,t),this._storage.has(i.id)||this._storage.add(i.id,i),this._registry.flushBackendUpdates(),this._iconAtlasRegistry.flushAtlasesUpdates(),this._communicator.sendMessage({type:2,objectId:i.id,content:r.content},!0)}_onBatchRemoved(t){const e=this._requests.get(t.id);e&&(e.destructor(),this._requests.delete(t.id))}}class Rn extends l{}class Cn{constructor(t,e,i=6e4){this._communicator=t,this._storage=e,this._longAgoThreshold=i,this._lastNearnessTimeKey=Symbol("geo_gc_nearness_time"),this._currentExtendedViewportBBox=Object.assign({},S),this._communicator.onMessage.addListener(this._onMessage,this),this._storage.onAdded.addListener(this._onBatchAdded,this),this._storage.onRemoved.addListener(this._onBatchRemoved,this);for(const r of e.items)this._onBatchAdded(r)}destructor(){this._communicator.onMessage.removeListener(this._onMessage),this._storage.onAdded.removeListener(this._onBatchAdded),this._storage.onRemoved.removeListener(this._onBatchRemoved);for(const t of this._storage.items)this._onBatchRemoved(t)}_onBatchAdded(t){t[this._lastNearnessTimeKey]=de(),t.onBBoxExtended.addListener(this._onBatchBBoxExtended,this)}_onBatchRemoved(t){delete t[this._lastNearnessTimeKey],t.onBBoxExtended.removeListener(this._onBatchBBoxExtended)}_onMessage(t){switch(t.type){case 0:this._onCameraUpdate(t)}}_onCameraUpdate(t){const e=de(),i=t.viewportBBox,r=i.maxX-i.minX,s=i.maxY-i.minY;this._currentExtendedViewportBBox=I(i.minX-=2*r,i.maxX+=2*r,i.minY-=2*s,i.maxY+=2*s);for(const n of this._storage.items)this._updateNearnessTime(n,e);this._garbageCollect()}_onBatchBBoxExtended(t){this._updateNearnessTime(t)}_updateNearnessTime(t,e=de()){(function(t,e){let i,r,s,n;return t.minX<e.minX?(i=t,r=e):(i=e,r=t),t.maxY>e.maxY?(s=t,n=e):(s=e,n=t),r.minX<i.maxX&&n.maxY>s.minY})(this._currentExtendedViewportBBox,t.bbox)&&(t[this._lastNearnessTimeKey]=e)}_isGarbage(t,e=de()){return e-t[this._lastNearnessTimeKey]>this._longAgoThreshold}_garbageCollect(t=de()){const e=[];for(const i of this._storage.items)this._isGarbage(i,t)&&e.push(i);for(const i of e)this._storage.remove(i.id),i.destructor()}}class On{constructor(t,e,i,r=new dn,n=100){this._objectIdProvider=e,this._taskQueue=i,this._loadManager=r,this._taskPriority=n,this._commutator=new s(t),this._communicator=this._commutator.getCommunicator(0),this._storage=new kn(this._commutator.getCommunicator(2)),this._batchStorage=new Rn,this._registry=new es(this._commutator.getCommunicator(3)),this._glyphAtlasRegistry=new _s(this._commutator.getCommunicator(5),new nn(this._loadManager)),this._iconAtlasRegistry=new sn(this._commutator.getCommunicator(4),this._loadManager),this._geoContentManager=new Pn(this._commutator.getCommunicator(1),this._storage,this._batchStorage,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,e,i,r),this._gc=new Cn(this._commutator.getCommunicator(6),this._batchStorage),this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){this._geoContentManager.destructor(),this._iconAtlasRegistry.destructor(),this._glyphAtlasRegistry.destructor(),this._gc.destructor(),this._commutator.destructor(),this._communicator.onMessage.removeListener(this._onMessage)}_onMessage(t){switch(t.type){case 0:this._onCameraChanged(t)}}_onCameraChanged(t){t.center.x>.208&&t.center.x<.209&&t.center.y>.372&&t.center.y<.375&&(console.log("fetching, ",t.center),this._geoContentManager.fetch("http://whatever.whh"))}}class Mn{constructor(t){this._addressee=t,this._messageQueue=[],this._transferableQueue=[],this._listeners=[]}addMessage(t,e=[]){this._messageQueue.push(t),this._transferableQueue.push(...e)}onMessage(t){this._listeners.push(t)}flushMessages(){0!==this._messageQueue.length&&this._addressee.postMessage(this._messageQueue,this._transferableQueue),this._messageQueue.length=0,this._transferableQueue.length=0}listen(){this._addressee.onmessage=({data:t})=>{for(const e of t)for(const t of this._listeners)t(e)}}}e.default=new class{constructor(t){var e;this._commutator=new s(new n(t)),this._communicator=this._commutator.getCommunicator(0),this._contentProviders=new Map,this._geoContentProviders=new Map,this._objectIdProvider=(e=mt,{idGenerator:pn(bt),collidingIdGenerator:pn(e)}),this._taskQueue=new ls,this._loadManager=new dn,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:3},!0)}destructor(){for(const t of this._contentProviders.values())t.destructor();this._taskQueue.destroy(),this._commutator.destructor()}_onMessage(t){switch(t.type){case 0:this._onInitContentProvider(t);break;case 1:this._onInitGeoContentProvider(t);break;case 2:this._onDestroyContentProvider(t)}}_onInitContentProvider(t){let e;e="indoor"===t.name?new vn(this._commutator.getCommunicator(t.id),this._objectIdProvider,this._taskQueue,this._loadManager,t.options.basePriority,t.options.tileCacheSize):new fn(this._commutator.getCommunicator(t.id),this._objectIdProvider,this._taskQueue,this._loadManager,t.options.basePriority,t.options.tileCacheSize),this._contentProviders.set(t.id,e)}_onInitGeoContentProvider(t){const e=new On(this._commutator.getCommunicator(t.id),this._objectIdProvider,this._taskQueue,this._loadManager);this._geoContentProviders.set(t.id,e)}_onDestroyContentProvider(t){const{id:e}=t,i=this._contentProviders.get(e);if(i)return i.destructor(),void this._contentProviders.delete(e);const r=this._geoContentProviders.get(e);r&&(r.destructor(),this._geoContentProviders.delete(e))}}(new class extends Mn{run(){return this.listen(),this}}(self).run())}]);',null)}},function(t,e){t.exports="#version 100\nattribute vec2 position;uniform sampler2D directPriorityGrid;uniform sampler2D reversePriorityGrid;uniform vec2 idHalfPxSize;uniform vec2 gridHalfPxSize;varying lowp vec4 id;const vec2 A=vec2(0,0);const vec4 B=vec4(2,2,2,1);const float C=255./256.;const float D=0.01;const float E=0.25;const float F=0.5;void main(){vec4 G=texture2D(reversePriorityGrid,position);if(G.rg!=A){vec4 H=texture2D(directPriorityGrid,position);vec2 I=G.rg*C+idHalfPxSize;bool J=G!=H;gl_Position=vec4(I*2.-1.,E,1);id=vec4(A,0,0);if(J&&H.a>=D){gl_Position.z=F;id=vec4(H.rg,0,1);}gl_PointSize=1.;}else{gl_Position=B;}}"},function(t,e){t.exports="#version 100\nattribute vec4 position;varying vec2 idTexCoordinates;void main(){gl_Position=vec4(position.xy,0,1);idTexCoordinates=position.zw;}"},function(t,e){t.exports="#version 100\nprecision mediump float;uniform sampler2D prevVisibility;uniform sampler2D overlaps;uniform sampler2D scene;uniform float fadeAnimationAmount;uniform float currentZoom;uniform float currentTilt;uniform float currentAzimuth;varying vec2 idTexCoordinates;const float A=1./256.;void main(){vec4 B=texture2D(prevVisibility,idTexCoordinates);vec4 C=texture2D(overlaps,idTexCoordinates);vec4 D=texture2D(scene,idTexCoordinates);bool E=D.a>=A;if(E){gl_FragColor=B;bool F=C.a>=A;if(F){if(gl_FragColor.b<A){gl_FragColor.b=currentZoom;gl_FragColor.r=currentTilt;gl_FragColor.g=currentAzimuth;}gl_FragColor.a=clamp(gl_FragColor.a-fadeAnimationAmount,0.,1.);}else{gl_FragColor.a=clamp(gl_FragColor.a+fadeAnimationAmount,0.,1.);gl_FragColor.rgb=vec3(0,0,0);}}else{gl_FragColor=vec4(0,0,0,0);}}"},function(t,e){t.exports="#version 100\nattribute vec4 position;void main(){gl_Position=vec4(position.xy,0,1);}"},function(t,e){t.exports="#version 100\nvoid main(){gl_FragColor=vec4(0,0,0,1);}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexId;uniform vec2 idHalfPxSize;void main(){vec2 A=vertexId.xy/256.+idHalfPxSize;vec4 B=vec4(A*2.-1.,0,1);gl_Position=B;gl_PointSize=1.;}"},function(t,e){t.exports="#version 100\nvoid main(){gl_FragColor=vec4(0,0,0,1);}"},function(t,e){t.exports="#version 100\nuniform lowp vec4 color;void main(){gl_FragColor=color;}"},function(t,e){t.exports="#version 100\nprecision mediump float;uniform vec2 pixelSize;uniform sampler2D texture;uniform float dpr;const float A=0.75;const float B=0.063;const float C=0.0625;const float D=0.0001;float E(vec4 F){return dot(F.xyz,vec3(0.299,0.587,0.114));}vec4 G(vec2 H,sampler2D I,vec2 J,float K,float L,float M){vec2 N;N.x=H.x;N.y=H.y;vec4 O=texture2D(I,N);float P=E(O);float Q=E(texture2D(I,N+vec2(0,1)*J.xy));float R=E(texture2D(I,N+vec2(1,0)*J.xy));float S=E(texture2D(I,N+vec2(0,-1)*J.xy));float T=E(texture2D(I,N+vec2(-1,0)*J.xy));float U=max(Q,P);float V=min(Q,P);float W=max(R,U);float X=min(R,V);float Y=max(S,T);float Z=min(S,T);float a=max(Y,W);float b=min(Z,X);float c=a*L;float d=a-b;float e=max(M,c);bool f=d<e;if(f)return O;float g=E(texture2D(I,N+vec2(-1,-1)*J.xy));float h=E(texture2D(I,N+vec2(1,1)*J.xy));float i=E(texture2D(I,N+vec2(1,-1)*J.xy));float j=E(texture2D(I,N+vec2(-1,1)*J.xy));float k=S+Q;float l=T+R;float m=1./d;float n=k+l;float o=(-2.*P)+k;float p=(-2.*P)+l;float q=i+h;float r=g+i;float s=(-2.*R)+q;float t=(-2.*S)+r;float u=g+j;float v=j+h;float w=(abs(o)*2.)+abs(s);float x=(abs(p)*2.)+abs(t);float y=(-2.*T)+u;float z=(-2.*Q)+v;float AA=abs(y)+w;float AB=abs(z)+x;float AC=u+q;float AD=J.x;bool AE=AA>=AB;float AF=n*2.+AC;if(AE){AD=J.y;}else{S=T;Q=R;}float AG=(AF*(1./12.))-P;float AH=S-P;float AI=Q-P;float AJ=S+P;float AK=Q+P;bool AL=abs(AH)>=abs(AI);float AM=max(abs(AH),abs(AI));if(AL){AD=-AD;}else{AJ=AK;}float AN=clamp(abs(AG)*m,0.,1.);vec2 AO=N;vec2 AP;vec2 AQ;if(AE){AP=vec2(J.x,0.);AQ=vec2(0.,AD);}else{AP=vec2(0.,J.y);AQ=vec2(AD,0.);}vec2 AR=AO-AP*2.;vec2 AS=AO+AP*2.;float AT=((-2.)*AN)+3.;float AU=E(mix(texture2D(I,AR),texture2D(I,AR+AQ),0.5));float AV=AN*AN;float AW=E(mix(texture2D(I,AS),texture2D(I,AS+AQ),0.5));float AX=AM*0.25;float AY=P-AJ*0.5;float AZ=AT*AV;bool Aa=AY<0.;AU-=AJ*0.5;AW-=AJ*0.5;bool Ab=abs(AU)>=AX;bool Ac=abs(AW)>=AX;if(!Ab){AR-=AP*3.;}bool Ad=(!Ab)||(!Ac);if(!Ac){AS+=AP*3.;}if(Ad){if(!Ab){AU=E(mix(texture2D(I,AR),texture2D(I,AR+AQ),0.5));AU=AU-AJ*0.5;}if(!Ac){AW=E(mix(texture2D(I,AS.xy),texture2D(I,AS.xy+AQ),0.5));AW=AW-AJ*0.5;}Ab=abs(AU)>=AX;Ac=abs(AW)>=AX;if(!Ab){AR-=AP*12.;}if(!Ac){AS+=AP*12.;}}float Ae=N.x-AR.x;float Af=AS.x-N.x;if(!AE){Ae=N.y-AR.y;Af=AS.y-N.y;}bool Ag=(AU<0.)!=Aa;float Ah=(Af+Ae);bool Ai=(AW<0.)!=Aa;float Aj=1./Ah;bool Ak=Ae<Af;float Al=min(Ae,Af);bool Am=Ak?Ag:Ai;float An=AZ*AZ;float Ao=(Al*(-Aj))+0.5;float Ap=An*K;float Aq=Am?Ao:0.;float Ar=max(Aq,Ap);vec4 As;float At=Ar;if(AE){As=mix(texture2D(I,N),texture2D(I,N+vec2(0.,AD)),At);}else{As=mix(texture2D(I,N),texture2D(I,N+vec2(AD,0.)),At);}return As;}void main(){vec2 H=gl_FragCoord.xy*pixelSize;vec4 As=G(H,texture,pixelSize,A,B,C);if(As.a>D){As.xyz/=As.a;}gl_FragColor=As;}"},function(t,e){t.exports="#version 100\nprecision mediump float;varying highp vec2 textureCoordinates;varying vec4 iconLocation;uniform sampler2D atlas;uniform vec2 atlasSize;uniform bool isColorTransformed;uniform mat4 colorTransform;vec4 A(vec4 B,mat4 C){return C*vec4(B.rgb,1)*vec4(1,1,1,B.a);}vec4 D(vec4 B,mat4 colorTransform){vec4 E=A(vec4(B.rgb/B.a,B.a),colorTransform);return vec4(E.rgb*B.a,B.a)*E.a;}void main(void){vec2 F=iconLocation.yw-iconLocation.xz;vec2 G=textureCoordinates;G.x=mod(G.x,F.x);vec2 H=iconLocation.xz+G;vec4 B=texture2D(atlas,H/atlasSize);gl_FragColor=isColorTransformed?D(B,colorTransform):B;}"},function(t,e){t.exports="#version 100\nprecision mediump float;uniform sampler2D atlas;uniform bool isColorTransformed;uniform mat4 colorTransform;varying vec2 uv;varying float alpha;vec4 A(vec4 B,mat4 C){return C*vec4(B.rgb,1)*vec4(1,1,1,B.a);}const float D=0.69;vec4 E(vec4 F,vec4 G){F.rgb/=F.a;float H=max(0.2126*F.r+0.7152*F.g+0.0722*F.b,D);vec3 I=mix(G.rgb,vec3(1.),(H-D)/(1.-D));return vec4(I*F.a,F.a)*G.a;}void main(){vec4 B=texture2D(atlas,uv);gl_FragColor=isColorTransformed?E(B,A(B,colorTransform)):B;gl_FragColor*=alpha;}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexUV;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;varying vec2 uv;const float A=1.999969482421875;const float B=0.000030517112463712692;void main(){vec4 C=viewProjMatrix*vec4(A*(vertexPosHigh-lookAtHigh)+B*(vertexPosLow-lookAtLow),0,1);gl_Position=C;uv=vertexUV;}"},function(t,e){t.exports="#version 100\nprecision mediump float;uniform sampler2D atlas;uniform vec2 atlasSize;varying vec2 uv;void main(){gl_FragColor=texture2D(atlas,uv/atlasSize);if(gl_FragColor.a==0.){discard;}}"},function(t,e){t.exports="#version 100\nvarying lowp vec4 color;void main(void){gl_FragColor=color;}"},function(t,e){t.exports="#version 100\n#extension GL_OES_standard_derivatives : require\nprecision highp float;varying vec4 diffuseColor;varying vec4 globalPosition;const vec3 A=vec3(0.2,0.2,1.);const float B=0.4;const float C=1.-B;const float D=C+0.5*B*(A.z+1.);void main(void){vec3 E=globalPosition.xyz;vec3 F=dFdx(E);vec3 G=dFdy(E);vec3 H=cross(F,G);float I=dot(H,A)/length(G)/length(A)/length(F);gl_FragColor=vec4(diffuseColor.rgb*(C+0.5*B*(I+1.))/D,diffuseColor.a);}"},function(t,e){t.exports="#version 100\nprecision mediump float;attribute vec2 vertexPosition;attribute vec2 vertexUV;varying vec2 uv;void main(){gl_Position=vec4(vertexPosition,0,1);uv=vertexUV;}"},function(t,e){t.exports="#version 100\nprecision mediump float;uniform sampler2D texture;varying vec2 uv;void main(){gl_FragColor=texture2D(texture,uv);}"},function(t,e){t.exports="#version 100\nattribute vec4 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexUV;attribute float vertexPriority;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform sampler2D visibility;uniform sampler2D overlap;uniform sampler2D scene;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform lowp float currentTilt;uniform lowp float currentAzimuth;varying lowp vec4 id;const vec4 A=vec4(2,2,2,1);const float B=pow(2.,16.);const float C=pow(2.,-31.);vec4 D(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 E,vec2 F,vec2 G,vec2 H){vec4 I=viewProjMatrix*vec4((B*(E-lookAtHigh)+(F-lookAtLow))*C,0,1);I=vec4(I.xy/I.w,0.,1.);return I+vec4(G*H,0.,0.);}const vec4 J=vec4(0,0,0,0);const vec2 K=vec2(0,0);const float L=255./256.;const float M=0.05;const float N=0.15;const float O=0.02;bool P(vec2 Q,vec2 idHalfPxSize,sampler2D overlap,sampler2D scene){vec2 R=texture2D(overlap,Q).rg;return R!=K&&texture2D(scene,R*L+idHalfPxSize)!=J;}float S(vec2 id,vec2 idHalfPxSize,sampler2D visibility,sampler2D overlap,sampler2D scene,float currentZoom,float currentTilt,float currentAzimuth){vec2 Q=id/256.+idHalfPxSize;vec4 T=texture2D(visibility,Q);float U=T.b;float V=T.r;float W=T.g;float X=U-currentZoom;float Y=abs(V-currentTilt);float Z=abs(W-currentAzimuth);if((X>M||(abs(X)<=M&&Y<N&&Z<O))&&P(Q,idHalfPxSize,overlap,scene)){return-1.;}return T.a;}void main(void){float a=S(vertexId.xy,idHalfPxSize,visibility,overlap,scene,currentZoom,currentTilt,currentAzimuth);if(a<0.){gl_Position=A;}else{gl_Position=D(viewProjMatrix,lookAtHigh,lookAtLow,vertexPosHigh,vertexPosLow,vertexDisplacement,pixelSize);gl_Position.xy+=shift;gl_Position.z=vertexPriority;id=vec4(vertexId.xy/255.,0,a);}}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexId;attribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec3 vertexDisplacements;attribute vec2 vertexUV;attribute float vertexPriority;attribute lowp vec4 vertexColor;attribute lowp vec4 vertexOutlineColor;attribute vec2 polylineLength_vertexScale;attribute vec4 leftPolylineRatios;attribute vec4 leftPolylineAngles;attribute vec4 rightPolylineRatios;attribute vec4 rightPolylineAngles;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform sampler2D visibility;uniform sampler2D overlap;uniform sampler2D scene;uniform vec2 idHalfPxSize;uniform vec2 shift;uniform lowp float currentZoom;uniform lowp float currentTilt;uniform lowp float currentAzimuth;varying lowp vec4 id;const vec4 A=vec4(2,2,2,1);const float B=pow(2.,16.);const float C=pow(2.,-31.);const float D=3.1415927410125732;const int E=4;const float F=1000000.;const float G=1./256.;vec2 H(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 pixelSize,vec2 I,vec2 J,vec2 K){vec4 L=viewProjMatrix*vec4((B*(I-lookAtHigh)+(J-lookAtLow))*C+K,0,1);vec2 M=L.xy/L.w;return M/pixelSize;}vec2 N(float O,float P,float Q){float R=P*2.*D-D;float S=O*Q;return vec2(cos(R),sin(R))*S;}float T(vec4 R,int U){if(U==0)return R[0];if(U==1)return R[1];if(U==2)return R[2];return R[3];}vec4 V(mat4 viewProjMatrix,vec2 lookAtHigh,vec2 lookAtLow,vec2 W,vec2 X,vec2 Y,vec2 Z,float a,float Q,vec4 leftPolylineRatios,vec4 leftPolylineAngles,vec4 rightPolylineRatios,vec4 rightPolylineAngles){vec2 L=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,vec2(0,0));vec2 b=N(rightPolylineRatios[0],rightPolylineAngles[0],Q);vec2 c=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,b);bool d=a>0.;bool e=c.x<L.x;bool f=d^^e;if(d==e){b=f?N(rightPolylineRatios[0],rightPolylineAngles[0],Q):N(leftPolylineRatios[0],leftPolylineAngles[0],Q);c=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,b);}float g=abs(a);for(int U=1;U<=E;U++){vec2 h=c-L;bool i=U==E||T(f?rightPolylineRatios:leftPolylineRatios,U)<G;float j=i?F:length(h);if(j>g){float k=a>0.?1.:-1.;vec2 l=normalize(h);vec2 m=vec2(-l.y,l.x);L+=l*g;L+=k*l*Z.x;L+=k*m*Z.y;break;}else{g-=j;L+=h;vec2 n=f?N(T(rightPolylineRatios,U),T(rightPolylineAngles,U),Q):N(T(leftPolylineRatios,U),T(leftPolylineAngles,U),Q);c=H(viewProjMatrix,lookAtHigh,lookAtLow,W,X,Y,n);}}return vec4(L*W,0.,1.);}const vec4 o=vec4(0,0,0,0);const vec2 p=vec2(0,0);const float q=255./256.;const float r=0.05;const float s=0.15;const float t=0.02;bool u(vec2 v,vec2 idHalfPxSize,sampler2D overlap,sampler2D scene){vec2 w=texture2D(overlap,v).rg;return w!=p&&texture2D(scene,w*q+idHalfPxSize)!=o;}float x(vec2 id,vec2 idHalfPxSize,sampler2D visibility,sampler2D overlap,sampler2D scene,float currentZoom,float currentTilt,float currentAzimuth){vec2 v=id/256.+idHalfPxSize;vec4 y=texture2D(visibility,v);float z=y.b;float AA=y.r;float AB=y.g;float AC=z-currentZoom;float AD=abs(AA-currentTilt);float AE=abs(AB-currentAzimuth);if((AC>r||(abs(AC)<=r&&AD<s&&AE<t))&&u(v,idHalfPxSize,overlap,scene)){return-1.;}return y.a;}void main(void){float AF=x(vertexId.xy,idHalfPxSize,visibility,overlap,scene,currentZoom,currentTilt,currentAzimuth);if(AF<0.){gl_Position=A;}else{vec2 AG=vertexDisplacements.xy;float AH=vertexDisplacements.z;float Q=polylineLength_vertexScale[0];gl_Position=V(viewProjMatrix,lookAtHigh,lookAtLow,pixelSize,vertexPosHigh,vertexPosLow,AG,AH,Q,leftPolylineRatios,leftPolylineAngles,rightPolylineRatios,rightPolylineAngles);gl_Position.xy+=shift;gl_Position.z=vertexPriority;id=vec4(vertexId.xy/255.,0,AF);}}"},function(t,e){t.exports="#version 100\nattribute vec2 vertexPosHigh;attribute vec2 vertexPosLow;attribute vec2 vertexDisplacement;attribute vec2 vertexOffset;attribute vec4 vertexId;attribute float vertexPriority;uniform vec2 lookAtHigh;uniform vec2 lookAtLow;uniform mat4 viewProjMatrix;uniform vec2 pixelSize;uniform vec2 shift;uniform sampler2D visibility;uniform sampler2D overlap;uniform sampler2D scene;uniform vec2 idHalfPxSize;uniform lowp float currentZoom;uniform lowp float currentTilt;uniform lowp float currentAzimuth;varying vec4 id;const float A=pow(2.,16.);const float B=pow(2.,-31.);const float C=32.;const vec4 D=vec4(2,2,2,1);const vec4 E=vec4(0,0,0,0);const vec2 F=vec2(0,0);const float G=255./256.;const float H=0.05;const float I=0.15;const float J=0.02;bool K(vec2 L,vec2 idHalfPxSize,sampler2D overlap,sampler2D scene){vec2 M=texture2D(overlap,L).rg;return M!=F&&texture2D(scene,M*G+idHalfPxSize)!=E;}float N(vec2 id,vec2 idHalfPxSize,sampler2D visibility,sampler2D overlap,sampler2D scene,float currentZoom,float currentTilt,float currentAzimuth){vec2 L=id/256.+idHalfPxSize;vec4 O=texture2D(visibility,L);float P=O.b;float Q=O.r;float R=O.g;float S=P-currentZoom;float T=abs(Q-currentTilt);float U=abs(R-currentAzimuth);if((S>H||(abs(S)<=H&&T<I&&U<J))&&K(L,idHalfPxSize,overlap,scene)){return-1.;}return O.a;}void main(){float V=N(vertexId.xy,idHalfPxSize,visibility,overlap,scene,currentZoom,currentTilt,currentAzimuth);if(V<0.){gl_Position=D;}else{vec4 W=viewProjMatrix*vec4((A*(vertexPosHigh-lookAtHigh)+(vertexPosLow-lookAtLow))*B,0,1);vec2 X=(vertexDisplacement+vertexOffset)/C;gl_Position=vec4(W.xy/W.w+X*pixelSize,vertexPriority,1.);gl_Position.xy+=shift;id=vec4(vertexId.xy/255.,0,V);}}"},function(t,e,i){"use strict";var r=window.URL||window.webkitURL;t.exports=function(t,e){try{try{var i;try{(i=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder)).append(t),i=i.getBlob()}catch(s){i=new Blob([t])}return new Worker(r.createObjectURL(i))}catch(s){return new Worker("data:application/javascript,"+encodeURIComponent(t))}}catch(s){if(!e)throw Error("Inline worker is not supported");return new Worker(e)}}},function(t,e,i){"use strict";i.r(e);var r={};i.r(r),i.d(r,"createContentProvider",function(){return jn}),i.d(r,"Engine",function(){return Br}),i.d(r,"Camera",function(){return Fr}),i.d(r,"Context",function(){return $r}),i.d(r,"EventTrigger",function(){return s}),i.d(r,"YMapContentProvider",function(){return Le}),i.d(r,"VectorMapContentProvider",function(){return Kt}),i.d(r,"IndoorContentProvider",function(){return Te}),i.d(r,"VECTOR_METADATA_PREFIX",function(){return Lt}),i.d(r,"IndoorPlan",function(){return Qt}),i.d(r,"BackgroundRenderUnit",function(){return os}),i.d(r,"BackgroundColor",function(){return ns}),i.d(r,"LayerRenderUnit",function(){return ls}),i.d(r,"FxaaRenderUnit",function(){return us}),i.d(r,"createColorTransform",function(){return Ae}),i.d(r,"ModelsAnimationManager",function(){return fs}),i.d(r,"PolylineRenderUnit",function(){return As}),i.d(r,"PointLabelRenderUnit",function(){return Is}),i.d(r,"IconRenderUnit",function(){return Ks}),i.d(r,"TransparentPolygonRenderUnit",function(){return nn}),i.d(r,"PolygonRenderUnit",function(){return sn}),i.d(r,"ModelRenderUnit",function(){return xn}),i.d(r,"CurvedLabelRenderUnit",function(){return Tn}),i.d(r,"DebugFakePrimitiveRenderUnit",function(){return Rn}),i.d(r,"ColorIdPointLabelRenderer",function(){return kn}),i.d(r,"LabelResetRemovedRenderer",function(){return In}),i.d(r,"ColorIdCurvedLabelRenderer",function(){return Un}),i.d(r,"ColorIdIconRenderer",function(){return Vn}),i.d(r,"CollidingPrimitiveColorIdRenderer",function(){return br}),i.d(r,"CollidingPrimitivesResetRemovedRenderer",function(){return zr});class s{constructor(){this._listeners=new Map}addListener(t,e){this._listeners.set(t,e)}removeListener(t){this._listeners.delete(t)}fire(...t){for(const[e,i]of this._listeners)e.call(i,...t)}}class n{constructor(t){this._rootCommunicator=t,this._listeners={},this._rootCommunicator.onMessage.addListener(this._onMessage,this)}destructor(){this._rootCommunicator.onMessage.removeListener(this._onMessage)}getCommunicator(t){let e=this._listeners[t];return e||(e=new s,this._listeners[t]=e),{onMessage:e,sendMessage:(e,i,...r)=>{this._rootCommunicator.sendMessage({type:t,message:e},i,...r)}}}_onMessage(t){const e=this._listeners[t.type];e&&e.fire(t.message)}}function o(t,e="something that is supposed to be defined is undefined"){if(void 0===t)throw new Error(e);return void 0!==t}class a{constructor(t,e,i,r){this.id=i,this.page=t,this.location=e,this.metadata=r}}class l extends a{}function h(t,e){const i=[];for(const r of e){const e=t.getPage(r.location.bufferId);o(e)&&i.push(new l(e,r.location,r.id,r.metadata))}return i}function*c(t){for(const e in t)yield Number(e)}class d extends a{constructor(t,e,i,r,s){super(t,e,r,s),this.texture=i}}class u extends d{}function f(t,e,i){const r=[];for(const s of i){const i=t.getPage(s.location.bufferId),n=e.getAtlas(s.atlasId);o(i)&&o(n)&&r.push(new u(i,s.location,n.texture,s.id,s.metadata))}return r}class _ extends d{constructor(t,e,i,r,s,n){super(t,e,i,s,n),this.minZoom=r}}function p(t,e,i,r){const s=[];for(const n of i){const i=t.getPage(n.location.bufferId),a=e.getAtlas(n.atlasId);o(i)&&o(a)&&s.push(new _(i,n.location,a.texture,r,n.id,n.metadata))}return s}class m extends d{constructor(t,e,i,r,s,n,o){super(t,e,i,n,o),this.zIndex=r,this.minZoom=s}}function g(t,e,i,r){const s=[];for(const n of i){const i=t.getPage(n.location.bufferId),a=e.getAtlas(n.atlasId);o(i)&&o(a)&&s.push(new m(i,n.location,a.texture,n.zIndex,r,n.id,n.metadata))}return s}class y{constructor(t,e,i,r){this._registry=t,this._glyphAtlasRegistry=e,this._iconAtlasRegistry=i,this._additionalMetadata=r}destructor(){}_instantiatePrimitives(t,e){const i={primitives:{},references:[]};for(const r of c(t.primitives)){switch(r){case 0:case 1:case 2:i.primitives[r]=h(this._registry,t.primitives[r]);break;case 3:i.primitives[r]=f(this._registry,this._iconAtlasRegistry,t.primitives[r]);break;case 4:case 5:{const s=Math.max(e-2,0);i.primitives[r]=p(this._registry,this._glyphAtlasRegistry,t.primitives[r],s);break}case 6:{const s=Math.max(e-1,0);i.primitives[r]=g(this._registry,this._iconAtlasRegistry,t.primitives[r],s);break}}const s=i.primitives[r];o(s)&&this._applyAdditionalMetadata(s)}return t.references&&(i.references=i.references||[],i.references.push(...t.references)),i}_applyAdditionalMetadata(t){if(this._additionalMetadata)for(const e of t)if(e.metadata)for(const[t,i]of this._additionalMetadata)e.metadata.set(t,i)}}class v extends y{constructor(t,e,i,r,n,o,a,l){super(r,n,o,l),this._communicator=t,this._options=a,this._storage=e,this._modelStorage=i,this._onTileContentAdded=this.onTileContentAdded=new s,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:0,options:this._options},!1),this._options.customizationConfig&&this._options.customizationConfig.length&&this._updateCustomizationConfig()}destructor(){this._communicator.onMessage.removeListener(this._onMessage),super.destructor()}updateOption(t,e){this._options[t]=e,this._communicator.sendMessage({type:0,options:this._options},!1)}updateCustomizationConfig(t){this._options.customizationConfig=t,this._updateCustomizationConfig()}getOption(t){return this._options[t]}_onMessage(t){switch(t.type){case 3:this._onAddPrimitives(t);break;case 5:this._onAddModelPrimitives(t);break;case 4:this._onRemovePrimitives(t)}}_onAddPrimitives(t){const e=this._storage.get(t.tileId);if(o(e)){const i=this._instantiatePrimitives(t.content,e.tile.zoom);e.addContent(i),this._onTileContentAdded.fire(e,i,t.metrics)}}_onRemovePrimitives(t){const e=this._storage.get(t.tileId);if(o(e)){const n={primitives:{},references:[]};for(const o of t.content)i=n.primitives,r=o,s=e.content.primitives[o],i[r]=s;e.removeContent(n)}var i,r,s}_onAddModelPrimitives(t){const e=this._modelStorage.get(t.modelId),i=t.content.primitives[2];if(o(e)&&o(i)){const t=h(this._registry,i);this._applyAdditionalMetadata(t),e.addContent({primitives:{2:t}})}}_updateCustomizationConfig(){this._communicator.sendMessage({type:2,customizationConfig:this._options.customizationConfig},!1)}}function x(t,e){return t.x+"_"+t.y+"_"+t.zoom+"_"+e}function b(t,e){return Object.assign(Object.assign({},t),{id:x(t,e)})}function w(t,e){const i=[];for(const[r,s]of t)e.has(r)||i.push(s);return i}function A(t,e,i){let r=t.get(e);return r||(r=i(),t.set(e,r)),r}new Array;const P={x:0,y:0,zoom:0};class T{constructor(t,e,i=.5,r=1/0){this._camera=t,this._zoomShift=function(t){switch(e){case 1:return-1;case 2:return-2;default:return 0}}(),this._targetZoomShift=i,this._maxZoomWithTilesLoading=r}recalculateVisibleTiles(){const t=this._camera,e=Math.min(this._getTargetZoom(),this._maxZoomWithTilesLoading);return function*(t,e,i,r,s){if(0===s)return void(yield P);const n=1<<s,o=n-1,{minX:a,maxX:l,minY:h,maxY:c}=e,d=Math.floor((a+1)*n/2),u=Math.floor((l+1)*n/2),f=u-d+1,_=new Array(f),p=new Array(f);_.fill(Math.floor((1-h)*n/2)),p.fill(Math.floor((1-c)*n/2));const m=t.length;let g=t[m-1].x+1,y=1-t[m-1].y,v=Math.floor(g*n/2),x=Math.floor(y*n/2);for(let b=0;b<m;++b){const e=t[b].x+1,i=1-t[b].y,r=Math.floor(e*n/2),s=Math.floor(i*n/2),o=Math.abs(r-v)+Math.abs(s-x),a=e-g,l=i-y,h=a>0?1:-1,c=l>0?1:-1,u=2*h*l,f=-2*h*a,m=h*n*(a*y-l*g)+u*(~h>>>31);for(let t=0,n=v,g=x;t<o;++t){const t=u*n+f*g+m;0<=t&&t<=-f?n+=h:g+=c;const e=n-d;p[e]<g&&(p[e]=g),_[e]>g&&(_[e]=g)}g=e,y=i,v=r,x=s}if(2===i&&f>n)for(let b=0;b<n;++b)for(let t=b+n;t<f;t+=n)p[b]<p[t]&&(p[b]=p[t]),_[b]>_[t]&&(_[b]=_[t]);if(2===r)for(let b=0;b<f&&b<n;++b){const t=p[b]-_[b];if(t>n)_[b]=0,p[b]=o;else{const e=_[b]&=o;p[b]=e+t}}else for(let b=0;b<f&&b<n;++b)_[b]=Math.max(_[b],0),p[b]=Math.min(p[b],o);if(2===i)for(let b=0;b<f&&b<n;++b){const t=b+d&o;for(let e=_[b];e<=p[b];++e)yield{x:t,y:e&o,zoom:s}}else for(let b=Math.max(d,0),w=Math.min(u,o);b<=w;++b){const t=b-d;for(let e=_[t];e<=p[t];++e)yield{x:b,y:e&o,zoom:s}}}(t.getVisibleRegion(),t.getVisibleRegionBBox(),t.options.wrapModeX,t.options.wrapModeY,Math.max(0,e+this._zoomShift))}_getTargetZoom(){return Math.floor(this._camera.zoom+this._targetZoomShift)}}class S{constructor(t,e,i,r=new T(e,i.tileSize,i.targetZoomShift,i.maxZoomWithTilesLoading),n=""){this._camera=e,this._communicator=t,this._options=i,this._visibleTilesCalculator=r,this._tileIdPrefix=n,this._visibleTiles=new Map,this.onViewportChanged=this._onViewportChanged=new s,this._onCameraUpdateWrapper=this._onCameraUpdate.bind(this),this._camera.onUpdate.addListener(this._onCameraUpdateWrapper),this._syncOptions()}get visibleTiles(){return this._visibleTiles.values()}set tileIdPrefix(t){this._tileIdPrefix=t,this._syncOptions()}destructor(){this.pause(),this._camera.onUpdate.removeListener(this._onCameraUpdateWrapper)}forceCameraStateRecalculation(){this._onCameraUpdate()}pause(){this._camera.onUpdate.removeListener(this._onCameraUpdateWrapper),this._fireUpdates([],[...this._visibleTiles.values()]),this._visibleTiles.clear()}resume(){this._camera.onUpdate.addListener(this._onCameraUpdateWrapper,this),this.forceCameraStateRecalculation()}_onCameraUpdate(){const t=new Map;for(const s of this._visibleTilesCalculator.recalculateVisibleTiles()){const e=b(s,this._tileIdPrefix);t.set(e.id,e)}const e=this._visibleTiles;this._visibleTiles=t;const i=w(t,e),r=w(e,t);(i.length>0||r.length>0)&&this._fireUpdates(i,r)}_syncOptions(){var t;this._communicator.sendMessage({type:0,tileIdPrefix:this._tileIdPrefix,preloadedTilesBeltWidth:this._options.preloadedTilesBeltWidth,useLowPrecisionBeltTiles:(t=this._options.useLowPrecisionBeltTiles,null==t||t),wrapModeX:this._camera.options.wrapModeX,wrapModeY:this._camera.options.wrapModeY},!1)}_fireUpdates(t,e){this._onViewportChanged.fire({visibleAdded:t,visibleRemoved:e}),this._communicator.sendMessage({type:1,cameraPosition:{x:this._camera.center.x,y:this._camera.center.y,zoom:this._camera.zoom},visibleTilesToAdd:t,visibleTilesToRemove:e},!0)}}class R{constructor(){this._items=new Map,this.onAdded=this._onAdded=new s,this.onRemoved=this._onRemoved=new s}get size(){return this._items.size}get items(){return this._items.values()}get(t){return this._items.get(t)}has(t){return this._items.has(t)}_add(t,e){this._items.set(t,e),this._onAdded.fire(e)}_remove(t){const e=this._items.get(t);e&&(this._items.delete(t),this._onRemoved.fire(e))}}class z extends R{constructor(t){super(),this._communicator=t,this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}_onMessage(t){switch(t.type){case 0:this._onAdd(t);break;case 1:this._onRemove(t)}}_onAdd(t){this._add(t.id,this._deserialize(t.item))}_onRemove(t){this._remove(t.id)}}function M(t,e){return t>e?1:t<e?-1:0}function C(t,e,i){const r=t[e];t[e]=t[i],t[i]=r}function k(t,e,i=0,r=t.length,s=0){for(let n=i,o=s;n<r;++n,++o)e[o]=t[n]}function B(t,e=M,i=0,r=t.length){for(let s=i;s<r;++s)for(let r=s;r>i&&e(t[r-1],t[r])>0;--r)C(t,r-1,r)}function I(t,e,i,r,s,n,o){let a=o,l=r,h=s;for(;l<s&&h<n;)e[a++]=i(t[l],t[h])>0?t[h++]:t[l++];k(t,e,l,s,a),k(t,e,h,n,a)}function O(t,e){let i=0;for(let r=0;r<t.length;r++)e.has(t[r])||(t[i]=t[r],i++);t.length=i}class E{constructor(t){this.content=this._content=t,this.onContentAdded=this._onContentAdded=new s,this.onContentRemoved=this._onContentRemoved=new s}addContent(t){for(const e of c(t.primitives))this._content.primitives[e]||(this._content.primitives[e]=[]),this._content.primitives[e].push(...t.primitives[e]);t.references&&(this._content.references=this._content.references||[],this._content.references.push(...t.references)),this._onContentAdded.fire(this,t)}removeContent(t){for(const e of c(t.primitives)){const i=this._content.primitives[e];i&&O(i,new Set(t.primitives[e]))}if(t.references&&this._content.references){const e=new Set(t.references);O(this._content.references,e)}this._onContentRemoved.fire(this,t)}}class L extends E{constructor(t){super({primitives:{},references:[]}),this.id=t.id,this.tile=t}}class U extends z{_deserialize(t){return new L(t)}}class D{constructor(t,e,i,r){this._context=t,this.vertexBuffer=this._context.createVertexBuffer(i),this.indexBuffer=this._context.createIndexBuffer(r),this.vao=this._context.createVao(e,this.vertexBuffer,this.indexBuffer),this.indexType=5123}destructor(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.vao.destroy()}updateVertexContent(t,e){this._context.bindVao(null),this._context.uploadDataToBuffer(this.vertexBuffer,t,e)}updateIndexContent(t,e){this._context.bindVao(null),this._context.uploadDataToBuffer(this.indexBuffer,t,e)}}var F;!function(t){t[t.FROM_BACKEND_ADD_PAGE=0]="FROM_BACKEND_ADD_PAGE",t[t.FROM_BACKEND_UPDATE_PAGE=1]="FROM_BACKEND_UPDATE_PAGE",t[t.FROM_BACKEND_REMOVE_PAGE=2]="FROM_BACKEND_REMOVE_PAGE"}(F||(F={}));class V{constructor(t,e){this._communicator=t,this._context=e,this._pages=new Map,this.memoryUsage=this._memoryUsage={memoryForBuffers:0,memoryForVertices:0,memoryForIndices:0},this.onMemoryUsageChanged=this._onMemoryUsageChanged=new s,this._communicator.onMessage.addListener(this._onMessage,this)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getPage(t){return this._pages.get(t)}_onMessage(t){switch(t.type){case F.FROM_BACKEND_ADD_PAGE:this._onPageAdd(t);break;case F.FROM_BACKEND_UPDATE_PAGE:this._onPageUpdate(t);break;case F.FROM_BACKEND_REMOVE_PAGE:this._onPageRemove(t)}}_onPageAdd(t){this._pages.set(t.id,new D(this._context,t.attribMapping,t.vertexDataByteSize,t.indexDataByteSize))}_onPageUpdate(t){const e=this.getPage(t.id);o(e)&&(e.updateVertexContent(t.vertexData,t.vertexByteOffset),e.updateIndexContent(t.indexData,t.indexByteOffset))}_onPageRemove(t){const e=this._pages.get(t.id);o(e)&&(this._pages.delete(t.id),e.destructor())}}function*j(t,e){for(const i of t)yield e(i)}function*N(t,e){for(const i of t)e(i)&&(yield i)}function H(t,e){for(const i of t)if(!e(i))return!1;return!0}function W(t,e){let i=0;for(const r of t)e&&!e(r)||i++;return i}function X(t){let e="";for(let i=t.zoom;i>0;i--){let r="0";const s=1<<i-1;0!=(t.x&s)&&(r="1"),0!=(t.y&s)&&(r="1"===r?"3":"2"),e+=r}return e}function Y(t,e,i){return e<t?t<i?t:i:e}function q(t,e,i){const r=(t-e)/(i-e);return e+(i-e)*(r-Math.floor(r))}function G(t,e){const i=e.zoom-t.zoom;return i>0&&e.x>>i===t.x&&e.y>>i===t.y}const Z=Date.now(),K="performance"in self&&"now"in performance?performance.now.bind(performance):function(){return Date.now()-Z};class Q{constructor(){this._marks=new Map}mark(t){this._marks.set(t,K())}unmark(t){this._marks.delete(t)}measure(t,e=!1){const i=this._marks.get(t);return void 0!==i?(e||this.unmark(t),K()-i):Q.UNMEASURED}}Q.UNMEASURED=-1;const J={postfix:"",reduce:t=>t[0]},$={postfix:"Avg",reduce:t=>t.reduce((t,e)=>t+e,0)/t.length};class tt{constructor(t,e,i=1,r=[J],s){this._transport=t,this._name=e,this._maxItems=i,this._reducers=r,this._additionalParams=s,this._values={},this._marker=new Q}mark(t){this._marker.mark(t)}unmark(t){this._marker.unmark(t)}putMeasuredValue(t,e=t,i){const r=this._marker.measure(t,i);r!==Q.UNMEASURED&&this.putValue(e,r)}putValue(t,e){let i=this._values[t];i||(i=this._values[t]=[]),i.length<this._maxItems&&i.push(e)}putValues(t){for(const e of Object.keys(t)){const i=t[e];void 0!==i&&this.putValue(e,i)}}submit(){this._transport.submit(this._name,this._getReducedValues())}_getReducedValues(){const t=Object.assign({},this._additionalParams);for(const e of Object.keys(this._values)){const i=this._values[e];if(i&&i.length>0){i.sort((t,e)=>t-e);for(const r of this._reducers)t[e+r.postfix]=r.reduce(i).toFixed(2)}}return t}}function et(t){return!(!t.content.primitives[0]&&!t.content.primitives[1]||!t.content.primitives[4]&&!t.content.primitives[5])}var it,rt;!function(t){t[t.FULL=0]="FULL",t[t.IMMEDIATE=1]="IMMEDIATE"}(it||(it={}));class st{constructor(t,e,i,r,n,o){this._viewport=t,this._storage=e,this._tileContentVisibilityManager=i,this._modelVisibilityManager=r,this._allTileNodes=new Map,this._visualizableTileNodeByQuadKey=new Map,this._visibleTileNodes=new Map,this._visualizedTileNodes=new Map,this.onViewportStateChanged=this._onViewportStateChanged=new s,this.viewportState=this._viewportState={visibleTileNumber:0,visualizableTileNumber:0},this._viewport.onViewportChanged.addListener(this._onViewportUpdate,this),this._storage.onAdded.addListener(this._onTileAdd,this),this._storage.onRemoved.addListener(this._onTileRemove,this),this._metrics=new tt(n,"vector."+o+".viewport",1024,[$])}submitMetrics(){this._metrics.submit()}destructor(){this._viewport.onViewportChanged.removeListener(this._onViewportUpdate),this._storage.onAdded.removeListener(this._onTileAdd),this._storage.onRemoved.removeListener(this._onTileRemove),clearTimeout(this._changeModeTimer)}_onTileAdd(t){const e=et(t),i=this._getTileNode(t.tile);i.tile=t,i.isVisualizable=e,e&&this._visualizableTileNodeByQuadKey.set(i.quadKey,i),i.isVisible&&i.isVisualizable&&!i.isVisualized&&this._tryToVisualizeViewport(),t.onContentAdded.addListener(this._onTileContentAdded,this)}_onTileContentAdded(t){const e=this._getTileNode(t.tile);e.isVisualizable=e.isVisualizable||et(t),e.isVisualizable&&this._visualizableTileNodeByQuadKey.set(e.quadKey,e),e.isVisible&&e.isVisualizable&&this._tryToVisualizeViewport()}_onTileRemove(t){const e=this._getTileNode(t.tile);e.isVisible||(this._allTileNodes.delete(e.tileItem.id),this._visualizableTileNodeByQuadKey.delete(e.quadKey)),e.isVisualized&&this._makeNotVisualized(e),delete e.tile,t.onContentAdded.removeListener(this._onTileContentAdded)}_onViewportUpdate({visibleAdded:t,visibleRemoved:e}){for(const i of t){const t=this._getTileNode(i);this._makeVisible(t)}for(const i of e){const t=this._getTileNode(i);this._makeNotVisible(t)}if(t.length>0){const e=new Set,i=t[0].zoom;for(const t of this._visualizedTileNodes.values())e.add(t.tileItem.zoom);if(e.size<=2&&e.has(i+1))for(const t of this._visibleTileNodes.values())if(t.isVisualizable)this._makeVisualized(t);else for(let e=0;e<4;e++){const i=this._visualizableTileNodeByQuadKey.get(t.quadKey+e);i&&this._makeVisualized(i)}else if(e.size<=2&&e.has(i))for(const t of this._visibleTileNodes.values())if(t.isVisualizable)this._makeVisualized(t);else{const e=t.quadKey.slice(0,-1),i=this._visualizableTileNodeByQuadKey.get(e);if(i){let t=!0;for(let i=0;i<4;i++)this._visualizableTileNodeByQuadKey.get(e+i)&&(t=!1);t&&this._makeVisualized(i)}}}this._changeModeTimer||this._mode!==it.FULL||(this._changeModeTimer=setTimeout(()=>{this._mode=it.IMMEDIATE,this._tryToVisualizeViewport()},800)),this._tryToVisualizeViewport()}_tryToVisualizeViewport(){const t=this._visibleTileNodes.size;if(t===W(this._visibleTileNodes.values(),t=>t.isVisualizable)){clearTimeout(this._changeModeTimer),this._changeModeTimer=0,this._mode=it.FULL;for(const t of this._visualizedTileNodes.values())t.isVisible||this._makeNotVisualized(t);for(const t of this._visibleTileNodes.values())this._makeVisualized(t)}else if(this._mode===it.IMMEDIATE)for(const i of this._visibleTileNodes.values())if(!i.isVisualized&&i.isVisualizable){let t=!1;for(const e of this._visualizedTileNodes.values())if(G(i.tileItem,e.tileItem))this._makeNotVisualized(e);else if(G(e.tileItem,i.tileItem)){const i=e,r=[];for(const t of this._visibleTileNodes.values())G(i.tileItem,t.tileItem)&&r.push(t);H(r,t=>t.isVisualizable)?this._makeNotVisualized(i):t=!0}t||this._makeVisualized(i)}const e=W(this._visibleTileNodes.values(),t=>t.isVisualized);t===this._viewportState.visibleTileNumber&&e===this._viewportState.visualizableTileNumber||(this._viewportState.visibleTileNumber=t,this._viewportState.visualizableTileNumber=e,this._onViewportStateChanged.fire(this._viewportState))}_makeVisible(t){t.isVisible||(t.isVisible=!0,this._visibleTileNodes.set(t.id,t),this._metrics.mark(t.id))}_makeNotVisible(t){t.isVisible&&(t.isVisible=!1,this._visibleTileNodes.delete(t.id),this._metrics.unmark(t.id))}_makeVisualized(t){const e=t.tile;t.isVisualizable&&!t.isVisualized&&e&&(this._tileContentVisibilityManager.showObject(e),this._modelVisibilityManager.showTileModels(e),t.isVisualized=!0,this._visualizedTileNodes.set(t.id,t),this._metrics.putMeasuredValue(t.id,"tileVisualizationReady"))}_makeNotVisualized(t){const e=t.tile;t.isVisualized&&e&&(this._tileContentVisibilityManager.hideObject(e),this._modelVisibilityManager.hideTileModels(e),t.isVisualized=!1,this._visualizedTileNodes.delete(t.id))}_getTileNode(t){const e=this._allTileNodes.get(t.id);if(e)return e;{const e={id:t.id,tileItem:t,quadKey:X(t),isVisualizable:!1,isVisible:!1,isVisualized:!1};return this._allTileNodes.set(t.id,e),e}}}function nt(){return devicePixelRatio>1?devicePixelRatio:1}function ot(t,e){return{x:t,y:e}}!function(t){t[t.TO_BACKEND_SETUP=0]="TO_BACKEND_SETUP",t[t.FROM_BACKEND_ADD_ATLAS=1]="FROM_BACKEND_ADD_ATLAS",t[t.FROM_BACKEND_UPDATE_ATLAS=2]="FROM_BACKEND_UPDATE_ATLAS",t[t.FROM_BACKEND_REMOVE_ATLAS=3]="FROM_BACKEND_REMOVE_ATLAS"}(rt||(rt={}));const at=ot(0,0);function lt(t,e=ot(0,0)){return e.x=t.x,e.y=t.y,e}function ht(t,e,i=ot(0,0)){return i.x=t.x+e.x,i.y=t.y+e.y,i}function ct(t,e,i=ot(0,0)){return i.x=t.x*e,i.y=t.y*e,i}function dt(t,e,i=ot(0,0)){return i.x=e(t.x),i.y=e(t.y),i}function ut(t,e,i,r){return{minX:t,maxX:e,minY:i,maxY:r}}function ft(t,e={minX:0,maxX:0,minY:0,maxY:0}){if(0===t.length)return e;e.minX=e.maxX=t[0].x,e.minY=e.maxY=t[0].y;for(let i=1;i<t.length;++i){const{x:r,y:s}=t[i];r<e.minX&&(e.minX=r),r>e.maxX&&(e.maxX=r),s<e.minY&&(e.minY=s),s>e.maxY&&(e.maxY=s)}return e}function _t(t=0,e=0){return{width:t,height:e}}function pt(t,e=_t()){return e.width=t.width,e.height=t.height,e}function mt(t,e){return t.width===e.width&&t.height===e.height}ot(1,0),ot(-1,0),ot(0,1),ot(0,-1);class gt{constructor(t,e,i){this._context=t,this.texture=t.createEmpty2DTexture(e,i,6406,5121,{wrapS:33071,wrapT:33071,magnificationFilter:9729,minificationFilter:9729,premultipliedAlpha:!1,unpackAlignment:1}),"string"==typeof navigator.vendor&&navigator.vendor.match(/^Apple/)&&this.updateContent(ot(0,0),_t(1,1),new Uint8Array(1))}destructor(){this.texture.destroy()}updateContent(t,e,i){this._context.setTextureData(this.texture,i,t,e)}}class yt{constructor(t,e,i){this._communicator=t,this._context=i,this._atlases=[],this.memoryUsage=this._memoryUsage={memoryForGlyphs:0},this.onMemoryUsageChanged=this._onMemoryUsageChanged=new s,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:rt.TO_BACKEND_SETUP,options:e},!1)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getAtlas(t){return this._atlases[t]}_onMessage(t){switch(t.type){case rt.FROM_BACKEND_ADD_ATLAS:this._onAtlasAdd(t);break;case rt.FROM_BACKEND_UPDATE_ATLAS:this._onAtlasUpdate(t);break;case rt.FROM_BACKEND_REMOVE_ATLAS:this._onAtlasRemove(t)}}_onAtlasAdd(t){this._atlases[t.atlasId]=new gt(this._context,t.width,t.height)}_onAtlasUpdate(t){const{atlasId:e,data:i,offset:r,size:s}=t,n=this._atlases[e];o(n)&&n.updateContent(r,s,i)}_onAtlasRemove(t){const e=this._atlases[t.atlasId];o(e)&&(e.destructor(),delete this._atlases[t.atlasId])}}var vt;!function(t){t[t.TO_BACKEND_SETUP=0]="TO_BACKEND_SETUP",t[t.FROM_BACKEND_ADD_ATLAS=1]="FROM_BACKEND_ADD_ATLAS",t[t.FROM_BACKEND_UPDATE_ATLAS=2]="FROM_BACKEND_UPDATE_ATLAS",t[t.FROM_BACKEND_REMOVE_ATLAS=3]="FROM_BACKEND_REMOVE_ATLAS"}(vt||(vt={}));class xt{constructor(t,e,i){this._context=t,this.texture=t.createEmpty2DTexture(e,i,6408,5121,{wrapS:33071,wrapT:33071,magnificationFilter:9728,minificationFilter:9728,premultipliedAlpha:!0,unpackAlignment:1}),this.onContentUpdated=this._onContentUpdated=new s}destructor(){this.texture.destroy()}updateContent(t){this._context.setTextureData(this.texture,t.data,t.offset,t.size),this._onContentUpdated.fire()}}class bt{constructor(){this.onReleased=this._onReleased=new s,this.onRetain=this._onRetain=new s,this._clients=0}get isRetained(){return 0!==this._clients}retain(){++this._clients,this._onRetain.fire(this)}release(){this._clients>0&&(--this._clients,0===this._clients&&this._onReleased.fire(this))}}class wt{constructor(t){this._comparator=t,this._size=0}get root(){return this._root}get size(){return this._size}get min(){if(this._root)return this._min(this._root).value}get max(){if(this._root)return this._max(this._root).value}insert(t){if(this._size++,!this._root)return this._root={value:t},this._root;let e=this._root;for(;e;)if(this._comparator(t,e.value)<0){if(!e.left)return e.left={parent:e,value:t};e=e.left}else{if(!e.right)return e.right={parent:e,value:t};e=e.right}throw new Error}remove(t){if(this._size--,t.left&&t.right){const e=this._min(t.right);this._replaceSubtree(t,e),t.left&&(e.left=t.left,t.left.parent=e),t.right&&(e.right=t.right,t.right.parent=e)}else t.left?this._replaceSubtree(t,t.left):t.right?this._replaceSubtree(t,t.right):this._replaceSubtree(t,void 0)}*values(t){t&&(yield*this.values(t.left),yield t.value,yield*this.values(t.right))}[Symbol.iterator](){return this.values(this._root)}_min(t){let e=t;for(;e.left;)e=e.left;return e}_max(t){let e=t;for(;e.right;)e=e.right;return e}_replaceSubtree(t,e){t.parent?t.parent.left===t?t.parent.left=e:t.parent.right===t&&(t.parent.right=e):this._root=e,e&&(e.parent&&(e.parent.left===e?e.parent.left=void 0:e.parent.right===e&&(e.parent.right=void 0)),e.parent=t.parent)}}class At{constructor(){this._nodes=new Map}get begin(){return this._begin&&this._begin.value}get end(){return this._end&&this._end.value}insert(t){if(!this._nodes.has(t)){const e={value:t};this._end?this.insertAfter(this._end.value,t):(this._begin=this._end=e,this._nodes.set(t,e))}}insertBefore(t,e){const i=this._nodes.get(t);if(i&&!this._nodes.has(e)){const t={value:e};i.prev&&(i.prev.next=t,t.prev=i.prev),t.next=i,i.prev=t,this._nodes.set(e,t),i===this._begin&&(this._begin=t)}}insertAfter(t,e){const i=this._nodes.get(t);if(i&&!this._nodes.has(e)){const t={value:e};i.next&&(i.next.prev=t,t.next=i.next),t.prev=i,i.next=t,this._nodes.set(e,t),i===this._end&&(this._end=t)}}remove(t){const e=this._nodes.get(t);e&&(e===this._begin&&(this._begin=e.next),e===this._end&&(this._end=e.prev),e.next&&(e.next.prev=e.prev),e.prev&&(e.prev.next=e.next),this._nodes.delete(t))}getPrev(t){const e=this._nodes.get(t);if(e&&e.prev)return e.prev.value}getNext(t){const e=this._nodes.get(t);if(e&&e.next)return e.next.value}*values(){let t=this._begin;for(;t;)yield t.value,t=t.next}[Symbol.iterator](){return this.values()}}class Pt{constructor(t,e=1){this._size=t,this._alignment=e,this._freeOffset=0,this._allocatedOffsets=new Set}get size(){return this._size}get maxAllocableSize(){return this._size-this._freeOffset}get isEmpty(){return 0===this._allocatedOffsets.size}allocate(t){if(this._size>=this._freeOffset+t){const e=this._freeOffset;return this._freeOffset=function(t,e){return e*Math.ceil(t/e)}(e+t,this._alignment),this._allocatedOffsets.add(e),e}return-1}deallocate(t){this._allocatedOffsets.delete(t)}isAllocated(t){return t<this._freeOffset}extend(t){if(t<this._freeOffset)throw new Error("Could not reduce the size because it conflicts with already allocated region.");this._size=t}}class Tt{constructor(t){this._size=t,this._allRegions=new At,this._occupiedRegions=new Map,this._freeRegions=new wt((t,e)=>t.size-e.size);const e={offset:0,size:t};this._allRegions.insert(e),e._freeNode=this._freeRegions.insert(e)}get size(){return this._size}get maxAllocableSize(){const t=this._freeRegions.max;return t?t.size:0}get isEmpty(){return 0===this._occupiedRegions.size}allocate(t){const e=this._findMinSuitable(t);if(!e)return-1;const i=e.value;this._freeRegions.remove(e);const r={offset:i.offset,size:t};if(this._occupiedRegions.set(i.offset,r),this._allRegions.insertAfter(i,r),this._allRegions.remove(i),i.size>t){const e={offset:i.offset+t,size:i.size-t};e._freeNode=this._freeRegions.insert(e),this._allRegions.insertAfter(r,e)}return r.offset}deallocate(t){let e=this._occupiedRegions.get(t);if(e){const i=this._allRegions.getPrev(e);if(i&&i._freeNode){const t={offset:i.offset,size:i.size+e.size};this._allRegions.insertAfter(i,t),this._allRegions.remove(e),this._allRegions.remove(i),this._freeRegions.remove(i._freeNode),e=t}const r=this._allRegions.getNext(e);if(r&&r._freeNode){const t={offset:e.offset,size:e.size+r.size};this._allRegions.insertBefore(r,t),this._allRegions.remove(e),this._allRegions.remove(r),this._freeRegions.remove(r._freeNode),e=t}this._occupiedRegions.delete(t),e._freeNode=this._freeRegions.insert(e)}}isAllocated(t){return this._occupiedRegions.has(t)}extend(t){if(t<this._size)throw new Error("Size reducing is not allowed in free list allocator");const e=t-this._size,i=this._allRegions.end;if(i&&i._freeNode){this._freeRegions.remove(i._freeNode);const t={offset:i.offset,size:i.size+e,isFree:!0};this._allRegions.insertAfter(i,t),this._allRegions.remove(i),this._freeRegions.insert(t)}else{const t={offset:this._size,size:e,isFree:!0};this._allRegions.insert(t),this._freeRegions.insert(t)}this._size=t}_findMinSuitable(t){let e,i=this._freeRegions.root;for(;i;){if(i.value.size===t){e=i;break}i.value.size<t?i=i.right:(e=i,i=i.left)}return e}}class St{constructor(t,e){this.width=t,this.height=e,this._allocator=new Tt(this.width)}allocate(t){return this._allocator.allocate(t)}deallocate(t){this._allocator.deallocate(t)}isAllocated(t){return this._allocator.isAllocated(t)}canAllocate(t){return this._allocator.maxAllocableSize>=t}resize(t){this._allocator.extend(t),this.width=t}}class Rt{constructor(t,e){this.width=t,this.height=e,this._shelves=new Map,this._shelfAllocator=new Pt(e)}allocate(t){let e,i=-1,r=-1;for(const[s,n]of this._shelves.entries()){const o=t.height/n.height;if(1===o&&n.canAllocate(t.width)){e=n,i=s;break}o<1&&o>r&&n.canAllocate(t.width)&&(e=n,i=s,r=o)}if(!e&&this._shelfAllocator.maxAllocableSize>=t.height&&this.width>=t.width){const r=this._shelfAllocator.allocate(t.height);e=new St(this.width,t.height),i=r,this._shelves.set(r,e)}if(e){const r=e.allocate(t.width),s=i;return{minX:r,maxX:r+t.width,minY:s,maxY:s+t.height}}return null}deallocate(t){const e=this._shelves.get(t.minY);e&&e.deallocate(t.minX)}isAllocated(t){const e=this._shelves.get(t.minY);return!!e&&e.isAllocated(t.minX)}resize(t,e){this._shelfAllocator.extend(e);for(const i of this._shelves.values())i.resize(t);this.width=t,this.height=e}}ut(Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MIN_SAFE_INTEGER);class zt{constructor(t,e,i){this._communicator=t,this._context=i,this._atlases=[],this.memoryUsage=this._memoryUsage={memoryForIcons:0},this.onMemoryUsageChanged=this._onMemoryUsageChanged=new s,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:vt.TO_BACKEND_SETUP,options:e},!1)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getAtlas(t){return this._atlases[t]}_onMessage(t){switch(t.type){case vt.FROM_BACKEND_ADD_ATLAS:this._onAddAtlas(t);break;case vt.FROM_BACKEND_UPDATE_ATLAS:this._onUpdateAtlas(t);break;case vt.FROM_BACKEND_REMOVE_ATLAS:this._onRemoveAtlas(t)}}_onAddAtlas(t){this._atlases[t.atlasId]=new xt(this._context,t.atlasWidth,t.atlasHeight)}_onUpdateAtlas(t){const e=this._atlases[t.atlasId];o(e)&&e.updateContent(t.atlasRegion)}_onRemoveAtlas(t){const e=this._atlases[t.atlasId];o(e)&&(e.destructor(),delete this._atlases[t.atlasId])}}class Mt extends E{constructor(t){super({primitives:{}}),this.id=t}}class Ct extends z{_deserialize(t){return new Mt(t)}}class kt{constructor(t,e){this._contentVisibilityManager=t,this._modelStorage=e,this._modelsToVisualizedTiles=new Map,this._modelStorage.onAdded.addListener(this._onModelAdded,this),this._modelStorage.onRemoved.addListener(this._onModelRemoved,this)}showTileModels(t){for(const e of t.content.references||[]){const i=A(this._modelsToVisualizedTiles,e,()=>new Set);0===i.size&&this._tryToGetAndShowModel(e),i.add(t)}}hideTileModels(t){for(const e of t.content.references||[]){const i=this._modelsToVisualizedTiles.get(e);i&&(i.delete(t),0===i.size&&(this._modelsToVisualizedTiles.delete(e),this._tryToGetAndHideModel(e)))}}_onModelAdded(t){this._modelsToVisualizedTiles.has(t.id)&&this._contentVisibilityManager.showObject(t)}_onModelRemoved(t){this._modelsToVisualizedTiles.has(t.id)&&this._contentVisibilityManager.hideObject(t)}_tryToGetAndShowModel(t){const e=this._modelStorage.get(t);e&&this._contentVisibilityManager.showObject(e)}_tryToGetAndHideModel(t){const e=this._modelStorage.get(t);e&&this._contentVisibilityManager.hideObject(e)}}class Bt{constructor(t,e,i,r,s,n,o){this._storage=r,this._contentManager=s,this._viewport=n,this._tileReadyChecker=o,this._everVisibleTiles=new Set,this._measuringTiles=new Set;const a="vector."+e+".tile_processing";this._metrics=new It(t,a,i,{visible:"1"}),r.onRemoved.addListener(this._onTileRemoved,this),s.onTileContentAdded.addListener(this._onTileContentAdded,this),n.onViewportChanged.addListener(this._onViewportChanged,this)}submit(){this._metrics.submit()}destructor(){this._storage.onRemoved.removeListener(this._onTileRemoved),this._contentManager.onTileContentAdded.removeListener(this._onTileContentAdded),this._viewport.onViewportChanged.removeListener(this._onViewportChanged)}_onTileRemoved(t){this._everVisibleTiles.delete(t.id)}_onTileContentAdded(t,e,i){if(this._measuringTiles.has(t.id)){this._metrics.putValues(t.id,i),this._tileReadyChecker(t)&&this._metrics.measure(t.id,"tileReady");const r=e.primitives;(r[0]||r[1])&&this._metrics.measure(t.id,"polygonsReady"),(r[5]||r[4])&&this._metrics.measure(t.id,"labelsReady"),e.primitives[6]&&this._metrics.measure(t.id,"iconsReady")}}_onViewportChanged(t){for(const e of t.visibleAdded)this._everVisibleTiles.has(e.id)||this._storage.get(e.id)||(this._everVisibleTiles.add(e.id),this._measuringTiles.add(e.id),this._metrics.addTilesToMeasure(e.id));for(const e of t.visibleRemoved)this._measuringTiles.delete(e.id)&&this._metrics.removeTileMeasurement(e.id)}}class It{constructor(t,e,i,r){const s=[$];this._metrics=new tt(t,e,1024,s,Object.assign({firstViewport:"0"},r)),this._firstViewportMetrics=new tt(t,e,1024,s,Object.assign({firstViewport:"1"},r)),this._firstViewportTiles=new Set,this._isFirstViewport=!0,this._camera=i}addTilesToMeasure(t){this._firstViewportState||(this._firstViewportState={x:this._camera.center.x,y:this._camera.center.y,zoom:this._camera.zoom}),!this._isFirstViewport||this._firstViewportState.x==this._camera.center.x&&this._firstViewportState.y==this._camera.center.y&&this._firstViewportState.zoom==this._camera.zoom||(this._isFirstViewport=!1),this._isFirstViewport?(this._firstViewportTiles.add(t),this._firstViewportMetrics.mark(t)):this._metrics.mark(t)}measure(t,e){this._firstViewportTiles.size>0&&this._firstViewportTiles.has(t)?this._firstViewportMetrics.putMeasuredValue(t,e,!0):this._metrics.putMeasuredValue(t,e,!0)}removeTileMeasurement(t){this._firstViewportTiles.size>0&&this._firstViewportTiles.delete(t)?this._firstViewportMetrics.unmark(t):this._metrics.unmark(t)}putValues(t,e){this._firstViewportTiles.size>0&&this._firstViewportTiles.has(t)?this._firstViewportMetrics.putValues(e):this._metrics.putValues(e)}submit(){this._firstViewportMetrics.submit(),this._metrics.submit()}}class Ot{constructor(t){this.onUpdate=this._onUpdate=new s,this._camera=t,this._onZoomUpdated=this._onZoomUpdated.bind(this),t.onUpdate.addListener(this._onZoomUpdated)}destructor(){this._camera.onUpdate.removeListener(this._onZoomUpdated)}test(t){return this._camera.zoom>=t.minZoom}_onZoomUpdated(){this._prevZoom!==this._camera.zoom&&(this._onUpdate.fire(),this._prevZoom=this._camera.zoom)}}class Et{constructor(t){this._storages=t,this._index=new Map;for(const e of this._storages){for(const t of e.items)this._onObjectAdded(t);e.onAdded.addListener(this._onObjectAdded,this),e.onRemoved.addListener(this._onObjectRemoved,this)}}destructor(){for(const t of this._storages){for(const e of t.items)this._onObjectRemoved(e);t.onAdded.removeListener(this._onObjectAdded),t.onRemoved.removeListener(this._onObjectRemoved)}}getMetadata(t){var e;return null===(e=this._index.get(t))||void 0===e?void 0:e.metadata}_onObjectAdded(t){this._onContentAdded(t,t.content),t.onContentAdded.addListener(this._onContentAdded,this),t.onContentRemoved.addListener(this._onContentRemoved,this)}_onObjectRemoved(t){this._onContentRemoved(t,t.content),t.onContentAdded.removeListener(this._onContentAdded),t.onContentRemoved.removeListener(this._onContentRemoved)}_onContentAdded(t,e){for(const i of c(e.primitives))this._addPrimitivesMetadata(e.primitives[i])}_onContentRemoved(t,e){for(const i of c(e.primitives))this._removePrimitivesMetadata(e.primitives[i])}_addPrimitivesMetadata(t){if(t&&t.length>0)for(const e of t)e.id&&e.metadata&&this._retain(e.id,e.metadata)}_removePrimitivesMetadata(t){if(t&&t.length>0)for(const e of t)e.id&&this._release(e.id)}_retain(t,e){const i=this._index.get(t);i?i.count++:this._index.set(t,{metadata:e,count:1})}_release(t){const e=this._index.get(t);e&&(e.count--,0===e.count&&this._index.delete(t))}}const Lt="_vector_";let Ut=0;class Dt{constructor(){this._key=Symbol("array_storage_metadata#"+Ut++),this._data=[],this._isDirty=!1}*[Symbol.iterator](){this._isDirty&&this._shakeDown(),yield*this._data}add(t){let e=this._getMetadata(t);return!e&&(e={index:this._data.push(t)-1},t[this._key]=e,!0)}remove(t){const e=this._getMetadata(t);return!!e&&(delete this._data[e.index],delete t[this._key],this._isDirty=!0,!0)}_shakeDown(){let t=0;for(let e=0;e<this._data.length;++e){const i=this._data[e];if(void 0!==i){const e=this._getMetadata(i);this._data[t]=i,e.index=t,++t}}this._data.length=t,this._isDirty=!1}_getMetadata(t){return t[this._key]}}function Ft(t,e){let i=0;return(...r)=>{i&&clearTimeout(i),i=setTimeout(()=>{i=0,t(...r)},e)}}function Vt(t,e=!1){let i=!1;return(...r)=>{e&&i||(Promise.resolve().then(()=>{t(...r),i=!1}),i=!0)}}class jt{constructor(){this._primitives=new Dt,this.onUpdate=this._onUpdate=new s,this._updateScheduler=Vt(this._fireUpdate.bind(this),!0)}get primitives(){return this._primitives}add(t){for(const e of t)this._primitives.add(e);this._updateScheduler()}delete(t){for(const e of t)this._primitives.remove(e);this._updateScheduler()}_fireUpdate(){this._onUpdate.fire()}}class Nt extends jt{constructor(){super(),this._visiblePrimitives=new Dt}get primitives(){return this.visiblePrimitives}get visiblePrimitives(){return this._visiblePrimitives}add(t){super.add(t),this.show(t)}delete(t){this.hide(t),super.delete(t)}show(t){this._show(t)&&this._updateScheduler()}hide(t){this._hide(t)&&this._updateScheduler()}_show(t){let e=!1;for(const i of t)this._visiblePrimitives.add(i)&&(e=!0);return e}_hide(t){let e=!1;for(const i of t)this._visiblePrimitives.remove(i)&&(e=!0);return e}}class Ht extends Nt{constructor(t){super(),this._appearingEffectDuration=t,this._timeoutIds=new Set,this._removeSchedulerFlagKey=Symbol("1"),this._scheduler=Vt(this._scheduleRemovePrimitives.bind(this),!0),this._scheduledForRemovePrimitives=[]}get primitives(){return this._primitives}add(t){super.add(t);for(const e of t){const t=e[this._removeSchedulerFlagKey];t&&t.isScheduledForRemove&&(t.isScheduledForRemove=!1)}}delete(t){this.hide(t);for(const e of t){let t=e[this._removeSchedulerFlagKey];t||(t={isScheduledForRemove:!0},e[this._removeSchedulerFlagKey]=t),t.isScheduledForRemove=!0}this._scheduledForRemovePrimitives.push(...t),this._scheduler()}destroy(){for(const t of this._timeoutIds)clearTimeout(t)}_scheduleRemovePrimitives(){const t=setTimeout(e=>{super.delete([...N(e,t=>{const e=t[this._removeSchedulerFlagKey];return void 0!==e&&e.isScheduledForRemove})]),this._timeoutIds.delete(t)},this._appearingEffectDuration,[...this._scheduledForRemovePrimitives]);this._scheduledForRemovePrimitives.length=0,this._timeoutIds.add(t)}}class Wt{constructor(...t){this.onUpdate=this._onUpdate=new s,this._filterUpdateListener=()=>this._onUpdate.fire();for(const e of t)e.onUpdate&&e.onUpdate.addListener(this._filterUpdateListener);this._filters=new Set(t)}addFilter(t){this._filters.has(t)||(this._filters.add(t),t.onUpdate&&t.onUpdate.addListener(this._filterUpdateListener),this._onUpdate.fire())}deleteFilter(t){this._filters.delete(t)&&(t.onUpdate&&t.onUpdate.removeListener(this._filterUpdateListener),this._onUpdate.fire())}test(t){return H(this._filters,e=>e.test(t))}}class Xt{constructor(t){this._scene=t,this._filter=new Wt,this._visible=new Dt,this._hidden=new Dt,this._onFilterUpdate=this._onFilterUpdate.bind(this),this._filter.onUpdate.addListener(this._onFilterUpdate,this)}addPrimitives(t){const e=[],i=[];for(const r of t)this._filter.test(r)?(e.push(r),this._visible.add(r)):(i.push(r),this._hidden.add(r));this._scene.add(e),this._scene.add(i),this._scene.show(e),this._scene.hide(i)}removePrimitives(t){this._scene.remove(t);for(const e of t)this._visible.remove(e),this._hidden.remove(e)}addFilter(t){this._filter.addFilter(t)}removeFilter(t){this._filter.deleteFilter(t)}_onFilterUpdate(){const t=[];for(const i of this._visible)this._filter.test(i)||(t.push(i),this._visible.remove(i),this._hidden.add(i));this._scene.hide(t);const e=[];for(const i of this._hidden)this._filter.test(i)&&(e.push(i),this._visible.add(i),this._hidden.remove(i));this._scene.show(e)}}class Yt{constructor(t){this._storage=t}add(t){this._storage.add(t)}remove(t){this._storage.delete(t)}show(t){this.add(t)}hide(t){this.remove(t)}}class qt extends Yt{show(t){this._storage.show(t)}hide(t){this._storage.hide(t)}}class Gt{constructor(t){this._scene=t,this._filteringManagers={}}destructor(){}addFilter(t,e){let i=this._filteringManagers[t];if(!i){const e=this._scene[t],r=e instanceof Nt?new qt(e):new Yt(e);i=new Xt(r),this._filteringManagers[t]=i}return i.addFilter(e),this}removeFilter(t,e){const i=this._filteringManagers[t];i&&i.removeFilter(e)}showObject(t){this._showObjectContent(t,t.content),t.onContentAdded.addListener(this._onContentAdded,this),t.onContentRemoved.addListener(this._onContentRemoved,this)}hideObject(t){this._hideObjectContent(t,t.content),t.onContentAdded.removeListener(this._onContentAdded),t.onContentRemoved.removeListener(this._onContentRemoved)}_showObjectContent(t,e){for(const i of c(e.primitives)){const t=e.primitives[i];if(t&&t.length>0){const e=this._filteringManagers[i];e?e.addPrimitives(t):this._scene[i].add(t)}}}_hideObjectContent(t,e){for(const i of c(e.primitives)){const t=e.primitives[i];if(t){const e=this._filteringManagers[i];e?e.removePrimitives(t):this._scene[i].delete(t)}}}_onContentAdded(t,e){this._showObjectContent(t,e)}_onContentRemoved(t,e){this._hideObjectContent(t,e)}}class Zt{constructor(t,e,i,r,n,o,a){this._isPaused=!1,this._name=t,this._context=e,this._camera=i,this._registry=r,this._glyphAtlasRegistry=n,this._iconAtlasRegistry=o,this._objectMetadataIndex=a,this.scene=this._scene={0:new jt,1:new jt,2:new jt,3:new jt,4:new Ht(150),5:new Ht(150),6:new Ht(150)},this._contentVisibilityManager=new Gt(this._scene),this.memoryUsage=this._memoryUsage=Object.assign(Object.assign(Object.assign({},this._registry.memoryUsage),this._glyphAtlasRegistry.memoryUsage),this._iconAtlasRegistry.memoryUsage),this.onMemoryUsageChanged=this._onMemoryUsageChanged=new s}get isPaused(){return this._isPaused}getObjectMetadata(t){return this._objectMetadataIndex.getMetadata(t)}pause(){this._isPaused=!0}resume(){this._isPaused=!1}_createAdditionalMetadata(){return new Map([[Lt+"layerName",this._name]])}_onMemoryUsageComponentChange(t){Object.assign(this._memoryUsage,t),this._onMemoryUsageChanged.fire(this._memoryUsage)}}class Kt extends Zt{constructor(t,e,i,r,s,o){const a=Object.assign({dpr:nt()},r),l=new n(t),h=new U(l.getCommunicator(1)),c=new Ct(l.getCommunicator(2));super(s,i,e,new V(l.getCommunicator(4),i),new yt(l.getCommunicator(5),a,i),new zt(l.getCommunicator(6),a,i),new Et([h,c])),this._options=a,this._commutator=l,this._storage=h,this._modelStorage=c,this._viewport=new S(this._commutator.getCommunicator(0),e,this._options),this._tileContentManager=new v(this._commutator.getCommunicator(3),this._storage,this._modelStorage,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options,this._createAdditionalMetadata()),this._contentVisibilityManager.addFilter(4,new Ot(e)).addFilter(5,new Ot(e)).addFilter(6,new Ot(e)),this.visibilityManager=this._visibilityManager=new st(this._viewport,this._storage,this._contentVisibilityManager,new kt(this._contentVisibilityManager,this._modelStorage),o,s),this._metricsCollector=new Bt(o,s,e,this._storage,this._tileContentManager,this._viewport,et),this._tileGeneration=0,this._recalculateViewport(),window.addEventListener("beforeunload",()=>this._submitMetrics())}destructor(){this._viewport.destructor(),this._metricsCollector.destructor(),this._storage.destructor(),this._modelStorage.destructor(),this._tileContentManager.destructor(),this._visibilityManager.destructor(),this._contentVisibilityManager.destructor(),this._registry.destructor(),this._glyphAtlasRegistry.destructor(),this._objectMetadataIndex.destructor(),this._commutator.destructor()}get renderOptions(){return this._options}pause(){this._viewport.pause(),super.pause()}resume(){this._viewport.resume(),super.resume()}updateTileUrlTemplate(t){this._tileContentManager.updateOption("tileUrlTemplate",t),this._tileGeneration++,this._recalculateViewport()}setMapMode(t){t!==this._tileContentManager.getOption("mapMode")&&(this._tileContentManager.updateOption("mapMode",t),this._recalculateViewport())}updateCustomizationConfig(t){this._tileContentManager.updateCustomizationConfig(t),this._tileGeneration++,this._recalculateViewport()}addVisibilityFilter(t,e){return this._contentVisibilityManager.addFilter(t,e),this}removeVisibilityFilter(t,e){return this._contentVisibilityManager.removeFilter(t,e),this}_recalculateViewport(){this._viewport.tileIdPrefix=this._getTileIdPrefix(),this._viewport.forceCameraStateRecalculation()}_getTileIdPrefix(){return(1===this._tileContentManager.getOption("mapMode")?"night_":"")+this._tileGeneration.toString()}_submitMetrics(){this._metricsCollector.submit(),this._visibilityManager.submitMetrics()}}class Qt{constructor(t,e,i,r){if(this.id=t,0===e.length)throw new Error("No levels provided for a plan");this.levels=e;const n=this._selectLevelById(e,i);if(!n)throw new Error("Cannot find default level");this.defaultLevel=this._activeLevel=n,this.bbox=r,this.onActiveLevelChange=this._onActiveLevelChange=new s,this.onVisibilityChange=this._onVisibilityChange=new s,this.onOpacityChange=this._onOpacityChange=new s,this._isVisible=!1,this._opacity=1}get activeLevel(){return this._activeLevel}setActiveLevel(t){const e=this._selectLevelById(this.levels,t);if(e&&e!==this._activeLevel){const t=this._activeLevel;this._activeLevel=e,this._onActiveLevelChange.fire({previousLevel:t,currentLevel:e},this)}}get isVisible(){return this._isVisible}set isVisible(t){t!==this._isVisible&&(this._isVisible=t,this._onVisibilityChange.fire(t,this))}get opacity(){return this._opacity}set opacity(t){t!==this._opacity&&(this._opacity=t,this._onOpacityChange.fire(t,this))}_selectLevelById(t,e){return t.find(t=>t.id===e)}}var Jt;!function(t){t[t.SETUP=0]="SETUP",t[t.ADD=1]="ADD",t[t.DESTROY=2]="DESTROY"}(Jt||(Jt={}));class $t{constructor(t,e){this._communicator=t,this._plans=new Map,this.onPlanAdded=this._onPlanAdded=new s,this.onPlanRemoved=this._onPlanRemoved=new s,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:Jt.SETUP,options:e},!0)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}getPlan(t){return this._plans.get(t)}getAllPlans(){return[...this._plans.values()]}_onMessage(t){switch(t.type){case Jt.ADD:this._onAdd(t);break;case Jt.DESTROY:this._onDestroy(t)}}_onAdd(t){const{planId:e,levels:i,defaultLevelId:r,boundary:s}=t,n=new Qt(e,i,r,s);this._plans.set(e,n),this._onPlanAdded.fire(n)}_onDestroy(t){const e=this._plans.get(t.planId);o(e)&&(this._plans.delete(t.planId),this._onPlanRemoved.fire(e))}}class te{constructor(t){this._planRegistry=t,this.onUpdate=this._onUpdate=new s,this._metaKey=Symbol(),this._currentVersion=0,this._onPlanAdded=this._onPlanAdded.bind(this),this._onPlanRemoved=this._onPlanRemoved.bind(this),this._onPlanVisibilityChange=this._onPlanVisibilityChange.bind(this),this._onPlanLevelChange=this._onPlanLevelChange.bind(this),this._planRegistry.onPlanAdded.addListener(this._onPlanAdded,this),this._planRegistry.onPlanRemoved.addListener(this._onPlanRemoved,this)}destructor(){this._planRegistry.onPlanRemoved.removeListener(this._onPlanRemoved),this._planRegistry.onPlanAdded.removeListener(this._onPlanAdded),this._planRegistry.getAllPlans().forEach(t=>{t.onActiveLevelChange.removeListener(this._onPlanLevelChange),t.onVisibilityChange.removeListener(this._onPlanVisibilityChange)})}test(t){const e=t[this._metaKey];if(e&&e.version===this._currentVersion)return e.result;const i=this._test(t);return e?e.result=i:t[this._metaKey]={version:this._currentVersion,result:i},i}_test(t){if(!t.metadata)return!1;const e=t.metadata.get("indoor_plan_id");if(!e)return!1;const i=e&&this._planRegistry.getPlan(e);if(!i)return!1;const r=t.metadata.get("indoor_level_id");return!!r&&i.isVisible&&i.activeLevel.id===r}_onPlanAdded(t){t.onVisibilityChange.addListener(this._onPlanVisibilityChange),t.onActiveLevelChange.addListener(this._onPlanLevelChange),t.isVisible&&this._fireUpdate()}_onPlanRemoved(t){t.isVisible&&this._fireUpdate(),t.onActiveLevelChange.removeListener(this._onPlanLevelChange),t.onVisibilityChange.removeListener(this._onPlanVisibilityChange)}_onPlanVisibilityChange(){this._fireUpdate()}_onPlanLevelChange(t,e){e.isVisible&&this._fireUpdate()}_fireUpdate(){this._currentVersion++,this._onUpdate.fire()}}function ee(t,e,i){return{x:t,y:e,z:i}}new Array(9);const ie=ee(0,0,0),re=(ee(1,0,0),ee(-1,0,0),ee(0,1,0)),se=(ee(0,-1,0),ee(0,0,1));function ne(t,e=ee(0,0,0)){return e.x=t.x,e.y=t.y,e.z=t.z,e}function oe(t,e,i=ee(0,0,0)){return i.x=t.x*e.x,i.y=t.y*e.y,i.z=t.z*e.z,i}function ae(t,e,i=ee(0,0,0)){return i.x=t.x*e,i.y=t.y*e,i.z=t.z*e,i}function le(t,e=ee(0,0,0)){return function(t,e,i=ee(0,0,0)){return i.x=t.x/e,i.y=t.y/e,i.z=t.z/e,i}(t,function(t){return Math.hypot(t.x,t.y,t.z)}(t),e)}function he(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}function ce(t,e,i=ee(0,0,0)){const r=t.y*e.z-t.z*e.y,s=t.z*e.x-t.x*e.z,n=t.x*e.y-t.y*e.x;return i.x=r,i.y=s,i.z=n,i}function de(t,e,i=ee(0,0,0)){const r=Math.cos(e),s=Math.sin(e),n=t.y;return i.x=t.x,i.y=n*r-t.z*s,i.z=n*s+t.z*r,i}function ue(t,e,i=ee(0,0,0)){const r=Math.cos(e),s=Math.sin(e);return t=t===i?ne(t):t,i.x=t.x*r-t.y*s,i.y=t.x*s+t.y*r,i.z=t.z,i}ee(0,0,-1);const fe={normal:se,distance:0};function _e(t,e,i=ee(0,0,0)){const r=he(e.direction,t.normal);if(0===r)return null;const s=(t.distance-he(t.normal,e.origin))/r;return s<0?null:(ne(e.direction,i),ae(i,s,i),function(t,e,i=ee(0,0,0)){i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z}(i,e.origin,i),i)}const pe=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function me(){return new Array(16)}function ge(t,e=me()){for(let i=0;i<16;++i)e[i]=t[i];return e}const ye=ge(pe);function ve(t,e,i=me()){for(let r=0;r<16;r+=4){const s=t[r],n=t[r+1],o=t[r+2],a=t[r+3];for(let t=0;t<4;++t)i[r+t]=s*e[t]+n*e[4+t]+o*e[8+t]+a*e[12+t]}return i}function xe(t,e=me()){for(let i=0;i<4;i++)for(let r=i;r<4;r++){const s=t[4*i+r];e[4*i+r]=t[4*r+i],e[4*r+i]=s}return e}function be(t,e){return e?ve(t,e):t}function we(t){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,t]}function Ae(t){const{color:e,lightness:i,opacity:r,saturation:s}=t;if(void 0!==e){const t=function({r:t,g:e,b:i,a:r}){return[0,0,0,t,0,0,0,e,0,0,0,i,0,0,0,r]}(e);return xe(t,t)}let n;return void 0!==i&&(n=be(function(t){const e=1-Math.abs(t),i=Math.max(0,t);return[e,0,0,i,0,e,0,i,0,0,e,i,0,0,0,1]}(i),n)),void 0!==s&&(n=be(function(t){const e=.2125*(1-t),i=.7154*(1-t),r=.0721*(1-t);return[e+t,i,r,0,e,i+t,r,0,e,i,r+t,0,0,0,0,1]}(s+1),n)),void 0!==r&&(n=be(we(r),n)),n?xe(n,n):ge(pe)}class Pe{constructor(){this._plans=new Map,this.onTransformChanged=this._onTransformChanged=new s}destructor(){for(const{plan:t}of this._plans.values())this.removePlan(t)}addPlan(t){t.onOpacityChange.addListener(this._onOpacityChanged,this),this._plans.set(t.id,{plan:t,transform:Ae({opacity:t.opacity})})}removePlan(t){t.onOpacityChange.removeListener(this._onOpacityChanged),this._plans.delete(t.id)}get(t){var e,i;const r=null===(e=t.metadata)||void 0===e?void 0:e.get("indoor_plan_id");return r?null===(i=this._plans.get(r))||void 0===i?void 0:i.transform:void 0}_onOpacityChanged(t,e){const i=this._plans.get(e.id);o(i)&&(i.transform=we(t)),this._onTransformChanged.fire()}}class Te extends Kt{constructor(t,e,i,r,n,o){super(t,e,i,r,"indoor",n),this._planRegistry=new $t(this._commutator.getCommunicator(7),this._options),this._planRegistry.onPlanAdded.addListener(this._onPlanAdded,this),this._planRegistry.onPlanRemoved.addListener(this._onPlanRemoved,this),this._applyContentVisibilityFilters(),this._colorTransformProvider=this.colorTransformProvider=new Pe,this._coveredByIndoorFilter=this.coveredByIndoorFilter=o,this._coveredByIndoorFilter.activate(),this.onPlansChanged=this._onPlansChanged=new s}destructor(){this._planRegistry&&(this._planRegistry.onPlanRemoved.removeListener(this._onPlanRemoved),this._planRegistry.onPlanAdded.removeListener(this._onPlanAdded),this._planRegistry.destructor()),this._coveredByIndoorFilter.deactivate(),this._colorTransformProvider.destructor(),super.destructor()}pause(){this._coveredByIndoorFilter.deactivate(),super.pause()}resume(){super.resume(),this._coveredByIndoorFilter.activate()}get plans(){return this._planRegistry.getAllPlans()}_applyContentVisibilityFilters(){const t=new te(this._planRegistry);this._contentVisibilityManager.addFilter(3,t).addFilter(0,t).addFilter(1,t).addFilter(4,t).addFilter(5,t).addFilter(6,t)}_onPlanAdded(t){this._colorTransformProvider.addPlan(t),this._onPlansChanged.fire(this._planRegistry.getAllPlans())}_onPlanRemoved(t){this._colorTransformProvider.removePlan(t),this._onPlansChanged.fire(this._planRegistry.getAllPlans())}}class Se{constructor(){this._isActive=!1,this.onUpdate=this._onUpdate=new s}activate(){this._isActive=!0,this._onUpdate.fire()}deactivate(){this._isActive=!1,this._onUpdate.fire()}test(t){return!(this._isActive&&t.metadata&&"true"===t.metadata.get("indoor_covered"))}}class Re extends E{constructor(t,e){super({primitives:{},references:[]}),this.id=t,this.bbox=e}}class ze extends z{_deserialize(t){return new Re(t.id,t.bbox)}}class Me extends y{constructor(t,e,i,r,n,o,a){super(i,r,n,a),this._communicator=t,this._options=o,this._storage=e,this._onContentAdded=this.onContentAdded=new s,this._communicator.onMessage.addListener(this._onMessage,this),this._communicator.sendMessage({type:0,options:this._options},!1)}destructor(){this._communicator.onMessage.removeListener(this._onMessage)}updateOption(t,e){this._options[t]=e,this._communicator.sendMessage({type:0,options:this._options},!1)}_onMessage(t){switch(t.type){case 2:this._onAddPrimitives(t)}}_onAddPrimitives(t){const e=this._storage.get(t.objectId);if(o(e)){const i=this._instantiatePrimitives(t.content,0);e.addContent(i),this._onContentAdded.fire(e,i)}}}class Ce{constructor(t,e,i){this._camera=t,this._storage=e,this._contentVisibilityManager=i,this._visibleObjects=new Map,this._cameraArea=this._camera.getVisibleRegionBBox(),this._camera.onUpdate.addListener(this._onCameraChanged,this),this._storage.onAdded.addListener(this._onObjectAdded,this),this._storage.onRemoved.addListener(this._onObjectRemoved,this)}destructor(){this._camera.onUpdate.removeListener(this._onCameraChanged),this._storage.onAdded.removeListener(this._onObjectAdded),this._storage.onRemoved.removeListener(this._onObjectRemoved)}_onCameraChanged(){for(const t of this._storage.items)this._updateObjectVisibility(t)}_onObjectAdded(t){this._updateObjectVisibility(t)}_onObjectRemoved(t){this._visibleObjects.has(t.id)&&(this._visibleObjects.delete(t.id),this._contentVisibilityManager.hideObject(t))}_updateObjectVisibility(t){!function(t,e){let i,r,s,n;return t.minX<e.minX?(i=t,r=e):(i=e,r=t),t.maxY>e.maxY?(s=t,n=e):(s=e,n=t),r.minX<i.maxX&&n.maxY>s.minY}(this._cameraArea,t.bbox)?this._visibleObjects.has(t.id)&&(this._visibleObjects.delete(t.id),this._contentVisibilityManager.hideObject(t)):this._visibleObjects.has(t.id)||(this._visibleObjects.set(t.id,t),this._contentVisibilityManager.showObject(t))}}class ke{constructor(t,e,i){this._camera=e,this._communicator=t,this._storage=i,this._isActive=!1,this._onCameraUpdateDebounced=Ft(this._onCameraUpdate.bind(this),5e3),this._onUpdateInStorage()}destructor(){this._pause()}_pause(){this._isActive&&(this._camera.onUpdate.removeListener(this._onCameraUpdateDebounced),this._isActive=!1)}_resume(){this._isActive||(this._camera.onUpdate.addListener(this._onCameraUpdateDebounced,this),this._isActive=!0)}_onCameraUpdate(){this._communicator.sendMessage({type:0,viewportBBox:this._camera.getVisibleRegionBBox()},!0)}_onUpdateInStorage(){0===this._storage.size?this._pause():this._resume()}}class Be extends Zt{constructor(t,e,i,r,s){const o=new n(r),a=Object.assign({dpr:nt()},s),l=new ze(o.getCommunicator(2));super(t,e,i,new V(o.getCommunicator(3),e),new yt(o.getCommunicator(5),a,e),new zt(o.getCommunicator(4),a,e),new Et([l])),this._options=a,this._commutator=o,this._communicator=this._commutator.getCommunicator(0),this._storage=l,this._geoContentManager=new Me(this._commutator.getCommunicator(1),this._storage,this._registry,this._glyphAtlasRegistry,this._iconAtlasRegistry,this._options),this._visibilityManager=new Ce(this._camera,this._storage,this._contentVisibilityManager),this._gc=new ke(this._commutator.getCommunicator(6),this._camera,this._storage),this._onCameraChanged(),this._onCameraChanged=Ft(this._onCameraChanged.bind(this),500),this._camera.onUpdate.addListener(this._onCameraChanged)}destructor(){this._camera.onUpdate.removeListener(this._onCameraChanged),this._storage.destructor(),this._geoContentManager.destructor(),this._visibilityManager.destructor(),this._gc.destructor(),this._commutator.destructor()}get renderOptions(){return this._options}_onCameraChanged(){const t=this._camera.center;this._communicator.sendMessage({type:0,center:ot(t.x,t.y),zoom:this._camera.zoom},!0)}}class Ie{constructor(t){this._addressee=t,this._messageQueue=[],this._transferableQueue=[],this._listeners=[]}addMessage(t,e=[]){this._messageQueue.push(t),this._transferableQueue.push(...e)}onMessage(t){this._listeners.push(t)}flushMessages(){0!==this._messageQueue.length&&this._addressee.postMessage(this._messageQueue,this._transferableQueue),this._messageQueue.length=0,this._transferableQueue.length=0}listen(){this._addressee.onmessage=({data:t})=>{for(const e of t)for(const t of this._listeners)t(e)}}}class Oe extends Ie{constructor(t){const e="function"==typeof t?t():new Worker(t);super(e),this._worker=e,this.listen()}destroy(){this._worker.terminate()}}class Ee{constructor(t){this._worker=t,this._scheduledFlush=Vt(()=>t.flushMessages()),this.onMessage=this._onMessage=new s,t.onMessage(t=>{this._onMessage.fire(t)})}sendMessage(t,e,...i){this._worker.addMessage(t,i),e&&this._scheduledFlush()}}class Le{constructor(t,e,i,r){this._metrics=new tt(r,"vector.map.content_provider"),this._metrics.mark("workerInitialized");const o=new Oe(t);this._context=i,this._camera=e,this._metricsTransport=r,this._commutator=new n(new Ee(o)),this._communicator=this._commutator.getCommunicator(0),this.onMemoryUsageChanged=this._onMemoryUsageChanged=new s,this._contentProviders=[],this._coveredByIndoorFilter=new Se,this._currentProviderId=1,this._communicator.onMessage.addListener(this._onMessage,this),window.addEventListener("beforeunload",()=>this._metrics.submit())}get coveredByIndoorFilter(){return this._coveredByIndoorFilter}initContentProvider(t,e){var i;const r=null===(i=this._contentProviders.find(e=>e.name===t))||void 0===i?void 0:i.provider;if(r)return r.isPaused?r.resume():console.warn("initializing already initialized and running content provider"),r;const s=this._currentProviderId++;let n;return this._communicator.sendMessage({type:0,id:s,name:t,options:e},!1),n="indoor"===t?new Te(this._commutator.getCommunicator(s),this._camera,this._context,e,this._metricsTransport,this._coveredByIndoorFilter):new Kt(this._commutator.getCommunicator(s),this._camera,this._context,e,t,this._metricsTransport),this._contentProviders.push({id:s,name:t,provider:n}),n}initGeoContentProvider(t,e){const i=this._currentProviderId++;return this._communicator.sendMessage({type:1,id:i,name:t,options:e},!1),new Be(t,this._context,this._camera,this._commutator.getCommunicator(i),e)}getObjectMetadata(t){for(const e of this._contentProviders){if(!e)continue;const i=e.provider.getObjectMetadata(t);if(i)return i}}destroyContentProvider(t){const e=this._contentProviders.findIndex(e=>e.provider===t);if(-1!==e){const i=this._contentProviders[e];t.destructor(),this._communicator.sendMessage({type:2,id:i.id},!1),this._contentProviders.splice(e,1)}}_onMessage(t){switch(t.type){case 3:this._onWorkerInitialized()}}_onWorkerInitialized(){this._metrics.putMeasuredValue("workerInitialized")}_onMemoryUsageInContentProviderChanged(){const t={};t.total=this._computeTotalMemoryUsage();for(const{name:e,provider:i}of this._contentProviders)t[e]=i.memoryUsage;this._onMemoryUsageChanged.fire(t)}_computeTotalMemoryUsage(){const t=this._contentProviders;return{memoryForBuffers:t.reduce((t,{provider:e})=>t+e.memoryUsage.memoryForBuffers,0),memoryForVertices:t.reduce((t,{provider:e})=>t+e.memoryUsage.memoryForVertices,0),memoryForIndices:t.reduce((t,{provider:e})=>t+e.memoryUsage.memoryForIndices,0),memoryForGlyphs:t.reduce((t,{provider:e})=>t+e.memoryUsage.memoryForGlyphs,0),memoryForIcons:t.reduce((t,{provider:e})=>t+e.memoryUsage.memoryForIcons,0)}}}var Ue=i(10),De=i.n(Ue);class Fe extends class{constructor(){this._listeners=new Set}addListener(t){this._listeners.add(t)}removeListener(t){this._listeners.delete(t)}fire(t){this._listeners.forEach(e=>{e(t)})}}{fire(){super.fire(void 0)}}class Ve extends class{constructor(t=256,e=256){this.onContentUpdate=new Fe,this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this._canvasContext=this.canvas.getContext("2d"),this._allocator=new Rt(this.width,this.height)}get width(){return this.canvas.width}get height(){return this.canvas.height}allocateImage(t,e){const i=this._allocate(t);if(i){const r=ut(0,t.width,0,t.height);this.updateImage(i,e,r,r)}return i}reserveLocation(t){return this._allocate(t)}updateImage(t,e,i=ut(0,t.maxX-t.minX,0,t.maxY-t.minY),r=ut(0,e.width,0,e.height)){const s=r.minX,n=r.minY,o=r.maxX-r.minX,a=r.maxY-r.minY,l=t.minX+i.minX,h=t.minY+i.minY,c=i.maxX-i.minX,d=i.maxY-i.minY;this._canvasContext.clearRect(l,h,c,d),this._canvasContext.drawImage(e,s,n,o,a,l,h,c,d),this.onContentUpdate.fire()}removeImage(t){this._allocator.deallocate(t)}_allocate(t){let e=this._allocator.allocate(t);for(;!e;){const i=2*this.width,r=2*this.height;if(!(i<=2048&&r<=2048))break;this._expand(i,r),e=this._allocator.allocate(t)}return e}_expand(t,e){this._allocator.resize(t,e);const i=this._canvasContext.getImageData(0,0,this.width,this.height);this.canvas.width=t,this.canvas.height=e,this._canvasContext.putImageData(i,0,0)}}{constructor(t,e){super();const{filter:i,premultipliedAlpha:r}=e;this._context=t,this._filter=i,this._premultipliedAlpha=r,this.texture=this._createTexture(this.width,this.height,i,r),this.isDirty=!1}syncTexture(){this._context.setTextureDataFromDomElement(this.texture,this.canvas),this.isDirty=!1}updateImage(t,e,i,r){super.updateImage(t,e,i,r),this.isDirty=!0}destroy(){this.texture.destroy()}_expand(t,e){super._expand(t,e),this.texture.destroy(),this.texture=this._createTexture(this.width,this.height,this._filter,this._premultipliedAlpha),this.isDirty=!0}_createTexture(t,e,i,r){return this._context.createEmpty2DTexture(t,e,6408,5121,{minificationFilter:i,magnificationFilter:i,wrapS:33071,wrapT:33071,premultipliedAlpha:r})}}Ne(0,0,0,1);const je=Ne(1,1,0,1);function Ne(t,e,i,r=1){return{r:t,g:e,b:i,a:r}}Ne(0,0,0,0);const He={blend:!0,blendFuncSrcRgb:770,blendFuncDstRgb:771,blendFuncSrcAlpha:1,blendFuncDstAlpha:771},We={blend:!0,blendFuncSrcRgb:1,blendFuncDstRgb:771,blendFuncSrcAlpha:1,blendFuncDstAlpha:771},Xe={depthTest:!0,depthFunc:518};class Ye{constructor(...t){this.clearColor=Ne(0,0,0,0),this.clearDepth=1,this.clearStencil=0,this.colorMaskR=!0,this.colorMaskG=!0,this.colorMaskB=!0,this.colorMaskAlpha=!0,this.blend=!1,this.blendEquationRgb=32774,this.blendEquationAlpha=32774,this.blendFuncSrcRgb=1,this.blendFuncDstRgb=0,this.blendFuncSrcAlpha=1,this.blendFuncDstAlpha=0,this.cullFace=!1,this.cullFaceMode=1029,this.frontFaceMode=2305,this.depthTest=!1,this.depthFunc=513,this.depthRangeNear=0,this.depthRangeFar=1,this.depthMask=!0,this.dither=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.sampleAlphaToCoverage=!1,this.sampleCoverage=!1,this.sampleCoverageValue=1,this.sampleCoverageInvert=!1,this.scissorTest=!1,this.scissorX=0,this.scissorY=0,this.scissorWidth=-1,this.scissorHeight=-1,this.stencilTest=!1,this.stencilReference=0,this.stencilMask=255,this.stencilWriteMask=255,this.stencilFrontFunc=519,this.stencilFrontFailOp=7680,this.stencilFrontDepthFailOp=7680,this.stencilFrontDepthPassOp=7680,this.stencilBackFunc=519,this.stencilBackFailOp=7680,this.stencilBackDepthFailOp=7680,this.stencilBackDepthPassOp=7680,this.viewportX=0,this.viewportY=0,this.viewportWidth=-1,this.viewportHeight=-1,Object.assign(this,...t)}}function qe(t,e=4){let i=0;return{attributes:[...j(t,([t,{type:r,size:s,normalized:n}])=>{const o=[t,{type:r,size:s,normalized:n,offset:i}],a=s*function(t){switch(r){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4}}(),l=function(t,e){return(i+a-1&e)-e}(0,-e);return i=l,o})],vertexByteSize:i}}function Ge(t){return 65535*t|0}function Ze(t){return 4294967295*t|0}function*Ke(t){for(let e=2;e<t;++e)yield 0,yield e-1,yield e}function*Qe(t){yield 0,yield 1,yield 2;let e=1,i=2;for(let r=3;r<t;++r){yield r-e,yield r-i,yield r;const t=e;e=i,i=t}}class Je{constructor(t){this._nextWordOffset=0,this._initBuffers(t)}get isFull(){return this._nextWordOffset>=this._uint32View.length}get occupiedSize(){return this._nextWordOffset}get byteSize(){return this._uint32View.byteLength}extend(t){const e=this._uint32View;this._initBuffers(t),this._uint32View.set(e)}pushUint32(t){this._uint32View[this._nextWordOffset++]=t}pushFloat32(t){this._float32View[this._nextWordOffset++]=t}asUint32Array(){return this._uint32View.subarray(0,this.occupiedSize)}_initBuffers(t){const e=new ArrayBuffer(t);this._uint32View=new Uint32Array(e),this._float32View=new Float32Array(e)}static transferDataTail(t,e,i,r=0){const s=t.occupiedSize-i,n=t._uint32View.subarray(i,t.occupiedSize);e._uint32View.set(n,r),e._nextWordOffset=s,t._nextWordOffset=i}}class $e{constructor(t){this._nextIndexOffset=0,this._uint16View=new Uint16Array(t)}get occupiedSize(){return this._nextIndexOffset}get size(){return this._uint16View.length}extend(t){const e=this._uint16View;this._uint16View=new Uint16Array(t),this._uint16View.set(e)}push(t){this._uint16View[this._nextIndexOffset++]=t}asUint16Array(){return new Uint16Array(this._uint16View.buffer,0,this.occupiedSize)}static transferDataTail(t,e,i,r,s=0){for(let n=r,o=s;n<t.occupiedSize;n++,o++)e._uint16View[o]=t._uint16View[n]-i;e._nextIndexOffset=t.occupiedSize-r,t._nextIndexOffset=r}}class ti{constructor(t,e=1024,i=65536,r=3072){this._vertexByteSize=t,this._initVertexBufferByteSize=t*e,this._maxVertexBufferByteSize=t*i,this._initIndexBufferUint16Size=r,this._vertexBuffer=new Je(this._initVertexBufferByteSize),this._vertexBuffers=[this._vertexBuffer],this._indexBuffer=new $e(this._initIndexBufferUint16Size),this._indexBuffers=[this._indexBuffer],this._currentMeshVertexOffset=0,this._currentMeshIndexOffset=0,this._currentMeshBaseIndex=0}writeIndices(t){this._ensureEnoughIndexBufferSpace(t.length);const e=this._indexBuffer,i=this._currentMeshBaseIndex;for(let r=0;r<t.length;++r)e.push(i+t[r])}writeIndicesForStrip(t){this._ensureEnoughIndexBufferSpace(3*(t.length-2));const e=this._indexBuffer,i=this._currentMeshBaseIndex;for(const r of Qe(t.length))e.push(i+t[r])}writeIndicesForContinuousStrip(t,e=0){this._ensureEnoughIndexBufferSpace(3*(t-2));const i=this._indexBuffer,r=this._currentMeshBaseIndex+e;for(const s of Qe(t))i.push(r+s)}writeIndicesForFan(t){this._ensureEnoughIndexBufferSpace(3*(t.length-2));const e=this._indexBuffer,i=this._currentMeshBaseIndex;for(const r of Ke(t.length))e.push(i+t[r])}writeIndicesForContinuousFan(t,e=0){this._ensureEnoughIndexBufferSpace(3*(t-2));const i=this._indexBuffer,r=e+this._currentMeshBaseIndex;for(const s of Ke(t))i.push(r+s)}endMesh(){const t=this._currentMeshVertexOffset,e=this._vertexBuffer.occupiedSize;this._currentMeshVertexOffset=e,this._currentMeshBaseIndex=(e<<2)/this._vertexByteSize;const i=this._currentMeshIndexOffset,r=this._indexBuffer.occupiedSize;return this._currentMeshIndexOffset=r,{vertexByteOffset:t<<2,vertexByteLength:e-t<<2,indexByteOffset:i<<1,indexByteLength:r-i<<1,bufferIndex:this._vertexBuffers.length-1}}getBuffers(){return function(t,e,i=((t,e)=>[t,e])){const r=Math.min(t.length,e.length),s=new Array(r);for(let n=0;n<r;++n)s[n]=i(t[n],e[n]);return s}(this._vertexBuffers,this._indexBuffers,(t,e)=>({vertexBuffer:t.asUint32Array(),indexBuffer:e.asUint16Array()}))}getCurrentVertexBufferByteOffset(){return this._vertexBuffer.occupiedSize<<2}getCurrentVertexIdx(){return((this._vertexBuffer.occupiedSize<<2)/this._vertexByteSize|0)-this._currentMeshBaseIndex}_writeFloat32(t){this._ensureEnoughVertexBufferSpace(),this._vertexBuffer.pushFloat32(t)}_writeWord(t){this._ensureEnoughVertexBufferSpace(),this._vertexBuffer.pushUint32(t)}_writeHalfWords(t,e){this._writeWord(e<<16|65535&t)}_writeBytes(t,e,i,r){this._writeWord(r<<24|(255&i)<<16|(255&e)<<8|255&t)}_writeWorldCoordinate(t){const e=Ze(.5*(t.x+1)),i=Ze(.5*(t.y+1));this._writeHalfWords(e>>>16,i>>>16),this._writeHalfWords(e,i)}_getNextVertexBufferByteSize(t){return t<<1}_getNextIndexBufferUint16Size(t){return t<<1}_ensureEnoughVertexBufferSpace(){const t=this._vertexBuffer;if(!t.isFull)return;if(t.byteSize<this._maxVertexBufferByteSize)return void this._vertexBuffer.extend(this._getNextVertexBufferByteSize(t.byteSize));const e=this._currentMeshVertexOffset,i=4*(t.occupiedSize-e);if(i===this._maxVertexBufferByteSize)throw new Error("Mesh is too big to fit in.");let r=this._initVertexBufferByteSize;for(;r<=i;)r=this._getNextVertexBufferByteSize(r);const s=new Je(r);Je.transferDataTail(t,s,e),this._vertexBuffer=s,this._vertexBuffers.push(s),this._currentMeshVertexOffset=0;const n=this._indexBuffer,o=this._currentMeshIndexOffset,a=n.occupiedSize-o;let l=this._initIndexBufferUint16Size;for(;l<=a;)l=this._getNextIndexBufferUint16Size(l);const h=new $e(l);$e.transferDataTail(n,h,this._currentMeshBaseIndex,o),this._currentMeshBaseIndex=0,this._currentMeshIndexOffset=0,this._indexBuffer=h,this._indexBuffers.push(h)}_ensureEnoughIndexBufferSpace(t){const e=this._indexBuffer,i=e.occupiedSize+t;if(i<=e.size)return;let r=e.size;for(;i>r;)r=this._getNextIndexBufferUint16Size(r);this._indexBuffer.extend(r)}}const ei=qe([[0,{size:2,type:5123,normalized:!0}]]);class ii extends ti{constructor(t,e){const i=t*e;super(ei.vertexByteSize,i,void 0,0);const r=Ge(1/t),s=Ge(1/e),n=s/2;for(let o=0,a=r/2;o<t;o++,a+=r)for(let t=0,i=n;t<e;t++,i+=s)this._writeHalfWords(a,i);this.data=this.getBuffers()[0].vertexBuffer,this.numberOfSamplers=i}}class ri{constructor(t,e,i,r,s){this._context=t,this._renderState=e,this._program=i,this._hitTestRenderState=r,this._hitTestProgram=s}render(t,...e){this._program&&this._prepareProgram(this._program,...e),this._prepareRenderTarget(t,...e),this._render(...e)}renderHitTestBuffer(t,...e){this._hitTestProgram&&(this._prepareHitTestProgram(this._hitTestProgram,...e),this._prepareHitTestTarget(t,...e),this._renderHitTestBuffer(...e))}destroy(){this._program&&this._program.destroy(),this._hitTestProgram&&this._hitTestProgram.destroy()}_prepareProgram(t,...e){this._context.bindProgram(t)}_prepareHitTestProgram(t,...e){this._context.bindProgram(t)}_prepareRenderTarget(t,...e){this._context.bindRenderState(this._renderState),this._context.bindRenderTarget(t)}_prepareHitTestTarget(t,...e){const i=this._context;this._hitTestRenderState&&i.bindRenderState(this._hitTestRenderState),i.bindRenderTarget(t)}_renderHitTestBuffer(...t){}}class si extends ri{constructor(t,e){super(t,e)}get target(){return this._target}get content(){return this._context.bindRenderTarget(this._target),this._target.readPixels()}get size(){return this._target.size}updateGrid(...t){return this.render(this._target,...t),this._texture}_render(t,e,i,r,s,n,o,a,l,h){for(const c of i)c.render(this._target,t,e,this._renderState,r,s,n,o,a,l,h)}setResolution(t,e){this._destroyResources(),this._depthBuffer=this._context.createRenderbuffer(t,e,34041),this._texture=this._context.createEmpty2DTexture(t,e,6408,5121),this._target=this._context.createFramebuffer({color:this._texture,depthStencil:this._depthBuffer})}destroy(){this._destroyResources()}_prepareRenderTarget(t,...e){super._prepareRenderTarget(t,...e),this._context.clearCurrentTarget(16640)}_destroyResources(){this._target&&(this._target.destroy(),this._texture.destroy(),this._depthBuffer.destroy())}}class ni{render(t,e,i){for(const r of e)r.render(t,i)}}class oi{constructor(t){this._mins=new Array(t),this._maxs=new Array(t),this._mins.fill(Number.POSITIVE_INFINITY),this._maxs.fill(Number.NEGATIVE_INFINITY)}updateValue(t,e){this._mins[t]=Math.min(this._mins[t],e),this._maxs[t]=Math.max(this._maxs[t],e)}*values(){const t={min:0,max:0,index:-1};for(let e=0;e<this._mins.length;e++)t.min=this._mins[e],t.max=this._maxs[e],t.index=e,yield t}}function ai(t,e){return Number.isInteger(t)&&e===t?t-1:Math.floor(t)}const li=ot(-1,-1),hi=t=>{const e=lt(t);return function(t,e,i=ot(0,0)){i.x=t.x-e.x,i.y=t.y-e.y}(e,li,e),ct(e,.5,e),e},ci=t=>.5*(t+1)*4294967295,di=t=>Math.trunc(t/65536),ui=t=>65535&t,fi=(t,e)=>t.x-e.x||t.y-e.y,_i=ot(0,0),pi=[],mi=[];function gi(t){const e=t.getVisibleRegion();if(0===function(t,e,i){const r=Math.min(e.length,i.length);for(let s=0;s<r;s++){const r=t(e[s],i[s]);if(r)return r}return e.length-i.length}(fi,pi,e))return mi;const i=[];for(const r of function(t){const e=[],i=ft(t),r=Math.floor(i.minX),s=Math.ceil(i.maxX)-r,n=new oi(s);for(let o=t.length-1,a=0;a<t.length;o=a++){let e=t[o],s=t[a];if(e.x>s.x){const t=e;e=s,s=t}const l=Math.floor(e.x+1),h=Math.ceil(s.x-1),c=(e.y-s.y)/(e.x-s.x);n.updateValue(ai(e.x,i.maxX)-r,ai(e.y,i.maxY)),n.updateValue(ai(s.x,i.maxX)-r,ai(s.y,i.maxY));for(let t=l;t<=h;t++){const s=(isFinite(c)?c*(t-e.x):0)+e.y,o=t-r,a=o-1,l=Math.floor(s);Number.isInteger(s)?s===i.maxY?(n.updateValue(a,l-1),n.updateValue(o,l-1)):c>0?(n.updateValue(a,l-1),n.updateValue(o,l)):c<0&&(n.updateValue(a,l),n.updateValue(o,l-1)):(n.updateValue(a,l),n.updateValue(o,l))}}for(const{min:o,max:a,index:l}of n.values()){const t=r+l;for(let i=o;i<=a;i++)e.push(ot(t,i))}return e}(e.map(hi)))2!==t.options.wrapModeX&&0!==r.x||2!==t.options.wrapModeY&&0!==r.y||(ct(r,-2,_i),ht(t.center,_i,_i),dt(_i,ci,_i),i.push({lookAtHigh:dt(_i,di),lookAtLow:dt(_i,ui)}));k(i,mi),mi.length=i.length,pi.length=e.length;for(let r=0;r<e.length;r++)pi[r]=lt(e[r],pi[r]);return i}var yi=i(11),vi=i.n(yi),xi=i(0),bi=i.n(xi);const wi=new Ye({depthTest:!0,clearDepth:0,depthFunc:516,dither:!1});class Ai extends ri{constructor(t){const e=t.createProgram(vi.a,bi.a,{attribMap:{position:0}});super(t,wi,e),t.bindProgram(e),e.setIntScalarUniform("directPriorityGrid",0),e.setIntScalarUniform("reversePriorityGrid",1)}_prepareProgram(t,e,i,r,s,n){super._prepareProgram(t,e,i,r,s,n),this._context.bindTextureUnit(0),this._context.bindTexture(r),this._context.bindTextureUnit(1),this._context.bindTexture(s),t.setVector2Uniform("idHalfPxSize",n),t.setVector2Uniform("gridHalfPxSize",r.getHalfPxSize())}_render(t,e){this._context.bindVao(t),this._context.drawMesh(0,e,0)}_prepareRenderTarget(t,...e){super._prepareRenderTarget(t,...e),this._context.clearCurrentTarget(256)}}var Pi=i(12),Ti=i.n(Pi),Si=i(13),Ri=i.n(Si);const zi=qe([[0,{size:4,type:5120,normalized:!1}]]);class Mi extends ti{constructor(){super(zi.vertexByteSize,4,4,6),this._writeBytes(-1,-1,0,0),this._writeBytes(-1,1,0,1),this._writeBytes(1,1,1,1),this._writeBytes(1,-1,1,0),this.writeIndicesForFan([0,1,2,3]),this.vertexData=this.getBuffers()[0].vertexBuffer,this.indexData=this.getBuffers()[0].indexBuffer}}const Ci=new Ye({dither:!1});class ki extends ri{constructor(t){const e=t.createProgram(Ti.a,Ri.a,{attribMap:{position:0}});super(t,Ci,e);const i=new Mi;this._idSamplerVertexBuffer=this._context.createVertexBuffer(i.vertexData.byteLength),this._idSamplerIndexBuffer=this._context.createIndexBuffer(i.indexData.byteLength),this._idSamplerVao=this._context.createVao(zi,this._idSamplerVertexBuffer,this._idSamplerIndexBuffer),this._context.uploadDataToBuffer(this._idSamplerVertexBuffer,i.vertexData),this._context.uploadDataToBuffer(this._idSamplerIndexBuffer,i.indexData),t.bindProgram(e),e.setIntScalarUniform("prevVisibility",0),e.setIntScalarUniform("overlaps",1),e.setIntScalarUniform("scene",2)}_prepareProgram(t,e,i,r,s,n,o,a){super._prepareProgram(t,e,i,r,s,n,o,a),this._context.bindTextureUnit(0),this._context.bindTexture(e),this._context.bindTextureUnit(1),this._context.bindTexture(i),this._context.bindTextureUnit(2),this._context.bindTexture(r),t.setScalarUniform("fadeAnimationAmount",s),t.setScalarUniform("currentZoom",n),t.setScalarUniform("currentTilt",o),t.setScalarUniform("currentAzimuth",a)}_render(){this._context.bindVao(this._idSamplerVao),this._context.drawIndexedMesh(0,6,4)}}var Bi=i(14),Ii=i.n(Bi),Oi=i(15),Ei=i.n(Oi);const Li=new Ye({blend:!0,blendFuncSrcRgb:0,blendFuncDstRgb:1,blendFuncSrcAlpha:1,blendFuncDstAlpha:0,dither:!1});class Ui extends ri{constructor(t){const e=t.createProgram(Ii.a,Ei.a,{attribMap:{position:0}});super(t,Li,e);const i=new Mi;this._idSamplerVertexBuffer=this._context.createVertexBuffer(i.vertexData.byteLength),this._idSamplerIndexBuffer=this._context.createIndexBuffer(i.indexData.byteLength),this._idSamplerVao=this._context.createVao(zi,this._idSamplerVertexBuffer,this._idSamplerIndexBuffer),this._context.uploadDataToBuffer(this._idSamplerVertexBuffer,i.vertexData),this._context.uploadDataToBuffer(this._idSamplerIndexBuffer,i.indexData)}_render(){this._context.bindVao(this._idSamplerVao),this._context.drawIndexedMesh(0,6,4)}}const Di=new Ye({clearColor:Ne(0,0,0,0),dither:!1}),Fi=Ne(0,0,0,1),Vi=new Ye({clearColor:Fi,depthTest:!0,clearDepth:-1,depthFunc:518,dither:!1}),ji=new Ye({clearColor:Fi,depthTest:!0,clearDepth:1,depthFunc:513,dither:!1});class Ni{constructor(t,e,i,r,s=150){this.fadeEffectDuration=s,this._context=t,this._camera=e,this._renderLoop=i,this._lastRenderTimeInLoop=-1,this._animationTicksCount=0,this._prevTargetSize={width:0,height:0},this._isEnabled=!0,this._camera.onUpdate.addListener(this._onSceneUpdate,this),this._renderLoop.onBeforeRender.addListener(this._onBeforeRender,this),this._directPriorityGridRenderer=new si(t,Vi),this._reversePriorityGridRenderer=new si(t,ji),this._collidingOffVisibilityTexture=this._createPlainTexture(Ne(1,1,1,1)),this._currentVisibilityTexture=t.createEmpty2DTexture(256,256,6408,5121),this._prevVisibilityTexture=t.createEmpty2DTexture(256,256,6408,5121),this._sceneTexture=t.createEmpty2DTexture(256,256,6408,5121),this._overlapsTexture=t.createEmpty2DTexture(256,256,6408,5121),this._currentVisibilityBuffer=t.createFramebuffer({color:this._currentVisibilityTexture}),this._prevVisibilityBuffer=t.createFramebuffer({color:this._prevVisibilityTexture}),this._sceneBuffer=t.createFramebuffer({color:this._sceneTexture}),this._overlapsBuffer=t.createFramebuffer({color:this._overlapsTexture,depthStencil:t.createRenderbuffer(256,256,34041)}),this._stabilityShift=ee(0,0,0),this._gridHalfPxSizeUniform=ot(0,0),this._idHalfPxSizeUniform=ot(.5/256,.5/256),this._resetRemoved=new ni,this._makeAllOverlapped=new Ui(t),this._findOverlaps=new Ai(t),this._computeVisibility=new ki(t),this._clearVisibility(this._currentVisibilityBuffer),this._clearVisibility(this._overlapsBuffer),this._primitiveProviders=[],this._colorIdRenderers=[],this._resetRemovedRenderers=[],this.setTargetSize(r)}get visibilityTexture(){return this._isEnabled?this._currentVisibilityTexture:this._collidingOffVisibilityTexture}setEnabled(t){this._isEnabled=t,this._renderLoop.update()}setTargetSize(t){const e=3*nt(),i=Math.ceil(t.width/e),r=Math.ceil(t.height/e);this._directPriorityGridRenderer.setResolution(i,r),this._reversePriorityGridRenderer.setResolution(i,r),this._gridSamplerVertexBuffer&&this._destroyGridResources();const s=new ii(i,r),n=this._context;this._gridSamplerVertexBuffer=n.createVertexBuffer(s.data.byteLength),this._gridSamplerVao=n.createVao(ei,this._gridSamplerVertexBuffer,null),this._numberOfGridSamplers=s.numberOfSamplers,this._context.uploadDataToBuffer(this._gridSamplerVertexBuffer,s.data),pt(t,this._prevTargetSize),this._gridHalfPxSizeUniform.x=.5/i,this._gridHalfPxSizeUniform.y=.5/r}updateVisibilityIfNeeded(){if(!this._isEnabled||!this._isDirty)return;this._isDirty=!1;const t=this._stabilityShift;lt(this._camera.center,t),t.z=0,function(t,e,i=ee(0,0,0)){const r=t[3]*e.x+t[7]*e.y+t[11]*e.z+t[15],s=(t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12])/r,n=(t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13])/r,o=(t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14])/r;i.x=s,i.y=n,i.z=o}(this._camera.getViewProjMatrix(),t,t),t.x%=4*this._gridHalfPxSizeUniform.x,t.y%=4*this._gridHalfPxSizeUniform.y;const e=this._currentVisibilityTexture,i=this._currentVisibilityBuffer,r=this._prevVisibilityTexture,s=this._prevVisibilityBuffer,n=this._overlapsTexture,o=this._overlapsBuffer,a=this._sceneTexture,l=this._sceneBuffer;this._currentVisibilityBuffer=s,this._currentVisibilityTexture=r,this._prevVisibilityBuffer=i,this._prevVisibilityTexture=e,this._clearVisibility(s),this._clearVisibility(l),this._resetRemoved.render(l,this._resetRemovedRenderers,this._idHalfPxSizeUniform);const h=this._camera.zoom/this._camera.options.maxZoom,c=this._camera.tilt,d=this._camera.azimuth/(2*Math.PI),u=this._camera.getViewProjMatrix(),f=gi(this._camera),_=this._directPriorityGridRenderer.updateGrid(u,f,this._colorIdRenderers,t,e,n,a,h,c,d),p=this._reversePriorityGridRenderer.updateGrid(u,f,this._colorIdRenderers,t,e,n,a,h,c,d),m=K(),g=this._lastRenderTimeInLoop,y=-1!==g,v=m-this._lastSceneUpdateTime>this.fadeEffectDuration||y&&m-g>this.fadeEffectDuration,x=v?1:y?(m-g)/this.fadeEffectDuration:(m-this._lastSceneUpdateTime)/this.fadeEffectDuration;this._animationTicksCount++;const b=this._idHalfPxSizeUniform,w=this._gridSamplerVao,A=this._numberOfGridSamplers;this._makeAllOverlapped.render(o),this._findOverlaps.render(o,w,A,_,p,b),this._computeVisibility.render(s,e,n,a,x,h,c,d),v&&this._animationTicksCount>1?this._lastRenderTimeInLoop=-1:(this._renderLoop.update(),this._lastRenderTimeInLoop=m)}registerCollidingPrimitives(t,e,i){this._primitiveProviders.push(t),this._colorIdRenderers.push(e),this._resetRemovedRenderers.push(i),t.onUpdate.addListener(this._onSceneUpdate,this)}deregisterCollidingPrimitives(t,e,i){let r=this._primitiveProviders.indexOf(t);r>-1&&this._primitiveProviders.splice(r,1),(r=this._colorIdRenderers.indexOf(e))>-1&&this._colorIdRenderers.splice(r,1),(r=this._resetRemovedRenderers.indexOf(i))>-1&&this._resetRemovedRenderers.splice(r,1),t.onUpdate.removeListener(this._onSceneUpdate)}destroy(){this._destroyGridResources(),this._directPriorityGridRenderer.destroy(),this._reversePriorityGridRenderer.destroy(),this._camera.onUpdate.removeListener(this._onSceneUpdate);for(const t of this._primitiveProviders)t.onUpdate.removeListener(this._onSceneUpdate)}_onSceneUpdate(){this._lastSceneUpdateTime=K(),this._animationTicksCount=0,this._renderLoop.update()}_onBeforeRender(){this._isDirty=!0}_clearVisibility(t){this._context.bindRenderState(Di),this._context.bindRenderTarget(t),this._context.clearCurrentTarget(16384)}_createPlainTexture(t){const e=this._context.createEmpty2DTexture(1,1,6408,5121);return this._context.setTextureData(e,new Uint8Array([255*t.r,255*t.g,255*t.b,255*t.a])),e}_destroyGridResources(){this._gridSamplerVertexBuffer.destroy(),this._gridSamplerVao.destroy()}}class Hi extends class{constructor(){this._refCount=1}retain(){if(0===this._refCount)throw new Error("Tried to retain a destroyed object.");this._refCount++}release(){if(0===this._refCount)throw new Error("Tried to release a destroyed object.");this._refCount--,0===this._refCount&&this._destroy()}}{constructor(t,e){super(),this.page=t,this._location=e}get vertexByteOffset(){return this._location.vertexByteOffset}get indexByteOffset(){return this._location.indexByteOffset}_destroy(){this.page.free(this)}}function Wi(t,e){switch(e){case 5123:return t>>1;case 5125:return t>>2;default:return-1}}class Xi extends class extends class{constructor(){this._delegate=null}setDelegate(t){this._delegate=t}}{constructor(t,e,i,r,s,n){super(),this.vertexBuffer=t,this.indexBuffer=e,this.vao=i,this.indexType=r,this._vertexAllocator=s,this._indexAllocator=n}allocate(t,e){return this._vertexAllocator.maxAllocableSize>=t&&this._indexAllocator.maxAllocableSize>=e?new Hi(this,{vertexByteOffset:this._vertexAllocator.allocate(t),vertexByteLength:t,indexByteOffset:this._indexAllocator.allocate(e),indexByteLength:e}):null}free(t){this._vertexAllocator.deallocate(t.vertexByteOffset),this._indexAllocator.deallocate(t.indexByteOffset),this.isEmpty()&&this._delegate&&this._delegate.onPageEmpty(this)}isEmpty(){return this._vertexAllocator.isEmpty&&this._indexAllocator.isEmpty}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.vao.destroy()}}{constructor(t,e,i,r){super(t,e,i,r,new Pt(t.getSize()),new Pt(e.getSize())),this._failedAllocation=!1}allocate(t,e){if(this._failedAllocation)return null;const i=super.allocate(t,e);return this._failedAllocation=null===i,i}}class Yi{constructor(t){this._context=t,this._pages=new Map,this._emptyPagesClearTimeout=0}allocate(t,e,i){const r=this._context;let s=this._pages.get(i);s||(s=new Set,this._pages.set(i,s));for(const c of s){const i=c.allocate(t.byteLength,e.byteLength);if(i)return this._updatePage(c,i,t,e),i}const n=r.createVertexBuffer(Math.max(65536*i.vertexByteSize,t.byteLength)),o=r.createIndexBuffer(1048576),a=r.createVao(i,n,o),l=new Xi(n,o,a,5123);l.setDelegate(this),s.add(l);const h=l.allocate(t.byteLength,e.byteLength);return this._updatePage(l,h,t,e),h}onPageEmpty(){this._emptyPagesClearTimeout||(this._emptyPagesClearTimeout=setTimeout(()=>{this._clearEmptyPages(),this._emptyPagesClearTimeout=0}))}destroy(){this._emptyPagesClearTimeout&&clearTimeout(this._emptyPagesClearTimeout);for(const[,t]of this._pages)for(const e of t)e.destroy()}_updatePage(t,e,i,r){const s=this._context;s.bindVao(null),s.uploadDataToBuffer(t.vertexBuffer,i,e.vertexByteOffset);const n=e.vertexByteOffset/t.vao.attributeMapping.vertexByteSize|0;for(let o=0;o<r.length;++o)r[o]+=n;s.uploadDataToBuffer(t.indexBuffer,r,e.indexByteOffset)}_clearEmptyPages(){for(const t of this._pages.values())for(const e of t)e.isEmpty()&&(t.delete(e),e.setDelegate(null),e.destroy())}}const qi=8/nt(),Gi=_t(128,128);function Zi(t){return 128*Math.ceil(t/qi/128)}class Ki{constructor(t,e,i){this._context=t,this._renderer=e,this._renderLoop=i,this._tileCache=new Map,this._isDirty=!0,this._allocateResources(),this._lastRenderTime=0}destroy(){this._deleteResources()}updateSize(){this._deleteResources(),this._allocateResources(),this.setDirty()}setDirty(){this._isDirty||(this._isDirty=!0,this._tileCache.clear())}getIdAt(t){this._isDirty&&(!this._lastRenderTime||K()-this._lastRenderTime>100)&&(this._lastRenderTime=K(),this._renderer.renderHitTestBuffer(this._framebuffer),this._renderLoop.update(),this._tileCache.clear(),this._isDirty=!1);const e=this._context,i=this._framebuffer,r=e.getDefaultRenderTarget().size,s=t.x/r.width,n=1-t.y/r.height,o=s*i.size.width|0,a=n*i.size.height|0,l=ot(128*Math.floor(o/128),128*Math.floor(a/128)),h=l.x<<16|l.y;let c=this._tileCache.get(h);return c||(e.bindRenderTarget(i),c=new Uint32Array(i.readPixels(Gi,l).buffer),this._renderLoop.update(),this._tileCache.set(h,c)),c[128*(a-l.y)+(o-l.x)]}_deleteResources(){this._framebuffer.destroy(),this._colorBuffer.destroy(),this._depthBuffer.destroy()}_allocateResources(){const t=this._context,{width:e,height:i}=t.getDefaultRenderTarget().size,r=Zi(e),s=Zi(i);this._colorBuffer=t.createEmpty2DTexture(r,s,6408,5121),this._depthBuffer=t.createRenderbuffer(r,s,34041),this._framebuffer=t.createFramebuffer({color:this._colorBuffer,depthStencil:this._depthBuffer})}}class Qi extends Error{constructor(){super("Base render unit is not in the list")}}class Ji{constructor(){this.onUpdate=this._onUpdate=new s,this._subRenderUnits=[]}addRenderUnit(t){this._subRenderUnits.push(t),t.onUpdate.addListener(this._onSubRenderUnitUpdate,this),this._onUpdate.fire()}removeRenderUnit(t){const e=this._subRenderUnits.indexOf(t);-1!==e&&(this._subRenderUnits.splice(e,1),t.onUpdate.removeListener(this._onSubRenderUnitUpdate),this._onUpdate.fire())}addRenderUnitAbove(t,e){const i=this._subRenderUnits.indexOf(t);if(-1===i)throw new Qi;this._subRenderUnits.splice(i+1,0,e),e.onUpdate.addListener(this._onSubRenderUnitUpdate,this)}addRenderUnitBelow(t,e){const i=this._subRenderUnits.indexOf(t);if(-1===i)throw new Qi;this._subRenderUnits.splice(i,0,e),e.onUpdate.addListener(this._onSubRenderUnitUpdate,this)}render(t,...e){for(const i of this._subRenderUnits)i.render(t,...e)}renderHitTestBuffer(t,...e){for(const i of this._subRenderUnits)i.renderHitTestBuffer(t,...e)}_onSubRenderUnitUpdate(){this._onUpdate.fire()}}const $i=new Ye({clearDepth:-1,depthTest:!0,depthFunc:518}),tr=new Ye(Object.assign(Object.assign({},$i),{clearColor:je})),er={r:0,g:0,b:0,a:0};class ir extends Ji{constructor(t,e){super(),this._context=t,this._camera=e,this.onRender=this._onRender=new s,this.setBackgroundColor(er)}render(t){const e=this._camera.getViewProjMatrix(),i=gi(this._camera);this._context.bindRenderTarget(t),this._context.bindRenderState(this._renderState),this._context.clearCurrentTarget(17664);for(const r of this._subRenderUnits)r.render(t,e,i);this._onRender.fire()}renderHitTestBuffer(t){const e=this._camera.getViewProjMatrix(),i=gi(this._camera);this._context.bindRenderTarget(t),this._context.bindRenderState(tr),this._context.clearCurrentTarget(17664);for(const r of this._subRenderUnits)r.renderHitTestBuffer(t,e,i)}setBackgroundColor(t){this._renderState=new Ye($i,{clearColor:t})}}class rr extends a{}function sr(t,e){return e<<16|65535&t}function nr(t){return Ze(.5*(t+1))}class or extends class{constructor(t){this._bufferDataProvider=t,this._currentMeshWrittenVertices=0}endMesh(){return this._currentMeshWrittenVertices=0,this._currentBufferData.endMesh()}writeIndices(t){this._ensureEnoughIndexBufferSpace(t.length),this._currentBufferData.writeIndices(t)}writeVertex(...t){return this._ensureEnoughVertexBufferSpace(),this._writeVertex(this._currentBufferData,...t),this._currentMeshWrittenVertices++}_ensureEnoughVertexBufferSpace(t=1){this._currentBufferData||this._requestNewBuffer();const e=this._currentBufferData.vertexBuffer,i=t*e.vertexByteSize;if(e.occupiedByteSize+i>e.byteSize&&(this._requestNewBuffer(),i>this._currentBufferData.vertexBuffer.byteSize))throw new Error("Mesh is too big to write its vertices")}_ensureEnoughIndexBufferSpace(t){this._currentBufferData||this._requestNewBuffer();const e=this._currentBufferData.indexBuffer;if(e.occupiedSize+t>e.size&&(this._requestNewBuffer(),t>this._currentBufferData.indexBuffer.size))throw new Error("Mesh is too big to write its indices")}_requestNewBuffer(){const t=this._currentBufferData;this._currentBufferData=this._bufferDataProvider(),t&&(t.vertexBuffer.transferUnfinishedMesh(this._currentBufferData.vertexBuffer),t.indexBuffer.transferUnfinishedMesh(this._currentBufferData.indexBuffer,t.vertexBuffer.currentMeshBaseIndex))}}{writeFakePrimitive(t,e,i){const r=this.writeVertex(t,e.minX,e.minY,i),s=this.writeVertex(t,e.minX,e.maxY,i),n=this.writeVertex(t,e.maxX,e.minY,i),o=this.writeVertex(t,e.maxX,e.maxY,i);return this.writeIndices([r,n,s,s,n,o]),this.endMesh()}_writeVertex(t,e,i,r,s){(function(t,e){const i=nr(e.x),r=nr(e.y);t.writeVertexUint32(sr(i>>>16,r>>>16)),t.writeVertexUint32(sr(i,r))})(t,e),t.writeVertexUint32(sr(i,r)),t.writeVertexUint32(s)}}Error;class ar{constructor(t,e){this._wordByteSize=e,this._nextWordOffset=0,this._currentMeshByteOffset=0,this._uint8View=new Uint8Array(t)}get data(){return this._uint8View.buffer}get byteSize(){return this._uint8View.byteLength}get occupiedByteSize(){return this._nextWordOffset*this._wordByteSize}endMesh(){const t=this._currentMeshByteOffset,e=this.occupiedByteSize,i=e-t;return this._currentMeshByteOffset=e,{byteOffset:t,byteSize:i}}transferUnfinishedMesh(t){const e=this.occupiedByteSize,i=e-this._currentMeshByteOffset,r=this._uint8View.subarray(this._currentMeshByteOffset,e);t._uint8View.set(r,0),t._nextWordOffset=i/this._wordByteSize,this._nextWordOffset=this._currentMeshByteOffset/this._wordByteSize}reset(){this._nextWordOffset=0,this._currentMeshByteOffset=0}}class lr extends ar{constructor(t,e){super(t*e,Uint32Array.BYTES_PER_ELEMENT),this.vertexByteSize=e,this._uint32View=new Uint32Array(this._uint8View.buffer),this._float32View=new Float32Array(this._uint8View.buffer),this._currentMeshBaseIndex=0}get currentMeshBaseIndex(){return this._currentMeshBaseIndex}get isFull(){return this._nextWordOffset>=this._uint32View.length}pushUint32(t){this._uint32View[this._nextWordOffset++]=t}pushFloat32(t){this._float32View[this._nextWordOffset++]=t}asUint32Array(){return this._uint32View.subarray(0,this._nextWordOffset)}endMesh(){return this._currentMeshBaseIndex=this.occupiedByteSize/this.vertexByteSize,super.endMesh()}reset(){this._currentMeshBaseIndex=0,super.reset()}}class hr extends ar{constructor(t){const e=Uint16Array.BYTES_PER_ELEMENT;super(t*e,e),this._uint16View=new Uint16Array(this._uint8View.buffer)}get size(){return this._uint16View.length}get occupiedSize(){return this._nextWordOffset}push(t){this._uint16View[this._nextWordOffset++]=t}asUint16Array(){return this._uint16View.subarray(0,this._nextWordOffset)}transferUnfinishedMesh(t,e=0){if(super.transferUnfinishedMesh(t),e)for(let i=0;i<t._nextWordOffset;i++)t._uint16View[i]-=e}}class cr{constructor(t,e,i,r){this.id=t,this.vertexBuffer=new lr(e,i),this.indexBuffer=new hr(r),this.onMeshWritten=this._onMeshWritten=new s}writeVertexUint32(t){this.vertexBuffer.pushUint32(t)}writeVertexFloat32(t){this.vertexBuffer.pushFloat32(t)}writeIndices(t){const e=this.vertexBuffer.currentMeshBaseIndex;for(const i of t)this.indexBuffer.push(e+i)}endMesh(){const t=this.vertexBuffer.endMesh(),e=this.indexBuffer.endMesh(),i={vertexByteOffset:t.byteOffset,vertexByteLength:t.byteSize,indexByteOffset:e.byteOffset,indexByteLength:e.byteSize,bufferId:this.id};return this._onMeshWritten.fire(i),i}reset(){this.vertexBuffer.reset(),this.indexBuffer.reset()}}const dr={vertexMinByte:Number.MAX_SAFE_INTEGER,vertexMaxByte:Number.MIN_SAFE_INTEGER,indexMinByte:Number.MAX_SAFE_INTEGER,indexMaxByte:Number.MIN_SAFE_INTEGER};class ur extends bt{constructor(t,e,i,r,n){super(),this.id=t,this.attribMapping=e,this.data=new cr(t,i,r,n),this.data.onMeshWritten.addListener(this._onMeshWritten,this),this.onUpdate=this._onUpdate=new s,this._updatedRegion=Object.assign({},dr)}reset(){this.data.reset(),this.flushUpdatedRegion()}touch(t){this._onMeshWritten(t)}flushUpdatedRegion(){const t=this._updatedRegion;return this._updatedRegion=Object.assign({},dr),t}_onMeshWritten(t){t.vertexByteOffset<this._updatedRegion.vertexMinByte&&(this._updatedRegion.vertexMinByte=t.vertexByteOffset);const e=t.vertexByteOffset+t.vertexByteLength;e>this._updatedRegion.vertexMaxByte&&(this._updatedRegion.vertexMaxByte=e),t.indexByteOffset<this._updatedRegion.indexMinByte&&(this._updatedRegion.indexMinByte=t.indexByteOffset);const i=t.indexByteOffset+t.indexByteLength;i>this._updatedRegion.indexMaxByte&&(this._updatedRegion.indexMaxByte=i),this._onUpdate.fire(this)}}class fr{constructor(t){this._communicator=t,this._updatedPages=new Set,this._pages=new Map,this._freePages=new Map,this._lastGeneratedPageId=0}getPage(t){return this._pages.get(t)}getFreeOrCreatePage(t){const e=this._freePages.get(t),i=e&&e.pop();if(i)return i.reset(),i;{const e=this._generateId(),i=new ur(e,t,65536,t.vertexByteSize,131072);return i.onUpdate.addListener(this._onPageUpdated,this),i.onReleased.addListener(this._onPageReleased,this),this._pages.set(e,i),this._communicator.sendMessage({type:F.FROM_BACKEND_ADD_PAGE,id:e,attribMapping:t,vertexDataByteSize:i.data.vertexBuffer.byteSize,indexDataByteSize:i.data.indexBuffer.byteSize},!1),i}}flushBackendUpdates(){for(const t of this._updatedPages){const{vertexMinByte:e,vertexMaxByte:i,indexMinByte:r,indexMaxByte:s}=t.flushUpdatedRegion(),n=t.data.vertexBuffer.data.slice(e,i),o=t.data.indexBuffer.data.slice(r,s);this._communicator.sendMessage({type:F.FROM_BACKEND_UPDATE_PAGE,id:t.id,vertexData:n,vertexByteOffset:e,indexData:o,indexByteOffset:r},!1,n,o)}this._updatedPages.clear()}_onPageUpdated(t){this._updatedPages.add(t)}_onPageReleased(t){const e=this._freePages.get(t.attribMapping);e?e.push(t):this._freePages.set(t.attribMapping,[t])}_generateId(){return this._lastGeneratedPageId++}}const _r=qe([[0,{size:2,type:5123,normalized:!1}],[1,{size:2,type:5123,normalized:!1}],[6,{size:2,type:5122,normalized:!1}],[2,{size:4,type:5121,normalized:!1}]]);var pr=i(1),mr=i.n(pr);function gr(t,e){return e.vertexByteOffset+e.vertexByteLength===t.vertexByteOffset&&e.indexByteOffset+e.indexByteLength===t.indexByteOffset&&(e.vertexByteLength+=t.vertexByteLength,e.indexByteLength+=t.indexByteLength,!0)}function yr(t){const e=t.page,i=t.location;return{firstPrimitive:t,page:e,vertexByteOffset:i.vertexByteOffset,vertexByteLength:i.vertexByteLength,indexByteOffset:i.indexByteOffset,indexByteLength:i.indexByteLength}}function vr(t,e){return function*(t,e,i,r=(()=>!0)){const s=t[Symbol.iterator]();let n=s.next().value;if(!n)return;let o=n,a=i(o);for(n=s.next().value;n;){const t=e(n);r(o,n,a)&&gr(t,a)||(yield a,a=i(n)),o=n,n=s.next().value}yield a}(t,t=>t.location,yr,(t,i)=>!(t.page!==i.page||e&&!e(t,i)))}class xr extends ri{constructor(t,e,i,r,n,o){super(e,i,r,n,o),this.primitiveProvider=t,this.onUpdate=this._onUpdate=new s,this._updateListener=()=>this._onUpdate.fire(),this.primitiveProvider.onUpdate.addListener(this._updateListener),this._canBatchPredicate=this._canBatchAdjacentPrimitives.bind(this)}destroy(){this.primitiveProvider.onUpdate.removeListener(this._updateListener),super.destroy()}_render(t,e){const i=this._program;for(const r of e){i.setVector2Uniform("lookAtHigh",r.lookAtHigh),i.setVector2Uniform("lookAtLow",r.lookAtLow);for(const t of vr(this._getPrimitives(),this._canBatchPredicate))this._renderBatch(t,i)}}_renderHitTestBuffer(t,e){const i=this._hitTestProgram;for(const r of e){i.setVector2Uniform("lookAtHigh",r.lookAtHigh),i.setVector2Uniform("lookAtLow",r.lookAtLow);for(const t of vr(this._getHitTestPrimitives(),this._canBatchPredicate))this._renderBatch(t,i)}}_getPrimitives(){return this.primitiveProvider.primitives}_getHitTestPrimitives(){return this.primitiveProvider.primitives}_prepareProgram(t,e,i,...r){super._prepareProgram(t,e,i,...r),t.setMatrix4Uniform("viewProjMatrix",e)}_prepareHitTestProgram(t,e,i,...r){super._prepareProgram(t,e,i,...r),t.setMatrix4Uniform("viewProjMatrix",e)}_renderBatch(t,e){this._context.bindVao(t.page.vao),this._context.drawIndexedMesh(t.indexByteOffset,Wi(t.indexByteLength,t.page.indexType))}_canBatchAdjacentPrimitives(t,e){return!0}}class br extends xr{constructor(t,e,i){super(t,e,new Ye,i)}_getPrimitives(){return this.primitiveProvider.visiblePrimitives}_prepareProgram(t,e,i,r,s,n,o,a,l,h,c){super._prepareProgram(t,e,i,r,s,n,o,a,l,h,c),this._context.bindTextureUnit(0),this._context.bindTexture(n),this._context.bindTextureUnit(1),this._context.bindTexture(o),this._context.bindTextureUnit(2),this._context.bindTexture(a),t.setIntScalarUniform("visibility",0),t.setIntScalarUniform("overlap",1),t.setIntScalarUniform("scene",2),t.setVector2Uniform("idHalfPxSize",n.getHalfPxSize()),t.setVector2Uniform("shift",s),t.setScalarUniform("currentZoom",l),t.setScalarUniform("currentTilt",h),t.setScalarUniform("currentAzimuth",c)}_prepareRenderTarget(t,e,i,r,s,n,o){this._context.bindRenderState(r),this._context.bindRenderTarget(t)}}const wr={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexId:2}};class Ar extends br{constructor(t,e,i){super(t,e,e.createProgram(mr.a,bi.a,wr)),this._camera=i}_prepareProgram(t,e,i,r,s,n,o,a,l,h,c){super._prepareProgram(t,e,i,r,s,n,o,a,l,h,c),t.setVector2Uniform("pixelSize",this._camera.pixelSize)}}var Pr=i(16),Tr=i.n(Pr),Sr=i(17),Rr=i.n(Sr);class zr extends ri{constructor(t,e){const i=e.createProgram(Tr.a,Rr.a,{attribMap:{vertexId:2}});super(e,new Ye,i),this._primitiveProvider=t}_render(){const t=this._primitiveProvider.primitives;for(const e of vr(t))this._context.bindVao(e.page.vao),this._context.drawIndexedMesh(e.indexByteOffset,Wi(e.indexByteLength,e.page.indexType),0)}_prepareProgram(t,e){super._prepareProgram(t,e),t.setVector2Uniform("idHalfPxSize",e)}}class Mr{constructor(){this.onMessage=this._onMessage=new s}sendMessage(t,e){this.peerCommunicator&&this.peerCommunicator._onMessage.fire(t)}}class Cr{constructor(t,e,i,r){this._pageRegistryCommunicators=function(){const t=new Mr,e=new Mr;return t.peerCommunicator=e,e.peerCommunicator=t,{master:t,worker:e}}(),this._pageRegistry=new V(this._pageRegistryCommunicators.master,t),this._pageRegistryBackend=new fr(this._pageRegistryCommunicators.worker),this._bufferWriter=new or(function(t,e){let i;return()=>{i&&setTimeout(t=>t.release(),0,i),(i=t.getFreeOrCreatePage(e)).retain();const r=t=>{t.release(),t.onRetain.removeListener(r)};return i.retain(),i.onRetain.addListener(r),i.data}}(this._pageRegistryBackend,_r)),this._visibilityManager=i,this._fakePrimitiveStorage=new Nt,this._fakePrimitiveColorIdRenderer=new Ar(this._fakePrimitiveStorage,t,e),this._fakePrimitiveResetRemovedRenderer=new zr(this._fakePrimitiveStorage,t),this._visibilityManager.registerCollidingPrimitives(this._fakePrimitiveStorage,this._fakePrimitiveColorIdRenderer,this._fakePrimitiveResetRemovedRenderer),this._idGenerator=r,this._primitives=new Map}destructor(){this._visibilityManager.deregisterCollidingPrimitives(this._fakePrimitiveStorage,this._fakePrimitiveColorIdRenderer,this._fakePrimitiveResetRemovedRenderer),this._fakePrimitiveResetRemovedRenderer.destroy(),this._fakePrimitiveColorIdRenderer.destroy(),this._pageRegistry.destructor()}addPrimitives(...t){const e=t.map(({anchor:t,rect:e})=>{const i=this._idGenerator();return{id:i,location:this._bufferWriter.writeFakePrimitive(t,e,i)}});this._pageRegistryBackend.flushBackendUpdates();const i=e.map(({location:t,id:e})=>{const i=this._pageRegistry.getPage(t.bufferId);if(!i)throw new Error("No page for created fake primitive");return new rr(i,t,e)});return this._fakePrimitiveStorage.add(i),this._createCollidingPrimitives(i)}removePrimitives(...t){const e=[];for(const i of t){const t=this._primitives.get(i);t&&(e.push(t),this._primitives.delete(i))}this._fakePrimitiveStorage.delete(e)}clear(){this.removePrimitives(...this._primitives.keys())}_createCollidingPrimitives(t){return t.map(t=>{const e={};return this._primitives.set(e,t),e})}}const kr={min:1,max:511};class Br{constructor(t,e,i,r=new Ni(t,e,i,t.getDefaultRenderTarget().size)){this.camera=e,this.context=t,this._renderTarget=t.getDefaultRenderTarget(),this.renderer=new ir(t,e),this.renderLoop=i,this.memoryManager=new Yi(t),this._hitTestManager=new Ki(t,this.renderer,i),this._atlases=new Set,this.visibilityManager=r,this.visibilityTextureProvider=()=>(this.visibilityManager.updateVisibilityIfNeeded(),this.visibilityManager.visibilityTexture),this.invisibleCollidingPrimitiveManager=new Cr(t,e,r,function({min:t,max:e}){let i=0;return()=>i++%(e-t+1)+t}(kr)),this._onRender=this._onRender.bind(this),i.onRender.addListener(this._onRender),this._updateListener=()=>this.renderLoop.update(),this.onInternalError=new Fe,this.camera.onUpdate.addListener(this._updateListener),this.renderer.onUpdate.addListener(this._updateListener),this._contextLostListener=()=>this.onInternalError.fire(),this.context.onLoss.addListener(this._contextLostListener)}setRenderTargetSize(t){mt(this._renderTarget.size,t)||(this._renderTarget.size=t,this.visibilityManager.setTargetSize(t),this._hitTestManager.updateSize())}createImageAtlas(t){const e=new Ve(this.context,t);return e.onContentUpdate.addListener(this._updateListener),this._atlases.add(e),e}removeImageAtlas(t){t.destroy(),t.onContentUpdate.removeListener(this._updateListener),this._atlases.delete(t)}destroy(){this.camera.onUpdate.removeListener(this._updateListener),this.renderer.onUpdate.removeListener(this._updateListener);for(const t of this._atlases)t.onContentUpdate.removeListener(this._updateListener),t.destroy();this.context.onLoss.removeListener(this._contextLostListener),this.invisibleCollidingPrimitiveManager.destructor()}getObjectIdAt(t){return this._hitTestManager.getIdAt(t)}setBackgroundColor(t){this.renderer.setBackgroundColor(t),this.renderLoop.update()}_onRender(){this.renderer.render(this._renderTarget),this._hitTestManager.setDirty()}}const Ir=Math.PI/180;function Or(t){return t*Ir}const Er=Or(20),Lr=[ee(-1,1,-1),ee(1,1,-1),ee(1,-1,-1),ee(-1,-1,-1)],Ur={wrapModeX:1,wrapModeY:1,minZoom:0,maxZoom:24,fov:Or(30),maxTilt:Or(40),minTilt:Or(0)};function Dr(t,e){switch(t){case 0:return e;case 1:return Y(e,-1,1);case 2:return q(e,-1,1)}}class Fr{constructor(t){this.options=function(t,...e){return Object.assign({},t,...e)}(Ur,t),this.center=new Fr._Center(this),this.onUpdate=this._onUpdate=new s;const e=new Fr._ScreenSize(this);this.screenSize=e,this._distanceToCenter=1,this._recalculateMinDistanceToCenter(),this._zoom=this.options.minZoom,this._fov=this._computeFovAtZoom(this._zoom),this._tilt=this._azimuth=0,this._dirtyBits=-1,this._viewProjMatrix=ge(pe),this._visibleQuadrilateral=[ee(0,0,0),ee(0,0,0),ee(0,0,0),ee(0,0,0)],this._visibleQuadrilateralBBox=ft(this._visibleQuadrilateral),this._pixelSize=ot(0,0)}get aspectRatio(){const{width:t,height:e}=this.screenSize;return 0!==e?t/e:1}get zoom(){return this._zoom}get worldToPxFactor(){return this._worldToPxFactor}set zoom(t){(t=Y(t,this.options.minZoom,this.options.maxZoom))!==this._zoom&&(this._zoom=t,this._recalculateDistanceToCenter(),this._fov=this._computeFovAtZoom(t),this._tilt=this._constrainTilt(this._tilt),this._worldToPxFactor=2/(256*Math.pow(2,t)),this._setDirtyBits(3))}get fov(){return this._fov}get tilt(){return this._tilt}set tilt(t){t=this._constrainTilt(t),this._tilt!==t&&(this._tilt=t,this._setDirtyBits(3))}get azimuth(){return this._azimuth}set azimuth(t){t=q(t,0,2*Math.PI),this._azimuth!==t&&(this._azimuth=t,this._setDirtyBits(3))}get pixelSize(){return this._pixelSize}setDirty(){this._setDirtyBits(-1)}getViewProjMatrix(){const t=this._viewProjMatrix;if(1&this._dirtyBits){ge(pe,t),function(t,e,i,r,s=me()){const n=function(t,e,i=ee(0,0,0)){return i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i}(e,i);le(n,n);const o=ce(r,n);le(o,o);const a=ce(n,o);ye[0]=o.x,ye[1]=a.x,ye[2]=n.x,ye[4]=o.y,ye[5]=a.y,ye[6]=n.y,ye[8]=o.z,ye[9]=a.z,ye[10]=n.z,ye[12]=-he(o,e),ye[13]=-he(a,e),ye[14]=-he(n,e),ve(t,ye,s)}(t,this._computeCenterToCameraVector(),ie,ue(re,this._azimuth),t);const e=Math.tan(Math.abs(this._tilt))*Math.tan(.5*this._fov);!function(t,e,i,r,s,n=me()){const o=1/Math.tan(.5*e),a=o/i,l=(r+s)/(r-s),h=2*r*s/(r-s);for(let c=0;c<16;c+=4){n[c]=t[c]*a,n[c+1]=t[c+1]*o;const e=t[c+2],i=t[c+3];n[c+2]=e*l+i*h,n[c+3]=-e}}(t,this._fov,this.aspectRatio,Math.min(.01*this._distanceToCenter,this._distanceToCenter/(1+e)),this._distanceToCenter/(1-e),t),this._dirtyBits&=-2}return t}getVisibleRegion(){return this._computeVisibleQuadrilateral(),this._visibleQuadrilateral}getVisibleRegionBBox(){return this._computeVisibleQuadrilateral(),this._visibleQuadrilateralBBox}_constrainTilt(t){const e=function(t,e,i){const r=Y((i-1)/1,0,1);return r*r*(3-2*r)}(0,0,this._zoom);return Y(t,this.options.minTilt*e,this.options.maxTilt*e)}_setDirtyBits(t){t^t&this._dirtyBits&&(this._dirtyBits|=t,this._onUpdate.fire())}_computeFovAtZoom(t){if(t<=19)return this.options.fov;const e=t-19;return 2*Math.atan(Math.pow(2,-e)*Math.tan(.5*this.options.fov))}_computeDistanceToCenter(t){return this.screenSize.height*Math.pow(2,-t)/(256*Math.tan(.5*this.options.fov))}_recalculateDistanceToCenter(){this._distanceToCenter=Math.max(this._computeDistanceToCenter(this._zoom),this._minDistanceToCenter)}_recalculateMinDistanceToCenter(){this._minDistanceToCenter=this._computeDistanceToCenter(19)}_computeCenterToCameraVector(t=ee(0,0,0)){return ae(se,this._distanceToCenter,t),de(t,this._tilt,t),ue(t,this._azimuth,t),t}_computeVisibleQuadrilateral(){if(2&this._dirtyBits){const t=this._visibleQuadrilateral,e=Math.tan(.5*this._fov),i=this._computeCenterToCameraVector();ht(i,this.center,i);const r=ee(e*this.aspectRatio,e,1),s=ee(0,0,0),n={origin:i,direction:s};for(let o=0;o<4;++o)if(oe(Lr[o],r,s),de(s,this._computeFrustumTiltAngle(Lr[o]),s),ue(s,this._azimuth,s),!_e(fe,n,t[o]))throw new Error("Visible quadrilateral is unbounded, engine can't handle that case (yet)");ft(t,this._visibleQuadrilateralBBox),this._dirtyBits&=-3}}_computeFrustumTiltAngle(t){const e=this._tilt,i=this._fov/2;return-1!==t.y||e<=i?e:Math.max(e-Er,i)}}Fr._Center=class{constructor(t){this._camera=t,this._x=this._y=0}get x(){return this._x}set x(t){const e=this._camera;t=Dr(e.options.wrapModeX,t),this._x!==t&&(this._x=t,e._setDirtyBits(2))}get y(){return this._y}set y(t){const e=this._camera;t=Dr(e.options.wrapModeY,t),this._y!==t&&(this._y=t,e._setDirtyBits(2))}},Fr._ScreenSize=class{constructor(t){this._camera=t,this._width=this._height=0}get width(){return this._width}set width(t){if(this._width!==t){this._width=t;const e=this._camera;e._setDirtyBits(3),e._pixelSize.x=2/this._width}}get height(){return this._height}set height(t){if(this._height!==t){this._height=t;const e=this._camera;e._recalculateMinDistanceToCenter(),e._recalculateDistanceToCenter(),e._setDirtyBits(3),e._pixelSize.y=2/this._height}}};class Vr{constructor(t,e,i){this._gl=t,this._target=e,this._handle=t.createBuffer(),this._size=i}get size(){return this._size}bind(){this._gl.bindBuffer(this._target,this._handle)}isBound(){const t=this._gl,e=this._handle;switch(this._target){case t.ARRAY_BUFFER:return t.getParameter(t.ARRAY_BUFFER_BINDING)===e;case t.ELEMENT_ARRAY_BUFFER:return t.getParameter(t.ELEMENT_ARRAY_BUFFER_BINDING)===e}return!1}getTarget(){return this._target}getSize(){return this._size}destroy(){this._gl.deleteBuffer(this._handle)}}class jr{constructor(t,e){this.isClear=!1,this._gl=t,this._handle=t.createFramebuffer(),this.size=pt(e)}bind(){const t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,this._handle)}isBound(){const t=this._gl;return t.getParameter(t.FRAMEBUFFER_BINDING)===this._handle}readPixels(t=this.size,e=at,i=new Uint8Array(t.width*t.height*4)){return this._gl.readPixels(e.x,e.y,t.width,t.height,6408,5121,i),i}destroy(){this._gl.deleteFramebuffer(this._handle)}}function Nr(t,e){const i=Object.keys(e).map(t=>"#define "+t+" "+e[t]).join("\n"),r=t.indexOf("#version");if(-1===r)return i+"\n"+t;const s=t.indexOf("\n",r)+1;return t.slice(0,s)+i+"\n"+t.slice(s)}function Hr(t,e,i){const r=t.createShader(e);return t.shaderSource(r,i),t.compileShader(r),r}class Wr{constructor(t,e,i,r){this._gl=t;const s=this._handle=t.createProgram();r&&r.defines&&(e=Nr(e,r.defines),i=Nr(i,r.defines));const n=Hr(t,t.VERTEX_SHADER,e),o=Hr(t,t.FRAGMENT_SHADER,i);t.attachShader(s,n),t.attachShader(s,o),t.deleteShader(n),t.deleteShader(o),r&&r.attribMap&&Object.keys(r.attribMap).forEach(e=>t.bindAttribLocation(s,r.attribMap[e],e)),t.linkProgram(s),this._uniformCache=new Map}bind(){const t=this._gl,e=this._handle;t.useProgram(e)}isBound(){const t=this._gl;return t.getParameter(t.CURRENT_PROGRAM)===this._handle}setIntScalarUniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniform1i(i,e)}setScalarUniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniform1f(i,e)}setVector2Uniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniform2f(i,e.x,e.y)}setVector3Uniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniform3f(i,e.x,e.y,e.z)}setVector4Uniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniform4f(i,e.x,e.y,e.z,e.w)}setColorUniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniform4f(i,e.r,e.g,e.b,e.a)}setMatrix3Uniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniformMatrix3fv(i,!1,e)}setMatrix4Uniform(t,e){const i=this._getUniformLocation(t);i&&this._gl.uniformMatrix4fv(i,!1,e)}destroy(){this._gl.deleteProgram(this._handle)}_getUniformLocation(t){const e=this._uniformCache;let i=e.get(t);if(!i){if(!(i=this._gl.getUniformLocation(this._handle,t)))return null;e.set(t,i)}return i}}class Xr{constructor(t,e,i){this._gl=t,this._handle=t.createRenderbuffer(),this._width=e,this._height=i}bind(){const t=this._gl;t.bindRenderbuffer(t.RENDERBUFFER,this._handle)}isBound(){const t=this._gl;return t.getParameter(t.RENDERBUFFER_BINDING)===this._handle}attachToFramebuffer(t){const e=this._gl;e.framebufferRenderbuffer(e.FRAMEBUFFER,t,e.RENDERBUFFER,this._handle)}getWidth(){return this._width}getHeight(){return this._height}destroy(){this._gl.deleteRenderbuffer(this._handle)}}class Yr{constructor(t){this._gl=t,this._paramValues=new Map}getAliasedLineWidthRange(){return this._getParam(33902)}getAliasedPointSizeRange(){return this._getParam(33901)}getMaxCombinedTextureImageUnits(){return this._getParam(35661)}getMaxCubeMapTextureSize(){return this._getParam(34076)}getMaxFragmentUniformVectors(){return this._getParam(36349)}getMaxRenderbufferSize(){return this._getParam(34024)}getMaxTextureImageUnits(){return this._getParam(34930)}getMaxTextureSize(){return this._getParam(3379)}getMaxVaryingVectors(){return this._getParam(36348)}getMaxVertexAttribs(){return this._getParam(34921)}getMaxVertexTextureImageUnits(){return this._getParam(35660)}getMaxVertexUniformVectors(){return this._getParam(36347)}getMaxViewportDims(){return this._getParam(3386)}getRenderer(){return this._getParam(7937)}getSubpixelBits(){return this._getParam(3408)}getVendor(){return this._getParam(7936)}getVersion(){return this._getParam(7938)}getUnmaskedVendor(){return this._getParam(37445)}getUnmaskedRenderer(){return this._getParam(37446)}_getParam(t){const e=this._paramValues;let i=e.get(t);return i||(i=this._gl.getParameter(t),e.set(t,i)),i}}const qr={wrapS:33071,wrapT:33071,magnificationFilter:9728,minificationFilter:9728,premultipliedAlpha:!1,unpackAlignment:4};class Gr{constructor(t,e,i,r,s,n){const o=Object.assign(Object.assign({},qr),n);this._gl=t,this._format=r,this._type=s,this._params=o,this._width=e,this._height=i,this._halfPxSize=ot(.5/e,.5/i),this._handle=t.createTexture(),this._magnificationFilter=null,this._minificationFilter=null}initialize(){const t=this._gl;t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,this._params.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,this._params.wrapT),this.setFilters(this._params.magnificationFilter,this._params.minificationFilter),t.texImage2D(t.TEXTURE_2D,0,this._format,this._width,this._height,0,this._format,this._type,null)}bind(){const t=this._gl;t.bindTexture(t.TEXTURE_2D,this._handle)}isBound(){const t=this._gl;return t.getParameter(t.TEXTURE_BINDING_2D)===this._handle}attachToFramebuffer(t){const e=this._gl;e.framebufferTexture2D(e.FRAMEBUFFER,t,e.TEXTURE_2D,this._handle,0)}getWidth(){return this._width}getHeight(){return this._height}getFormat(){return this._format}getType(){return this._type}getParams(){return this._params}getHalfPxSize(){return this._halfPxSize}setFilters(t=this._params.magnificationFilter,e=this._params.minificationFilter){const i=this._gl;this._magnificationFilter!==t&&(this._magnificationFilter=t,i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,t)),this._minificationFilter!==e&&(this._minificationFilter=e,i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,e))}destroy(){this._gl.deleteTexture(this._handle)}}class Zr{constructor(t,e,i,r,s){this._gl=t,this._vaoExt=e,this._handle=e.createVertexArrayOES(),this.attributeMapping=i,this.vertexBuffer=r,this.indexBuffer=s,this.onDestroy=new Fe}bind(){this._vaoExt.bindVertexArrayOES(this._handle)}isBound(){return this._gl.getParameter(this._vaoExt.VERTEX_ARRAY_BINDING_OES)===this._handle}destroy(){this._vaoExt.deleteVertexArrayOES(this._handle),this.onDestroy.fire()}}const Kr=new Float32Array([-1,-1,0,0,1,1,1,1,-1,1,0,1,-1,-1,0,0,1,-1,1,0,1,1,1,1]),Qr=qe([[0,{size:2,type:5126,normalized:!1}],[4,{size:2,type:5126,normalized:!1}]]);class Jr{constructor(t){this.isClear=!1,this._gl=t}bind(){const t=this._gl;t.bindFramebuffer(t.FRAMEBUFFER,null)}setSize(t,e){const i=this._gl.canvas;i.width=t,i.height=e}get size(){return _t(this._gl.drawingBufferWidth,this._gl.drawingBufferHeight)}set size(t){const e=this._gl.canvas;e.width=t.width,e.height=t.height}destroy(){}}class $r{constructor(t){this._gl=t,this.onLoss=new Fe,this._contextLostListener=t=>{t.preventDefault(),this.onLoss.fire()},t.canvas.addEventListener("webglcontextlost",this._contextLostListener),this._capabilities=new Yr(t);const e=t.getExtension("OES_vertex_array_object");if(!e)throw new Error("OES_vertex_array_object is required.");if(this._vaoExt=e,!t.getExtension("OES_standard_derivatives"))throw new Error("OES_standard_derivatives is required.");const i=this._boundRenderTarget=this._defaultRenderTarget=new Jr(t),r=this._boundRenderState=new Ye;this._unpackPremultiplyAlpha=!1,this._unpackAlignment=4;const{width:s,height:n}=i.size;r.scissorWidth=r.viewportWidth=s,r.scissorHeight=r.viewportHeight=n;const o=this._quadVertexBuffer=new Vr(t,t.ARRAY_BUFFER,t.STATIC_DRAW);o.bind(),t.bufferData(t.ARRAY_BUFFER,Kr,t.STATIC_DRAW),this._quadVao=this.createVao(Qr,o,null),t.bindBuffer(t.ARRAY_BUFFER,null),this._boundProgram=null,this._boundVao=null,this._boundTextures=new Array(this._capabilities.getMaxCombinedTextureImageUnits()),this._boundTextures.fill(null),this._boundTextureUnit=0}getCapabilities(){return this._capabilities}createFramebuffer({color:t,depth:e,stencil:i,depthStencil:r}){const s=this._gl;let n=0,o=0;t?(n=t.getWidth(),o=t.getHeight()):e?(n=e.getWidth(),o=e.getHeight()):i?(n=i.getWidth(),o=i.getHeight()):r&&(n=r.getWidth(),o=r.getHeight());const a=new jr(s,_t(n,o));return this.bindRenderTarget(a),t&&t.attachToFramebuffer(s.COLOR_ATTACHMENT0),e&&e.attachToFramebuffer(s.DEPTH_ATTACHMENT),i&&i.attachToFramebuffer(s.STENCIL_ATTACHMENT),r&&r.attachToFramebuffer(s.DEPTH_STENCIL_ATTACHMENT),a}createRenderbuffer(t,e,i){const r=this._gl,s=new Xr(r,t,e);return s.bind(),r.renderbufferStorage(r.RENDERBUFFER,i,t,e),s}createEmpty2DTexture(t,e,i,r,s){const n=new Gr(this._gl,t,e,i,r,s);return this.bindTexture(n),n.initialize(),n}createProgram(t,e,i){return new Wr(this._gl,t,e,i)}createVertexBuffer(t,e=35044){return this._createBuffer(this._gl.ARRAY_BUFFER,t,e)}createIndexBuffer(t,e=35044){return this._createBuffer(this._gl.ELEMENT_ARRAY_BUFFER,t,e)}uploadDataToBuffer(t,e,i=0){t.bind(),this._gl.bufferSubData(t.getTarget(),i,e)}createVao(t,e,i,r=t.vertexByteSize){const s=this._gl,n=new Zr(s,this._vaoExt,t,e,i);n.bind(),i?i.bind():s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),e.bind();for(const[o,a]of t.attributes)s.enableVertexAttribArray(o),s.vertexAttribPointer(o,a.size,a.type,a.normalized,r,a.offset);return this._vaoExt.bindVertexArrayOES(null),n}setTextureData(t,e,i={x:0,y:0},r={width:t.getWidth(),height:t.getHeight()}){const s=this._gl,n=t.getFormat(),o=t.getType(),a=t.getParams(),{width:l,height:h}=r;this._setTextureDataUnpackParams(a),this.bindTexture(t),s.texSubImage2D(s.TEXTURE_2D,0,i.x,i.y,l,h,n,o,e),this._onTextureDataUpdated(t)}setTextureDataFromDomElement(t,e){const i=this._gl,r=t.getFormat(),s=t.getType(),n=t.getParams();this._setTextureDataUnpackParams(n),this.bindTexture(t),i.texSubImage2D(i.TEXTURE_2D,0,0,0,r,s,e),this._onTextureDataUpdated(t)}getDefaultRenderTarget(){return this._defaultRenderTarget}clearCurrentTarget(t){t&&(this._gl.clear(t),this._boundRenderTarget.isClear=!0)}bindRenderTarget(t){this._boundRenderTarget!==t&&(t.bind(),this._boundRenderTarget=t);const{width:e,height:i}=t.size;this._setViewportState(new Ye({viewportWidth:e,viewportHeight:i}))}bindRenderState(t){this._setColorBufferState(t),this._setBlendState(t),this._setCullFaceState(t),this._setFrontFaceState(t),this._setDepthTestState(t),this._setDitherState(t),this._setPolygonOffsetState(t),this._setAlphaToCoverageState(t),this._setSampleCoverageState(t),this._setStencilTestState(t),this._setScissorTestState(t),this._setViewportState(t)}bindProgram(t){this._boundProgram!==t&&(t.bind(),this._boundProgram=t)}bindVao(t){this._boundVao!==t&&(t?t.bind():this._vaoExt.bindVertexArrayOES(null),this._boundVao=t)}bindQuadVao(){this.bindVao(this._quadVao)}bindTextureUnit(t){const e=this._gl;this._boundTextureUnit!==t&&(e.activeTexture(e.TEXTURE0+t),this._boundTextureUnit=t)}bindTexture(t,e,i){const r=this._boundTextureUnit;this._boundTextures[r]!==t&&(t.bind(),this._boundTextures[r]=t),t.setFilters(e,i)}drawQuad(){this.drawMesh(0,6,4)}drawMesh(t,e,i=4){this._gl.drawArrays(i,t,e),this._boundRenderTarget.isClear=!1}drawIndexedMesh(t,e,i=4){const r=this._gl;r.drawElements(i,e,r.UNSIGNED_SHORT,t),this._boundRenderTarget.isClear=!1}destroy(){this._quadVao.destroy(),this._quadVertexBuffer.destroy(),this._gl.canvas.removeEventListener("webglcontextlost",this._contextLostListener)}static createFromCanvas(t,e){const i=t.getContext("webgl",e);if(!i)throw new Error("Failed to create GL context from canvas.");return new $r(i)}_setCapabilityEnabled(t,e){e?this._gl.enable(t):this._gl.disable(t)}_setColorBufferState(t){const e=this._gl,i=this._boundRenderState,r=t.clearColor;var s,n;n=r,((s=i.clearColor).r!==n.r||s.g!==n.g||s.b!==n.b||s.a!==n.a)&&(e.clearColor(r.r,r.g,r.b,r.a),function(t,e=Ne(0,0,0,0)){e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a}(r,i.clearColor)),i.colorMaskR===t.colorMaskR&&i.colorMaskG===t.colorMaskG&&i.colorMaskB===t.colorMaskB&&i.colorMaskAlpha===t.colorMaskAlpha||(this._gl.colorMask(t.colorMaskR,t.colorMaskG,t.colorMaskB,t.colorMaskAlpha),i.colorMaskR=t.colorMaskR,i.colorMaskG=t.colorMaskG,i.colorMaskB=t.colorMaskB,i.colorMaskAlpha=t.colorMaskAlpha)}_setBlendState(t){const e=this._gl,i=this._boundRenderState;i.blend!==t.blend&&(this._setCapabilityEnabled(e.BLEND,t.blend),i.blend=t.blend),t.blend&&(i.blendEquationRgb===t.blendEquationRgb&&i.blendEquationAlpha===t.blendEquationAlpha||(e.blendEquationSeparate(t.blendEquationRgb,t.blendEquationAlpha),i.blendEquationRgb=t.blendEquationRgb,i.blendEquationAlpha=t.blendEquationAlpha),i.blendFuncDstRgb===t.blendFuncDstRgb&&i.blendFuncSrcRgb===t.blendFuncSrcRgb&&i.blendFuncDstAlpha===t.blendFuncDstAlpha&&i.blendFuncSrcAlpha===t.blendFuncSrcAlpha||(e.blendFuncSeparate(t.blendFuncSrcRgb,t.blendFuncDstRgb,t.blendFuncSrcAlpha,t.blendFuncDstAlpha),i.blendFuncSrcRgb=t.blendFuncSrcRgb,i.blendFuncDstRgb=t.blendFuncDstRgb,i.blendFuncSrcAlpha=t.blendFuncSrcAlpha,i.blendFuncDstAlpha=t.blendFuncDstAlpha))}_setCullFaceState(t){const e=this._gl,i=this._boundRenderState;i.cullFace!==t.cullFace&&(this._setCapabilityEnabled(e.CULL_FACE,t.cullFace),i.cullFace=t.cullFace),t.cullFace&&i.cullFaceMode!==t.cullFaceMode&&(e.cullFace(t.cullFaceMode),i.cullFaceMode=t.cullFaceMode)}_setFrontFaceState(t){const e=this._boundRenderState;e.frontFaceMode!==t.frontFaceMode&&(this._gl.frontFace(t.frontFaceMode),e.frontFaceMode=t.frontFaceMode)}_setDepthTestState(t){const e=this._gl,i=this._boundRenderState;i.depthTest!==t.depthTest&&(this._setCapabilityEnabled(e.DEPTH_TEST,t.depthTest),i.depthTest=t.depthTest),t.depthTest&&(i.clearDepth!==t.clearDepth&&(e.clearDepth(t.clearDepth),i.clearDepth=t.clearDepth),i.depthMask!==t.depthMask&&(e.depthMask(t.depthMask),i.depthMask=t.depthMask),i.depthFunc!==t.depthFunc&&(e.depthFunc(t.depthFunc),i.depthFunc=t.depthFunc),i.depthRangeNear===t.depthRangeNear&&i.depthRangeFar===t.depthRangeFar||(e.depthRange(t.depthRangeNear,t.depthRangeFar),i.depthRangeNear=t.depthRangeNear,i.depthRangeFar=t.depthRangeFar))}_setDitherState(t){const e=this._boundRenderState;e.dither!==t.dither&&(this._setCapabilityEnabled(this._gl.DITHER,t.dither),e.dither=t.dither)}_setPolygonOffsetState(t){const e=this._gl,i=this._boundRenderState;i.polygonOffset!==t.polygonOffset&&(this._setCapabilityEnabled(e.POLYGON_OFFSET_FILL,t.polygonOffset),i.polygonOffset=t.polygonOffset),!t.polygonOffset||i.polygonOffsetFactor===t.polygonOffsetFactor&&i.polygonOffsetUnits===t.polygonOffsetUnits||(e.polygonOffset(t.polygonOffsetFactor,t.polygonOffsetUnits),i.polygonOffsetFactor=t.polygonOffsetFactor,i.polygonOffsetUnits=t.polygonOffsetUnits)}_setAlphaToCoverageState(t){const e=this._boundRenderState;e.sampleAlphaToCoverage!==t.sampleAlphaToCoverage&&(this._setCapabilityEnabled(this._gl.SAMPLE_ALPHA_TO_COVERAGE,t.sampleAlphaToCoverage),e.sampleAlphaToCoverage=t.sampleAlphaToCoverage)}_setSampleCoverageState(t){const e=this._gl,i=this._boundRenderState;i.sampleCoverage!==t.sampleCoverage&&(this._setCapabilityEnabled(e.SAMPLE_COVERAGE,t.sampleCoverage),i.sampleCoverage=t.sampleCoverage),!t.sampleCoverage||i.sampleCoverageValue===t.sampleCoverageValue&&i.sampleCoverageInvert===t.sampleCoverageInvert||(e.sampleCoverage(t.sampleCoverageValue,t.sampleCoverageInvert),i.sampleCoverageValue=t.sampleCoverageValue,i.sampleCoverageInvert=t.sampleCoverageInvert)}_setStencilTestState(t){const e=this._gl,i=this._boundRenderState;if(i.stencilTest!==t.stencilTest&&(this._setCapabilityEnabled(e.STENCIL_TEST,t.stencilTest),i.stencilTest=t.stencilTest),t.stencilTest){i.clearStencil!==t.clearStencil&&(e.clearStencil(t.clearStencil),i.clearStencil=t.clearStencil),i.stencilWriteMask!==t.stencilWriteMask&&(e.stencilMask(t.stencilWriteMask),i.stencilWriteMask=t.stencilWriteMask);const r=i.stencilMask!==t.stencilMask||i.stencilReference!==t.stencilReference;r&&(i.stencilMask=t.stencilMask,i.stencilReference=t.stencilReference),(i.stencilFrontFunc!==t.stencilFrontFunc||r)&&(e.stencilFuncSeparate(e.FRONT,t.stencilFrontFunc,t.stencilReference,t.stencilMask),i.stencilFrontFunc=t.stencilFrontFunc),(i.stencilBackFunc!==t.stencilBackFunc||r)&&(e.stencilFuncSeparate(e.BACK,t.stencilBackFunc,t.stencilReference,t.stencilMask),i.stencilBackFunc=t.stencilBackFunc),i.stencilFrontFailOp===t.stencilFrontFailOp&&i.stencilFrontDepthFailOp===t.stencilFrontDepthFailOp&&i.stencilFrontDepthPassOp===t.stencilFrontDepthPassOp||(e.stencilOpSeparate(e.FRONT,t.stencilFrontFailOp,t.stencilFrontDepthFailOp,t.stencilFrontDepthPassOp),i.stencilFrontFailOp=t.stencilFrontFailOp,i.stencilFrontDepthFailOp=t.stencilFrontDepthFailOp,i.stencilFrontDepthPassOp=t.stencilFrontDepthPassOp),i.stencilBackFailOp===t.stencilBackFailOp&&i.stencilBackDepthFailOp===t.stencilBackDepthFailOp&&i.stencilBackDepthPassOp===t.stencilBackDepthPassOp||(e.stencilOpSeparate(e.BACK,t.stencilBackFailOp,t.stencilBackDepthFailOp,t.stencilBackDepthPassOp),i.stencilBackFailOp=t.stencilBackFailOp,i.stencilBackDepthFailOp=t.stencilBackDepthFailOp,i.stencilBackDepthPassOp=t.stencilBackDepthPassOp)}}_setScissorTestState(t){const e=this._gl,i=this._boundRenderState;i.scissorTest!==t.scissorTest&&(this._setCapabilityEnabled(e.SCISSOR_TEST,t.scissorTest),i.scissorTest=t.scissorTest),t.scissorTest&&t.scissorWidth>=0&&t.scissorHeight>=0&&(i.scissorX!==t.scissorX||i.scissorY!==t.scissorY||i.scissorWidth!==t.scissorWidth||i.scissorHeight!==t.scissorHeight)&&(e.scissor(t.scissorX,t.scissorY,t.scissorWidth,t.scissorHeight),i.scissorX=t.scissorX,i.scissorY=t.scissorY,i.scissorWidth=t.scissorWidth,i.scissorHeight=t.scissorHeight)}_setViewportState(t){const e=this._boundRenderState;t.viewportWidth>=0&&t.viewportHeight>=0&&(e.viewportX!==t.viewportX||e.viewportY!==t.viewportY||e.viewportWidth!==t.viewportWidth||e.viewportHeight!==t.viewportHeight)&&(this._gl.viewport(t.viewportX,t.viewportY,t.viewportWidth,t.viewportHeight),e.viewportX=t.viewportX,e.viewportY=t.viewportY,e.viewportWidth=t.viewportWidth,e.viewportHeight=t.viewportHeight)}_setTextureDataUnpackParams(t){const e=this._gl;this._unpackPremultiplyAlpha!==t.premultipliedAlpha&&(e.pixelStorei(37441,+t.premultipliedAlpha),this._unpackPremultiplyAlpha=t.premultipliedAlpha),this._unpackAlignment!==t.unpackAlignment&&(e.pixelStorei(3317,t.unpackAlignment),this._unpackAlignment=t.unpackAlignment)}_onTextureDataUpdated(t){const e=this._gl;t.getParams().minificationFilter>=9984&&e.generateMipmap(e.TEXTURE_2D)}_createBuffer(t,e,i=this._gl.STATIC_DRAW){const r=this._gl,s=new Vr(r,t,e);return this.bindVao(null),s.bind(),r.bufferData(t,e,i),s}}var ts=i(2),es=i.n(ts),is=i(18),rs=i.n(is);const ss=new Ye({depthTest:!0,depthFunc:518}),ns={LIGHT:{r:.98,g:.97,b:.94,a:1},DARK:{r:.12,g:.14,b:.18,a:1}};class os extends ri{constructor(t){const e=t.createProgram(es.a,rs.a,{attribMap:{vertexPosition:0,vertexUv:4}});super(t,ss,e),this._color=ns.LIGHT,t.bindProgram(e),e.setScalarUniform("zIndex",-1),this.onUpdate=new s}setColor(t){this._color=t,this.onUpdate.fire()}_render(){this._context.bindQuadVao(),this._context.drawQuad()}_prepareProgram(t){super._prepareProgram(t),t.setScalarUniform("dpr",nt());const{r:e,g:i,b:r,a:s}=this._color;t.setVector4Uniform("color",{x:e,y:i,z:r,w:s})}}const as=new Ye({depthTest:!0,clearDepth:-1});class ls extends Ji{constructor(t,e=0){super(),this._depthClearStrategy=e,this._context=t}render(t,...e){this._clearDepthIfNeeded(t),super.render(t,...e)}renderHitTestBuffer(t,...e){this._clearDepthIfNeeded(t),super.renderHitTestBuffer(t,...e)}_clearDepthIfNeeded(t){1===this._depthClearStrategy&&(this._context.bindRenderState(as),this._context.bindRenderTarget(t),this._context.clearCurrentTarget(256))}}var hs=i(19),cs=i.n(hs);const ds=new Ye(He);class us extends ri{constructor(t,e){super(t,ds,t.createProgram(es.a,cs.a,{attribMap:{vertexPosition:0}})),this._renderers=new Ji,this._renderLoop=e,this.onUpdate=this._renderers.onUpdate,this._pixelSize=ot(0,0)}addRenderUnit(t){this._renderers.addRenderUnit(t)}removeRenderUnit(t){this._renderers.removeRenderUnit(t)}render(t,...e){if(this._renderLoop.isActive)return this._renderers.render(t,...e),void this._renderLoop.update();this._intermediateRenderbuffer?mt(this._intermediateRenderbuffer.size,t.size)||(this._destroyInternalRenderTargets(),this._initIntermediateRenderTargets(t.size)):this._initIntermediateRenderTargets(t.size),this._context.bindRenderTarget(this._intermediateRenderbuffer),this._context.clearCurrentTarget(17664),this._renderers.render(this._intermediateRenderbuffer,...e),this._intermediateRenderbuffer.isClear||(this._updateFrameUniformState(t),super.render(t,...e))}renderHitTestBuffer(t,...e){this._renderers.renderHitTestBuffer(t,...e)}destroy(){this._intermediateRenderbuffer&&this._destroyInternalRenderTargets()}_render(){this._context.bindQuadVao(),this._context.drawQuad()}_prepareProgram(t,...e){super._prepareProgram(t,...e),this._context.bindTextureUnit(0),this._context.bindTexture(this._intermediateColorBuffer),t.setIntScalarUniform("texture",0),t.setVector2Uniform("pixelSize",this._pixelSize),t.setScalarUniform("dpr",nt())}_updateFrameUniformState(t){this._pixelSize.x=1/t.size.width,this._pixelSize.y=1/t.size.height}_initIntermediateRenderTargets({width:t,height:e}){const i=this._context,r=this._intermediateColorBuffer=i.createEmpty2DTexture(t,e,6408,5121),s=this._intermediateDepthStencilBuffer=i.createRenderbuffer(t,e,34041);this._intermediateRenderbuffer=i.createFramebuffer({color:r,depthStencil:s})}_destroyInternalRenderTargets(){this._intermediateRenderbuffer.destroy(),this._intermediateColorBuffer.destroy(),this._intermediateDepthStencilBuffer.destroy()}}class fs{constructor(t,e,i,r,s,n){this._camera=t,this._renderLoop=e,this._viewport=i,this._startFromZoom=s,this._duration=r,this._limitByZoom=n,this._isWorld3D=!1,this._lastAnimationTick=void 0,this._heightFactor=0,this.heightProvider=()=>this._heightFactor,this._viewport.onViewportStateChanged.addListener(this._onViewportUpdate,this),this._camera.onUpdate.addListener(this._onViewportUpdate,this),this._renderLoop.onBeforeRender.addListener(this._onBeforeRender,this),this._onViewportUpdate(this._viewport.viewportState)}destroy(){this._renderLoop.onBeforeRender.removeListener(this._onBeforeRender),this._viewport.onViewportStateChanged.removeListener(this._onViewportUpdate)}get _maxHeightFactor(){return Y(1-(this._startFromZoom-this._camera.zoom)/this._limitByZoom,0,1)}_onViewportUpdate(t=this._viewport.viewportState){const e=t.visualizableTileNumber>0,i=this._camera.zoom>=this._startFromZoom;e&&i!==this._isWorld3D&&(this._lastAnimationTick=K(),this._isWorld3D=i,this._renderLoop.update())}_onBeforeRender(){if(void 0!==this._lastAnimationTick){const t=K(),e=(t-this._lastAnimationTick)/this._duration;this._heightFactor=Y(this._heightFactor+(this._isWorld3D?e:-e),0,this._maxHeightFactor);const i=this._isWorld3D?this._heightFactor<1:this._heightFactor>0;this._lastAnimationTick=i?t:void 0,this._renderLoop.update()}}}var _s=i(4),ps=i.n(_s),ms=i(20),gs=i.n(ms);class ys extends xr{constructor(t,e,i,r,s,n,o){super(t,e,i,r,s,n),this._colorTransformProvider=o}_renderBatch(t,e){const i=this._colorTransformProvider&&this._colorTransformProvider.get(t.firstPrimitive);i?(e.setIntScalarUniform("isColorTransformed",1),e.setMatrix4Uniform("colorTransform",i)):e.setIntScalarUniform("isColorTransformed",0),super._renderBatch(t,e)}_canBatchAdjacentPrimitives(t,e){const i=this._colorTransformProvider;return super._canBatchAdjacentPrimitives(t,e)&&(!i||i.get(t)===i.get(e))}}const vs={maxZoomWithTilesLoading:1/0},xs=new Ye(We,{depthTest:!0,depthMask:!1,depthFunc:518}),bs={attribMap:{vertexId:2,vertexPosHigh:0,vertexPosLow:1,vertexNormal:5,vertexDisplacement:6,vertexZIndex:10,vertexUv:4,vertexIconLocation:12,vertexScale:13,vertexZoomRelatedData:14}},ws={attribMap:bs.attribMap,defines:{YV_COLOR_ID:1}};class As extends ys{constructor(t,e,i,r,s){var n,o;super(t,e,xs,e.createProgram(ps.a,gs.a,bs),new Ye(Xe),e.createProgram(ps.a,bi.a,ws),s),this._camera=i,this._atlasSizeUniform=ot(0,0),this._maxZoomWithTilesLoading=null!=(o=null===(n=r)||void 0===n?void 0:n.maxZoomWithTilesLoading)?o:vs.maxZoomWithTilesLoading}_prepareProgram(t,e,i,...r){super._prepareProgram(t,e,i,...r),this._prepareProgramState(t)}_prepareHitTestProgram(t,e,i,...r){super._prepareHitTestProgram(t,e,i,...r),this._prepareProgramState(t)}_renderBatch(t,e){const i=t.firstPrimitive.texture;this._atlasSizeUniform.x=i.getWidth(),this._atlasSizeUniform.y=i.getHeight(),e.setVector2Uniform("atlasSize",this._atlasSizeUniform),this._context.bindTextureUnit(0),this._context.bindTexture(i,9729,9729),super._renderBatch(t,e)}_canBatchAdjacentPrimitives(t,e){return super._canBatchAdjacentPrimitives(t,e)&&t.texture===e.texture}_prepareProgramState(t){const e=this._camera.zoom,i=Y((e-this._maxZoomWithTilesLoading)/2*.5+.5,.5,1);t.setScalarUniform("worldToPxFactor",this._camera.worldToPxFactor),t.setScalarUniform("zoom",e),t.setScalarUniform("zoomScaleFactor",i)}}var Ps=i(5),Ts=i.n(Ps),Ss=i(3),Rs=i.n(Ss);const zs=new Ye(He,{cullFace:!0,cullFaceMode:1028}),Ms=new Ye;class Cs extends ys{constructor(t,e,i,r,s,n,o){super(t,e,zs,r,Ms,s,o),this._camera=i,this._visibilityProvider=n,this._atlasSizeUniform=ot(0,0)}_render(t,e){this._program.setScalarUniform("isOutlinePhase",1),super._render(t,e),this._program.setScalarUniform("isOutlinePhase",0),super._render(t,e)}_prepareProgram(t,e,i){const r=this._visibilityProvider();super._prepareProgram(t,e,i),this._prepareProgramState(t,r)}_prepareHitTestProgram(t,e,i){const r=this._visibilityProvider();super._prepareHitTestProgram(t,e,i),this._prepareProgramState(t,r)}_renderBatch(t,e){const i=t.firstPrimitive.texture;this._atlasSizeUniform.x=i.getWidth(),this._atlasSizeUniform.y=i.getHeight(),e.setIntScalarUniform("atlas",1),e.setVector2Uniform("atlasSize",this._atlasSizeUniform),this._context.bindTextureUnit(1),this._context.bindTexture(i),super._renderBatch(t,e)}_getHitTestPrimitives(){return N(super._getHitTestPrimitives(),t=>!!t.metadata)}_canBatchAdjacentPrimitives(t,e){return super._canBatchAdjacentPrimitives(t,e)&&t.texture===e.texture}_prepareProgramState(t,e){this._context.bindTextureUnit(0),this._context.bindTexture(e),t.setVector2Uniform("idHalfPxSize",e.getHalfPxSize()),t.setVector2Uniform("pixelSize",this._camera.pixelSize),t.setScalarUniform("dpr",window.devicePixelRatio)}}const ks={attribMap:{vertexId:2,vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexUV:4,vertexPriority:9,vertexColor:7,vertexOutlineColor:8,vertexScale:11}},Bs={defines:{YV_COLOR_ID:1},attribMap:ks.attribMap};class Is extends Cs{constructor(t,e,i,r,s){super(t,e,i,e.createProgram(Ts.a,Rs.a,ks),e.createProgram(Ts.a,bi.a,Bs),r,s)}}var Os=i(6),Es=i.n(Os),Ls=i(21),Us=i.n(Ls),Ds=i(22),Fs=i.n(Ds),Vs=i(23),js=i.n(Vs);const Ns=new Ye(We),Hs=new Ye;class Ws extends ys{constructor(t,e,i=e.createProgram(Fs.a,js.a,{attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexUV:4}}),r,s){super(t,e,Ns,i,Hs,r,s),this._atlasSizeUniform=ot(0,0)}_renderBatch(t,e){const i=t.firstPrimitive.texture;this._atlasSizeUniform.x=i.getWidth(),this._atlasSizeUniform.y=i.getHeight(),e.setVector2Uniform("atlasSize",this._atlasSizeUniform),this._prepareTexture(i),super._renderBatch(t,e)}_prepareTexture(t){this._context.bindTextureUnit(0),this._context.bindTexture(t)}_canBatchAdjacentPrimitives(t,e){return super._canBatchAdjacentPrimitives(t,e)&&t.texture===e.texture}}class Xs{constructor(t,e){this._primitivesProvider=t,this._orderingPredicate=e,this._orderedPrimitives=[],this._isDirty=!1,this._updatePrimitivesListener=()=>this._isDirty=!0,this._primitivesProvider.onUpdate.addListener(this._updatePrimitivesListener)}destroy(){this._orderedPrimitives=[],this._primitivesProvider.onUpdate.removeListener(this._updatePrimitivesListener)}get orderedPrimitives(){return this._isDirty&&this._updatePrimitivesStorage(),this._orderedPrimitives}_updatePrimitivesStorage(){const{primitives:t}=this._primitivesProvider,e=[...t];!function(t,e=M,i=0,r=t.length){if(r-i<=32)return void B(t,e,i,r);{let s=i,n=s+32;for(;n<r;)B(t,e,s,n),s=n,n+=32;B(t,e,s,r)}const s=new Array(r-i);for(let n=32;n<r-i;n+=n){k(t,s,i,r);let o=i,a=0,l=n,h=l+n;for(;h<r-i;)I(s,t,e,a,l,h,o),h=(l=(a=h)+n)+n,o+=2*n;I(s,t,e,a,Math.min(l,r-i),r-i,o)}}(e,this._orderingPredicate),this._orderedPrimitives=e,this._isDirty=!1}}const Ys=0,qs=0,Gs={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6,vertexOffset:11,vertexUV:4,vertexId:2,vertexPriority:9}},Zs={attribMap:Gs.attribMap,defines:{YV_COLOR_ID:1}};class Ks extends Ws{constructor(t,e,i,r,s,n){var o,a,l,h;super(t,e,e.createProgram(Es.a,Us.a,Gs),e.createProgram(Es.a,bi.a,Zs),n),this._camera=i,this._linearFilterFrames=0,this._cameraUpdateListener=()=>{this._linearFilterFrames=3},this._camera.onUpdate.addListener(this._cameraUpdateListener),this._orderedPrimitiveStorage=new Xs(t,(t,e)=>t.zIndex-e.zIndex),this._visibilityProvider=r,this._extensionAndMinSize={x:(a=null===(o=s)||void 0===o?void 0:o.iconHitTestField,null!=a?a:Ys),y:(h=null===(l=s)||void 0===l?void 0:l.iconHitTestMinSize,null!=h?h:qs)}}destroy(){this._camera.onUpdate.removeListener(this._cameraUpdateListener),this._orderedPrimitiveStorage.destroy(),super.destroy()}_render(t,e){super._render(t,e),this._linearFilterFrames>0&&(this._linearFilterFrames--,this._requestRerender())}_prepareProgram(t,e,i){const r=this._visibilityProvider();super._prepareProgram(t,e,i),this._prepareProgramState(t,r),t.setVector2Uniform("extensionAndMinSize",at)}_prepareHitTestProgram(t,e,i){const r=this._visibilityProvider();super._prepareHitTestProgram(t,e,i),this._prepareProgramState(t,r),t.setVector2Uniform("extensionAndMinSize",this._extensionAndMinSize)}_prepareTexture(t){this._context.bindTextureUnit(0);const e=this._linearFilterFrames>0?9729:void 0;this._context.bindTexture(t,e,e)}_getPrimitives(){return this._orderedPrimitiveStorage.orderedPrimitives}_requestRerender(){this._onUpdate.fire()}_prepareProgramState(t,e){this._context.bindTextureUnit(1),this._context.bindTexture(e),t.setIntScalarUniform("visibility",1),t.setVector2Uniform("idHalfPxSize",e.getHalfPxSize()),t.setVector2Uniform("pixelSize",this._camera.pixelSize)}}var Qs=i(7),Js=i.n(Qs),$s=i(24),tn=i.n($s);const en={depthTest:!0,depthFunc:518},rn={vertexPosHigh:0,vertexPosLow:1,vertexColor:7,vertexZIndex:10,vertexId:2};class sn extends ys{constructor(t,e,i=new Ye(en),r){super(t,e,i,e.createProgram(Js.a,tn.a,{attribMap:rn}),new Ye(Xe),e.createProgram(Js.a,bi.a,{attribMap:rn,defines:{YV_COLOR_ID:1}}),r)}}class nn extends sn{constructor(t,e,i){super(t,e,new Ye(en,{depthMask:!1},He),i)}}var on=i(8),an=i.n(on),ln=i(25),hn=i.n(ln),cn=i(26),dn=i.n(cn),un=i(27),fn=i.n(un);const _n=new Ye(He),pn={attribMap:{vertexPosition:0,vertexUV:4}};class mn extends ri{constructor(t){super(t,_n,t.createProgram(dn.a,fn.a,pn))}_render(t){this._context.bindTextureUnit(0),this._context.bindTexture(t),this._context.bindQuadVao(),this._context.drawQuad()}}const gn=new Ye({depthTest:!0}),yn={attribMap:{vertexPosHigh:0,vertexPosLow:1,vertexHeight:3,vertexColor:7,vertexId:2}},vn={attribMap:yn.attribMap,defines:{YV_COLOR_ID:1}};class xn extends ys{constructor(t,e,i,r=(()=>1)){super(t,e,gn,e.createProgram(an.a,hn.a,yn),new Ye,e.createProgram(an.a,bi.a,vn),i),this._heightFactorProvider=r,this._outputSize=_t(-1,-1),this._overlayRenderer=new mn(e)}render(t,e,i){this._syncOutputBuffer(t),super.render(this._outputBuffer,e,i),this._outputBuffer.isClear||this._overlayRenderer.render(t,this._outputTexture)}destroy(){this._overlayRenderer.destroy(),this._outputTexture&&this._outputTexture.destroy(),this._outputDepthBuffer&&this._outputDepthBuffer.destroy(),this._outputBuffer&&this._outputBuffer.destroy(),super.destroy()}_prepareProgram(t,e,i,...r){super._prepareProgram(t,e,i,...r),t.setScalarUniform("zFactor",this._heightFactorProvider())}_prepareHitTestProgram(t,e,i,...r){this._prepareProgram(t,e,i,...r)}_syncOutputBuffer(t){if(!mt(this._outputSize,t.size)){(this._outputTexture||this._outputDepthBuffer||this._outputBuffer)&&(this._outputTexture.destroy(),this._outputDepthBuffer.destroy(),this._outputBuffer.destroy());const{width:e,height:i}=pt(t.size,this._outputSize);this._outputTexture=this._context.createEmpty2DTexture(e,i,6408,5121),this._outputDepthBuffer=this._context.createRenderbuffer(e,i,34041),this._outputBuffer=this._context.createFramebuffer({color:this._outputTexture,depthStencil:this._outputDepthBuffer})}}_prepareRenderTarget(t,e,i){super._prepareRenderTarget(t,e,i),this._context.clearCurrentTarget(16640)}_prepareRenderTargetHitTest(t,e,i){super._prepareRenderTarget(t,e,i),this._context.clearCurrentTarget(256)}}var bn=i(9),wn=i.n(bn);const An={attribMap:{vertexId:2,vertexPosHigh:0,vertexPosLow:1,vertexDisplacements:6,vertexUV:4,vertexColor:7,vertexOutlineColor:8,vertexPriority:9,leftPolylineRatios:12,leftPolylineAngles:13,rightPolylineRatios:14,rightPolylineAngles:15,polylineLength_vertexScale:11}},Pn={defines:{YV_COLOR_ID:1},attribMap:An.attribMap};class Tn extends Cs{constructor(t,e,i,r){super(t,e,i,e.createProgram(wn.a,Rs.a,An),e.createProgram(wn.a,bi.a,Pn),r)}}const Sn={vertexPosHigh:0,vertexPosLow:1,vertexDisplacement:6};class Rn extends xr{constructor(t,e,i,r=new Ye){super(t,e,r,e.createProgram(mr.a,bi.a,{attribMap:Sn})),this._camera=i}_prepareProgram(t,e,i){super._prepareProgram(t,e,i),t.setVector2Uniform("pixelSize",this._camera.pixelSize)}}var zn=i(28),Mn=i.n(zn);class Cn extends br{constructor(t,e,i,r){super(t,e,i),this._camera=r}_prepareProgram(t,e,i,r,s,n,o,a,l,h,c){super._prepareProgram(t,e,i,r,s,n,o,a,l,h,c),t.setVector2Uniform("pixelSize",this._camera.pixelSize)}}class kn extends Cn{constructor(t,e,i){super(t,e,e.createProgram(Mn.a,bi.a,ks),i)}}const Bn=new Map;class In extends zr{_render(){const t=this._primitiveProvider.primitives;for(const e of vr(t)){const t=e.page.vao.attributeMapping.vertexByteSize,i=On(t)*t,r=e.page.vao;Bn.get(r)||(Bn.set(r,this._context.createVao(e.page.vao.attributeMapping,e.page.vao.vertexBuffer,null,i)),r.onDestroy.addListener(()=>{Bn.get(r).destroy(),Bn.delete(r)})),this._context.bindVao(Bn.get(r)),this._context.drawMesh(e.vertexByteOffset/i,e.vertexByteLength/i,0)}}}function On(t){const e=Math.floor(255/t);return Math.min(e,4)}var En=i(29),Ln=i.n(En);class Un extends Cn{constructor(t,e,i){super(t,e,e.createProgram(Ln.a,bi.a,An),i)}}var Dn=i(30),Fn=i.n(Dn);class Vn extends br{constructor(t,e,i){super(t,e,e.createProgram(Fn.a,bi.a,Gs)),this._camera=i}_prepareProgram(t,e,i,r,s,n,o,a,l,h,c){super._prepareProgram(t,e,i,r,s,n,o,a,l,h,c),t.setVector2Uniform("pixelSize",this._camera.pixelSize)}}function jn(t,e,i){return new Le(De.a,t,e,i)}e.default=r}]).default)},2808:function(t,e,i){"use strict";i.r(e);var r,s=i(34),n=i(75),o=i(434),a=i(192),l=i(455),h=i(74),c=i(633),d=i(634),u=i(76),f=i(656),_=i(435),p=i(901);var m=function(){function t(t){void 0===t&&(t={}),this._additionalData=t}return t.prototype.submit=function(t,e){var i,n="/dtype=stred/pid=443/cid=73323/path="+t+"/"+(i=Object(s.a)(Object(s.a)({},e),this._additionalData),Object.keys(i).map(function(t){return t+"="+i[t]}).join("/"))+"/*",o=function(){if(r)return r;switch(location.hostname.split(".").pop()){case"tr":return r="https://yandex.com.tr/clck/counter";case"com":case"fr":return r="https://yandex.com/clck/counter";case"eu":return r="https://yandex.eu/clck/counter";default:return r="https://yandex.ru/clck/counter"}}();window.navigator.sendBeacon?navigator.sendBeacon(o,n):document.createElement("img").src=""+o+n},t}(),g=i(565),y=(i(248),i(635)),v=i(167);i.d(e,"VectorMapEngine",function(){return S});var x={},b={r:.98,g:.97,b:.94,a:1},w={r:.12,g:.14,b:.18,a:1},A=function(){function t(t,e){var i=this;this._destroyed=!1,this.onBeforeRender=new t.EventTrigger,this.onRender=new t.EventTrigger,this._renderLoop=e,this._renderLoopSubscription=this._renderLoop.on("beforeRender",function(){return i.onBeforeRender.fire()}).on("render",function(){return i.onRender.fire()})}return Object.defineProperty(t.prototype,"isActive",{get:function(){return this._renderLoop.isActive},enumerable:!1,configurable:!0}),t.prototype.update=function(){this._destroyed||this._renderLoop.update()},t.prototype.destroy=function(){this._destroyed=!0,this._renderLoopSubscription.offAll()},t}(),P=function(){function t(t,e){this.source=t,this._plan=e}return t.prototype.getId=function(){return this._plan.id},t.prototype.getBounds=function(){var t=this._plan.bbox;return[[t.lowerCorner.lon,t.lowerCorner.lat],[t.upperCorner.lon,t.upperCorner.lat]]},t.prototype.isVisible=function(){return this._plan.isVisible},t.prototype.setVisible=function(t){this._plan.isVisible=t},t.prototype.getLevels=function(){return this._plan.levels},t.prototype.getDefaultLevel=function(){return this._plan.defaultLevel},t.prototype.getActiveLevel=function(){return this._plan.activeLevel},t.prototype.setActiveLevel=function(t){this._plan.setActiveLevel(t)},t.prototype.getOpacity=function(){return this._plan.opacity},t.prototype.setOpacity=function(t){this._plan.opacity=t},t}(),T=function(t){var e=Math.floor(t);return t-e<.5?e:e+1},S=function(t){function e(e,i,r,o,a,l,h,c){var d=t.call(this)||this;return d._processingQueue=new _.a(20),d._contentProvidersBySource=new n.Map,d._layersById=new n.Map,d._layerDescriptions=[],d._tileDataSources={},d._filters=new n.Map,d._finalizeSetLayers=function(t,e,i){d._layersById.forEach(function(t){for(var e=0,i=t.renderUnits;e<i.length;e++){var r=i[e];d._engine.renderer.removeRenderUnit(r)}}),d._contentProvidersBySource=i,d._layerDescriptions=t,d._layersById=e,d._layersById.forEach(function(t){for(var e=0,i=t.renderUnits;e<i.length;e++){var r=i[e];d._engine.renderer.addRenderUnit(r)}}),d._asyncSetLayersAbortController=void 0,d._emit("indoorPlansChanged")},d._createContentProvider=function(t){var e,i,r,s,n=t.tileSource,o=t.sourceName,a={iconUrlTemplate:n.vectorSourceDescription.imageUrl,glyphRangeUrlTemplate:n.vectorSourceDescription.glyphRangeUrl,tileUrlTemplate:n.vectorSourceDescription.tileUrl,meshUrlTemplate:n.vectorSourceDescription.meshUrl,tileSize:{X1:0,X4:1,X16:2}[n.vectorSourceDescription.requestTileSize||"X1"],preloadedTilesBeltWidth:n.vectorSourceDescription.tileBeltSize||0,useLowPrecisionBeltTiles:n.vectorSourceDescription.lowPrecisionBeltTiles,tileCacheSize:n.vectorSourceDescription.tileCacheSize||100,indoorPlanUrlTemplate:n.vectorSourceDescription.indoorPlanUrl,basePriority:{low:100,medium:200,high:300}[n.vectorSourceDescription.priority],objectsCollisionPriority:{low:0,medium:1,high:2,ultra:3}[null!==(e=n.vectorSourceDescription.collisionPriority)&&void 0!==e?e:"medium"],customizationConfig:null!==(i=n.vectorSourceDescription.customization)&&void 0!==i?i:[],iconHitTestField:null===(r=n.vectorSourceDescription.objectTapableArea)||void 0===r?void 0:r.field,iconHitTestMinSize:null===(s=n.vectorSourceDescription.objectTapableArea)||void 0===s?void 0:s.minSize,mapMode:"night"===n.vectorSourceDescription.mapMode?1:0},l=d._contentProdiver.initContentProvider(o,a);l instanceof d.vector.IndoorContentProvider?(l.onPlansChanged.addListener(d._onPlansChanged),d._colorTransformers.indoorOpacity=l.colorTransformProvider):d._toggleVisibilityFilter(l,d._contentProdiver.coveredByIndoorFilter,!0,[6,4,2]);var h=n.group().on("changed",function(){var t;l.updateCustomizationConfig(null!==(t=n.vectorSourceDescription.customization)&&void 0!==t?t:[]),l.updateTileUrlTemplate(n.vectorSourceDescription.tileUrl)});return l.visibilityManager.onViewportStateChanged.addListener(d._onViewportStateChanged),d._filters.forEach(function(t){d._toggleVisibilityFilter(l,t,!0)}),{contentProvider:l,tileSource:n,tileSourceSubscription:h}},d._destroyContentProvider=function(t){t.contentProvider instanceof d.vector.IndoorContentProvider?(t.contentProvider.onPlansChanged.removeListener(d._onPlansChanged),d._colorTransformers.indoorOpacity=void 0):d._toggleVisibilityFilter(t.contentProvider,d._contentProdiver.coveredByIndoorFilter,!1,[6,4,2]),t.contentProvider.visibilityManager.onViewportStateChanged.removeListener(d._onViewportStateChanged),t.tileSourceSubscription.offAll(),d._contentProdiver.destroyContentProvider(t.contentProvider)},d._onPlansChanged=function(){return d._emit("indoorPlansChanged")},d._onViewportStateChanged=function(){d._emit("stateChanged"),d._areTilesReady()&&(d._emit("tilesLoaded"),d._emit("tilesReady"))},d._createLayerImplementation=function(t,e,i){var r,n=x[t.type];if(!n)throw new Error("Unknown type for vector layer: "+t.type);var o=Object(s.a)(Object(s.a)({},n(d.vector,d._engine,e,t.options.vector)),{tileSource:d._tileDataSources[t.source],tileSourceSubscription:d._tileDataSources[t.source].group()});o.colorTransformer.provider=i||d._colorTransformers.general,d._setupHotspotLayer(o,t),o.tileSourceSubscription.on("changed",function(){d._teardownHotspotLayer(o),d._setupHotspotLayer(o,t)});for(var a=0,l=o.collidingPrimitives;a<l.length;a++){var h=l[a];(r=d._engine.visibilityManager).registerCollidingPrimitives.apply(r,h)}return o},d._destroyLayerImplementation=function(t){var e;t.tileSourceSubscription.offAll(),d._teardownHotspotLayer(t);for(var i=t.collidingPrimitives.length-1;i>=0;i--)(e=d._engine.visibilityManager).deregisterCollidingPrimitives.apply(e,t.collidingPrimitives[i]);for(i=t.renderUnits.length-1;i>=0;i--){var r=t.renderUnits[i];d._engine.renderer.removeRenderUnit(r),r.destroy&&r.destroy()}for(var s=0,n=t.destroyables;s<n.length;s++){n[s].destroy()}},d.renderLoop=h,d.vector=e,d.worldOptions=c,d._metricsTransport=new m(i),d._applyDataSources(l),d.element=r.canvas,d.element.style.width="100%",d.element.style.height="100%",d._context=new d.vector.Context(r),d._vectorRenderLoop=new A(d.vector,h),d._size=o,d._renderLoopSubscription=h.on("render",function(t){d._layersById.forEach(function(e){var i=e.hotspotLayer;return i&&i.render(t)})}).on("beforeRender",function(){(!d._renderedSize&&Boolean(d._size)||!u.areEqual(d._size,d._renderedSize))&&d._doResize()}),d._engine=new d.vector.Engine(d._context,new d.vector.Camera({wrapModeX:2,wrapModeY:0,maxTilt:y.a}),d._vectorRenderLoop),d._backgroundRenderUnit=new d.vector.BackgroundRenderUnit(d._context),d._engine.renderer.addRenderUnit(d._backgroundRenderUnit),d._applyBackgroundColor(l),d._engine.onInternalError.addListener(function(){return d._emit("internalError")}),d._updateRenderLoop=d.renderLoop.update.bind(d.renderLoop),d._contentProdiver=d.vector.createContentProvider(d._engine.camera,d._engine.context,d._metricsTransport),d._colorTransformers={general:{get:function(t){var e,i;return(null===(e=d._colorTransformers.hoverHighlight)||void 0===e?void 0:e.get(t))||(null===(i=d._colorTransformers.indoorOpacity)||void 0===i?void 0:i.get(t))}}},d.update(a),d}return Object(s.b)(e,t),e.prototype.getLayerReadyState=function(t){var e,i=null===(e=this._layersById.get(t))||void 0===e?void 0:e.contentProvider;if(i){var r=i.visibilityManager.viewportState.visibleTileNumber,s=i.visibilityManager.viewportState.visualizableTileNumber;return{tilesReady:s,tilesLoaded:s,tilesTotal:r}}},e.prototype.destroy=function(){this.setLayers([]),this._backgroundRenderUnit.destroy(),this._renderLoopSubscription.offAll(),this._engine.destroy(),this._context.destroy(),this._vectorRenderLoop.destroy(),this._asyncSetLayersAbortController&&(this._asyncSetLayersAbortController.abort(),this._asyncSetLayersAbortController=void 0)},e.prototype.setDataSources=function(t){this._applyDataSources(t),this._applyBackgroundColor(t),this.setLayers(this._layerDescriptions)},e.prototype.update=function(t){var e=this;this._camera=t,this._engine.camera.zoom=t.zoom,this._engine.camera.center.x=t.worldCenter.x,this._engine.camera.center.y=t.worldCenter.y,this._engine.camera.azimuth=t.azimuth,this._engine.camera.tilt=t.tilt,this._layersById.forEach(function(i){var r=i.hotspotLayer;return r&&r.update(t,e.fov)})},e.prototype.resize=function(t){this._size=t},e.prototype.setLayers=function(t){var e=this;this._abortAndCleanupAsyncLayersInitIfInProgress();for(var i=new n.Map,r=new n.Map,s=0,o=t;s<o.length;s++){var a=o[s],l=this._tileDataSources[a.source];if(!l.vectorSourceDescription)throw new Error(a.id+" does not have vector source");i.set(a.id,a),r.set(a.source,{tileSource:l,sourceName:a.source})}var h=Object(d.a)(this._contentProvidersBySource,r,this._createContentProvider,this._destroyContentProvider,function(){},function(){return!0}).result,c=this._getColorTransformersByLayers(t),u=Object(d.a)(this._layersById,i,function(t){var i=h.get(t.source).contentProvider;return e._createLayerImplementation(t,i,c[t.id])},this._destroyLayerImplementation,function(t,i){t.colorTransformer.provider=c[i.id]||e._colorTransformers.general},function(t,i){return t.tileSource===e._tileDataSources[i.source]});this._finalizeSetLayers(t,u.result,h)},e.prototype.initLayersAsync=function(t,e){var i,r=this;if(e.aborted)return Promise.reject(new g.a);this._asyncSetLayersAbortController=new o.AbortController;var s=this._asyncSetLayersAbortController.signal,l=function(){e.removeEventListener("abort",l),r._abortAndCleanupAsyncLayersInitIfInProgress()};e.addEventListener("abort",l);for(var h=this._getColorTransformersByLayers(t),c=new n.Map,d=new n.Map,u=[],f=function(t){var e=_._tileDataSources[t.source];if(!e.vectorSourceDescription)throw new Error(t.id+" does not have vector source.");var n=null!==(i=c.get(t.source))&&void 0!==i?i:_._createContentProvider({tileSource:e,sourceName:t.source});c.set(t.source,n);u.push(new Promise(function(t){return setTimeout(t)}).then(function(){if(!s.aborted){var e=r._createLayerImplementation(t,n.contentProvider,h[t.id]);d.set(t.id,e)}}))},_=this,p=0,m=t;p<m.length;p++){f(m[p])}return Object(a.promiseFinally)(new Promise(function(t,e){s.addEventListener("abort",function(){c.forEach(r._destroyContentProvider),t()}),Promise.all(u).then(t).catch(e)}).then(function(){s.aborted||r._finalizeSetLayers(t,d,c)}),function(){e.removeEventListener("abort",l),r._asyncSetLayersAbortController&&(r._asyncSetLayersAbortController=void 0)})},e.prototype.preloadHotspotsInPoint=function(t){this._layersById.forEach(function(e){e.hotspotLayer&&e.hotspotLayer.preloadHotspotsInPoint(t)})},e.prototype.preloadHotspotsForViewport=function(){this._layersById.forEach(function(t){t.hotspotLayer&&t.hotspotLayer.preloadHotspotsForViewport()})},e.prototype.setObjectFilters=function(t){for(var e=this,i=Object(d.a)(this._filters,t,function(t){var i=new e.vector.EventTrigger,r=t.on("update",function(){return i.fire()});return{filter:t,onUpdate:i,subscription:r,test:function(e){return t.test(e)}}},function(t){t.subscription.offAll()}),r=function(t){s._contentProvidersBySource.forEach(function(i){var r=i.contentProvider;e._toggleVisibilityFilter(r,t,!1)})},s=this,n=0,o=i.removed;n<o.length;n++){r(o[n])}for(var a=function(t){l._contentProvidersBySource.forEach(function(i){var r=i.contentProvider;e._toggleVisibilityFilter(r,t,!0)})},l=this,h=0,c=i.created;h<c.length;h++){a(c[h])}this._filters=i.result},e.prototype.setInvisibleCollidingPrimitives=function(t){var e=this._engine.invisibleCollidingPrimitiveManager,i=[];t.forEach(function(t){return i.push(t)}),e.clear(),e.addPrimitives.apply(e,i)},e.prototype.getIndoorPlans=function(){var t=this,e=[];if(this._contentProvidersBySource.forEach(function(i,r){var s=i.contentProvider;s instanceof t.vector.IndoorContentProvider&&e.push([s,r])}),0===e.length)return null;for(var i=[],r=0,s=e;r<s.length;r++)for(var n=s[r],o=n[0],a=n[1],l=0,h=o.plans;l<h.length;l++){var c=h[l];i.push(new P(a,c))}return i},e.prototype.getVisibleObjects=function(t){var e=this._contentProvidersBySource.get(t);if(!e)return null;for(var i=[],r=e.contentProvider.scene[6].visiblePrimitives[n.Symbol.iterator](),s=r.next();!s.done;s=r.next()){var o=s.value.metadata;o&&i.push(o)}return i},e.prototype._abortAndCleanupAsyncLayersInitIfInProgress=function(){this._asyncSetLayersAbortController&&(this._asyncSetLayersAbortController.abort(),this._asyncSetLayersAbortController=void 0)},e.prototype._applyDataSources=function(t){this._tileDataSources={};for(var e=0,i=Object.keys(t);e<i.length;e++){var r=i[e],s=t[r];s instanceof f.a&&s.vectorSourceDescription&&(this._tileDataSources[r]=s)}},e.prototype._applyBackgroundColor=function(t){var e=Object(n.arrayFind)(Object.keys(t),function(e){var i,r=t[e];return r instanceof f.a&&"night"===(null===(i=r.vectorSourceDescription)||void 0===i?void 0:i.mapMode)})?w:b;this._backgroundRenderUnit.setColor(e)},e.prototype._doResize=function(){var t=this,e=Math.max(this._size.x,1),i=Math.max(this._size.y,1),r=Object(c.a)();this._engine.camera.screenSize.width=e,this._engine.camera.screenSize.height=i,this._engine.setRenderTargetSize({width:e*r,height:i*r}),this._layersById.forEach(function(e){var i=e.hotspotLayer;return i&&i.resize(t._size)}),this._renderedSize=this._size},e.prototype._getColorTransformersByLayers=function(t){var e=this;return t.reduce(function(t,i){var r=i.options.vector.transformLayers||{};return Object.keys(r).forEach(function(i){var s=e.vector.createColorTransform(r[i]);t[i]={get:function(){return s}}}),t},{})},e.prototype._setupHotspotLayer=function(t,e){var i=this._tileDataSources[e.source],r=(i.vectorSourceDescription.hotspots||{})[e.type];if("function"==typeof r){var s=new p.a(this._size,this._camera,{fetchHotspots:r,hotspotAbortRadius:i.hotspotAbortRadius,tileSize:i.tileSize,zoomRange:i.zoomRange,inset:l.b,padding:0},this._processingQueue,this.worldOptions,T);s.on("requestRender",this._updateRenderLoop),t.hotspotLayer=s}},e.prototype._teardownHotspotLayer=function(t){t.hotspotLayer&&(t.hotspotLayer.offSingle("requestRender",this._updateRenderLoop),t.hotspotLayer.destroy())},e.prototype._areTilesReady=function(){var t=!0;return this._contentProvidersBySource.forEach(function(e){var i=e.contentProvider.visibilityManager.viewportState;t=t&&i.visibleTileNumber===i.visualizableTileNumber}),t},e.prototype.findObjectInPosition=function(t){var e=Object(v.d)(t,Object(s.a)(Object(s.a)({},this._camera),{fov:this.fov,size:{x:this._engine.camera.screenSize.width,y:this._engine.camera.screenSize.height}})),i=this._engine.getObjectIdAt(u.muln(e,Object(c.a)())),r=this._contentProdiver.getObjectMetadata(i);if(!r)return this._findRasterHotspotObjectAbove(t,void 0);var n=r.get("uri"),o=r.get("position"),a=r.get("objectId"),l=o?o.split(",").map(Number):void 0,h=(r.get("tags")||r.get("eventTags")||r.get("group")||"").split(",").filter(Boolean),d=r.get(this.vector.VECTOR_METADATA_PREFIX+"layerName"),f=0===h.length?void 0:this._findLayerForMetadata(h,d),_=this._findRasterHotspotObjectAbove(t,f);if(_)return _;if(!f)return null;var p=this._tileDataSources[d].vectorSourceDescription.hotspots;return p&&!this._areHotspotsEnabled(p[f.type])?null:{type:"hotspot",layer:f.id,source:d,feature:{type:"Feature",id:n||o||a||"",geometry:l&&{type:"Point",coordinates:{x:l[0],y:l[1]}},properties:{uri:n,tags:h,name:r.get("name"),selectedIconUrl:r.get(this.vector.VECTOR_METADATA_PREFIX+"selectedIconUrl"),vectorMetadata:r,vectorId:i}}}},e.prototype.findObjectInPositionEx=function(t){var e,i=this.findObjectInPosition(t),r=this._layerDescriptions.slice().reverse(),s=Object(n.arrayFindIndex)(r,function(t){return t.id===(null==i?void 0:i.layer)});s>=0&&(r=r.slice(0,s));var o={layers:[]};return(e=o.layers).push.apply(e,r.map(function(t){return{layer:t.id,object:null}})),i&&o.layers.push({layer:i.layer,object:i}),o},e.prototype.setObjectHighlight=function(t){var e=null==t?void 0:t.object.properties.vectorId;if(t&&e){var i=this.vector.createColorTransform(t.color);this._colorTransformers.hoverHighlight={get:function(t){return t.id===e?i:void 0}}}else this._colorTransformers.hoverHighlight=void 0;this._vectorRenderLoop.update()},e.prototype._findRasterHotspotObjectAbove=function(t,e){for(var i=0,r=this._layerDescriptions.slice().reverse();i<r.length;i++){var n=r[i],o=this._layersById.get(n.id);if(o.hotspotLayer){var a=o.hotspotLayer.findObjectInPosition(t);if(a)return Object(s.a)(Object(s.a)({},a),{layer:n.id,source:n.source})}if(n===e)return null}return null},e.prototype._findLayerForMetadata=function(t,e){for(var i=-1!==t.indexOf("building"),r=0,s=this._layerDescriptions;r<s.length;r++){var o=s[r];if(o.source===e&&(i&&"buildings"===o.type||"icons"===o.type))return o}return Object(n.arrayFind)(this._layerDescriptions,function(t){return t.source===e})},e.prototype._areHotspotsEnabled=function(t){return"object"==typeof t?void 0===t.minZoom||this._engine.camera.zoom>=t.minZoom:void 0===t||!0===t},e.prototype._toggleVisibilityFilter=function(t,e,i,r){void 0===r&&(r=[6,4]);for(var s=i?"addVisibilityFilter":"removeVisibilityFilter",n=0,o=r;n<o.length;n++){var a=o[n];t[s](a,e)}},Object.defineProperty(e.prototype,"fov",{get:function(){return this._engine.camera.fov},enumerable:!1,configurable:!0}),e}(Object(h.a)().with());x.ground=function(t,e,i){var r=e.context,s=e.camera,n=i.scene,o={get:function(t){var e;return null===(e=this.provider)||void 0===e?void 0:e.get(t)}};return{contentProvider:i,colorTransformer:o,renderUnits:[new t.LayerRenderUnit(r,1),i instanceof t.IndoorContentProvider?new t.TransparentPolygonRenderUnit(n[0],r,o):new t.PolygonRenderUnit(n[0],r,void 0,o),new t.TransparentPolygonRenderUnit(n[1],r,o),new t.PolylineRenderUnit(n[3],r,s,i.renderOptions,o)],collidingPrimitives:[],destroyables:[]}},x.buildings=function(t,e,i,r){var s;(null==r?void 0:r.modelsAppearingAnimation)&&(s=new t.ModelsAnimationManager(e.camera,e.renderLoop,i.visibilityManager,r.modelsAppearingAnimation.duration,r.modelsAppearingAnimation.transitionZoom,r.modelsAppearingAnimation.limitByZoom));var n={get:function(t){var e;return null===(e=this.provider)||void 0===e?void 0:e.get(t)}},o=new t.ModelRenderUnit(i.scene[2],e.context,n,null==s?void 0:s.heightProvider),a=new t.FxaaRenderUnit(e.context,e.renderLoop);a.addRenderUnit(o);var l=[o];return s&&l.push(s),{contentProvider:i,destroyables:l,colorTransformer:n,renderUnits:[a],collidingPrimitives:[]}},x.icons=function(t,e,i){var r={get:function(t){var e;return null===(e=this.provider)||void 0===e?void 0:e.get(t)}},s=new t.IconRenderUnit(i.scene[6],e.context,e.camera,e.visibilityTextureProvider,i.renderOptions,r),n=new t.ColorIdIconRenderer(i.scene[6],e.context,e.camera),o=new t.CollidingPrimitivesResetRemovedRenderer(i.scene[6],e.context);return{contentProvider:i,colorTransformer:r,renderUnits:[s],collidingPrimitives:[[i.scene[6],n,o]],destroyables:[n,o]}},x.labels=function(t,e,i){var r=e.context,s=e.camera,n=i.scene,o={get:function(t){var e;return null===(e=this.provider)||void 0===e?void 0:e.get(t)}},a=new t.PointLabelRenderUnit(n[4],r,s,e.visibilityTextureProvider,o),l=new t.CurvedLabelRenderUnit(n[5],r,s,e.visibilityTextureProvider),h=new t.ColorIdCurvedLabelRenderer(n[5],e.context,e.camera),c=new t.LabelResetRemovedRenderer(n[5],e.context),d=new t.ColorIdPointLabelRenderer(n[4],e.context,e.camera),u=new t.LabelResetRemovedRenderer(n[4],e.context);return{contentProvider:i,colorTransformer:o,renderUnits:[l,a],collidingPrimitives:[[n[5],h,c],[n[4],d,u]],destroyables:[h,d,c,u]}}},312:function(t,e,i){"use strict";i.d(e,"c",function(){return s}),i.d(e,"d",function(){return n}),i.d(e,"b",function(){return o}),i.d(e,"a",function(){return a});var r=i(34);function s(t,e){return Object(r.a)(Object(r.a)({},t),{geometry:t.geometry&&n(t.geometry,e)})}function n(t,e){switch(t.type){case"Point":return Object(r.a)(Object(r.a)({},t),{coordinates:e(t.coordinates)});case"LineString":return Object(r.a)(Object(r.a)({},t),{coordinates:t.coordinates.map(e)});case"MultiLineString":return Object(r.a)(Object(r.a)({},t),{coordinates:t.coordinates.map(function(t){return t.map(e)})});case"Polygon":return Object(r.a)(Object(r.a)({},t),{coordinates:t.coordinates.map(function(t){return t.map(e)})});case"MultiPolygon":return Object(r.a)(Object(r.a)({},t),{coordinates:t.coordinates.map(function(t){return t.map(function(t){return t.map(e)})})});default:throw new Error("Unexpected geometry type: "+t.type)}}function o(t){var e;return"FeatureCollection"===t.type?(e=[]).concat.apply(e,t.features.map(function(t){return o(t)})):[t]}function a(t){if("string"!=typeof t.id)throw new Error("Feature or collection id must be a string")}},402:function(t,e,i){"use strict";function r(t,e,i){return{x:t,y:e,z:i}}i.d(e,"e",function(){return r}),i.d(e,"a",function(){return s}),i.d(e,"d",function(){return n}),i.d(e,"c",function(){return o}),i.d(e,"m",function(){return a}),i.d(e,"i",function(){return l}),i.d(e,"j",function(){return h}),i.d(e,"g",function(){return c}),i.d(e,"f",function(){return d}),i.d(e,"k",function(){return u}),i.d(e,"l",function(){return f}),i.d(e,"b",function(){return _}),i.d(e,"h",function(){return p});var s=r(0,0,0);function n(t,e){return void 0===e&&(e=r(0,0,0)),e.x=t.x,e.y=t.y,e.z=t.z,e}function o(t,e,i){return void 0===i&&(i=r(0,0,0)),i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i}function a(t,e,i){return void 0===i&&(i=r(0,0,0)),i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i}function l(t,e,i){return void 0===i&&(i=r(0,0,0)),i.x=t.x*e.x,i.y=t.y*e.y,i.z=t.z*e.z,i}function h(t,e){return void 0===e&&(e=r(0,0,0)),function(t,e,i){return void 0===i&&(i=r(0,0,0)),i.x=t.x/e,i.y=t.y/e,i.z=t.z/e,i}(t,function(t){return Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)+Math.pow(t.z,2))}(t),e)}function c(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}function d(t,e,i){void 0===i&&(i=r(0,0,0));var s=t.y*e.z-t.z*e.y,n=t.z*e.x-t.x*e.z,o=t.x*e.y-t.y*e.x;return i.x=s,i.y=n,i.z=o,i}function u(t,e,i){void 0===i&&(i=r(0,0,0));var s=Math.cos(e),n=Math.sin(e),o=t.y;return i.x=t.x,i.y=o*s-t.z*n,i.z=o*n+t.z*s,i}function f(t,e,i){void 0===i&&(i=r(0,0,0));var s=Math.cos(e),o=Math.sin(e);return t=t===i?n(t):t,i.x=t.x*s-t.y*o,i.y=t.x*o+t.y*s,i.z=t.z,i}var _={normal:r(0,0,1),distance:0};function p(t,e,i){void 0===i&&(i=r(0,0,0));var s=c(e.direction,t.normal);if(0===s)return null;var a=(t.distance-c(t.normal,e.origin))/s;return a<0?null:(n(e.direction,i),function(t,e,i){void 0===i&&(i=r(0,0,0)),i.x=t.x*e,i.y=t.y*e,i.z=t.z*e}(i,a,i),o(i,e.origin,i),i)}},434:function(t,e,i){"use strict";i.r(e),i.d(e,"AbortController",function(){return r});var r,s=i(34),n=i(74),o=window;if(o.AbortController)r=o.AbortController;else{var a=function(t){function e(e){var i=t.call(this)||this;return i.onabort=null,i._controller=e,i}return Object(s.b)(e,t),Object.defineProperty(e.prototype,"aborted",{get:function(){return this._controller.aborted},enumerable:!1,configurable:!0}),e.prototype.addEventListener=function(t,e){this.on(String(t),e)},e.prototype.removeEventListener=function(t,e){this.offSingle(String(t),e)},e.prototype.dispatchEvent=function(t){return this.onabort&&this.onabort(t),this._emit(t.type,t),!1},e}(Object(n.a)().with());r=function(){function t(){this._aborted=!1,this.signal=new a(this)}return t.prototype.abort=function(){if(!this._aborted){this._aborted=!0;var t=document.createEvent("Event");t.initEvent("abort",!1,!1),this.signal.dispatchEvent(t)}},Object.defineProperty(t.prototype,"aborted",{get:function(){return this._aborted},enumerable:!1,configurable:!0}),t}()}},435:function(t,e,i){"use strict";i.d(e,"a",function(){return a}),i.d(e,"b",function(){return o});var r=i(434),s=i(192),n=i(565),o=function(){var t=this;this.promise=new Promise(function(e,i){t.resolve=e,t.reject=i})},a=function(){function t(t){var e=this;this._queue=[],this._processing=[],this._paused=!1,this._changed=!1,this._onTaskAbort=function(t,i){var r=e._processing.indexOf(t);if(-1!==r)e._processing.splice(r,1);else{var s=e._queue.indexOf(t);-1!==s&&e._queue.splice(s,1),i.reject(new n.a)}},this._maxConcurrency=t}return t.prototype.enqueue=function(t,e){var i=this;void 0===e&&(e=0);var s=new r.AbortController,n=new o,a={task:t,abortController:s,process:function(){return t(s.signal).then(n.resolve,n.reject)},priority:e};return s.signal.addEventListener("abort",function(){return i._onTaskAbort(a,n)}),this._queue.push(a),this._changed=!0,this._paused||this._process(),{abortController:s,promise:n.promise,updatePriority:function(){a.priority=e,i._changed=!0}}},t.prototype.pause=function(){this._paused=!0},t.prototype.resume=function(){this._paused=!1,this._process()},t.prototype._process=function(){var t,e=this;if(!(this._processing.length>=this._maxConcurrency)){this._changed&&this._queue.sort(function(t,e){return t.priority-e.priority});var i=this._queue.splice(0,this._maxConcurrency-this._processing.length);(t=this._processing).push.apply(t,i);for(var r=function(t){Object(s.promiseFinally)(t.process(),function(){var i=e._processing.indexOf(t);-1!==i&&e._processing.splice(i,1),e._process()})},n=0,o=i;n<o.length;n++){r(o[n])}}},t}()},436:function(t,e,i){"use strict";i.d(e,"a",function(){return s}),i.d(e,"c",function(){return r}),i.d(e,"b",function(){return n});var r=function(){return{min:0,max:21}},s=function(t){if(t.min>=t.max)throw new Error("Invalid zoom range, min >= max ("+t.min+" >= "+t.max+")");if(t.min<0||t.max<0)throw new Error("Invalid zoom range, min or max is less than zero (min="+t.min+" max="+t.max+")")},n=function(t,e,i){return void 0===i&&(i=r()),i.min=Math.max(t.min,e.min),i.max=Math.min(t.max,e.max),i}},437:function(t,e,i){"use strict";i.d(e,"a",function(){return c}),i.d(e,"c",function(){return d}),i.d(e,"b",function(){return u}),i.d(e,"f",function(){return p}),i.d(e,"h",function(){return _}),i.d(e,"d",function(){return m}),i.d(e,"e",function(){return g}),i.d(e,"g",function(){return f});var r=i(34),s=i(75),n=i(125),o=i(76),a=i(155),l=i(566),h=i(402);function c(t,e,i,r){var s=o.divn(e,2*i),n=o.sub(t,s);o.divn(n,r,n),o.applyFunction(n,Math.floor,n);var a=o.add(t,s);return o.divn(a,r,a),o.applyFunction(a,Math.floor,a),{minX:n.x,minY:n.y,maxX:a.x,maxY:a.y}}function d(t,e,i,r,s){var n=o.divn(i,2*r);return[{x:n.x,y:n.y},{x:n.x,y:-n.y},{x:-n.x,y:-n.y},{x:-n.x,y:n.y}].map(function(t){return o.rotate(t,-e)}).map(function(e){return o.sub(t,e)}).map(function(t){return o.divn(t,s)})}function u(t,e,i,a,l,c,d){var u={worldCenter:t,zoom:Object(s.mathLog2)(Math.pow(2,a)*l),azimuth:e,tilt:i},f=function(t,e,i,s,a){var l=e.worldCenter,c=e.tilt,d=e.azimuth,u=e.zoom,f={x:0,y:0,z:.5*-n.a.convertPixelSizeToWorldSize(i,u).y/Math.tan(.5*t)};h.k(f,c,f),h.l(f,d,f),h.c(f,Object(r.a)(Object(r.a)({},l),{z:0}),f);for(var _=Math.tan(.5*t),p=i.x/i.y,m=h.e(_*p,_,1),g=[h.d(h.a),h.d(h.a),h.d(h.a),h.d(h.a)],v=h.e(0,0,0),x={origin:f,direction:v},b=0;b<4;++b){if(h.i(y[b],m,v),h.k(v,c,v),h.l(v,d,v),!h.h(h.b,x,g[b]))throw new Error("Visible quadrilateral is unbounded, engine can't handle that case (yet)")}return g.map(function(t){var e=n.a.worldToPixels(t,s);return o.divn(e,a)})}(Math.PI/6,u,c,a,d),_=function(t){for(var e=1/0,i=-1/0,r=[],s=0,n=1;s<t.length;++s,n=++n%t.length){var o=[t[s],t[(s+1)%t.length]].sort(function(t,e){return t.y-e.y}),a=o[0],l=o[1],h=Math.floor(a.y),c=Math.ceil(l.y);e=Math.min(e,h),i=Math.max(i,c);var d=(l.x-a.x)/(l.y-a.y),u=a.x-(isFinite(d)?d*(a.y-h):0);r.push({firstRow:h,lastRow:c,startX:a.x,endX:l.x,x:u,k:d})}for(var f=[],_=e;_<i;_++){for(var p=1/0,m=-1/0,g=0,y=r;g<y.length;g++){var v=y[g];if(!(_<v.firstRow||_>=v.lastRow)){var x=v.x+v.k,b=v.k>=0?Math.max(v.x,v.startX):Math.min(v.x,v.startX),w=v.k>=0?Math.min(x,v.endX):Math.max(x,v.endX);p=Math.floor(Math.min(p,b,w)),m=Math.ceil(Math.max(m,b,w)),v.x=x}}for(u=p;u<m;u++)f.push({x:u,y:_})}return f}(f),p=new s.Map;return _.forEach(function(t){return p.set(g(t,a),Object(r.a)(Object(r.a)({},t),{border:!1}))}),{tiles:p,tileBounds:f}}function f(t,e){return t.every(function(t){return Object(l.b)(e,t)})}function _(t,e){return{x:Object(a.a)(t.x,0,e),y:Object(a.a)(t.y,0,e)}}function p(t,e,i){var r=t.x,s=t.y;return(i.cycledX||r<e&&r>=0)&&(i.cycledY||s<e&&s>=0)}function m(t,e){return Math.ceil(Math.pow(2,t+8)/e)}function g(t,e){return t.x+"."+t.y+"."+e}var y=[h.e(-1,1,-1),h.e(1,1,-1),h.e(1,-1,-1),h.e(-1,-1,-1)]},565:function(t,e,i){"use strict";i.d(e,"a",function(){return s});var r=i(34),s=function(t){function e(i){var r=t.call(this,void 0===i?"Aborted":i)||this;return r.name="AbortError",r.__proto__=e.prototype,r}return Object(r.b)(e,t),e}(Error)},566:function(t,e,i){"use strict";function r(t,e){for(var i=e.x,r=e.y,s=t.length-1,n=!1,o=0;o<t.length;o++){var a=t[o].y<=r&&t[s].y>r||t[s].y<=r&&t[o].y>r,l=i>(t[s].x-t[o].x)*(r-t[o].y)/(t[s].y-t[o].y)+t[o].x;a&&l&&(n=!n),s=o}return n}function s(t,e){for(var i=1;i<t.length;i++)if(r(t[i],e))return!1;return r(t[0],e)}function n(t,e){if("Point"===t.type)return!1;if("LineString"===t.type)return!1;if("Polygon"===t.type)return s(t.coordinates,e);if("MultiPolygon"===t.type){for(var i=0,r=t.coordinates;i<r.length;i++){if(s(r[i],e))return!0}return!1}return!1}i.d(e,"b",function(){return r}),i.d(e,"a",function(){return n})},633:function(t,e,i){"use strict";i.d(e,"a",function(){return s});var r=i(155);function s(){return Object(r.b)(devicePixelRatio,1,3)}},634:function(t,e,i){"use strict";i.d(e,"a",function(){return s});var r=i(75);function s(t,e,i,s,n,o){void 0===s&&(s=function(){}),void 0===n&&(n=function(){}),void 0===o&&(o=function(){return!0});var a=new r.Map,l=[],h=[],c=[];function d(t,e){s(t,e),c.push(t)}return e.forEach(function(e,r){var s=t.get(r);if(s&&o(s,e)?(n(s,e),h.push(s)):s&&(d(s,r),s=void 0),!s){var c=i(e);l.push(c),s=c}a.set(r,s)}),t.forEach(function(t,i){e.has(i)||d(t,i)}),{result:a,created:l,updated:h,removed:c}}},635:function(t,e,i){"use strict";i.d(e,"b",function(){return n}),i.d(e,"a",function(){return s});var r=i(76),s=40*Math.PI/180;function n(t,e){return r.areFuzzyEqual(t.worldCenter,e.worldCenter)&&t.zoom===e.zoom&&t.azimuth===e.azimuth&&t.tilt===e.tilt}},656:function(t,e,i){"use strict";var r=i(34);function s(t,e){return t===e?null:{old:t,new:e}}var n=i(455),o=i(436),a=i(437),l=i(74);i(248);i.d(e,"a",function(){return h}),i.d(e,"b",function(){return c});var h=function(t){function e(e,i){var r=t.call(this)||this;return r._isTileAnimationStarted=!1,r._makeFields=function(t,e){return{tileSize:e.size||n.c,transparent:Boolean(e.transparent),clampMapZoom:Boolean(t.clampMapZoom),zoomRange:t.zoomRange||Object(o.c)(),fetchHotspots:e.fetchHotspots,hotspotAbortRadius:e.hotspotAbortRadius||n.a,vectorHotspots:t.vector&&t.vector.hotspots||{},awaitAllTilesOnFirstDisplay:Boolean(e.awaitAllTilesOnFirstDisplay)}},r.setSource(e),r.worldOptions=i,r}return Object(r.b)(e,t),Object.defineProperty(e.prototype,"isTileAnimationStarted",{get:function(){return this._isTileAnimationStarted},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rasterSourceDescription",{get:function(){return this._source.raster},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vectorSourceDescription",{get:function(){return this._source.vector},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vectorHotspots",{get:function(){return this._fields.vectorHotspots},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"zoomRange",{get:function(){return this._fields.zoomRange},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"clampMapZoom",{get:function(){return this._fields.clampMapZoom},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"transparent",{get:function(){return this._fields.transparent},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"tileSize",{get:function(){return this._fields.tileSize},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"fetchHotspots",{get:function(){return this._fields.fetchHotspots},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hotspotAbortRadius",{get:function(){return this._fields.hotspotAbortRadius},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"awaitAllTilesOnFirstDisplay",{get:function(){return this._fields.awaitAllTilesOnFirstDisplay},enumerable:!1,configurable:!0}),e.prototype.getHotspotTileDataSource=function(){return this._rasterSource.fetchHotspots?{fetchHotspots:this._rasterSource.fetchHotspots,hotspotAbortRadius:this._rasterSource.hotspotAbortRadius||n.a,tileSize:this._rasterSource.size||n.c,inset:void 0===this._rasterSource.hotspotInset?n.b:this._rasterSource.hotspotInset,padding:this._rasterSource.hotspotPadding||0,zoomRange:this.zoomRange}:null},e.prototype.setSource=function(t){if(!t.raster)return this._source=t,this._emit("changed"),void this._emit("sourceChanged",{clampMapZoom:null,fetchHotspots:null,hotspotAbortRadius:null,tileSize:null,fetchTile:null,vectorHotspots:null,transparent:null,zoomRange:null,awaitAllTilesOnFirstDisplay:null});this._source=t;var e,i=this._makeFields(t,t.raster),n=Object(r.a)(Object(r.a)({},function(t,e){for(var i={},r=0,n=Object.keys(t);r<n.length;r++){var o=n[r];i[o]=s(t[o],e[o])}return i}(this._fields||{},i)),{fetchTile:s(this._rasterSource&&this._rasterSource.tileUrl,t.raster.tileUrl)});this._rasterSource=t.raster,this._fields=i,"string"==typeof this._rasterSource.tileUrl&&(this._tileUrlGenerator=(e=this._rasterSource.tileUrl,function(t,i,r,s){return e.replace("{{x}}",String(t)).replace("{{y}}",String(i)).replace("{{z}}",String(r)).replace("{{scale}}",String(s)).replace(/\{\{d\|(\d+)\}\}/,function(e,s){var n=(t+i+r)%Number(s)+1;return String(n)})})),this._emit("changed"),this._emit("sourceChanged",n)},e.prototype.generateTileUrl=function(t,e,i,r){var s=Object(a.d)(i,this.tileSize);if(!Object(a.f)({x:t,y:e},s,this.worldOptions))return null;var n=Object(a.h)({x:t,y:e},s),o=n.x,l=n.y;return this._tileUrlGenerator(o,l,i,r)},e.prototype.startTileAnimation=function(){this._isTileAnimationStarted=!0,this._emit("tileAnimationStarted")},e.prototype.stopTileAnimation=function(){this._isTileAnimationStarted=!1},e}(Object(l.a)().with());function c(t,e){return t.fetchHotspots===e.fetchHotspots&&t.hotspotAbortRadius===e.hotspotAbortRadius&&t.tileSize===e.tileSize}},74:function(t,e,i){"use strict";var r=i(34),s=i(75),n=(i(248),Object(s.Symbol)("EventEmitter")),o=Object(s.Symbol)("EventEmitter.MixinConstructor"),a=Object(s.Symbol)("EventEmitter.MixinPrototype"),l=function(){function t(){}return t[o]=function(t){t._eventListenersHash={}},t[a]=function(e){e[n]=t.prototype[n],e.group=t.prototype.group,e.on=t.prototype.on,e.offSingle=t.prototype.offSingle,e._emit=t.prototype._emit},t.prototype.on=function(t,e){return this.group().on(t,e)},t.prototype.offSingle=function(t,e){var i=this._eventListenersHash[t];i&&i.delete(e)},t.prototype.group=function(){return new t._eventGroupImpl(this)},t.prototype._emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var r=this._eventListenersHash[t];if(r){var s=[];r.forEach(function(t){return s.push(t)});for(var n=0,o=s;n<o.length;n++){var a=o[n];a(e[0])}}},t._eventGroupImpl=function(){function t(t){this._listeners=[],this._emitter=t}return t.prototype.on=function(t,e){var i=this._emitter._eventListenersHash[t];return i?i.add(e):(this._emitter._eventListenersHash[t]=new s.Set,this._emitter._eventListenersHash[t].add(e)),this._listeners.push([t,e]),this},t.prototype.offAll=function(){for(var t=0,e=this._listeners;t<e.length;t++){var i=e[t],r=i[0],s=i[1];this._emitter._eventListenersHash[r].delete(s)}this._listeners=[]},t}(),t}();l.prototype[n]=!0,i.d(e,"a",function(){return c});var h=function(){},c=function(t){return void 0===t&&(t=h),{with:function(){if(e=t.prototype,Boolean(e&&e[n]))return t;var e,i=function(t){function e(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];var r=t.apply(this,e)||this;return l[o](r),r}return Object(r.b)(e,t),e}(t);return l[a](i.prototype),i}}}},75:function(t,e,i){"use strict";i.r(e),i.d(e,"mathSign",function(){return s}),i.d(e,"mathLog2",function(){return n}),i.d(e,"mathLog10",function(){return o}),i.d(e,"arrayFindIndex",function(){return f}),i.d(e,"arrayFind",function(){return _}),i.d(e,"arrayFrom",function(){return p}),i.d(e,"arraySome",function(){return v}),i.d(e,"Symbol",function(){return l}),i.d(e,"Map",function(){return c}),i.d(e,"Set",function(){return u}),i.d(e,"WeakMap",function(){return d}),i.d(e,"MAX_SAFE_INTEGER",function(){return a});var r={},s=Math.sign?Math.sign.bind(Math):function(t){return t<0?-1:0===t?0:1},n=Math.log2?Math.log2.bind(Math):function(t){return Math.log(t)*Math.LOG2E},o=Math.log10?Math.log10.bind(Math):function(t){return Math.log(t)/Math.LN10},a=Number.MAX_SAFE_INTEGER||9007199254740991,l="undefined"==typeof Symbol?function(t){return"__Symbol_"+t+"_"+Date.now()+"_"+Math.random()}:Symbol,h=function(t){return new t([[r,1]]).has(r)?function(e){return new t(e)}:function(e){var i=new t;if(void 0!==e)for(var r=0,s=e;r<s.length;r++){var n=s[r],o=n[0],a=n[1];i.set(o,a)}return i}},c=h(Map),d=h(WeakMap),u=new Set([r]).has(r)?function(t){return new Set(t)}:function(t){var e=new Set;if(void 0!==t)for(var i=0,r=t;i<r.length;i++){var s=r[i];e.add(s)}return e};c.prototype=Map.prototype,d.prototype=WeakMap.prototype,u.prototype=Set.prototype;var f=Boolean(Array.prototype.findIndex)?function(t,e,i){return t.findIndex(e,i)}:function(t,e,i){for(var r=0;r<t.length;r++)if(e.call(i,t[r],r,t))return r;return-1},_=Boolean(Array.prototype.find)?function(t,e,i){return t.find(e,i)}:function(t,e,i){var r=f(t,e,i);return-1===r?void 0:t[r]},p=Array.from?Array.from:function(t){var e=this,i=Object(t);if(null==t)throw new TypeError("Array.from requires an array-like object - not null or undefined");var r=arguments.length>1?arguments[1]:void 0,s=arguments.length>2?arguments[2]:void 0;if(void 0!==r&&!g(r))throw new TypeError("Array.from: when provided, the second argument must be a function");for(var n=y(i.length),o=g(e)?Object(new e(n)):new Array(n),a=0;a<n;){var l=i[a];o[a]=r?void 0===s?r(l,a):r.call(s,l,a):l,a+=1}return o.length=n,o},m=Object.prototype.toString;function g(t){return"function"==typeof t||"[object Function]"===m.call(t)}function y(t){var e=Number(t);return isNaN(e)||e<=0?0:Math.min(e,a)}var v=function(t,e,i){return-1!==f(t,e,i)}},76:function(t,e,i){"use strict";i.r(e),i.d(e,"create",function(){return s}),i.d(e,"add",function(){return n}),i.d(e,"sub",function(){return o}),i.d(e,"muln",function(){return a}),i.d(e,"divn",function(){return c}),i.d(e,"mulv",function(){return l}),i.d(e,"divv",function(){return h}),i.d(e,"applyFunction",function(){return d}),i.d(e,"areEqual",function(){return f}),i.d(e,"areFuzzyEqual",function(){return u}),i.d(e,"normalize",function(){return _}),i.d(e,"length",function(){return p}),i.d(e,"length2",function(){return m}),i.d(e,"dot",function(){return g}),i.d(e,"avg",function(){return y}),i.d(e,"rotate",function(){return b}),i.d(e,"ORIGIN",function(){return r});var r=s(0,0);function s(t,e){return{x:t,y:e}}function n(t,e,i){return void 0===i&&(i=s(0,0)),i.x=t.x+e.x,i.y=t.y+e.y,i}function o(t,e,i){return void 0===i&&(i=s(0,0)),i.x=t.x-e.x,i.y=t.y-e.y,i}function a(t,e,i){return void 0===i&&(i=s(0,0)),i.x=t.x*e,i.y=t.y*e,i}function l(t,e,i){return void 0===i&&(i=s(0,0)),i.x=t.x*e.x,i.y=t.y*e.y,i}function h(t,e,i){return void 0===i&&(i=s(0,0)),i.x=t.x/e.x,i.y=t.y/e.y,i}function c(t,e,i){return void 0===i&&(i=s(0,0)),i.x=t.x/e,i.y=t.y/e,i}function d(t,e,i){return void 0===i&&(i=s(0,0)),i.x=e(t.x,1),i.y=e(t.y,2),i}function u(t,e,i){void 0===i&&(i=1e-6);var r=o(t,e);return-i<r.x&&r.x<i&&-i<r.y&&r.y<i}function f(t,e){return t.x===e.x&&t.y===e.y}function _(t,e){return void 0===e&&(e=s(0,0)),c(t,p(t),e)}function p(t){return Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2))}function m(t){return Math.pow(t.x,2)+Math.pow(t.y,2)}function g(t,e){return t.x*e.x+t.y*e.y}function y(t,e){return void 0===e&&(e=s(0,0)),e.x=t.reduce(function(t,e){return t+e.x},0)/t.length,e.y=t.reduce(function(t,e){return t+e.y},0)/t.length,e}var v=Math.cos,x=Math.sin;function b(t,e,i){void 0===i&&(i=s(0,0));var r=t.x,n=t.y,o=v(e),a=x(e);return i.x=o*r-a*n,i.y=a*r+o*n,i}},901:function(t,e,i){"use strict";i.d(e,"a",function(){return p});var r=i(34),s=i(75),n=i(192),o=i(437),a=i(74),l=i(268),h=i(566),c=i(125),d=i(312),u=i(155),f=i(76),_=function(){},p=function(t){function e(e,i,r,n,o,a){var l=t.call(this)||this;return l._newTiles=new s.Map,l._loadingTiles=new s.Map,l._readyTiles=new s.Map,l._size=e,l._camera=i,l._tileSource=r,l._zoomRoundingRule=a,l._worldOptions=o,l._queue=n,l}return Object(r.b)(e,t),Object.defineProperty(e.prototype,"state",{get:function(){return{tilesLoaded:0,tilesReady:0,tilesTotal:0,borderTotal:0,borderLoaded:0,borderReady:0}},enumerable:!1,configurable:!0}),e.prototype.destroy=function(){this._loadingTiles.forEach(function(t){t.abortController.abort()})},e.prototype.preloadHotspotsInPoint=function(t){for(var e=this._zoomRoundingRule(this._camera.zoom),i=!1,r=0,s=this._computeAffectedTiles(t,e);r<s.length;r++){var n=s[r],a=Object(o.e)(n,n.zoom);this._isTileDataReadyOrLoading(a)||this._newTiles.has(a)||(this._newTiles.set(a,{id:n}),i=!0)}var l=this._stopLoadingTilesOutsideRadius(t);(i||l)&&this._emit("hotspotsChanged"),i&&this._emit("requestRender")},e.prototype.preloadHotspotsForViewport=function(){for(var t=this,e=!1,i=0,r=this._getTilesForViewport().filter(function(e){return!t._isTileDataReadyOrLoading(Object(o.e)(e,e.zoom))});i<r.length;i++){var s=r[i],n=Object(o.e)(s,s.zoom);this._isTileDataReadyOrLoading(n)||this._newTiles.has(n)||(this._newTiles.set(n,{id:s}),e=!0)}e&&(this._emit("hotspotsChanged"),this._emit("requestRender"))},e.prototype.resize=function(t){f.areEqual(t,this._size)||(this._size=t,this._removeTilesOutsideViewport()&&this._emit("hotspotsChanged"))},e.prototype.update=function(t,e){var i=t.worldCenter,r=t.zoom;i===this._camera.worldCenter&&r===this._camera.zoom||(this._camera=t,this._removeTilesOutsideViewport()&&this._emit("hotspotsChanged"))},e.prototype.render=function(t){var e=this;t.qualityHint<l.a.FULL||this._camera.zoom<this._tileSource.zoomRange.min||this._camera.zoom>this._tileSource.zoomRange.max||(this._newTiles.forEach(function(t){var i=Object(o.e)(t.id,t.id.zoom),s=e._loadTile(t);e._loadingTiles.set(i,s),Object(n.promiseFinally)(s.promise.then(function(n){var o=n.map(function(i){return"world"===i.type?i:function(t,e,i){var r=f.muln(e,i);return{type:"world",feature:t.feature,geometry:Object(d.d)(t.geometry,function(t){return c.a.pixelsToWorld(f.add(t,r),e.zoom)})}}(i,t.id,e._tileSource.tileSize)}),a=e._zoomRoundingRule(e._camera.zoom),l=e._tileSource.padding/c.a.getWorldPixelSize(a),h=0===e._tileSource.padding?o:o.map(function(t){return Object(r.a)(Object(r.a)({},t),{geometry:g(t.geometry,l)})});e._readyTiles.set(i,{id:s.id,hotspots:h}),e._emit("hotspotsChanged")}),function(){return e._loadingTiles.delete(i)}).catch(function(t){if(!t||"AbortError"!==t.name)throw t})}),this._newTiles.clear())},e.prototype.findObjectInPosition=function(t){for(var e=c.a.restrictToZeroWorld(t,this._worldOptions),i=this._zoomRoundingRule(this._camera.zoom),r=!0,s=0,n=this._computeAffectedTiles(e,i);s<n.length;s++){var a=n[s],l=this._readyTiles.get(Object(o.e)(a,i));if(l)for(var d=l.hotspots.length-1;d>=0;d--){var u=l.hotspots[d];if(Object(h.a)(u.geometry,e))return{type:"raw-hotspot",feature:u.feature}}else r=!1}return r?null:void 0},e.prototype._stopLoadingTilesOutsideRadius=function(t){var e=this._zoomRoundingRule(this._camera.zoom),i=f.divn(c.a.worldToPixels(t,e),this._tileSource.tileSize),r=Math.max(this._tileSource.hotspotAbortRadius,this._tileSource.inset)/this._tileSource.tileSize;return m(this._loadingTiles,function(t){return function(t,e,i){var r=f.create(Object(u.b)(e.x,t.x,t.x+1),Object(u.b)(e.y,t.y,t.y+1));return f.sub(r,e,r),f.length2(r)<=Math.pow(i,2)}(t.id,i,r)},function(t){return t.abortController.abort()})},e.prototype._removeTilesOutsideViewport=function(){var t=this._zoomRoundingRule(this._camera.zoom),e=c.a.getScale(t,this._camera.zoom),i=f.create(this._size.x+2*this._tileSource.inset,this._size.y+2*this._tileSource.inset),r=c.a.worldToPixels(this._camera.worldCenter,t),s=Object(o.a)(r,i,e,this._tileSource.tileSize),n=function(e){var i=e.id;return i.zoom===t&&i.x<=s.maxX&&i.x+1>=s.minX&&i.y<=s.maxY&&i.y+1>=s.minY},a=m(this._newTiles,n),l=m(this._loadingTiles,n,function(t){return t.abortController.abort()}),h=m(this._readyTiles,n);return a||l||h},e.prototype._isTileDataReadyOrLoading=function(t){return this._loadingTiles.has(t)||this._readyTiles.has(t)},e.prototype._getTilesForViewport=function(){for(var t=this._zoomRoundingRule(this._camera.zoom),e=c.a.getScale(t,this._camera.zoom),i=c.a.worldToPixels(this._camera.worldCenter,t),r=Object(o.a)(i,this._size,e,this._tileSource.tileSize),s=[],n=r.minX;n<=r.maxX;n++)for(var a=r.minY;a<=r.maxY;a++)s.push({x:n,y:a,zoom:t});return s},e.prototype._loadTile=function(t){var e=this,i=Object(o.d)(t.id.zoom,this._tileSource.tileSize),r=f.applyFunction(t.id,function(t){return Object(u.a)(t,0,i)}),s=this._queue.enqueue(function(i){var s=e._tileSource.fetchHotspots;return!i.aborted&&s?Promise.resolve(s(r.x,r.y,t.id.zoom,i)):Promise.resolve([])}),n=s.promise,a=s.abortController;return{id:t.id,abortController:a,promise:n}},e.prototype._computeAffectedTiles=function(t,e){var i=c.a.worldToTile(t,e,this._tileSource.tileSize),r=f.applyFunction(i,Math.floor),s=f.sub(i,r);f.muln(s,this._tileSource.tileSize,s);var n=s.x<this._tileSource.inset,o=s.x>this._tileSource.tileSize-this._tileSource.inset,a=s.y<this._tileSource.inset,l=s.y>this._tileSource.tileSize-this._tileSource.inset,h=[{x:r.x,y:r.y,zoom:e}];return n&&h.push({x:r.x-1,y:r.y,zoom:e}),o&&h.push({x:r.x+1,y:r.y,zoom:e}),a&&h.push({x:r.x,y:r.y-1,zoom:e}),l&&h.push({x:r.x,y:r.y+1,zoom:e}),n&&a&&h.push({x:r.x-1,y:r.y-1,zoom:e}),n&&l&&h.push({x:r.x-1,y:r.y+1,zoom:e}),o&&a&&h.push({x:r.x+1,y:r.y-1,zoom:e}),o&&l&&h.push({x:r.x+1,y:r.y+1,zoom:e}),h},e}(Object(a.a)().with());function m(t,e,i){void 0===i&&(i=_);var r=!1;return t.forEach(function(s,n){e(s)||(i(s),t.delete(n),r=!0)}),r}function g(t,e){if("Polygon"!==t.type)return t;for(var i=t.coordinates[0],r=i.reduce(function(t,e){return f.add(t,e,t)},f.create(0,0)),s=f.divn(r,i.length),n=1+e/i.reduce(function(t,e){return Math.max(t,f.length(f.sub(e,s)))},0),o=0,a=i;o<a.length;o++){var l=a[o],h=f.sub(l,s);f.muln(h,n,h),f.add(h,s,l)}return t}}}]);